# ๐ ุฎุทุฉ ุชุทููุฑ ููุฒุฉ ุงูุฏูุงุฆุฑ ุงูุฌุบุฑุงููุฉ (Geofencing)

> ูุณุชูุญุงุฉ ูู ุชุทุจูู Life360 - ูุธุงู ุชุชุจุน ุฐูู ููููุธููู ูุน ุฑุจุท ุตุงุฑู ุจุงูุฃูุณุงู

---

## ๐ฏ ุงูููุฑุฉ ุงูุฃุณุงุณูุฉ

### ูุง ูู ุงูุฏูุงุฆุฑ ุงูุฌุบุฑุงููุฉุ

ุงูุฏูุงุฆุฑ ุงูุฌุบุฑุงููุฉ (Geofencing) ูู ููุงุทู ุงูุชุฑุงุถูุฉ **ูุฑุชุจุทุฉ ุจูุณู ูุนูู** ูุชู ุฑุณููุง ุนูู ุงูุฎุฑูุทุฉ. ูููู ูุนุฑูุฉ ููุธูู ุงููุณู ุฏุงุฎู ุงูุฏุงุฆุฑุฉ ููู ูู ุฎุงุฑุฌูุงุ ูุน ุฅููุงููุฉ **ุชุณุฌูู ุญุถูุฑ ุฌูุงุนู ููุท ูููุธูู ุงููุณู ุงููุฑุชุจุท** ุจุถุบุทุฉ ุฒุฑ ูุงุญุฏุฉ.

### โ๏ธ **ุงููุงุนุฏุฉ ุงูุฃุณุงุณูุฉ:**
**ุงูุฏุงุฆุฑุฉ ูุฑุชุจุทุฉ ุจูุณู ูุงุญุฏ ููุท** โ ูุชู ุชุณุฌูู ุงูุญุถูุฑ **ููุท ูููุธูู ูุฐุง ุงููุณู** ุงูููุฌูุฏูู ุฏุงุฎู ุงูุฏุงุฆุฑุฉ.

### ูุซุงู ุนููู:

#### ุฏุงุฆุฑุฉ "ูุดุฑูุน ุจุฑุฌ ุงูููููุฉ" ๐ข
- **ูุฑุชุจุทุฉ ุจูุณู**: ุงูููุฏุณุฉ
- **ุงููููุน**: ุงูุฑูุงุถ - ุญู ุงูุนููุง
- **ูุตู ุงููุทุฑ**: 500 ูุชุฑ
- **ุงูููุธููู ุงููุคูููู ููุญุถูุฑ**: ููุท ููุธูู ูุณู ุงูููุฏุณุฉ

**ุงูุณููุงุฑูู:**
```
ุงูููุธููู ุฏุงุฎู ุงูุฏุงุฆุฑุฉ:
โ ุฃุญูุฏ ูุญูุฏ (ูุณู: ุงูููุฏุณุฉ) โ ุณููุณุฌู ุญุถูุฑู
โ ุฎุงูุฏ ุนูู (ูุณู: ุงูููุฏุณุฉ) โ ุณููุณุฌู ุญุถูุฑู
โ ููุฏ ุณุนุฏ (ูุณู: ุงููุจูุนุงุช) โ ูู ููุณุฌู ุญุถูุฑู (ูุณู ูุฎุชูู)
โ ุณุนุฏ ุฃุญูุฏ (ูุณู: ุงููุญุงุณุจุฉ) โ ูู ููุณุฌู ุญุถูุฑู (ูุณู ูุฎุชูู)
```

#### ุฏุงุฆุฑุฉ "ุงูููุชุจ ุงูุฑุฆูุณู" ๐๏ธ
- **ูุฑุชุจุทุฉ ุจูุณู**: ุงูุฅุฏุงุฑุฉ
- **ุงููููุน**: ุงูุฑูุงุถ - ุงูุนููุง
- **ูุตู ุงููุทุฑ**: 200 ูุชุฑ
- **ุงูููุธููู ุงููุคูููู ููุญุถูุฑ**: ููุท ููุธูู ูุณู ุงูุฅุฏุงุฑุฉ

#### ุฏุงุฆุฑุฉ "ุงููุณุชูุฏุน ุงูุดูุงูู" ๐ฆ
- **ูุฑุชุจุทุฉ ุจูุณู**: ุงูููุฌุณุชูุงุช
- **ุงููููุน**: ุงูุฑูุงุถ - ุงูุดูุงู
- **ูุตู ุงููุทุฑ**: 300 ูุชุฑ
- **ุงูููุธููู ุงููุคูููู ููุญุถูุฑ**: ููุท ููุธูู ูุณู ุงูููุฌุณุชูุงุช

---

## ๐ฏ ุงูููุฒุงุช ุงููุทููุจุฉ

### 1๏ธโฃ ุฅูุดุงุก ูุฅุฏุงุฑุฉ ุงูุฏูุงุฆุฑ

#### ุนูุฏ ุฅูุดุงุก ุฏุงุฆุฑุฉ ุฌุฏูุฏุฉ:
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุฅุถุงูุฉ ุฏุงุฆุฑุฉ ุฌุบุฑุงููุฉ ุฌุฏูุฏุฉ                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ุงุณู ุงูุฏุงุฆุฑุฉ: [ูุดุฑูุน ุจุฑุฌ ุงูููููุฉ      ]   โ
โ  ุงูููุน: [ูุดุฑูุน โผ]                          โ
โ  ุงููุณู ุงููุฑุชุจุท: [ุงูููุฏุณุฉ โผ] โ **ุฅูุฒุงูู**  โ
โ                                             โ
โ  ุงููููุน ุนูู ุงูุฎุฑูุทุฉ: [ุงููุฑ ูุชุญุฏูุฏ]        โ
โ  ูุตู ุงููุทุฑ: [500] ูุชุฑ                      โ
โ  ุงูููู: [๐ฃ #667eea]                       โ
โ                                             โ
โ  [ุฅูุดุงุก ุงูุฏุงุฆุฑุฉ]                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ููุงุญุธุฉ ูููุฉ**: ูุง ูููู ุฅูุดุงุก ุฏุงุฆุฑุฉ ุจุฏูู ุฑุจุทูุง ุจูุณู.

### 2๏ธโฃ ุงููุดู ุงูุชููุงุฆู (ุญุณุจ ุงููุณู)

ุงููุธุงู ูุนุฑุถ ููุท **ููุธูู ุงููุณู ุงููุฑุชุจุท** ูุน ุญุงูุชูู:
- **โ ุฏุงุฎู ุงูุฏุงุฆุฑุฉ** (ุฃุฎุถุฑ) - ููุธู ูู ุงููุณู ูุฏุงุฎู ุงููุทุงู
- **โ๏ธ ุฎุงุฑุฌ ุงูุฏุงุฆุฑุฉ** (ุฃุตูุฑ) - ููุธู ูู ุงููุณู ููู ุฎุงุฑุฌ ุงููุทุงู
- **๐ ููุธูู ุฃูุณุงู ุฃุฎุฑู** - ูุชู ุฅุฎูุงุคูู ุฃู ุนุฑุถูู ุจููู ุฑูุงุฏู ูููุนูููุฉ ููุท

### 3๏ธโฃ ุณุฌู ุงูุฃุญุฏุงุซ
- ุชุณุฌูู **ุฏุฎูู/ุฎุฑูุฌ** ูุฌููุน ุงูููุธููู (ุจุบุถ ุงููุธุฑ ุนู ุงููุณู) ููุชุชุจุน
- ููู **ุชุณุฌูู ุงูุญุถูุฑ** ููุท ูููุธูู ุงููุณู ุงููุฑุชุจุท

### 4๏ธโฃ **ุฒุฑ ุชุณุฌูู ุงูุญุถูุฑ ุงูุฌูุงุนู** โญ (ุงูููุฒุฉ ุงูุฑุฆูุณูุฉ)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ ุฏุงุฆุฑุฉ: ูุดุฑูุน ุจุฑุฌ ุงูููููุฉ                                โ
โ  ๐ข ุงููุณู: ุงูููุฏุณุฉ | ๐ ูุตู ุงููุทุฑ: 500 ูุชุฑ                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ฅ ููุธูู ูุณู ุงูููุฏุณุฉ ุฏุงุฎู ุงูุฏุงุฆุฑุฉ: 5 ููุธููู               โ
โ                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ             โ
โ  โ  โ ุชุณุฌูู ุญุถูุฑ ุฌูุงุนู (5 ููุธููู)          โ โ **ุงูุฒุฑ**  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ             โ
โ                                                              โ
โ  ุงูููุธููู ุงููุคูููู (ูุณู ุงูููุฏุณุฉ):                          โ
โ  โ ุฃุญูุฏ ูุญูุฏ (ูููุฏุณ ุฅูุดุงุฆู) - ุฏุงุฎู - 120ู                โ
โ  โ ุฎุงูุฏ ุนูู (ูููุฏุณ ูุนูุงุฑู) - ุฏุงุฎู - 85ู                   โ
โ  โ ุณุนูุฏ ุญุณู (ูููุฏุณ ููุฑุจุงุก) - ุฏุงุฎู - 200ู                  โ
โ  โ ูุญูุฏ ุนูุฑ (ูููุฏุณ ูููุงูููุง) - ุฏุงุฎู - 150ู                โ
โ  โ ููุฏ ุนุจุฏุงููู (ูููุฏุณ ูุฏูู) - ุฏุงุฎู - 300ู                 โ
โ                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ       โ
โ  ููุธููู ุขุฎุฑูู ุฏุงุฎู ุงูุฏุงุฆุฑุฉ (ุฃูุณุงู ุฃุฎุฑู):                   โ
โ  ๐ ูุงุณุฑ ุณุนุฏ (ูุณู ุงููุจูุนุงุช) - ูู ููุณุฌู ุญุถูุฑู               โ
โ  ๐ ุนูุฑ ููุฏ (ูุณู ุงููุญุงุณุจุฉ) - ูู ููุณุฌู ุญุถูุฑู                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### ุนูุฏ ุงูุถุบุท ุนูู ุงูุฒุฑ:
1. โ ูุชู ุชุณุฌูู ุญุถูุฑ **ููุท** ูููุธูู ูุณู "ุงูููุฏุณุฉ" ุงูููุฌูุฏูู ุฏุงุฎู ุงูุฏุงุฆุฑุฉ
2. โ ูุง ูุชู ุชุณุฌูู ุญุถูุฑ ููููุธููู ูู ุฃูุณุงู ุฃุฎุฑู (ุญุชู ูู ูุงููุง ุฏุงุฎู ุงูุฏุงุฆุฑุฉ)
3. โ ูุธูุฑ ุฅุดุนุงุฑ: "ุชู ุชุณุฌูู ุญุถูุฑ 5 ููุธููู ูู ูุณู ุงูููุฏุณุฉ"
4. โ ูุชู ุชุฎุทู ูู ุณุฌู ุญุถูุฑู ูุณุจูุงู ุงูููู

### 5๏ธโฃ ุงูุฅุดุนุงุฑุงุช (ุงุฎุชูุงุฑูุฉ)
- ุฅุดุนุงุฑ ุนูุฏ ุฏุฎูู/ุฎุฑูุฌ ููุธู ูู ุงููุณู ุงููุฑุชุจุท
- ุชูุฑูุฑ ูููู ุจุญุฑูุฉ ููุธูู ุงููุณู
- ุชูุจูู ููุชุฃุฎูุฑ ูููุธูู ุงููุณู

### 6๏ธโฃ ุนุฑุถ ุตูุฑุฉ ุงูููุฑ ุงูุตูุงุนู
- ุฒุฑ ูุชุจุฏูู ุจูู ุงูุฎุฑูุทุฉ ุงูุนุงุฏูุฉ ูุตูุฑุฉ ุงูููุฑ ุงูุตูุงุนู
- ุงุณุชุฎุฏุงู **Mapbox Satellite** ูููุถูุญ

### 7๏ธโฃ ูุณุฎ ุฑุงุจุท ุงููููุน ูููุดุงุฑูุฉ
- ุฅูุดุงุก **ุฑุงุจุท ูุคูุช** ููุดุงุฑูุฉ ูููุน ุงูุฏุงุฆุฑุฉ
- ููุชูู ุจุนุฏ 24 ุณุงุนุฉ

### 8๏ธโฃ ุนุฑุถ ุตูุฑ ุงูููุธููู ุนูู ุงูุฎุฑูุทุฉ
- ุตูุฑุฉ ุฏุงุฆุฑูุฉ ุตุบูุฑุฉ (64ร64 ุจูุณู)
- ุชูููุฒ ููุธูู ุงููุณู ุงููุฑุชุจุท ุจููู ูุฎุชูู

---

## ๐๏ธ ุงูุจููุฉ ุงูุชูููุฉ

### ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### 1. ุฌุฏูู ุงูุฏูุงุฆุฑ (geofences)
```sql
CREATE TABLE geofences (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,                    -- ุงุณู ุงูุฏุงุฆุฑุฉ
    type VARCHAR(50) DEFAULT 'project',            -- ููุน (project, office, warehouse)
    description TEXT,                               -- ูุตู
    center_latitude NUMERIC(9, 6) NOT NULL,        -- ุฎุท ุงูุนุฑุถ
    center_longitude NUMERIC(9, 6) NOT NULL,       -- ุฎุท ุงูุทูู
    radius_meters INTEGER NOT NULL,                -- ูุตู ุงููุทุฑ
    color VARCHAR(20) DEFAULT '#667eea',           -- ููู ุงูุฏุงุฆุฑุฉ
    is_active BOOLEAN DEFAULT TRUE,                -- ูู ูุดุทุฉุ
    
    -- โญ **ุงูุญูู ุงูุฃุณุงุณู: ุฑุจุท ุตุงุฑู ุจูุณู ูุงุญุฏ**
    department_id INTEGER NOT NULL REFERENCES department(id) ON DELETE CASCADE,
    
    notify_on_entry BOOLEAN DEFAULT FALSE,         -- ุฅุดุนุงุฑ ุนูุฏ ุงูุฏุฎูู
    notify_on_exit BOOLEAN DEFAULT FALSE,          -- ุฅุดุนุงุฑ ุนูุฏ ุงูุฎุฑูุฌ
    
    created_by INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    CONSTRAINT valid_radius CHECK (radius_meters > 0 AND radius_meters <= 10000),
    CONSTRAINT valid_type CHECK (type IN ('project', 'office', 'warehouse', 'other'))
);

-- ููุฑุณ ูุชุณุฑูุน ุงูุจุญุซ ุจุงููุณู
CREATE INDEX idx_geofence_department ON geofences(department_id, is_active);
```

**ููุงุญุธุฉ**: `department_id` ุงูุขู **NOT NULL** - ูุฌุจ ุฑุจุท ูู ุฏุงุฆุฑุฉ ุจูุณู.

#### 2. ุฌุฏูู ุงูุฃุญุฏุงุซ (geofence_events)
```sql
CREATE TABLE geofence_events (
    id SERIAL PRIMARY KEY,
    geofence_id INTEGER REFERENCES geofences(id) ON DELETE CASCADE,
    employee_id INTEGER REFERENCES employee(id) ON DELETE CASCADE,
    event_type VARCHAR(30) NOT NULL,               -- enter, exit, bulk_check_in
    location_latitude NUMERIC(9, 6),
    location_longitude NUMERIC(9, 6),
    distance_from_center INTEGER,
    recorded_at TIMESTAMP DEFAULT NOW(),
    processed_at TIMESTAMP,
    source VARCHAR(20) DEFAULT 'auto',             -- auto, bulk
    attendance_id INTEGER REFERENCES attendance(id),
    notes TEXT,
    
    CONSTRAINT valid_event_type CHECK (
        event_type IN ('enter', 'exit', 'bulk_check_in')
    )
);

-- ููุงุฑุณ ููุฃุฏุงุก
CREATE INDEX idx_geofence_events_time ON geofence_events(recorded_at DESC);
CREATE INDEX idx_geofence_events_employee ON geofence_events(employee_id, recorded_at DESC);
CREATE INDEX idx_geofence_events_geofence ON geofence_events(geofence_id, recorded_at DESC);
```

**ุชุจุณูุท**: ุชู ุฅุฒุงูุฉ ุฌุฏูู `geofence_membership` ูุฃููุง ูุนุชูุฏ ุนูู **ุฑุจุท ุงููุณู** ูุจุงุดุฑุฉ.

---

## ๐ป ุงูุชูููุฐ ุงูููุชุฑุญ

### 1. Models ูู Flask

```python
class Geofence(db.Model):
    """ุฏุงุฆุฑุฉ ุฌุบุฑุงููุฉ ูุฑุชุจุทุฉ ุจูุณู"""
    __tablename__ = 'geofences'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(200), nullable=False)
    type = db.Column(db.String(50), default='project')
    description = db.Column(db.Text)
    center_latitude = db.Column(db.Numeric(9, 6), nullable=False)
    center_longitude = db.Column(db.Numeric(9, 6), nullable=False)
    radius_meters = db.Column(db.Integer, nullable=False)
    color = db.Column(db.String(20), default='#667eea')
    is_active = db.Column(db.Boolean, default=True)
    
    # โญ **ุฑุจุท ุฅูุฒุงูู ุจูุณู ูุงุญุฏ**
    department_id = db.Column(db.Integer, db.ForeignKey('department.id', ondelete='CASCADE'), nullable=False)
    
    notify_on_entry = db.Column(db.Boolean, default=False)
    notify_on_exit = db.Column(db.Boolean, default=False)
    created_by = db.Column(db.Integer, db.ForeignKey('users.id'))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # ุงูุนูุงูุงุช
    department = db.relationship('Department', backref='geofences')
    events = db.relationship('GeofenceEvent', backref='geofence', cascade='all, delete-orphan')
    
    def get_department_employees_inside(self):
        """
        ุฌูุจ ููุธูู ุงููุณู ุงููุฑุชุจุท ุงูููุฌูุฏูู ุฏุงุฎู ุงูุฏุงุฆุฑุฉ ููุท
        """
        from models import Employee, EmployeeLocation
        
        employees_inside = []
        
        # โญ **ุฌูุจ ููุธูู ุงููุณู ุงููุฑุชุจุท ููุท**
        department_employees = Employee.query.join(employee_departments).filter(
            employee_departments.c.department_id == self.department_id
        ).all()
        
        for employee in department_employees:
            # ุฌูุจ ุขุฎุฑ ูููุน ููููุธู
            latest_location = EmployeeLocation.query.filter_by(
                employee_id=employee.id
            ).order_by(EmployeeLocation.recorded_at.desc()).first()
            
            if latest_location:
                # ุงูุชุญูู ูู ูุฌูุฏู ุฏุงุฎู ุงูุฏุงุฆุฑุฉ
                distance = self.calculate_distance(
                    latest_location.latitude,
                    latest_location.longitude
                )
                
                if distance <= self.radius_meters:
                    employees_inside.append({
                        'employee': employee,
                        'location': latest_location,
                        'distance': distance
                    })
        
        return employees_inside
    
    def get_all_employees_inside(self):
        """
        ุฌูุจ ุฌููุน ุงูููุธููู ุฏุงุฎู ุงูุฏุงุฆุฑุฉ (ูู ุฌููุน ุงูุฃูุณุงู)
        ููุนุฑุถ ููุท - ูู ูุชู ุชุณุฌูู ุญุถูุฑ ููู
        """
        from models import Employee, EmployeeLocation
        
        all_employees_inside = []
        
        # ุฌูุจ ุฌููุน ุงูููุธููู
        all_employees = Employee.query.all()
        
        for employee in all_employees:
            latest_location = EmployeeLocation.query.filter_by(
                employee_id=employee.id
            ).order_by(EmployeeLocation.recorded_at.desc()).first()
            
            if latest_location:
                distance = self.calculate_distance(
                    latest_location.latitude,
                    latest_location.longitude
                )
                
                if distance <= self.radius_meters:
                    # ุงูุชุญูู ูู ุงููุณู
                    is_from_linked_department = any(
                        dept.id == self.department_id 
                        for dept in employee.departments
                    )
                    
                    all_employees_inside.append({
                        'employee': employee,
                        'location': latest_location,
                        'distance': distance,
                        'is_eligible': is_from_linked_department  # โญ ูุคูู ููุญุถูุฑ
                    })
        
        return all_employees_inside
    
    def calculate_distance(self, lat, lon):
        """ุญุณุงุจ ุงููุณุงูุฉ ูู ูุฑูุฒ ุงูุฏุงุฆุฑุฉ ุจุงุณุชุฎุฏุงู Haversine"""
        from math import radians, sin, cos, sqrt, atan2
        
        R = 6371000  # ูุตู ูุทุฑ ุงูุฃุฑุถ ุจุงูุฃูุชุงุฑ
        
        lat1 = radians(float(self.center_latitude))
        lon1 = radians(float(self.center_longitude))
        lat2 = radians(lat)
        lon2 = radians(lon)
        
        dlat = lat2 - lat1
        dlon = lon2 - lon1
        
        a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
        c = 2 * atan2(sqrt(a), sqrt(1-a))
        
        return R * c


class GeofenceEvent(db.Model):
    """ุญุฏุซ ุฏุฎูู/ุฎุฑูุฌ/ุชุณุฌูู ุฌูุงุนู"""
    __tablename__ = 'geofence_events'
    
    id = db.Column(db.Integer, primary_key=True)
    geofence_id = db.Column(db.Integer, db.ForeignKey('geofences.id', ondelete='CASCADE'))
    employee_id = db.Column(db.Integer, db.ForeignKey('employee.id', ondelete='CASCADE'))
    event_type = db.Column(db.String(30), nullable=False)
    location_latitude = db.Column(db.Numeric(9, 6))
    location_longitude = db.Column(db.Numeric(9, 6))
    distance_from_center = db.Column(db.Integer)
    recorded_at = db.Column(db.DateTime, default=datetime.utcnow)
    processed_at = db.Column(db.DateTime)
    source = db.Column(db.String(20), default='auto')
    attendance_id = db.Column(db.Integer, db.ForeignKey('attendance.id'))
    notes = db.Column(db.Text)
    
    # ุงูุนูุงูุงุช
    employee = db.relationship('Employee', backref='geofence_events')
```

### 2. Route ูุชุณุฌูู ุงูุญุถูุฑ ุงูุฌูุงุนู (ููุญุฏูุซ)

```python
@geofences_bp.route('/<int:geofence_id>/bulk-check-in', methods=['POST'])
@login_required
def bulk_check_in(geofence_id):
    """
    ุชุณุฌูู ุญุถูุฑ ุฌูุงุนู ููุท ูููุธูู ุงููุณู ุงููุฑุชุจุท ุจุงูุฏุงุฆุฑุฉ
    """
    
    geofence = Geofence.query.get_or_404(geofence_id)
    
    # โญ **ุฌูุจ ููุธูู ุงููุณู ุงููุฑุชุจุท ููุท**
    employees_inside = geofence.get_department_employees_inside()
    
    if not employees_inside:
        return jsonify({
            'success': False,
            'message': f'ูุง ููุฌุฏ ููุธููู ูู ูุณู "{geofence.department.name}" ุฏุงุฎู ุงูุฏุงุฆุฑุฉ ุญุงููุงู'
        })
    
    checked_in = []
    already_checked = []
    errors = []
    
    for emp_data in employees_inside:
        employee = emp_data['employee']
        location = emp_data['location']
        
        # ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุญุถูุฑ ูุณุฌู ุงูููู
        today_start = datetime.utcnow().replace(hour=0, minute=0, second=0, microsecond=0)
        existing_attendance = Attendance.query.filter(
            Attendance.employee_id == employee.id,
            Attendance.check_in_time >= today_start
        ).first()
        
        if existing_attendance:
            already_checked.append(employee.name)
            continue
        
        try:
            # ุชุณุฌูู ุงูุญุถูุฑ
            attendance = Attendance(
                employee_id=employee.id,
                check_in_time=datetime.utcnow(),
                status='present',
                notes=f'ุชุณุฌูู ุฌูุงุนู ูู ุฏุงุฆุฑุฉ: {geofence.name} (ูุณู: {geofence.department.name})'
            )
            db.session.add(attendance)
            db.session.flush()  # ููุญุตูู ุนูู attendance.id
            
            # ุชุณุฌูู ุญุฏุซ ูู ุงูุฏุงุฆุฑุฉ
            event = GeofenceEvent(
                geofence_id=geofence.id,
                employee_id=employee.id,
                event_type='bulk_check_in',
                location_latitude=location.latitude,
                location_longitude=location.longitude,
                distance_from_center=int(emp_data['distance']),
                source='bulk',
                attendance_id=attendance.id,
                notes=f'ุชุณุฌูู ุฌูุงุนู ุจูุงุณุทุฉ {current_user.username} - ูุณู: {geofence.department.name}'
            )
            db.session.add(event)
            
            checked_in.append(employee.name)
            
        except Exception as e:
            errors.append(f'{employee.name}: {str(e)}')
    
    db.session.commit()
    
    return jsonify({
        'success': True,
        'department_name': geofence.department.name,
        'checked_in_count': len(checked_in),
        'already_checked_count': len(already_checked),
        'error_count': len(errors),
        'checked_in': checked_in,
        'already_checked': already_checked,
        'errors': errors,
        'message': f'ุชู ุชุณุฌูู ุญุถูุฑ {len(checked_in)} ููุธู ูู ูุณู "{geofence.department.name}" ุจูุฌุงุญ'
    })
```

---

## ๐๏ธ ุฎุทุฉ ุงูุชูููุฐ

### **ุงููุฑุญูุฉ 1: ุงูุจููุฉ ุงูุฃุณุงุณูุฉ** (ุฃุณุจูุน 1)
- [ ] ุฅูุดุงุก ุฌุฏูู `geofences` ูุน ุฑุจุท ุฅูุฒุงูู ุจุงููุณู
- [ ] ุฅูุดุงุก ุฌุฏูู `geofence_events`
- [ ] ุฅูุดุงุก Models ูู Flask
- [ ] ุฅูุดุงุก Routes ุงูุฃุณุงุณูุฉ

### **ุงููุฑุญูุฉ 2: ุงููุนุงูุฌุฉ ุงูุชููุงุฆูุฉ** (ุฃุณุจูุน 2)
- [ ] ูุดู ุชููุงุฆู ููุฏุฎูู/ุงูุฎุฑูุฌ (ูุฌููุน ุงูููุธููู)
- [ ] ุชุณุฌูู ุงูุฃุญุฏุงุซ (ููุชุชุจุน)
- [ ] ุญุณุงุจ ุงููุณุงูุงุช ุจููุงุกุฉ (Haversine)

### **ุงููุฑุญูุฉ 3: ุงููุงุฌูุฉ ูุงูุฎุฑูุทุฉ** (ุฃุณุจูุน 3)
- [ ] ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุฏูุงุฆุฑ
- [ ] ูููุฐุฌ ุฅูุดุงุก ุฏุงุฆุฑุฉ (ูุน ุงุฎุชูุงุฑ ุงููุณู ุฅูุฒุงููุงู)
- [ ] ุฑุณู ุงูุฏูุงุฆุฑ ุนูู ุงูุฎุฑูุทุฉ (Leaflet.js)
- [ ] **ุนุฑุถ ููุธูู ุงููุณู ุฏุงุฎู/ุฎุงุฑุฌ ุงูุฏุงุฆุฑุฉ**
- [ ] **ุฒุฑ ุชุณุฌูู ุงูุญุถูุฑ ุงูุฌูุงุนู** โญ
- [ ] ุนุฑุถ ุตูุฑ ุงูููุธููู ุนูู ุงูุฎุฑูุทุฉ
- [ ] ุชุจุฏูู ุตูุฑุฉ ุงูููุฑ ุงูุตูุงุนู (Mapbox Satellite)

### **ุงููุฑุญูุฉ 4: ุงูููุฒุงุช ุงูุฅุถุงููุฉ** (ุฃุณุจูุน 4)
- [ ] ุฑูุงุจุท ุงููุดุงุฑูุฉ ุงููุคูุชุฉ
- [ ] ุงูุฅุดุนุงุฑุงุช (ุงุฎุชูุงุฑูุฉ)
- [ ] ุงูุชูุงุฑูุฑ ูุงูุฅุญุตุงุฆูุงุช (ุญุณุจ ุงููุณู)
- [ ] ุณุฌู ุงูุฏุฎูู ูุงูุฎุฑูุฌ ุงูุชุงุฑูุฎู

---

## ๐ก ุงููุฑููุงุช ุงูุฃุณุงุณูุฉ

### โ **ุงูุชุญุฏูุซ ุงูุฑุฆูุณู:**

| ุงูููุฒุฉ | **ุงููุณุฎุฉ ุงูุณุงุจูุฉ** | **ุงููุณุฎุฉ ุงูุญุงููุฉ** |
|--------|-------------------|-------------------|
| ุฑุจุท ุงูุฏุงุฆุฑุฉ ุจูุณู | ุงุฎุชูุงุฑู (nullable) | **ุฅูุฒุงูู (NOT NULL)** |
| ุชุณุฌูู ุงูุญุถูุฑ | ูุฌููุน ูู ูู ุงูุฏุงุฆุฑุฉ | **ููุท ูููุธูู ุงููุณู ุงููุฑุชุจุท** |
| ุนุฑุถ ุงูููุธููู | ุฌููุน ูู ูู ุงูุฏุงุฆุฑุฉ | **ุชูููุฒ ููุธูู ุงููุณู** |
| ุฌุฏูู ุงูุฃุนุถุงุก | geofence_membership | **ุชู ุฅูุบุงุคู - ูุณุชุฎุฏู ุฑุจุท ุงููุณู** |

### ๐ฏ **ุงููุงุฆุฏุฉ:**
- **ุชุญูู ุฃูุถู**: ูู ุฏุงุฆุฑุฉ ุฎุงุตุฉ ุจูุณู ูุงุญุฏ
- **ูุถูุญ ุฃูุจุฑ**: ูุง ููุฌุฏ ูุจุณ ูู ูู ููุณุฌู ุญุถูุฑู
- **ุจููุฉ ุฃุจุณุท**: ูุง ุญุงุฌุฉ ูุฌุฏูู geofence_membership
- **ุฃูุงู ุฃุนูู**: ูุง ูููู ุชุณุฌูู ุญุถูุฑ ูููุธู ูู ูุณู ุฎุงุทุฆ

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ**: 08 ููููุจุฑ 2025  
**ุงูุฅุตุฏุงุฑ**: 3.0 (ุฑุจุท ุตุงุฑู ุจุงูุฃูุณุงู)  
**ุงูุญุงูุฉ**: ุฌุงูุฒ ููุชูููุฐ โ
