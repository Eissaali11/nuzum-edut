# دراسة تطوير قسم المحاسبة

تاريخ الإصدار: 2026-02-27
الحالة: خطة تطوير تنفيذية

## 1) الهدف من الدراسة
هذه الدراسة تحول قسم المحاسبة من وضع "يعمل وظيفيًا" إلى وضع "قابل للتوسع وسهل الصيانة" عبر:
- تقليل التعقيد الفني في طبقة المسارات.
- تثبيت واجهات المسارات والقوالب بدون كسر التوافق.
- فصل منطق الأعمال عن واجهات الويب تدريجيًا.
- رفع قابلية الاختبار والسرعة في تسليم الميزات.

## 2) نطاق التطوير
يشمل النطاق:
- routes/accounting/*
- routes/blueprint_registry.py (في جزء التسجيل والتوافق)
- services/accounting_service.py
- القوالب المرتبطة بالمحاسبة والروابط التاريخية

خارج النطاق (حالياً):
- إعادة تصميم كامل لواجهة المستخدم.
- تغيير جذري في نماذج البيانات (إلا عند الضرورة).

## 3) تشخيص الوضع الحالي
## 3.1 نقاط قوة
- وجود تقسيم جزئي جيد داخل routes/accounting.
- وظائف أساسية متوفرة: الحسابات، القيود، التحليلات، الربحية، الفوترة.
- وجود خدمة محاسبية أولية في services/accounting_service.py.

## 3.2 نقاط ضعف
- تضخم ملفات حرجة (مثل accounting_extended.py و profitability_routes.py).
- تداخل نقاط الدخول (Core + Extended + Profitability) داخل registry.
- اعتماد واضح على توافق رجعي في endpoints داخل registry.
- تكرار نمط CRUD والتحقق ومعالجة الأخطاء بين المسارات.

## 3.3 الأثر التشغيلي الحالي
- ارتفاع تكلفة أي تعديل بسيط بسبب تداخل المسؤوليات.
- زيادة مخاطر ظهور أخطاء BuildError عند تغيير endpoint names.
- زمن أطول للمراجعة والاختبار عند كل تطوير.

## 4) البنية المستهدفة (Target Architecture)
## 4.1 طبقات واضحة
- Presentation Layer:
  - routes/accounting/<bounded_context>/..._routes.py
  - مسؤولية: استقبال الطلبات، التحقق السطحي، الرد.
- Application Layer:
  - modules/accounting/application/<use_case>_service.py
  - مسؤولية: orchestration وقواعد العمل.
- Domain Layer:
  - modules/accounting/domain/*.py
  - مسؤولية: الكيانات والقواعد الجوهرية.
- Infrastructure Layer:
  - تخزين/تصدير/تكاملات خارجية.

## 4.2 مبدأ التوافق
- الحفاظ على endpoints الحالية عبر aliases مرحلية.
- نقل القوالب تدريجيًا إلى endpoints canonical.
- إزالة aliases فقط بعد الوصول إلى 0 استخدام فعلي.

## 5) مسارات العمل (Workstreams)
## A) توحيد واجهة المسارات
- حصر جميع url_for المستخدمة للمحاسبة.
- إنتاج جدول Mapping:
  - Legacy endpoint
  - Canonical endpoint
  - حالة التوافق (مفعل/قابل للإزالة)

## B) تقليل التكرار في طبقة Routes
- استخراج utilities موحدة:
  - parsing للأرقام/التواريخ
  - commit/rollback + flash
  - قوالب ردود JSON القياسية

## C) تفكيك الملفات الكبيرة
- تفكيك accounting_extended.py إلى:
  - payroll_routes.py
  - vehicle_expense_routes.py
  - financial_reports_routes.py
- تفكيك profitability_routes.py إلى:
  - profitability_dashboard_routes.py
  - contracts_routes.py
  - utility_bills_routes.py

## D) نقل قواعد العمل إلى Services
- إبقاء route كمنسق فقط.
- نقل منطق احتساب الربحية، القيود التلقائية، والتحقق المحاسبي إلى خدمات تطبيقية.

## E) الاختبار والمراقبة
- اختبارات smoke للمسارات المحاسبية الحرجة.
- اختبار ربط القوالب (Template URL Validation).
- قياس أخطاء 500/BuildError قبل وبعد كل مرحلة.

## 6) خطة التنفيذ المرحلية
## المرحلة 0 (1-2 يوم) — تثبيت سريع
- تجميد أسماء endpoints الحرجة.
- توثيق mapping الحالي.
- إضافة فحص بسيط يمنع حذف aliases المستخدمة.

مؤشر نجاح:
- صفر BuildError في التنقلات المحاسبية الأساسية.

## المرحلة 1 (3-5 أيام) — توحيد سطح المسارات
- اعتماد canonical endpoints.
- تحديث القوالب الأكثر استخدامًا أولاً.
- الإبقاء على aliases التوافقية.

مؤشر نجاح:
- انخفاض روابط legacy في القوالب بنسبة 40% على الأقل.

## المرحلة 2 (1 أسبوع) — تفكيك الملفات الكبيرة
- نقل use-cases إلى ملفات أصغر.
- إبقاء wrappers بنفس الأسماء لتجنب الكسر.

مؤشر نجاح:
- ألا يتجاوز أي ملف routes محاسبي 300-350 سطر تقريبًا.

## المرحلة 3 (1 أسبوع) — نقل منطق الأعمال إلى services
- تقليل منطق SQL المباشر داخل routes.
- رفع نسبة الاستدعاء عبر services.

مؤشر نجاح:
- 60%+ من منطق الأعمال المحاسبي خارج routes.

## المرحلة 4 (3-5 أيام) — تنظيف التوافق والاعتماد النهائي
- إزالة aliases غير المستخدمة.
- تحديث التوثيق النهائي.

مؤشر نجاح:
- 0 endpoint legacy مستخدم فعليًا.

## 7) مصفوفة المخاطر
- خطر: كسر روابط القوالب.
  - التخفيف: Mapping + aliases + فحص template URLs قبل الدمج.
- خطر: اختلاف السلوك بعد نقل المنطق إلى service.
  - التخفيف: اختبارات regression على سيناريوهات الرواتب والقيود.
- خطر: بطء التنفيذ بسبب حجم الملفات.
  - التخفيف: العمل على دفعات صغيرة (PRs قصيرة).

## 8) مؤشرات القياس (KPIs)
- عدد أخطاء 500 المرتبطة بالمحاسبة أسبوعيًا.
- عدد BuildError المرتبطة url_for.
- متوسط زمن مراجعة PR في قسم المحاسبة.
- نسبة التغطية الاختبارية للمسارات الحرجة.
- عدد الملفات التي تتجاوز 350 سطر.

## 9) خطة التسليم المقترحة (4 أسابيع)
الأسبوع 1:
- Mapping endpoints + تثبيت aliases + تحديث القوالب الأعلى استخدام.

الأسبوع 2:
- تفكيك accounting_extended.py.

الأسبوع 3:
- تفكيك profitability_routes.py + توحيد utilities.

الأسبوع 4:
- نقل use-cases للخدمات + regression + تنظيف التوافق.

## 10) قائمة بدء فورية (Ready-to-Start)
1. إنشاء ملف Mapping رسمي للـ endpoints المحاسبية.
2. تحديد 10 قوالب الأكثر استخدامًا وتحديثها إلى canonical.
3. بدء تفكيك accounting_extended.py على 3 PRs صغيرة.
4. إضافة اختبار smoke لمسارات:
   - /accounting/dashboard
   - /accounting/transactions
   - /accounting/profitability

## 11) النتيجة المتوقعة
عند تنفيذ هذه الخطة، قسم المحاسبة سيصبح:
- أكثر استقرارًا في التشغيل اليومي.
- أسرع في التطوير وإضافة الميزات.
- أقل عرضة للأخطاء الناتجة عن تداخل المسارات.
- أوضح معماريًا للفريق الحالي والجدد.
