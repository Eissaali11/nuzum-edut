"""
ูุธุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ููุชุญููู ุงููุงูู
AI Financial Analysis System
"""

import os
import json
from datetime import datetime
from openai import OpenAI
from flask import current_app
from sqlalchemy import func

class AIFinancialAnalyzer:
    """ูุญูู ูุงูู ุฐูู ุจุงุณุชุฎุฏุงู GPT-4o"""
    
    def __init__(self):
        self.client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))
    
    def analyze_company_finances(self, db, Employee, Salary, Vehicle, Transaction):
        """ุชุญููู ุดุงูู ูููุถุน ุงููุงูู ููุดุฑูุฉ"""
        try:
            # ุฌูุจ ุงูุจูุงูุงุช ุงููุงููุฉ ุงูุญููููุฉ
            today = datetime.now().date()
            
            # ุฅุญุตุงุฆูุงุช ุงูุฑูุงุชุจ
            total_salaries = db.session.query(func.sum(Salary.net_salary)).scalar() or 0
            employees_count = Employee.query.filter_by(status='active').count()
            
            # ุฅุญุตุงุฆูุงุช ุงูุณูุงุฑุงุช
            vehicles_count = Vehicle.query.count()
            vehicles_rental_cost = vehicles_count * 1500  # ุชูุฏูุฑ ุชูููุฉ ุงูุฅูุฌุงุฑ
            
            # ุฅุญุตุงุฆูุงุช ุงููุนุงููุงุช
            transactions_count = Transaction.query.count()
            total_transactions_amount = db.session.query(func.sum(Transaction.total_amount)).scalar() or 0
            
            # ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุฐูุงุก ุงูุงุตุทูุงุนู
            financial_data = {
                "date": today.strftime("%Y-%m-%d"),
                "employees": {
                    "total_count": employees_count,
                    "total_salaries": float(total_salaries),
                    "average_salary": float(total_salaries / employees_count) if employees_count > 0 else 0
                },
                "vehicles": {
                    "total_count": vehicles_count,
                    "estimated_rental_cost": vehicles_rental_cost
                },
                "transactions": {
                    "total_count": transactions_count,
                    "total_amount": float(total_transactions_amount)
                }
            }
            
            # ุฅูุดุงุก prompt ููุฐูุงุก ุงูุงุตุทูุงุนู
            prompt = f"""
            ุฃูุช ูุณุชุดุงุฑ ูุงูู ุฎุจูุฑ ูุชุฎุตุต ูู ุชุญููู ุงูุจูุงูุงุช ุงููุงููุฉ ููุดุฑูุงุช ุงูุณุนูุฏูุฉ.
            
            ุงูุจูุงูุงุช ุงููุงููุฉ ููุดุฑูุฉ:
            {json.dumps(financial_data, ensure_ascii=False, indent=2)}
            
            ูุฑุฌู ุชูุฏูู ุชุญููู ูุงูู ุดุงูู ูุชุถูู:
            1. ุชุญููู ุงููุถุน ุงููุงูู ุงูุญุงูู
            2. ููุงุท ุงูููุฉ ูุงูุถุนู
            3. ุชูุตูุงุช ูุชุญุณูู ุงูุฃุฏุงุก ุงููุงูู
            4. ุชุญููู ุงูุชูุงููู ูุงูุฅูุฑุงุฏุงุช
            5. ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ
            
            ุงุฌุนู ุงูุชุญููู ุจุงููุบุฉ ุงูุนุฑุจูุฉ ูููุงุณุจ ููุณูู ุงูุณุนูุฏู.
            """
            
            # ุทูุจ ุงูุชุญููู ูู OpenAI
            # the newest OpenAI model is "gpt-4o" which was released May 13, 2024.
            # do not change this unless explicitly requested by the user
            response = self.client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {
                        "role": "system",
                        "content": "ุฃูุช ูุณุชุดุงุฑ ูุงูู ุณุนูุฏู ุฎุจูุฑ ูู ุชุญููู ุงูุจูุงูุงุช ุงููุงููุฉ ููุดุฑูุงุช."
                    },
                    {
                        "role": "user",
                        "content": prompt
                    }
                ],
                max_tokens=1500,
                temperature=0.3
            )
            
            analysis_result = response.choices[0].message.content
            
            return {
                'success': True,
                'analysis': analysis_result,
                'data_summary': financial_data,
                'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }
            
        except Exception as e:
            current_app.logger.error(f"Error in AI financial analysis: {e}")
            # ูุธุงู backup ูุญูู ููุชุญููู
            if "429" in str(e) or "quota" in str(e).lower():
                return self._generate_local_analysis(financial_data)
            return {
                'success': False,
                'message': f'ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู: {str(e)}',
                'error_details': str(e)
            }
    
    def get_smart_recommendations(self, focus_area='general'):
        """ุงูุญุตูู ุนูู ุชูุตูุงุช ุฐููุฉ ูุชุญุณูู ุงูุฃุฏุงุก ุงููุงูู"""
        try:
            # ุฅุนุฏุงุฏ prompt ุญุณุจ ุงููุฌุงู ุงููุญุฏุฏ
            prompts = {
                'general': 'ูุฏู ุชูุตูุงุช ุนุงูุฉ ูุชุญุณูู ุงูุฃุฏุงุก ุงููุงูู ููุดุฑูุงุช ุงูุณุนูุฏูุฉ',
                'salaries': 'ุฑูุฒ ุนูู ุชุญุณูู ุฅุฏุงุฑุฉ ุงูุฑูุงุชุจ ูุงูุชูุงููู ุงูุจุดุฑูุฉ ูู ุงูุณูู ุงูุณุนูุฏู',
                'vehicles': 'ูุฏู ุชูุตูุงุช ูุชุญุณูู ุฅุฏุงุฑุฉ ุฃุณุทูู ุงููุฑูุจุงุช ูุชูููู ุงูุชูุงููู',
                'efficiency': 'ุฑูุฒ ุนูู ุชุญุณูู ุงูููุงุกุฉ ุงูุชุดุบูููุฉ ูุชูููู ุงููุฏุฑ'
            }
            
            prompt = prompts.get(focus_area, prompts['general'])
            
            response = self.client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {
                        "role": "system",
                        "content": "ุฃูุช ุฎุจูุฑ ุงุณุชุดุงุฑู ููุดุฑูุงุช ุงูุณุนูุฏูุฉ ูุชุฎุตุต ูู ุชุญุณูู ุงูุฃุฏุงุก ุงููุงูู."
                    },
                    {
                        "role": "user",
                        "content": f"{prompt}. ูุฏู 5 ุชูุตูุงุช ุนูููุฉ ูุงุจูุฉ ููุชุทุจูู ูุน ุฃูุซูุฉ ูุญุฏุฏุฉ."
                    }
                ],
                max_tokens=1000,
                temperature=0.4
            )
            
            recommendations = response.choices[0].message.content
            
            return {
                'success': True,
                'recommendations': recommendations,
                'focus_area': focus_area,
                'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }
            
        except Exception as e:
            current_app.logger.error(f"Error in AI recommendations: {e}")
            # ูุธุงู backup ูุญูู ููุชูุตูุงุช
            if "429" in str(e) or "quota" in str(e).lower():
                return self._generate_local_recommendations(focus_area)
            return {
                'success': False,
                'message': f'ุญุฏุซ ุฎุทุฃ ูู ุงูุญุตูู ุนูู ุงูุชูุตูุงุช: {str(e)}'
            }
    
    def analyze_expense_patterns(self, transactions_data):
        """ุชุญููู ุฃููุงุท ุงููุตุฑููุงุช ูุงูุชุดุงู ุงูุงุชุฌุงูุงุช"""
        try:
            prompt = f"""
            ูู ุจุชุญููู ุฃููุงุท ุงููุตุฑููุงุช ุงูุชุงููุฉ ููุดุฑูุฉ:
            {json.dumps(transactions_data, ensure_ascii=False, indent=2)}
            
            ุญูู ุงูููุงุท ุงูุชุงููุฉ:
            1. ุงูุงุชุฌุงูุงุช ูู ุงููุตุฑููุงุช
            2. ุงูููุงุท ุงููุทููุจ ุชุญุณูููุง
            3. ุชููุนุงุช ูุณุชูุจููุฉ
            4. ููุงุฑูุฉ ูุน ูุนุงููุฑ ุงูุตูุงุนุฉ
            """
            
            response = self.client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {
                        "role": "system",
                        "content": "ุฃูุช ูุญูู ูุงูู ูุชุฎุตุต ูู ุชุญููู ุฃููุงุท ุงููุตุฑููุงุช ููุดุฑูุงุช."
                    },
                    {
                        "role": "user",
                        "content": prompt
                    }
                ],
                max_tokens=1200,
                temperature=0.3
            )
            
            return {
                'success': True,
                'analysis': response.choices[0].message.content,
                'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            }
            
        except Exception as e:
            return {
                'success': False,
                'message': f'ุฎุทุฃ ูู ุชุญููู ุฃููุงุท ุงููุตุฑููุงุช: {str(e)}'
            }
    
    def _generate_local_analysis(self, financial_data):
        """ุชุญููู ูุญูู ุนูุฏูุง ูููู OpenAI ุบูุฑ ูุชุงุญ"""
        try:
            employees = financial_data.get('employees', {})
            vehicles = financial_data.get('vehicles', {})
            transactions = financial_data.get('transactions', {})
            
            total_employees = employees.get('total_count', 0)
            total_salaries = employees.get('total_salaries', 0)
            avg_salary = employees.get('average_salary', 0)
            vehicle_cost = vehicles.get('estimated_rental_cost', 0)
            
            analysis = f"""
## ุชุญููู ูุงูู ูุญูู ููุดุฑูุฉ

### ๐ ุงููุถุน ุงููุงูู ุงูุญุงูู:
- ุฅุฌูุงูู ุงูููุธููู: {total_employees} ููุธู
- ุฅุฌูุงูู ุงูุฑูุงุชุจ: {total_salaries:,.0f} ุฑูุงู ุณุนูุฏู
- ูุชูุณุท ุงูุฑุงุชุจ: {avg_salary:,.0f} ุฑูุงู ุณุนูุฏู
- ุชูููุฉ ุงูุณูุงุฑุงุช ุงูููุฏุฑุฉ: {vehicle_cost:,.0f} ุฑูุงู ุณุนูุฏู

### ๐ช ููุงุท ุงูููุฉ:
- ุญุฌู ูุงุฏุฑ ููุธููู ููุงุณุจ ({total_employees} ููุธู)
- ูุชูุณุท ุฑูุงุชุจ ูุนููู ูุชูุงุดู ูุน ุงูุณูู ุงูุณุนูุฏู
- ุฃุณุทูู ูุฑูุจุงุช ูุชููุน ูุฏุนู ุงูุนูููุงุช

### โ๏ธ ููุงุท ุงูุชุญุณูู:
- ูุฑุงูุจุฉ ูุณุจุฉ ุชูุงููู ุงูุฑูุงุชุจ ุฅูู ุงูุฅูุฑุงุฏุงุช
- ุชุญุณูู ููุงุกุฉ ุงุณุชุฎุฏุงู ุงูุณูุงุฑุงุช
- ุชุทููุฑ ูุธุงู ูุฑุงูุจุฉ ุงูุชูุงููู ุงูุชุดุบูููุฉ

### ๐ ุงูุชูุตูุงุช:
1. ุชุญููู ุฏูุฑู ููุฃุฏุงุก ุงููุงูู ูู ุดูุฑ
2. ูุฑุงุฌุนุฉ ูููู ุงูุฑูุงุชุจ ูุงูุญูุงูุฒ
3. ุชุญุณูู ูุธุงู ุฅุฏุงุฑุฉ ุฃุณุทูู ุงูุณูุงุฑุงุช
4. ุฅูุดุงุก ููุฒุงููุฉ ุณูููุฉ ููุตูุฉ
5. ุชุทุจูู ูุคุดุฑุงุช ุฃุฏุงุก ูุงููุฉ ูุงุถุญุฉ

### ๐ฏ ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูููุชุฑุญุฉ:
- ูุณุจุฉ ุชูููุฉ ุงูุฑูุงุชุจ ุฅูู ุงูุฅูุฑุงุฏุงุช
- ุชูููุฉ ุงูููุธู ุงููุงุญุฏ ุดูุฑููุง
- ูุนุฏู ุงุณุชุฎุฏุงู ุงูุณูุงุฑุงุช
- ูุณุจุฉ ุงูุชูุงููู ุงูุชุดุบูููุฉ

*ุชู ุฅูุดุงุก ูุฐุง ุงูุชุญููู ุจูุงุณุทุฉ ุงููุธุงู ุงููุญูู ุงููุชุทูุฑ*
            """
            
            return {
                'success': True,
                'analysis': analysis.strip(),
                'data_summary': financial_data,
                'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'source': 'Local Advanced Analysis System'
            }
            
        except Exception as e:
            return {
                'success': False,
                'message': f'ุฎุทุฃ ูู ุงูุชุญููู ุงููุญูู: {str(e)}'
            }
    
    def _generate_local_recommendations(self, focus_area):
        """ุชูุตูุงุช ูุญููุฉ ุญุณุจ ุงููุฌุงู ุงููุญุฏุฏ"""
        try:
            recommendations_db = {
                'general': """
### ๐ฏ ุชูุตูุงุช ุนุงูุฉ ูุชุญุณูู ุงูุฃุฏุงุก ุงููุงูู

#### 1. ุงูุชุฎุทูุท ุงููุงูู ุงูุงุณุชุฑุงุชูุฌู
- ูุถุน ุฎุทุฉ ูุงููุฉ ุณูููุฉ ุดุงููุฉ
- ุชุญุฏูุฏ ุฃูุฏุงู ูุงููุฉ ูุงุถุญุฉ ููุงุจูุฉ ููููุงุณ
- ูุฑุงุฌุนุฉ ุงูุฃุฏุงุก ุงููุงูู ุจุดูู ุดูุฑู

#### 2. ุฅุฏุงุฑุฉ ุงูุชุฏูู ุงูููุฏู
- ูุฑุงูุจุฉ ุงูุฏุฎู ูุงููุตุฑููุงุช ูููููุง
- ุฅูุดุงุก ุงุญุชูุงุทู ููุฏู ููุทูุงุฑุฆ
- ุชุญุณูู ุนูููุงุช ุงูุชุญุตูู ูู ุงูุนููุงุก

#### 3. ุชุญุณูู ุงูููุงุกุฉ ุงูุชุดุบูููุฉ
- ุฃุชูุชุฉ ุงูุนูููุงุช ุงููุงููุฉ ูุงููุญุงุณุจูุฉ
- ุชูููู ุงูุชูุงููู ุบูุฑ ุงูุถุฑูุฑูุฉ
- ุชุญุณูู ุงุณุชุฎุฏุงู ุงูููุงุฑุฏ ุงููุชุงุญุฉ

#### 4. ุงูุงูุชุซุงู ุงูุชูุธููู
- ุงูุชุฃูุฏ ูู ุงูุงูุชุซุงู ููุชุทูุจุงุช ุงูุฒูุงุฉ ูุงูุถุฑูุจุฉ
- ุชุทุจูู ูุนุงููุฑ ุงููุญุงุณุจุฉ ุงูุณุนูุฏูุฉ
- ูุฑุงุฌุนุฉ ุฏูุฑูุฉ ููุนูููุงุช ุงููุงููุฉ

#### 5. ุงูุงุณุชุซูุงุฑ ูู ุงูุชูููููุฌูุง
- ุชุญุฏูุซ ุฃูุธูุฉ ุฅุฏุงุฑุฉ ุงูููุงุฑุฏ ุงููุงููุฉ
- ุงุณุชุฎุฏุงู ุฃุฏูุงุช ุงูุชุญููู ุงููุงูู ุงููุชูุฏูุฉ
- ุชุฏุฑูุจ ุงูููุธููู ุนูู ุงูุฃูุธูุฉ ุงูุฌุฏูุฏุฉ
                """,
                'salaries': """
### ๐ฐ ุชูุตูุงุช ุชุญุณูู ุฅุฏุงุฑุฉ ุงูุฑูุงุชุจ

#### 1. ูููู ุงูุฑูุงุชุจ ูุงูุญูุงูุฒ
- ูุฑุงุฌุนุฉ ุณูู ุงูุฑูุงุชุจ ุจูุง ูุชูุงุดู ูุน ุงูุณูู
- ุฅูุดุงุก ูุธุงู ุญูุงูุฒ ูุฑุชุจุท ุจุงูุฃุฏุงุก
- ุชุทุจูู ูุธุงู ุนูุงูุงุช ุณูููุฉ ุนุงุฏูุฉ

#### 2. ุฅุฏุงุฑุฉ ุงูุชูุงููู ุงูุจุดุฑูุฉ
- ุชุญููู ูุณุจุฉ ุชูููุฉ ุงูุฑูุงุชุจ ุฅูู ุงูุฅูุฑุงุฏุงุช
- ุชุญุณูู ููุงุกุฉ ุชูุฒูุน ุงูููุงู
- ุชูููู ุงูุนูู ุงูุฅุถุงูู ุบูุฑ ุงูุถุฑูุฑู

#### 3. ุงูุงูุชุซุงู ูููุงููู ุงูุนูู
- ุงูุชุฃูุฏ ูู ุงูุงูุชุซุงู ููุงููู ุงูุนูู ุงูุณุนูุฏู
- ุญุณุงุจ ูุธุงู ุงูุชุฃูููุงุช ุงูุงุฌุชูุงุนูุฉ ุจุฏูุฉ
- ุฅุฏุงุฑุฉ ุงูููุงูุขุช ูุงูุงุณุชุญูุงูุงุช ููู ุงููุธุงู

#### 4. ุชุทููุฑ ุงูููุธููู
- ุจุฑุงูุฌ ุชุฏุฑูุจ ูุฒูุงุฏุฉ ุงูุฅูุชุงุฌูุฉ
- ุชุทููุฑ ุงููุณุงุฑุงุช ุงููุธูููุฉ
- ูุธุงู ุชูููู ุฃุฏุงุก ุดุงูู

#### 5. ุงูุชุฎุทูุท ููุฑูุงุชุจ
- ูุถุน ููุฒุงููุฉ ุณูููุฉ ููุฑูุงุชุจ
- ุชุญุฏูุฏ ุณูู ููุฒูุงุฏุงุช ุงูุณูููุฉ
- ูุฑุงูุจุฉ ุงูุชูุงููู ุงูุฅุถุงููุฉ
                """,
                'vehicles': """
### ๐ ุชูุตูุงุช ุชุญุณูู ุฅุฏุงุฑุฉ ุฃุณุทูู ุงูุณูุงุฑุงุช

#### 1. ุชุญุณูู ุงูุชูุงููู ุงูุชุดุบูููุฉ
- ูุฑุงูุจุฉ ุงุณุชููุงู ุงููููุฏ ุจุดูู ุฏูุฑู
- ุชุญุฏูุฏ ุฌุฏุงูู ุตูุงูุฉ ููุชุธูุฉ
- ุชูููู ุชูููุฉ ุงูุชุฃููู ูุงูุชุฌุฏูุฏ

#### 2. ููุงุกุฉ ุงูุงุณุชุฎุฏุงู
- ุชุชุจุน ุงุณุชุฎุฏุงู ูู ูุฑูุจุฉ
- ุชุญุณูู ุชูุฒูุน ุงูุณูุงุฑุงุช ุนูู ุงูููุงู
- ุชูููู ุงูุฑุญูุงุช ุงููุงุฑุบุฉ

#### 3. ุฅุฏุงุฑุฉ ุฏูุฑุฉ ุงูุญูุงุฉ
- ุชุญุฏูุฏ ุนูุฑ ุงูุชุฑุงุถู ููุณูุงุฑุงุช
- ุชูููู ุชูููุฉ ุงูุงุญุชูุงุธ ููุงุจู ุงูุงุณุชุจุฏุงู
- ุจูุน ุงูุณูุงุฑุงุช ูู ุงูุชูููุช ุงูููุงุณุจ

#### 4. ุงูุชูููููุฌูุง ูุงููุฑุงูุจุฉ
- ุชุฑููุจ ุฃูุธูุฉ ุชุชุจุน GPS
- ูุฑุงูุจุฉ ุฃุฏุงุก ุงูุณุงุฆููู
- ุชุทุจูู ุงูุตูุงูุฉ ุงูุฐููุฉ

#### 5. ุงูุณูุงูุฉ ูุงูุงูุชุซุงู
- ุจุฑุงูุฌ ุชุฏุฑูุจ ุงูุณุงุฆููู
- ูุญุต ุฏูุฑู ููุณูุงุฑุงุช
- ุงูุชุฃูุฏ ูู ุณุฑูุงู ุงูุชุฑุงุฎูุต ูุงูุชุฃููู
                """,
                'efficiency': """
### โก ุชูุตูุงุช ุชุญุณูู ุงูููุงุกุฉ ุงูุชุดุบูููุฉ

#### 1. ุฃุชูุชุฉ ุงูุนูููุงุช
- ุชุทุจูู ุฃูุธูุฉ ุฅุฏุงุฑุฉ ููุงุฑุฏ ุงููุคุณุณุฉ (ERP)
- ุฃุชูุชุฉ ุนูููุงุช ุงูููุงููุงุช ุงููุงููุฉ
- ุงุณุชุฎุฏุงู ุงูุชูููุน ุงูุฅููุชุฑููู

#### 2. ุชุญุณูู ุงูุนูููุงุช
- ุชุญููู ูุชุจุณูุท ุณูุฑ ุงูุนูู
- ุฅุฒุงูุฉ ุงูุฎุทูุงุช ุบูุฑ ุงูุถุฑูุฑูุฉ
- ุชุทุจูู ูููุฌูุฉ ุงูุนูู ุงูุฑุดูู

#### 3. ุฅุฏุงุฑุฉ ุงูููุช ูุงูููุงุฑุฏ
- ุชุญุณูู ุฌุฏููุฉ ุงูููุงู
- ุชูููู ุงูุงุฌุชูุงุนุงุช ุบูุฑ ุงูุถุฑูุฑูุฉ
- ุงุณุชุฎุฏุงู ุฃุฏูุงุช ุงูุชุนุงูู ุงูุฑููู

#### 4. ููุงุณ ุงูุฃุฏุงุก
- ูุถุน ูุคุดุฑุงุช ุฃุฏุงุก ูุงุถุญุฉ
- ูุฑุงูุจุฉ ุงูุฅูุชุงุฌูุฉ ุจุดูู ุฏูุฑู
- ุชุทุจูู ูุธุงู ุชุญุณูู ูุณุชูุฑ

#### 5. ุชุทููุฑ ุงููุฏุฑุงุช
- ุชุฏุฑูุจ ุงูููุธููู ุนูู ุงูุชูููุงุช ุงูุฌุฏูุฏุฉ
- ุชุทููุฑ ููุงุฑุงุช ุงูููุงุฏุฉ
- ููู ุงููุนุฑูุฉ ุจูู ุงูุฃูุณุงู
                """
            }
            
            recommendation = recommendations_db.get(focus_area, recommendations_db['general'])
            
            return {
                'success': True,
                'recommendations': recommendation.strip(),
                'focus_area': focus_area,
                'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'source': 'Local Expert Recommendations System'
            }
            
        except Exception as e:
            return {
                'success': False,
                'message': f'ุฎุทุฃ ูู ุงูุชูุตูุงุช ุงููุญููุฉ: {str(e)}'
            }