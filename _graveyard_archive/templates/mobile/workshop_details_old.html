{% extends "mobile/layout.html" %}

{% block title %}ØªÙØ§ØµÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„ÙˆØ±Ø´Ø© - {{ vehicle.plate_number }}{% endblock %}

{% block content %}
<div class="container-fluid px-2" style="padding-top: 70px !important; padding-bottom: 120px !important;">
    <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø³Ù† -->
    <div class="workshop-header">
        <div class="header-gradient">
            <div class="d-flex align-items-center justify-content-between">
                <div class="header-content">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-tools me-2 text-warning"></i>
                        <h5 class="mb-0 text-white">ØªÙØ§ØµÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„ÙˆØ±Ø´Ø©</h5>
                    </div>
                    <div class="vehicle-info">
                        <span class="badge bg-light text-dark me-2">
                            <i class="fas fa-car me-1"></i>
                            {{ vehicle.plate_number }}
                        </span>
                        <span class="text-white-50">{{ vehicle.make }} {{ vehicle.model }}</span>
                    </div>
                </div>
                <a href="{{ url_for('mobile.vehicle_details', vehicle_id=vehicle.id) }}" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø­Ø³Ù†Ø© -->
    <div class="workshop-info-grid">
        <!-- ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ© -->
        <div class="info-card">
            <div class="info-header">
                <i class="fas fa-calendar-alt"></i>
                <span>ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</span>
            </div>
            <div class="info-content">
                <div class="date-item">
                    <div class="date-label">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆØ±Ø´Ø©</div>
                    <div class="date-value">{{ workshop_record.entry_date.strftime('%Y-%m-%d') if workshop_record.entry_date else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                </div>
                <div class="date-item">
                    <div class="date-label">Ø®Ø±ÙˆØ¬ Ø§Ù„ÙˆØ±Ø´Ø©</div>
                    <div class="date-value">
                        {% if workshop_record.exit_date %}
                        {{ workshop_record.exit_date.strftime('%Y-%m-%d') }}
                        {% else %}
                        <span class="status-badge in-progress">Ù„Ø§ ÙŠØ²Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆØ±Ø´Ø©</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© -->
        <div class="info-card">
            <div class="info-header">
                <i class="fas fa-cog"></i>
                <span>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</span>
            </div>
            <div class="info-content">
                <div class="status-item">
                    <div class="status-label">Ø§Ù„Ø³Ø¨Ø¨</div>
                    <div class="status-value">
                        {% if workshop_record.reason == 'maintenance' %}
                        <span class="status-badge maintenance">ØµÙŠØ§Ù†Ø© Ø¯ÙˆØ±ÙŠØ©</span>
                        {% elif workshop_record.reason == 'breakdown' %}
                        <span class="status-badge breakdown">Ø¹Ø·Ù„</span>
                        {% elif workshop_record.reason == 'accident' %}
                        <span class="status-badge accident">Ø­Ø§Ø¯Ø«</span>
                        {% else %}
                        <span class="status-badge other">{{ workshop_record.reason }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­</div>
                    <div class="status-value">
                        {% if workshop_record.repair_status == 'in_progress' %}
                        <span class="status-badge in-progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</span>
                        {% elif workshop_record.repair_status == 'completed' %}
                        <span class="status-badge completed">ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­</span>
                        {% elif workshop_record.repair_status == 'pending_approval' %}
                        <span class="status-badge pending">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ workshop_record.repair_status }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {% if workshop_record.cost and workshop_record.cost > 0 %}
            <div class="info-item mb-3">
                <label class="text-muted small">ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥ØµÙ„Ø§Ø­</label>
                <div class="fw-bold text-success h5">{{ '{:,.2f}'.format(workshop_record.cost) }} Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0">
                <i class="fas fa-clipboard-list ms-2"></i>
                ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©
            </h6>
        </div>
        <div class="card-body">
            <p class="mb-0">{{ workshop_record.description if workshop_record.description else 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ' }}</p>
        </div>
    </div>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ±Ø´Ø© ÙˆØ§Ù„ÙÙ†ÙŠ -->
    <div class="card mb-3">
        <div class="card-header bg-warning text-dark">
            <h6 class="mb-0">
                <i class="fas fa-wrench ms-2"></i>
                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ±Ø´Ø©
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item mb-3">
                        <label class="text-muted small">Ø§Ø³Ù… Ø§Ù„ÙˆØ±Ø´Ø©</label>
                        <div class="fw-bold">{{ workshop_record.workshop_name if workshop_record.workshop_name else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item mb-3">
                        <label class="text-muted small">Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
                        <div class="fw-bold">{{ workshop_record.technician_name if workshop_record.technician_name else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                    </div>
                </div>
            </div>
            
            {% if workshop_record.workshop_phone %}
            <div class="info-item mb-3">
                <label class="text-muted small">Ù‡Ø§ØªÙ Ø§Ù„ÙˆØ±Ø´Ø©</label>
                <div class="fw-bold">
                    <a href="tel:{{ workshop_record.workshop_phone }}" class="text-decoration-none">
                        <i class="fas fa-phone text-success"></i> {{ workshop_record.workshop_phone }}
                    </a>
                </div>
            </div>
            {% endif %}
            
            {% if workshop_record.workshop_address %}
            <div class="info-item mb-3">
                <label class="text-muted small">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ø´Ø©</label>
                <div>{{ workshop_record.workshop_address }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ±Ø´Ø© -->
    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <h6 class="mb-0">
                <i class="fas fa-hand-holding ms-2"></i>
                ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ±Ø´Ø©
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item mb-3">
                        <label class="text-muted small">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
                        <div class="fw-bold">{{ workshop_record.delivery_date.strftime('%Y-%m-%d') if workshop_record.delivery_date else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item mb-3">
                        <label class="text-muted small">Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø³Ù„Ù…</label>
                        <div class="fw-bold">{{ workshop_record.delivered_by if workshop_record.delivered_by else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                    </div>
                </div>
            </div>
            
            {% if workshop_record.delivery_notes %}
            <div class="info-item mb-3">
                <label class="text-muted small">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
                <div>{{ workshop_record.delivery_notes }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ø´Ø© -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0">
                <i class="fas fa-hand-receiving ms-2"></i>
                Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ø´Ø©
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item mb-3">
                        <label class="text-muted small">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</label>
                        <div class="fw-bold">{{ workshop_record.pickup_date.strftime('%Y-%m-%d') if workshop_record.pickup_date else 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ø¹Ø¯' }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item mb-3">
                        <label class="text-muted small">Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
                        <div class="fw-bold">{{ workshop_record.received_by if workshop_record.received_by else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                    </div>
                </div>
            </div>
            
            {% if workshop_record.pickup_notes %}
            <div class="info-item mb-3">
                <label class="text-muted small">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</label>
                <div>{{ workshop_record.pickup_notes }}</div>
            </div>
            {% endif %}
        </div>
    </div>
    {% if workshop_record.workshop_name or workshop_record.technician_name %}
    <div class="card mb-3">
        <div class="card-header bg-secondary text-white">
            <h6 class="mb-0">
                <i class="fas fa-tools ms-2"></i>
                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ±Ø´Ø© ÙˆØ§Ù„ÙÙ†ÙŠ
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                {% if workshop_record.workshop_name %}
                <div class="col-md-6">
                    <div class="info-item mb-3">
                        <label class="text-muted small">Ø§Ø³Ù… Ø§Ù„ÙˆØ±Ø´Ø©</label>
                        <div class="fw-bold">{{ workshop_record.workshop_name }}</div>
                    </div>
                </div>
                {% endif %}
                {% if workshop_record.technician_name %}
                <div class="col-md-6">
                    <div class="info-item mb-3">
                        <label class="text-muted small">Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
                        <div class="fw-bold">{{ workshop_record.technician_name }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Ø§Ù„Ø±ÙˆØ§Ø¨Ø· -->
    {% if workshop_record.delivery_link or workshop_record.reception_link %}
    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <h6 class="mb-0">
                <i class="fas fa-link ms-2"></i>
                Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ù†Ù…Ø§Ø°Ø¬
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                {% if workshop_record.delivery_link %}
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Ø±Ø§Ø¨Ø· ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ±Ø´Ø©</label>
                    <div>
                        <a href="{{ workshop_record.delivery_link }}" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt ms-1"></i>
                            ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ³Ù„ÙŠÙ…
                        </a>
                    </div>
                </div>
                {% endif %}
                {% if workshop_record.reception_link %}
                <div class="col-md-6 mb-3">
                    <label class="text-muted small">Ø±Ø§Ø¨Ø· Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„ÙˆØ±Ø´Ø©</label>
                    <div>
                        <a href="{{ workshop_record.reception_link }}" target="_blank" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-external-link-alt ms-1"></i>
                            ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
    {% if workshop_record.notes %}
    <div class="card mb-3">
        <div class="card-header bg-warning text-dark">
            <h6 class="mb-0">
                <i class="fas fa-sticky-note ms-2"></i>
                Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
            </h6>
        </div>
        <div class="card-body">
            <p class="mb-0">{{ workshop_record.notes }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙ‚Ø© - ØªØµÙ…ÙŠÙ… Ù…Ø­Ø³Ù† -->
    {% if workshop_record.images %}
    <div class="images-section">
        <div class="section-header">
            <i class="fas fa-camera"></i>
            <span>Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ÙˆØ«Ù‚Ø© ({{ workshop_record.images|length }})</span>
        </div>
        
        <!-- ÙØµÙ„ Ø§Ù„ØµÙˆØ± Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ -->
        {% set before_images = workshop_record.images|selectattr("image_type", "equalto", "before")|list %}
        {% set after_images = workshop_record.images|selectattr("image_type", "equalto", "after")|list %}
        
        {% if before_images %}
        <div class="image-category">
            <div class="category-title before">
                <i class="fas fa-exclamation-triangle"></i>
                <span>ØµÙˆØ± Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ({{ before_images|length }})</span>
            </div>
            <div class="images-grid">
                {% for image in before_images %}
                <div class="image-item">
                    <div class="image-container">
                        <img src="/static/{{ image.image_path }}" 
                             alt="ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­" 
                             onclick="showImageModal('/static/{{ image.image_path }}', '{{ image.notes or 'ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­' }}')">
                        <div class="image-overlay">
                            <i class="fas fa-search-plus"></i>
                        </div>
                    </div>
                    {% if image.notes %}
                    <div class="image-notes">{{ image.notes }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if after_images %}
        <div class="image-category">
            <div class="category-title after">
                <i class="fas fa-check-circle"></i>
                <span>ØµÙˆØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ({{ after_images|length }})</span>
            </div>
            <div class="images-grid">
                {% for image in after_images %}
                <div class="image-item">
                    <div class="image-container">
                        <img src="/static/{{ image.image_path }}" 
                             alt="ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­" 
                             onclick="showImageModal('/static/{{ image.image_path }}', '{{ image.notes or 'ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­' }}')">
                        <div class="image-overlay">
                            <i class="fas fa-search-plus"></i>
                        </div>
                    </div>
                    {% if image.notes %}
                    <div class="image-notes">{{ image.notes }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="no-images">
        <i class="fas fa-image"></i>
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…Ø±ÙÙ‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„</p>
    </div>
    {% endif %}

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
    <div class="card mb-3">
        <div class="card-header bg-light">
            <h6 class="mb-0 text-muted">
                <i class="fas fa-clock ms-2"></i>
                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <small class="text-muted">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</small>
                    <div class="small">{{ workshop_record.created_at.strftime('%Y-%m-%d %H:%M') if workshop_record.created_at else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                </div>
                <div class="col-md-6">
                    <small class="text-muted">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</small>
                    <div class="small">{{ workshop_record.updated_at.strftime('%Y-%m-%d %H:%M') if workshop_record.updated_at else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
    <div class="action-buttons-container">
        <div class="row gx-2 mb-3">
            <div class="col-6">
                <a href="{{ url_for('mobile.edit_workshop_record', workshop_id=workshop_record.id) }}" class="btn btn-primary w-100">
                    <i class="fas fa-edit ms-1"></i>
                    ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„
                </a>
            </div>
            <div class="col-6">
                <button type="button" class="btn btn-success w-100" onclick="shareWorkshopDetails()">
                    <i class="fas fa-share-alt ms-1"></i>
                    Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„
                </button>
            </div>
        </div>
        <div class="row gx-2">
            <div class="col-12">
                <a href="{{ url_for('mobile.vehicle_details', vehicle_id=vehicle.id) }}" class="btn btn-secondary w-100">
                    <i class="fas fa-arrow-right ms-1"></i>
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø³ÙŠØ§Ø±Ø©
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalTitle">ØµÙˆØ±Ø© Ø§Ù„ÙˆØ±Ø´Ø©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="ØµÙˆØ±Ø© Ø§Ù„ÙˆØ±Ø´Ø©">
            </div>
        </div>
    </div>
</div>

<style>
.page-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
}

.card {
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 10px;
    margin-bottom: 15px;
}

.card-header {
    border-radius: 10px 10px 0 0;
    font-weight: 600;
}

.info-item label {
    font-size: 0.85rem;
    margin-bottom: 4px;
    display: block;
}

.image-card img {
    cursor: pointer;
    transition: transform 0.2s;
    border-radius: 8px;
    height: 120px;
    width: 100%;
    object-fit: cover;
}

.image-card img:hover {
    transform: scale(1.05);
}

.btn {
    border-radius: 8px;
    font-weight: 500;
}

.action-buttons-container {
    margin-top: 20px;
}

.badge {
    font-size: 0.8rem;
}
</style>

<script>
function showImageModal(imageSrc, title) {
    document.getElementById('modalImage').src = imageSrc;
    document.getElementById('imageModalTitle').textContent = title;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

function shareWorkshopDetails() {
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Øµ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
    const workshopData = {
        vehicle: "{{ vehicle.plate_number }} - {{ vehicle.make }} {{ vehicle.model }}",
        entryDate: "{{ workshop_record.entry_date.strftime('%Y-%m-%d') if workshop_record.entry_date else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}",
        exitDate: "{% if workshop_record.exit_date %}{{ workshop_record.exit_date.strftime('%Y-%m-%d') }}{% else %}Ù„Ø§ ÙŠØ²Ø§Ù„ ÙÙŠ Ø§Ù„ÙˆØ±Ø´Ø©{% endif %}",
        reason: "{% if workshop_record.reason == 'maintenance' %}ØµÙŠØ§Ù†Ø© Ø¯ÙˆØ±ÙŠØ©{% elif workshop_record.reason == 'breakdown' %}Ø¹Ø·Ù„{% elif workshop_record.reason == 'accident' %}Ø­Ø§Ø¯Ø«{% else %}{{ workshop_record.reason }}{% endif %}",
        status: "{% if workshop_record.repair_status == 'in_progress' %}Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°{% elif workshop_record.repair_status == 'completed' %}ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­{% elif workshop_record.repair_status == 'pending_approval' %}Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©{% else %}{{ workshop_record.repair_status }}{% endif %}",
        description: "{{ workshop_record.description or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ' }}",
        workshopName: "{{ workshop_record.workshop_name or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}",
        technicianName: "{{ workshop_record.technician_name or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}",
        cost: "{% if workshop_record.cost and workshop_record.cost > 0 %}{{ '{:,.2f}'.format(workshop_record.cost) }} Ø±ÙŠØ§Ù„{% else %}ØºÙŠØ± Ù…Ø­Ø¯Ø¯{% endif %}",
        deliveryLink: "{{ workshop_record.delivery_link or '' }}",
        receptionLink: "{{ workshop_record.reception_link or '' }}",
        notes: "{{ workshop_record.notes or 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª' }}",
        detailsUrl: window.location.href,
        imagesCount: {{ workshop_record.images|length if workshop_record.images else 0 }},
        beforeImages: [
            {% for image in workshop_record.images %}
            {% if image.image_type == 'before' or 'before' in (image.image_path or '') %}
            {
                url: "{{ request.url_root }}static/{{ image.image_path }}",
                notes: "{{ image.notes or 'ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­' }}",
                type: "before"
            },
            {% endif %}
            {% endfor %}
        ],
        afterImages: [
            {% for image in workshop_record.images %}
            {% if image.image_type == 'after' or 'after' in (image.image_path or '') %}
            {
                url: "{{ request.url_root }}static/{{ image.image_path }}",
                notes: "{{ image.notes or 'ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­' }}",
                type: "after"
            },
            {% endif %}
            {% endfor %}
        ]
    };
    
    // ØªÙƒÙˆÙŠÙ† Ø§Ù„Ù†Øµ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© - ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯ÙŠ
    const currentDate = new Date();
    const formattedDateTime = currentDate.toLocaleDateString('ar-SA') + ' ' + currentDate.toLocaleTimeString('ar-SA', { hour12: false });
    
    let shareText = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹\n\n`;
    shareText += `Ø¥Ù„ÙŠÙƒ ØªÙØ§ØµÙŠÙ„ ØªØ³Ù„ÙŠÙ…/Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ø´Ø© Ù„Ù„Ø³ÙŠØ§Ø±Ø©:\n\n`;
    shareText += `ğŸš™ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${workshopData.vehicle}\n`;
    shareText += `ğŸ“… ØªØ§Ø±ÙŠØ® ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${formattedDateTime}\n\n`;
    shareText += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
    shareText += `ğŸ”§ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:\n`;
    shareText += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
    
    shareText += `ğŸ“… ØªØ§Ø±ÙŠØ® Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆØ±Ø´Ø©: ${workshopData.entryDate}\n`;
    shareText += `ğŸ“… ØªØ§Ø±ÙŠØ® Ø®Ø±ÙˆØ¬ Ø§Ù„ÙˆØ±Ø´Ø©: ${workshopData.exitDate}\n`;
    shareText += `ğŸ› ï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ${workshopData.status}\n`;
    shareText += `ğŸ“ Ø³Ø¨Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${workshopData.reason}\n\n`;
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ±Ø´Ø©
    shareText += `ğŸšš ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ±Ø´Ø©:\n`;
    shareText += `â€¢ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…: {{ workshop_record.delivery_date.strftime('%Y-%m-%d') if workshop_record.delivery_date else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}\n`;
    shareText += `â€¢ Ø§Ù„Ù…ÙØ³Ù„Ù…: {{ workshop_record.delivered_by if workshop_record.delivered_by else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}\n`;
    {% if workshop_record.delivery_notes %}
    shareText += `â€¢ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…: {{ workshop_record.delivery_notes }}\n`;
    {% endif %}
    shareText += `\n`;
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆØ±Ø´Ø©
    shareText += `ğŸ“¦ Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„ÙˆØ±Ø´Ø©:\n`;
    shareText += `â€¢ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: {{ workshop_record.pickup_date.strftime('%Y-%m-%d') if workshop_record.pickup_date else 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ø¹Ø¯' }}\n`;
    shareText += `â€¢ Ø§Ù„Ù…ÙØ³ØªÙ„Ù…: {{ workshop_record.received_by if workshop_record.received_by else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}\n`;
    {% if workshop_record.pickup_notes %}
    shareText += `â€¢ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: {{ workshop_record.pickup_notes }}\n`;
    {% endif %}
    shareText += `\n`;
    
    shareText += `ğŸ“– ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø¹Ù…Ù„ÙŠØ©:\n`;
    shareText += `${workshopData.description}\n\n`;
    
    if (workshopData.workshopName !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' || workshopData.technicianName !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' || workshopData.cost !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
        shareText += `ğŸª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ±Ø´Ø©:\n`;
        if (workshopData.workshopName !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
            shareText += `â€¢ Ø§Ø³Ù… Ø§Ù„ÙˆØ±Ø´Ø©: ${workshopData.workshopName}\n`;
        }
        if (workshopData.technicianName !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
            shareText += `â€¢ Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: ${workshopData.technicianName}\n`;
        }
        if (workshopData.cost !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
            shareText += `â€¢ Ø§Ù„ØªÙƒÙ„ÙØ©: ${workshopData.cost}\n`;
        }
        shareText += `\n`;
    }
    
    // Ù‚Ø³Ù… Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙˆØ§Ù„ÙˆØ«Ø§Ø¦Ù‚ - ÙÙ‚Ø· Ø±Ø§Ø¨Ø· ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ±Ø´Ø©
    if (workshopData.deliveryLink || workshopData.receptionLink) {
        if (workshopData.deliveryLink && workshopData.receptionLink) {
            shareText += `ğŸ“ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù†Ù…Ø§Ø°Ø¬:\n`;
            shareText += `â€¢ Ø±Ø§Ø¨Ø· ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ±Ø´Ø©: ${workshopData.deliveryLink}\n`;
            shareText += `â€¢ Ø±Ø§Ø¨Ø· Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„ÙˆØ±Ø´Ø©: ${workshopData.receptionLink}\n\n`;
        } else if (workshopData.deliveryLink) {
            shareText += `ğŸ“ Ø±Ø§Ø¨Ø· Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ±Ø´Ø©:\n${workshopData.deliveryLink}\n\n`;
        } else if (workshopData.receptionLink) {
            shareText += `ğŸ“ Ø±Ø§Ø¨Ø· Ù†Ù…ÙˆØ°Ø¬ Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„ÙˆØ±Ø´Ø©:\n${workshopData.receptionLink}\n\n`;
        }
    }
    
    // Ù‚Ø³Ù… Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙ‚Ø©
    if (workshopData.beforeImages.length > 0 || workshopData.afterImages.length > 0) {
        shareText += `ğŸ“¸ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙ‚Ø© Ù…Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:\n`;
        shareText += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
        
        if (workshopData.beforeImages.length > 0) {
            shareText += `ğŸ”´ ØµÙˆØ± Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ${workshopData.beforeImages.length} ØµÙˆØ±Ø©\n`;
            workshopData.beforeImages.forEach((image, index) => {
                if (image.notes && image.notes !== 'ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­') {
                    shareText += `   ${index + 1}. ${image.notes}\n`;
                }
            });
            shareText += `\n`;
        }
        
        if (workshopData.afterImages.length > 0) {
            shareText += `ğŸŸ¢ ØµÙˆØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ${workshopData.afterImages.length} ØµÙˆØ±Ø©\n`;
            workshopData.afterImages.forEach((image, index) => {
                if (image.notes && image.notes !== 'ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­') {
                    shareText += `   ${index + 1}. ${image.notes}\n`;
                }
            });
            shareText += `\n`;
        }
        
        shareText += `ğŸ“ Ø§Ù„ØµÙˆØ± Ù…Ø±ÙÙ‚Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©\n\n`;
    }
    
    if (workshopData.notes !== 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª') {
        shareText += `ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:\n${workshopData.notes}\n\n`;
    }
    
    shareText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    shareText += `ğŸ“± Ù†Ø¸Ø§Ù… Ù†ÙØ¸Ù… Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª\n`;
    shareText += `ğŸ• ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${formattedDateTime}`;
    
    // Ø¬Ù…Ø¹ Ø§Ù„ØµÙˆØ± ÙƒÙ…Ù„ÙØ§Øª Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
    const allImages = [...workshopData.beforeImages, ...workshopData.afterImages];
    
    if (allImages.length > 0) {
        console.log('Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Canvas...');
        
        // Ø·Ø±ÙŠÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø§Ø³ØªØ®Ø¯Ø§Ù… Canvas Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø¥Ù„Ù‰ Ù…Ù„ÙØ§Øª
        const createFileFromImage = async (image, index) => {
            return new Promise((resolve) => {
                try {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± img Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = function() {
                        try {
                            // Ø¥Ù†Ø´Ø§Ø¡ Canvas
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // ØªØ­Ø¯ÙŠØ¯ Ø£Ø¨Ø¹Ø§Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø©
                            const maxSize = 1200;
                            let { width, height } = img;
                            
                            if (width > height) {
                                if (width > maxSize) {
                                    height = (height * maxSize) / width;
                                    width = maxSize;
                                }
                            } else {
                                if (height > maxSize) {
                                    width = (width * maxSize) / height;
                                    height = maxSize;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø©
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Blob
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ Ø§Ù„Ù…Ø³Ø§Ø±
                                    let imageType = 'workshop_image';
                                    if (image.notes) {
                                        if (image.notes.includes('Ù‚Ø¨Ù„') || image.notes.includes('before')) {
                                            imageType = 'before_repair';
                                        } else if (image.notes.includes('Ø¨Ø¹Ø¯') || image.notes.includes('after')) {
                                            imageType = 'after_repair';
                                        }
                                    } else if (image.image_path) {
                                        if (image.image_path.includes('before')) {
                                            imageType = 'before_repair';
                                        } else if (image.image_path.includes('after')) {
                                            imageType = 'after_repair';
                                        }
                                    }
                                    
                                    const vehicleNum = '{{ vehicle.plate_number }}'.replace(/[^a-zA-Z0-9]/g, '');
                                    const timestamp = Date.now() + index;
                                    const fileName = `workshop_${vehicleNum}_${imageType}_${timestamp}.jpg`;
                                    
                                    const file = new File([blob], fileName, { type: 'image/jpeg' });
                                    console.log(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù: ${fileName} (${blob.size} bytes)`);
                                    resolve(file);
                                } else {
                                    console.error('ÙØ´Ù„ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Canvas Ø¥Ù„Ù‰ Blob');
                                    resolve(null);
                                }
                            }, 'image/jpeg', 0.9);
                            
                        } catch (canvasError) {
                            console.error('Ø®Ø·Ø£ ÙÙŠ Canvas:', canvasError);
                            resolve(null);
                        }
                    };
                    
                    img.onerror = function() {
                        console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©:', image.url);
                        resolve(null);
                    };
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØ±Ø©
                    let imageUrl = image.url;
                    if (!imageUrl.startsWith('http')) {
                        imageUrl = window.location.origin + '/' + imageUrl.replace(/^\/+/, '');
                    }
                    
                    img.src = imageUrl;
                    
                } catch (error) {
                    console.error('Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©:', error);
                    resolve(null);
                }
            });
        };
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±
        Promise.all(allImages.map(createFileFromImage)).then(files => {
            const validFiles = files.filter(file => file !== null);
            
            // Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ
            console.log('Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± Ø§Ù„ØµØ§Ù„Ø­Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©:', validFiles.length);
            validFiles.forEach((file, i) => {
                console.log(`Ø§Ù„Ù…Ù„Ù ${i + 1}:`, file.name, file.type, file.size, 'bytes');
            });
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
            if (navigator.share) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„ÙØ§Øª
                if (validFiles.length > 0 && navigator.canShare && navigator.canShare({ files: validFiles })) {
                    console.log('Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„ÙØ§ØªØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©...');
                    navigator.share({
                        title: `Ø³Ø¬Ù„ ÙˆØ±Ø´Ø© - ${workshopData.vehicle}`,
                        text: shareText,
                        files: validFiles
                    }).then(() => {
                        console.log('ØªÙ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„ØµÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
                        showShareSuccess('ØªÙ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…Ø¹ Ø§Ù„ØµÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!');
                    }).catch((error) => {
                        console.error('ÙØ´Ù„Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø¹ Ø§Ù„ØµÙˆØ±:', error);
                        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙˆÙ† ØµÙˆØ±
                        shareWithoutImages(shareText);
                    });
                } else {
                    console.log('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„ÙØ§ØªØŒ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†Øµ ÙÙ‚Ø·...');
                    shareWithoutImages(shareText);
                }
            } else {
                // Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„ÙØ§Øª
                shareWithoutImages(shareText);
            }
        }).catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±:', error);
            shareWithoutImages(shareText);
        });
    } else {
        // Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±ØŒ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†Øµ ÙÙ‚Ø·
        shareWithoutImages(shareText);
    }
}

function shareWithoutImages(shareText) {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Share API Ù„Ù„Ù†Øµ ÙÙ‚Ø·
    if (navigator.share) {
        navigator.share({
            title: 'Ø³Ø¬Ù„ ÙˆØ±Ø´Ø©',
            text: shareText
        }).then(() => {
            console.log('ØªÙ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            showShareSuccess('ØªÙ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
        }).catch((error) => {
            console.log('ÙØ´Ù„Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:', error);
            fallbackShare(shareText);
        });
    } else {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©
        fallbackShare(shareText);
    }
}

function fallbackShare(text) {
    // Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            showShareSuccess('ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø£ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©.');
        }).catch(() => {
            showShareFallback(text);
        });
    } else {
        showShareFallback(text);
    }
}

function showShareSuccess(message) {
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
    const toast = document.createElement('div');
    toast.className = 'toast-container position-fixed top-0 end-0 p-3';
    toast.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle ms-2"></i>
                <strong class="me-auto">Ù†Ø¬Ø­!</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    document.body.appendChild(toast);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        if (toast.parentNode) {
            document.body.removeChild(toast);
        }
    }, 5000);
}

function showShareFallback(text) {
    // Ø¥Ù†Ø´Ø§Ø¡ modal Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ù…Ø´Ø§Ø±ÙƒØ© ØªÙØ§ØµÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„ÙˆØ±Ø´Ø©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø£Ø¯Ù†Ø§Ù‡ ÙˆØ´Ø§Ø±ÙƒÙ‡ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</p>
                    <textarea class="form-control" rows="15" readonly style="font-family: monospace; direction: rtl;">${text}</textarea>
                    <div class="mt-3">
                        <small class="text-info">
                            <i class="fas fa-info-circle ms-1"></i>
                            Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ØªØ­ØªØ§Ø¬ Ù„Ø¥Ø±ÙØ§Ù‚ Ø§Ù„ØµÙˆØ± ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="copyToClipboard('${text.replace(/'/g, "\\'")}')">
                        <i class="fas fa-copy ms-1"></i>
                        Ù†Ø³Ø® Ø§Ù„Ù†Øµ
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Ø¥Ø²Ø§Ù„Ø© Modal Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

function copyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showShareSuccess('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¨Ù†Ø¬Ø§Ø­!');
}

function showShareSuccess(message) {
    // Ø¥Ù†Ø´Ø§Ø¡ toast notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle ms-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Ø¥Ø¶Ø§ÙØ© styles Ù„Ù„toast
    if (!document.getElementById('toast-styles')) {
        const styles = document.createElement('style');
        styles.id = 'toast-styles';
        styles.textContent = `
            .toast-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                max-width: 350px;
            }
        `;
        document.head.appendChild(styles);
    }
    
    document.body.appendChild(toast);
    
    // Ø¥Ø²Ø§Ù„Ø© Toast Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        if (toast.parentNode) {
            document.body.removeChild(toast);
        }
    }, 5000);
}
</script>
{% endblock %}