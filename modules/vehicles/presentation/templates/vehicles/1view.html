{% extends 'layout.html' %}

{% block title %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: {{ vehicle.plate_number }}{% endblock %}

{% block content %}
<!-- ============================ CSS Ù„Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ============================ -->
<style>
    :root {
        --primary-color: #0d6efd;
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --sidebar-bg: #ffffff;
        --sidebar-width: 280px;
        --border-radius: .375rem; /* Bootstrap's default border radius */
        --shadow: 0 0.5rem 1rem rgba(0, 0, 0, .15);
        --font-family-cairo: 'Cairo', sans-serif;
    }

    body {
        font-family: var(--font-family-cairo) !important;
        background-color: var(--light-color);
    }

    .page-wrapper {
        display: flex;
        padding-top: 1rem;
    }

    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
    .sidebar {
        width: var(--sidebar-width);
        flex-shrink: 0; /* Prevents sidebar from shrinking */
        background-color: var(--sidebar-bg);
        border-left: 1px solid #dee2e6;
        height: calc(100vh - 80px); /* Adjust based on your header's height if you have one in layout.html */
        position: sticky;
        top: 20px;
        transition: transform 0.3s ease-in-out;
        margin-right: 1.5rem; /* Space between sidebar and top-header */
        border-radius: var(--border-radius);
        box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
    }

    .sidebar-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #e9ecef;
    }

    .sidebar-header h5 {
        margin: 0;
        font-weight: 700;
        color: var(--dark-color);
    }
    .sidebar-nav {
        overflow-y: auto;
        max-height: calc(100% - 70px);
    }

    .sidebar-nav ul {
        list-style: none;
        padding: 0;
        margin: 0.5rem 0;
    }

    .sidebar-nav li a {
        display: block;
        padding: 0.75rem 1.25rem;
        color: #495057;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.95rem;
        border-right: 4px solid transparent;
        transition: all 0.2s ease;
    }

    .sidebar-nav li a i {
        margin-left: 10px;
        width: 20px; /* To align text */
        text-align: center;
        color: #6c757d;
        transition: color 0.2s ease;
    }

    .sidebar-nav li a:hover,
    .sidebar-nav li a:hover i {
        background-color: #f1f3f5;
        color: var(--primary-color);
    }

    .sidebar-nav li a.active {
        background-color: #e9ecef;
        color: var(--primary-color);
        border-right-color: var(--primary-color);
    }

    .sidebar-nav li a.active i {
        color: var(--primary-color);
    }

    /* ØªØµÙ…ÙŠÙ… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
    .content-area {
        flex-grow: 1; /* Makes content take remaining space */
        min-width: 0; /* Prevents flex items from overflowing */
    }

    .main-content {
        padding-bottom: 2rem; /* Space at the bottom */
    }

    .content-section {
        display: none;
        animation: fadeIn 0.4s ease-in-out;
    }
    .content-section.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ */
    .top-header-controls {
        background-color: #fff;
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
    }

    /* ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ */
    @media (max-width: 992px) {
        .page-wrapper {
            flex-direction: column;
        }
        .sidebar {
            position: static;
            width: 100%;
            height: auto;
            margin-right: 0;
            margin-bottom: 1.5rem;
            border-left: none;
            border-bottom: 1px solid #dee2e6;
        }
        .sidebar-nav {
            max-height: 250px;
        }
    }

</style>

<div class="container-fluid">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙŠØ¨Ù‚Ù‰ Ø¸Ø§Ù‡Ø±Ù‹Ø§ Ø¯Ø§Ø¦Ù…Ù‹Ø§ -->
    <div class="top-header-controls d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2 class="mb-0 h4">
            <i class="fas fa-car ms-2"></i>
            ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: {{ vehicle.plate_number }}
        </h2>
        <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('vehicles.edit', id=vehicle.id) }}" class="btn btn-warning btn-sm">
                <i class="fas fa-edit ms-1"></i> ØªØ¹Ø¯ÙŠÙ„
            </a>
            <a href="{{ url_for('vehicles.confirm_delete', id=vehicle.id) }}" class="btn btn-danger btn-sm">
                <i class="fas fa-trash ms-1"></i> Ø­Ø°Ù
            </a>
            <a href="{{ url_for('vehicles.generate_vehicle_report', id=vehicle.id) }}" class="btn btn-info btn-sm" target="_blank">
                <i class="fas fa-file-excel ms-1"></i> ØªÙ‚Ø±ÙŠØ± Excel
            </a>
            <a href="{{ url_for('vehicles.index') }}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-right ms-1"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
            </a>
        </div>
    </div>

    {% if inspection_warnings %}
    <div class="alert alert-warning mb-4">
        <i class="fas fa-exclamation-triangle ms-2"></i>
        {% for warning in inspection_warnings %}
        <span>{{ warning }}</span>{% if not loop.last %} | {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <div class="page-wrapper">
        <!-- ============================ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ============================ -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h5 class="mb-0">
                    <i class="fas fa-list-ul ms-2"></i>
                    Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©
                </h5>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#section-main-info" class="nav-link active"><i class="fas fa-info-circle"></i>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</a></li>
                    <li><a href="#section-license-image" class="nav-link"><i class="fas fa-id-card"></i>ØµÙˆØ±Ø© Ø§Ù„Ø±Ø®ØµØ©</a></li>
                    <li><a href="#section-rental" class="nav-link"><i class="fas fa-money-bill-wave"></i>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</a></li>
                    <li><a href="#section-docs" class="nav-link"><i class="fas fa-file-alt"></i>Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ø±Ø³Ù…ÙŠØ©</a></li>
                    <li><a href="#section-periodic-inspection" class="nav-link"><i class="fas fa-clipboard-check"></i>Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ</a></li>
                    <li><a href="#section-safety-checks" class="nav-link"><i class="fas fa-shield-alt"></i>ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©</a></li>
                    <li><a href="#section-workshop" class="nav-link"><i class="fas fa-tools"></i>Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙˆØ±Ø´Ø©</a></li>
                    <li><a href="#section-projects" class="nav-link"><i class="fas fa-project-diagram"></i>ØªØ®ØµÙŠØµØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</a></li>
                    <li><a href="#section-drivers" class="nav-link"><i class="fas fa-users"></i>Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†</a></li>
                    <li><a href="#section-handovers" class="nav-link"><i class="fas fa-exchange-alt"></i>Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙˆØ§Ù„Ø§Ø³ØªÙ„Ø§Ù…</a></li>
                    <li><a href="#section-authorizations" class="nav-link"><i class="fas fa-file-signature"></i>Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©</a></li>
                    <li><a href="#section-accidents" class="nav-link"><i class="fas fa-car-crash"></i>Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ù…Ø±ÙˆØ±ÙŠØ©</a></li>
                </ul>
            </nav>
        </aside>

        <!-- ============================ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ============================ -->
        <div class="content-area">
            <main class="main-content">

                <!-- Ø§Ù„Ù‚Ø³Ù… 1: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
                <div id="section-main-info" class="content-section">
                     <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙŠØ¨Ù‚Ù‰ Ù‡Ù†Ø§ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ -->
                     <div class="card shadow-sm h-100">
                        <div class="card-header ">
                            <h5 class="mb-0"><i class="fas fa-info-circle ms-2"></i>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h5>
                        </div>
                        <div class="card-body">
                             <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©:</div>
                                <div class="col-sm-8">{{ vehicle.plate_number }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">Ø§Ù„Ù†ÙˆØ¹:</div>
                                <div class="col-sm-8">{{ vehicle.make }} {{ vehicle.model }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹:</div>
                                <div class="col-sm-8">{{ vehicle.year }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">Ø§Ù„Ù„ÙˆÙ†:</div>
                                <div class="col-sm-8">
                                    <span class="badge rounded-pill"
                                        style="background-color: {{ vehicle.color }}; color: {{ '#000' if vehicle.color in ['white', 'yellow', 'silver'] else '#fff' }};">
                                        {{ vehicle.color }}
                                    </span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">Ø§Ù„Ø­Ø§Ù„Ø©:</div>
                                <div class="col-sm-8">
                                    {% if vehicle.status == 'available' %}
                                    <span class="badge bg-success">Ù…ØªØ§Ø­Ø©</span>
                                    {% elif vehicle.status == 'rented' %}
                                    <span class="badge bg-primary">Ù…Ø¤Ø¬Ø±Ø©</span>
                                    {% elif vehicle.status == 'in_project' %}
                                    <span class="badge bg-info">ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</span>
                                    {% elif vehicle.status == 'in_workshop' %}
                                    <span class="badge bg-warning text-dark">ÙÙŠ Ø§Ù„ÙˆØ±Ø´Ø©</span>
                                    {% elif vehicle.status == 'accident' %}
                                    <span class="badge bg-danger">Ø­Ø§Ø¯Ø«</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ vehicle.status }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©:</div>
                                <div class="col-sm-8">{{ vehicle.created_at.strftime('%Y-%m-%d') if vehicle.created_at else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</div>
                                <div class="col-sm-8">{{ vehicle.updated_at.strftime('%Y-%m-%d') if vehicle.updated_at else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-sm-4 fw-bold">Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ:</div>
                                <div class="col-sm-8">
                                    {% if current_driver %}
                                    <span class="text-success fw-bold">{{ current_driver.name }}</span>
                                    <small class="text-muted d-block">Ù…Ù†Ø° {{ current_driver.formatted_date }}</small>
                                    <div class="mt-2">
                                        <a href="{{ url_for('vehicles.view_handover', id=current_driver.handover_id) }}"
                                            class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye ms-1"></i>
                                            Ù…Ø´Ø§Ù‡Ø¯Ø© Ø³Ø¬Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ…
                                        </a>
                                        {% if current_driver.mobile %}
                                        <a href="https://wa.me/{{ current_driver.mobile.replace('+', '').replace(' ', '').replace('-', '') }}?text=Ù…Ø±Ø­Ø¨Ø§Ù‹ {{ current_driver.name }}%0A%0AğŸš— Ø¨Ø®ØµÙˆØµ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø±Ù‚Ù…: {{ vehicle.plate_number }}%0AğŸ“… ØªØ§Ø±ÙŠØ® {{ current_driver.handover_type_ar }}: {{ current_driver.formatted_date }}%0A%0AğŸ“‹ Ù…Ù„Ù PDF Ù„Ù„ØªØ³Ù„ÙŠÙ…/Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:%0A{{ url_for('vehicles.handover_pdf_public', id=current_driver.handover_id, _external=True) }}%0A%0AğŸ™ Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø© ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚"
                                            class="btn btn-sm btn-success ms-1" target="_blank" title="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨">
                                            <i class="fab fa-whatsapp ms-1"></i>
                                            ÙˆØ§ØªØ³Ø§Ø¨
                                        </a>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <span class="text-muted">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% if vehicle.notes %}
                            <div class="row mb-2">
                                <div class="col-12 fw-bold">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</div>
                                <div class="col-12 mt-2">
                                    <div class="alert alert-secondary">{{ vehicle.notes }}</div>
                                </div>
                            </div>
                            {% endif %}
                            <hr class="my-3">
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">
                                    <i class="fab fa-google-drive text-info ms-1"></i>
                                    Ù…Ù„ÙØ§Øª Google Drive:
                                </div>
                                <div class="col-sm-8">
                                    {% if vehicle.drive_folder_link %}
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-success me-2">Ù…Ø±ØªØ¨Ø·</span>
                                        <a href="{{ vehicle.drive_folder_link }}" target="_blank" class="btn btn-sm btn-success me-2">
                                            <i class="fab fa-google-drive me-1"></i>
                                            ÙØªØ­ Ø§Ù„Ù…Ø¬Ù„Ø¯
                                        </a>
                                        <a href="{{ url_for('vehicles.drive_management', vehicle_id=vehicle.id) }}" class="btn btn-sm btn-info">
                                            <i class="fas fa-cog me-1"></i>
                                            Ø¥Ø¯Ø§Ø±Ø©
                                        </a>
                                    </div>
                                    <small class="text-muted d-block mt-1">ØªÙ… Ø±Ø¨Ø· Ù…Ø¬Ù„Ø¯ Ù„ØªÙ†Ø¸ÙŠÙ… Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</small>
                                    {% else %}
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-warning text-dark me-2">ØºÙŠØ± Ù…Ø±ØªØ¨Ø·</span>
                                        <a href="{{ url_for('vehicles.drive_management', vehicle_id=vehicle.id) }}" class="btn btn-sm btn-info">
                                            <i class="fas fa-link me-1"></i>
                                            Ø±Ø¨Ø· Ù…Ø¬Ù„Ø¯
                                        </a>
                                    </div>
                                    <small class="text-muted d-block mt-1">Ù„Ù… ÙŠØªÙ… Ø±Ø¨Ø· Ù…Ø¬Ù„Ø¯ Google Drive Ø¨Ø¹Ø¯</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ø§Ù„Ù‚Ø³Ù… 2: ØµÙˆØ±Ø© Ø§Ù„Ø±Ø®ØµØ© -->
                <div id="section-license-image" class="content-section">
                    <div class="card shadow-sm h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-id-card ms-2"></i>ØµÙˆØ±Ø© Ø±Ø®ØµØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h5>
                            <a href="{{ url_for('vehicles.vehicle_license_image', vehicle_id=vehicle.id) }}" class="btn btn-sm btn-primary">
                                {% if vehicle.license_image %}ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©{% else %}Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©{% endif %}
                            </a>
                        </div>
                        <div class="card-body">
                           {% if vehicle.license_image %}
                            <div class="text-center">
                                <div class="license-image-container mb-3">
                                    <img src="{{ url_for('static', filename='uploads/vehicles/' + vehicle.license_image) }}" 
                                         class="img-fluid rounded border" 
                                         style="max-height: 400px; max-width: 100%; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer;" 
                                         alt="ØµÙˆØ±Ø© Ø±Ø®ØµØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©"
                                         onclick="showLicenseModal()">
                                </div>
                                <div class="license-actions d-flex gap-2 justify-content-center flex-wrap">
                                    <button onclick="showLicenseModal()" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-search-plus ms-1"></i>
                                        Ø¹Ø±Ø¶ ÙƒØ¨ÙŠØ±
                                    </button>
                                    <a href="{{ url_for('static', filename='uploads/vehicles/' + vehicle.license_image) }}" 
                                       target="_blank" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-download ms-1"></i>
                                        ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                                    </a>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle ms-1"></i>
                                        Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø¹Ø±Ø¶ Ø¨Ø­Ø¬Ù… ÙƒØ§Ù…Ù„
                                    </small>
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <div class="mb-3">
                                    <i class="fas fa-id-card fa-4x text-muted"></i>
                                </div>
                                <h5>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ø±Ø®ØµØ©</h5>
                                <p class="text-muted">Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ ØµÙˆØ±Ø© Ø±Ø®ØµØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¨Ø¹Ø¯</p>
                                <a href="{{ url_for('vehicles.vehicle_license_image', vehicle_id=vehicle.id) }}" 
                                   class="btn btn-primary mt-2">
                                    <i class="fas fa-plus ms-1"></i>
                                    Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø±Ø®ØµØ©
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Ø§Ù„Ù‚Ø³Ù… 3: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ÙŠØ¬Ø§Ø± -->
                <div id="section-rental" class="content-section">
                    <div class="card shadow-sm h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-money-bill-wave ms-2"></i>
                                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±
                            </h5>
                            <a href="{{ url_for('vehicles.create_rental', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                                {% if rental %}ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±{% else %}Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ¬Ø§Ø±{% endif %}
                            </a>
                        </div>
                        <div class="card-body">
                            {% if rental %}
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</div>
                                <div class="col-sm-8">{{ rental.formatted_start_date }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:</div>
                                <div class="col-sm-8">
                                    {% if rental.end_date %}
                                    {{ rental.formatted_end_date }}
                                    {% else %}
                                    <span class="badge bg-info">Ù…Ø³ØªÙ…Ø±</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ:</div>
                                <div class="col-sm-8">{{ "{:,.2f}".format(rental.monthly_cost) }} Ø±ÙŠØ§Ù„</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:</div>
                                <div class="col-sm-8">
                                    {% if rental.is_active %}
                                    <span class="badge bg-success">Ù†Ø´Ø·</span>
                                    {% else %}
                                    <span class="badge bg-danger">Ù…Ù†ØªÙ‡ÙŠ</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">Ø§Ù„Ù…Ø¤Ø¬Ø±:</div>
                                <div class="col-sm-8">{{ rental.lessor_name or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„:</div>
                                <div class="col-sm-8">{{ rental.lessor_contact or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-sm-4 fw-bold">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</div>
                                <div class="col-sm-8">{{ rental.contract_number or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
                            </div>
                            {% if rental.notes %}
                            <div class="row mb-2">
                                <div class="col-12 fw-bold">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:</div>
                                <div class="col-12 mt-2">
                                    <div class="alert alert-secondary">{{ rental.notes }}</div>
                                </div>
                            </div>
                            {% endif %}
                            <div class="mt-3">
                                <a href="{{ url_for('vehicles.edit_rental', id=rental.id) }}" class="btn btn-sm btn-warning">
                                    <i class="fas fa-edit ms-1"></i>
                                    ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±
                                </a>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <div class="mb-3">
                                    <i class="fas fa-file-contract fa-4x text-muted"></i>
                                </div>
                                <h5>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥ÙŠØ¬Ø§Ø± Ù†Ø´Ø· Ø­Ø§Ù„ÙŠØ§Ù‹</h5>
                                <p class="text-muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ù„Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ¬Ø§Ø±"</p>
                                <a href="{{ url_for('vehicles.create_rental', id=vehicle.id) }}" class="btn btn-primary mt-2">
                                    <i class="fas fa-plus ms-1"></i>
                                    Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠØ¬Ø§Ø±
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Ø§Ù„Ù‚Ø³Ù… 4: ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© -->
                <div id="section-docs" class="content-section">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-id-card ms-2"></i>
                                ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©
                            </h5>
                            <a href="{{ url_for('vehicles.edit_documents', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-edit ms-1"></i>
                                ØªØ¹Ø¯ÙŠÙ„ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚
                            </a>
                        </div>
                        <div class="card-body">
                             <!-- Your Original content of documents (authorization, registration, etc.) goes here -->
                             <!-- Paste from "col-md-12 mb-4" card -->
                              <div class="row">
                                <!-- ØªÙÙˆÙŠØ¶ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© -->
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100 {% if vehicle.authorization_expiry_date %}{% if (vehicle.authorization_expiry_date - today).days < 0 %}border-danger{% elif (vehicle.authorization_expiry_date - today).days <= 30 %}border-warning{% else %}border-success{% endif %}{% else %}border-light{% endif %}">
                                        <div class="card-body text-center">
                                            <h5 class="card-title mb-3"><i class="fas fa-file-contract me-1"></i> ØªÙÙˆÙŠØ¶ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</h5>
                                            {% if vehicle.authorization_expiry_date %}<p class="mb-1">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</p><h4 class="mb-2">{{ vehicle.authorization_expiry_date.strftime('%Y-%m-%d') }}</h4>{% set days_remaining = (vehicle.authorization_expiry_date - today).days %}{% if days_remaining < 0 %} <div class="badge bg-danger p-2 mb-2 w-100">Ù…Ù†ØªÙ‡ÙŠ Ù…Ù†Ø° {{ days_remaining|abs }} ÙŠÙˆÙ…</div>{% elif days_remaining <= 30 %} <div class="badge bg-warning text-dark p-2 mb-2 w-100">ÙŠØªØ¨Ù‚Ù‰ {{ days_remaining }} ÙŠÙˆÙ…</div>{% else %}<div class="badge bg-success p-2 mb-2 w-100">ÙŠØªØ¨Ù‚Ù‰ {{ days_remaining }} ÙŠÙˆÙ…</div>{% endif %}<a href="{{ url_for('vehicles.view_documents', id=vehicle.id) }}" class="btn btn-sm btn-outline-primary w-100"><i class="fas fa-eye ms-1"></i>Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>{% else %}<div class="text-muted mb-3"><i class="fas fa-exclamation-circle fa-2x"></i><p class="mt-2">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡</p></div><a href="{{ url_for('vehicles.edit_documents', id=vehicle.id) }}" class="btn btn-sm btn-primary w-100"><i class="fas fa-plus ms-1"></i>Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ§Ø±ÙŠØ®</a>{% endif %}
                                        </div>
                                    </div>
                                </div>
                                <!-- Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© --><div class="col-md-4 mb-3"><div class="card h-100 {% if vehicle.registration_expiry_date %}{% if (vehicle.registration_expiry_date - today).days < 0 %}border-danger{% elif (vehicle.registration_expiry_date - today).days <= 30 %}border-warning{% else %}border-success{% endif %}{% else %}border-light{% endif %}"><div class="card-body text-center"><h5 class="card-title mb-3"><i class="fas fa-clipboard-list me-1"></i>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h5>{% if vehicle.registration_expiry_date %}<p class="mb-1">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</p><h4 class="mb-2">{{ vehicle.registration_expiry_date.strftime('%Y-%m-%d') }}</h4>{% set days_remaining = (vehicle.registration_expiry_date - today).days %}{% if days_remaining < 0 %} <div class="badge bg-danger p-2 mb-2 w-100">Ù…Ù†ØªÙ‡ÙŠ Ù…Ù†Ø° {{ days_remaining|abs }} ÙŠÙˆÙ…</div>{% elif days_remaining <= 30 %} <div class="badge bg-warning text-dark p-2 mb-2 w-100">ÙŠØªØ¨Ù‚Ù‰ {{ days_remaining }} ÙŠÙˆÙ…</div>{% else %}<div class="badge bg-success p-2 mb-2 w-100">ÙŠØªØ¨Ù‚Ù‰ {{ days_remaining }} ÙŠÙˆÙ…</div>{% endif %}<a href="{{ url_for('vehicles.view_documents', id=vehicle.id) }}" class="btn btn-sm btn-outline-primary w-100"><i class="fas fa-eye ms-1"></i>Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>{% else %}<div class="text-muted mb-3"><i class="fas fa-exclamation-circle fa-2x"></i><p class="mt-2">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡</p></div><a href="{{ url_for('vehicles.edit_documents', id=vehicle.id) }}" class="btn btn-sm btn-primary w-100"><i class="fas fa-plus ms-1"></i>Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ§Ø±ÙŠØ®</a>{% endif %}</div></div></div>
                                <!-- Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ --><div class="col-md-4 mb-3"><div class="card h-100 {% if vehicle.inspection_expiry_date %}{% if (vehicle.inspection_expiry_date - today).days < 0 %}border-danger{% elif (vehicle.inspection_expiry_date - today).days <= 30 %}border-warning{% else %}border-success{% endif %}{% else %}border-light{% endif %}"><div class="card-body text-center"><h5 class="card-title mb-3"><i class="fas fa-clipboard-check me-1"></i>Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ</h5>{% if vehicle.inspection_expiry_date %}<p class="mb-1">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</p><h4 class="mb-2">{{ vehicle.inspection_expiry_date.strftime('%Y-%m-%d') }}</h4>{% set days_remaining = (vehicle.inspection_expiry_date - today).days %}{% if days_remaining < 0 %} <div class="badge bg-danger p-2 mb-2 w-100">Ù…Ù†ØªÙ‡ÙŠ Ù…Ù†Ø° {{ days_remaining|abs }} ÙŠÙˆÙ…</div>{% elif days_remaining <= 30 %} <div class="badge bg-warning text-dark p-2 mb-2 w-100">ÙŠØªØ¨Ù‚Ù‰ {{ days_remaining }} ÙŠÙˆÙ…</div>{% else %}<div class="badge bg-success p-2 mb-2 w-100">ÙŠØªØ¨Ù‚Ù‰ {{ days_remaining }} ÙŠÙˆÙ…</div>{% endif %}<a href="{{ url_for('vehicles.view_documents', id=vehicle.id) }}" class="btn btn-sm btn-outline-primary w-100"><i class="fas fa-eye ms-1"></i>Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>{% else %}<div class="text-muted mb-3"><i class="fas fa-exclamation-circle fa-2x"></i><p class="mt-2">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡</p></div><a href="{{ url_for('vehicles.edit_documents', id=vehicle.id) }}" class="btn btn-sm btn-primary w-100"><i class="fas fa-plus ms-1"></i>Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ§Ø±ÙŠØ®</a>{% endif %}</div></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ... Ù‡Ù†Ø§ Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© ... -->

                <!-- Ø§Ù„Ù‚Ø³Ù… 5: Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ -->
                <div id="section-periodic-inspection" class="content-section">
                     <!-- ... Ø¶Ø¹ Ù‡Ù†Ø§ ÙƒÙˆØ¯ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ... -->
                    <!-- Ø¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ <div id="section-periodic-inspection" class="content-section"> -->
                    <div class="card shadow-sm h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-clipboard-check ms-2"></i>
                                Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ
                                {% if periodic_inspections %}
                                <span class="badge bg-secondary">{{ periodic_inspections|length }}</span>
                                {% endif %}
                            </h5>
                            <div>
                                <a href="{{ url_for('vehicles.vehicle_inspections', id=vehicle.id) }}"
                                    class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye ms-1"></i>
                                    Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
                                </a>
                                <a href="{{ url_for('vehicles.create_inspection', id=vehicle.id) }}"
                                    class="btn btn-sm btn-success me-1">
                                    <i class="fas fa-plus ms-1"></i>
                                    Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if periodic_inspections %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Ø±Ù‚Ù… Ø§Ù„ÙØ­Øµ</th>
                                            <th>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ</th>
                                            <th>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for inspection in periodic_inspections[:3] %}
                                        <tr
                                            class="{% if inspection.is_expired %}table-danger{% elif inspection.is_expiring_soon %}table-warning{% endif %}">
                                            <td>{{ inspection.inspection_number }}</td>
                                            <td>{{ inspection.formatted_inspection_date }}</td>
                                            <td>{{ inspection.formatted_expiry_date }}</td>
                                            <td>
                                                {% if inspection.inspection_type == 'technical' %}
                                                <span class="badge bg-info">ÙØ­Øµ ÙÙ†ÙŠ</span>
                                                {% elif inspection.inspection_type == 'periodic' %}
                                                <span class="badge bg-primary">ÙØ­Øµ Ø¯ÙˆØ±ÙŠ</span>
                                                {% elif inspection.inspection_type == 'safety' %}
                                                <span class="badge bg-warning text-dark">ÙØ­Øµ Ø£Ù…Ø§Ù†</span>
                                                {% else %}
                                                <span class="badge bg-secondary">{{ inspection.inspection_type }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if inspection.inspection_status == 'valid' %}
                                                <span class="badge bg-success">Ø³Ø§Ø±ÙŠ</span>
                                                {% elif inspection.inspection_status == 'expired' %}
                                                <span class="badge bg-danger">Ù…Ù†ØªÙ‡ÙŠ</span>
                                                {% elif inspection.inspection_status == 'expiring_soon' %}
                                                <span class="badge bg-warning text-dark">ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ù‹Ø§</span>
                                                {% else %}
                                                <span class="badge bg-secondary">{{ inspection.inspection_status }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if periodic_inspections|length > 3 %}
                            <div class="text-center mt-2">
                                <a href="{{ url_for('vehicles.vehicle_inspections', id=vehicle.id) }}"
                                    class="btn btn-sm btn-outline-primary">
                                    Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ({{ periodic_inspections|length }})
                                </a>
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="text-center py-4">
                                <div class="mb-3">
                                    <i class="fas fa-clipboard fa-4x text-muted"></i>
                                </div>
                                <h5>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ÙØ­Øµ Ø¯ÙˆØ±ÙŠ</h5>
                                <p class="text-muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ÙØ­Øµ Ø¯ÙˆØ±ÙŠ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ"</p>
                                <a href="{{ url_for('vehicles.create_inspection', id=vehicle.id) }}"
                                    class="btn btn-success mt-2">
                                    <i class="fas fa-plus ms-1"></i>
                                    Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ Ø¯ÙˆØ±ÙŠ
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                </div>



                                                
                <!-- Ø§Ù„Ù‚Ø³Ù… 6: ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© -->
                <div id="section-safety-checks" class="content-section">
                    <!-- ... Ø¶Ø¹ Ù‡Ù†Ø§ ÙƒÙˆØ¯ Ø¨Ø·Ø§Ù‚Ø© ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ... -->


                    <!-- Ø¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ <div id="section-safety-checks" class="content-section"> -->
                    <div class="card shadow-sm h-100">
                        <div class="card-header  d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-shield-alt ms-2"></i>
                                ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©
                                {% if safety_checks %}
                                <span class="badge bg-secondary">{{ safety_checks|length }}</span>
                                {% endif %}
                            </h5>
                            <div>
                                <a href="{{ url_for('vehicles.vehicle_safety_checks', id=vehicle.id) }}"
                                    class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye ms-1"></i>
                                    Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
                                </a>
                                <a href="{{ url_for('vehicles.create_safety_check', id=vehicle.id) }}"
                                    class="btn btn-sm btn-success me-1">
                                    <i class="fas fa-plus ms-1"></i>
                                    Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if safety_checks %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                            <th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                                            <th>Ø§Ù„Ù…Ø´Ø±Ù</th>
                                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th>Ù…Ø´Ø§ÙƒÙ„</th>
                                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for check in safety_checks[:3] %}
                                        <tr>
                                            <td>{{ check.formatted_check_date }}</td>
                                            <td>
                                                {% if check.check_type == 'daily' %}
                                                <span class="badge bg-info">ÙŠÙˆÙ…ÙŠ</span>
                                                {% elif check.check_type == 'weekly' %}
                                                <span class="badge bg-warning text-dark">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</span>
                                                {% elif check.check_type == 'monthly' %}
                                                <span class="badge bg-danger">Ø´Ù‡Ø±ÙŠ</span>
                                                {% else %}
                                                <span class="badge bg-secondary">{{ check.check_type }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ check.driver_name }}</td>
                                            <td>{{ check.supervisor_name }}</td>
                                            <td>
                                                {% if check.status == 'completed' %}
                                                <span class="badge bg-success">Ù…ÙƒØªÙ…Ù„</span>
                                                {% elif check.status == 'in_progress' %}
                                                <span class="badge bg-warning text-dark">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</span>
                                                {% elif check.status == 'needs_review' %}
                                                <span class="badge bg-danger">Ø¨Ø­Ø§Ø¬Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                                                {% else %}
                                                <span class="badge bg-secondary">{{ check.status }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if check.issues_found %}
                                                <span class="badge bg-danger">Ù†Ø¹Ù…</span>
                                                {% else %}
                                                <span class="badge bg-success">Ù„Ø§</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="{{ url_for('vehicles.vehicle_safety_checks', id=vehicle.id) }}"
                                                        class="btn btn-sm btn-outline-primary" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a href="{{ url_for('vehicles.edit_safety_check', id=check.id) }}"
                                                        class="btn btn-sm btn-outline-warning" title="ØªØ¹Ø¯ÙŠÙ„">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <form method="POST"
                                                        action="{{ url_for('vehicles.delete_safety_check', id=check.id) }}"
                                                        style="display: inline-block;"
                                                        onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Ø­Ø°Ù">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if safety_checks|length > 3 %}
                            <div class="text-center mt-2">
                                <a href="{{ url_for('vehicles.vehicle_safety_checks', id=vehicle.id) }}"
                                    class="btn btn-sm btn-outline-primary">
                                    Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ({{ safety_checks|length }})
                                </a>
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="text-center py-4">
                                <div class="mb-3">
                                    <i class="fas fa-shield-alt fa-4x text-muted"></i>
                                </div>
                                <h5>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ÙØ­Øµ Ø³Ù„Ø§Ù…Ø©</h5>
                                <p class="text-muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ"</p>
                                <a href="{{ url_for('vehicles.create_safety_check', id=vehicle.id) }}"
                                    class="btn btn-success mt-2">
                                    <i class="fas fa-plus ms-1"></i>
                                    Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ Ø³Ù„Ø§Ù…Ø©
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>



                    <!-- Safety checks section already implemented above -->
                </div>

                <!-- Ø§Ù„Ù‚Ø³Ù… 7: Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙˆØ±Ø´Ø© -->
                <div id="section-workshop" class="content-section">
                    <!-- ... Ø¶Ø¹ Ù‡Ù†Ø§ ÙƒÙˆØ¯ Ø¨Ø·Ø§Ù‚Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙˆØ±Ø´Ø© Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ... -->


                    <div class="card shadow-sm h-100">
                        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <h5 class="mb-0">
                                <i class="fas fa-tools ms-2"></i>
                                Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙˆØ±Ø´Ø©
                                <span class="badge bg-secondary">{{ workshop_records|length }}</span>
                            </h5>
                            <div>
                                <a href="{{ url_for('vehicles.create_workshop', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-plus ms-1"></i>
                                    Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if workshop_records %}
                            <!-- Ù…Ø­ØªÙˆÙ‰ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆØ±Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ ÙŠÙˆØ¶Ø¹ Ù‡Ù†Ø§ -->
                            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙˆØ±Ø´Ø© -->
                            <div class="row mb-3 text-center">
                                <div class="col-4">
                                    <div class="fw-bold text-primary h5 mb-1">{{ workshop_records|selectattr('repair_status', 'equalto', 'in_progress')|list|length }}</div>
                                    <small class="text-muted">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</small>
                                </div>
                                <div class="col-4">
                                    <div class="fw-bold text-success h5 mb-1">{{ workshop_records|selectattr('repair_status', 'equalto', 'completed')|list|length }}</div>
                                    <small class="text-muted">Ù…ÙƒØªÙ…Ù„</small>
                                </div>
                                <div class="col-4">
                                    <div class="fw-bold text-warning h5 mb-1">{{ workshop_records|selectattr('repair_status', 'equalto', 'pending_approval')|list|length }}</div>
                                    <small class="text-muted">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</small>
                                </div>
                            </div>
                            <hr>
                            <div class="list-group" style="max-height: 500px; overflow-y: auto;">
                                {% for record in workshop_records %}
                                    <!-- Ù†ÙØ³ Ù…Ø­ØªÙˆÙ‰ Ø­Ù„Ù‚Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ -->
                                {% endfor %}
                            </div>
                             {% if workshop_records|length > 4 %}
                                <div class="text-center py-3 border-top">
                                    <button class="btn btn-outline-primary btn-sm" onclick="toggleOlderWorkshopRecords()">
                                        <i class="fas fa-chevron-down ms-1" id="toggleWorkshopIcon"></i>
                                        <span id="toggleWorkshopText">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ({{ workshop_records|length - 4 }})</span>
                                    </button>
                                </div>
                            {% endif %}
                            <div class="d-flex justify-content-between mt-3 pt-3 border-top">
                                <div>
                                    <span class="fw-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ:</span>
                                    <span class="badge bg-primary fs-6">{{ "{:,.2f}".format(total_maintenance_cost) }} Ø±ÙŠØ§Ù„</span>
                                </div>
                                <div>
                                    <span class="fw-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙŠØ§Ù…:</span>
                                    <span class="badge bg-danger fs-6">{{ days_in_workshop }} ÙŠÙˆÙ…</span>
                                </div>
                            </div>
                            {% else %}
                                <!-- ÙƒÙˆØ¯ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„Ø§Øª ÙˆØ±Ø´Ø© -->
                            {% endif %}
                        </div>
                    </div>



                    <!-- Workshop section already implemented above -->
                </div>

                <!-- Ø§Ù„Ù‚Ø³Ù… 8: ØªØ®ØµÙŠØµØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ -->
                <div id="section-projects" class="content-section">
                    <!-- ... Ø¶Ø¹ Ù‡Ù†Ø§ ÙƒÙˆØ¯ Ø¨Ø·Ø§Ù‚Ø© ØªØ®ØµÙŠØµØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ... -->

                    <!-- Ø¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ <div id="section-projects" class="content-section"> -->
                    <div class="card shadow-sm h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-project-diagram ms-2"></i>
                                ØªØ®ØµÙŠØµØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
                                <span class="badge bg-secondary">{{ project_assignments|length }}</span>
                            </h5>
                            <a href="{{ url_for('vehicles.create_project', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus ms-1"></i>
                                ØªØ®ØµÙŠØµ Ù„Ù…Ø´Ø±ÙˆØ¹
                            </a>
                        </div>
                        <div class="card-body">
                            {% if project_assignments %}
                            <div class="list-group">
                                {% for assignment in project_assignments %}
                                <div
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-bold">
                                            {{ assignment.project_name }}
                                            {% if assignment.is_active %}
                                            <span class="badge bg-success">Ù†Ø´Ø·</span>
                                            {% else %}
                                            <span class="badge bg-danger">Ù…Ù†ØªÙ‡ÙŠ</span>
                                            {% endif %}
                                        </div>
                                        <div class="small">
                                            Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: {{ assignment.formatted_start_date }}
                                            {% if assignment.end_date %}
                                            | Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: {{ assignment.formatted_end_date }}
                                            {% else %}
                                            | <span class="text-success">Ù…Ø³ØªÙ…Ø±</span>
                                            {% endif %}
                                        </div>
                                        <div class="small">
                                            Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: {{ assignment.manager_name }} |
                                            Ø§Ù„Ù…ÙˆÙ‚Ø¹: {{ assignment.location }}
                                        </div>
                                    </div>
                                    <a href="{{ url_for('vehicles.edit_project', id=assignment.id) }}"
                                        class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <div class="mb-3">
                                    <i class="fas fa-building fa-4x text-muted"></i>
                                </div>
                                <h5>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ®ØµÙŠØµØ§Øª Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h5>
                                <p class="text-muted">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ®ØµÙŠØµ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "ØªØ®ØµÙŠØµ Ù„Ù…Ø´Ø±ÙˆØ¹"</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>


                    <!-- Projects section already implemented above -->
                </div>

                <!-- Ø§Ù„Ù‚Ø³Ù… 9: Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† -->
                <div id="section-drivers" class="content-section">
                     <!-- ... Ø¶Ø¹ Ù‡Ù†Ø§ ÙƒÙˆØ¯ Ø¨Ø·Ø§Ù‚ØªÙŠ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ† Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ... -->


                    <!-- Ø¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ <div id="section-drivers" class="content-section"> -->
                    <div class="row">
                        <div class="col-lg-6 mb-4 mb-lg-0">
                            <div class="card shadow-sm h-100">
                                <div class="card-header  d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-user-tie ms-2"></i>
                                        Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ
                                    </h5>
                                    <a href="{{ url_for('vehicles.create_handover', id=vehicle.id) }}?type=delivery"
                                        class="btn btn-sm btn-success">
                                        <i class="fas fa-exchange-alt ms-1"></i>
                                        ØªØ³Ù„ÙŠÙ… Ù„Ø³Ø§Ø¦Ù‚
                                    </a>
                                </div>
                                <div class="card-body">
                                    {% if current_driver %}
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="h5 mb-1">{{ current_driver.name }}</div>
                                            <div class="small text-muted">
                                                Ù…Ù†Ø° {{ current_driver.formatted_date }}
                                            </div>
                                        </div>
                                        <div>
                                            <a href="{{ url_for('vehicles.view_handover', id=current_driver.handover_id) }}" class="btn btn-sm btn-outline-primary ms-1" title="Ù…Ø´Ø§Ù‡Ø¯Ø©"><i class="fas fa-eye"></i></a>
                                            <a href="{{ url_for('vehicles.handover_pdf_public', id=current_driver.handover_id) }}" class="btn btn-sm btn-outline-danger ms-1" target="_blank" title="PDF"><i class="fas fa-file-pdf"></i></a>
                                            {% if current_driver.mobile %}<a href="https://wa.me/{{ current_driver.mobile.replace('+', '').replace(' ', '').replace('-', '') }}?text=..." class="btn btn-sm btn-success ms-1" target="_blank" title="ÙˆØ§ØªØ³Ø§Ø¨"><i class="fab fa-whatsapp"></i></a>{% endif %}
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="text-muted text-center py-3">
                                        <i class="fas fa-info-circle ms-1 fa-2x mb-2"></i>
                                        <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ Ø­Ø§Ù„ÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="card shadow-sm h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-history ms-2"></i>
                                        Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙˆÙ†
                                        <span class="badge bg-secondary">{{ previous_drivers|length }}</span>
                                    </h5>
                                </div>
                                <div class="card-body">
                                    {% if previous_drivers %}
                                    <div class="list-group">
                                        {% for driver in previous_drivers %}
                                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="fw-bold">{{ driver.name }}</div>
                                                <div class="small text-muted">{{ driver.formatted_date }} ({{ driver.handover_type_ar }})</div>
                                            </div>
                                            <div>
                                                 <a href="{{ url_for('vehicles.view_handover', id=driver.handover_id) }}" class="btn btn-sm btn-outline-primary ms-1" title="Ù…Ø´Ø§Ù‡Ø¯Ø©"><i class="fas fa-eye"></i></a>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="text-muted text-center py-3">
                                        <i class="fas fa-info-circle ms-1 fa-2x mb-2"></i>
                                        <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø³Ø§Ø¨Ù‚ÙˆÙ† Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                     
                    
                    
                    
                    
                    
                
                        </div>
                        <div class="col-md-6">
                            <!-- Previous drivers section implemented above -->
                        </div>
            

                <!-- Ø§Ù„Ù‚Ø³Ù… 10: Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙˆØ§Ù„Ø§Ø³ØªÙ„Ø§Ù… -->
                <div id="section-handovers" class="content-section">
                     <!-- ... Ø¶Ø¹ Ù‡Ù†Ø§ ÙƒÙˆØ¯ Ø¨Ø·Ø§Ù‚Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙˆØ§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ... -->


                    <!-- Ø¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ <div id="section-handovers" class="content-section"> -->
                    <div class="card shadow-sm">
                        <div class="card-header  d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-exchange-alt ms-2"></i>
                                Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙˆØ§Ù„Ø§Ø³ØªÙ„Ø§Ù…
                                <span class="badge bg-secondary">{{ handover_records|length }}</span>
                            </h5>
                            <a href="{{ url_for('vehicles.create_handover', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus ms-1"></i>
                                Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„
                            </a>
                        </div>
                        <div class="card-body">
                            {% if handover_records %}
                            <!-- Ù…Ø­ØªÙˆÙ‰ Ø¨Ø·Ø§Ù‚Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙˆØ§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£ØµÙ„ÙŠ ÙŠÙˆØ¶Ø¹ Ù‡Ù†Ø§ -->
                             <form action="{{ url_for('vehicles.confirm_delete_handovers', vehicle_id=vehicle.id) }}" method="post" id="handover-delete-form">
                                <div class="mb-3 d-flex justify-content-end">
                                    <button type="submit" class="btn btn-sm btn-danger" id="delete-selected-btn" disabled>
                                        <i class="fas fa-trash-alt ms-1"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <!-- Ù†ÙØ³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ -->
                                     <table class="table table-bordered table-hover">...</table>
                                </div>
                            </form>
                            {% else %}
                            <div class="text-center py-4">
                                <div class="mb-3"><i class="fas fa-file-signature fa-4x text-muted"></i></div>
                                <h5>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØ³Ù„ÙŠÙ… ÙˆØ§Ø³ØªÙ„Ø§Ù…</h5>
                                <p class="text-muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„".</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>


                    <!-- Handovers section already implemented above -->
                </div>

                <!-- Ø§Ù„Ù‚Ø³Ù… 11: Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© -->
                <div id="section-authorizations" class="content-section">
                     <!-- ... Ø¶Ø¹ Ù‡Ù†Ø§ ÙƒÙˆØ¯ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ... -->


                    <!-- Ø¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ <div id="section-authorizations" class="content-section"> -->
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-file-signature ms-2"></i>
                                Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
                                <span class="badge bg-secondary">{{ external_authorizations|length }}</span>
                            </h5>
                            <a href="{{ url_for('vehicles.create_external_authorization', vehicle_id=vehicle.id) }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus ms-1"></i>
                                Ø¥Ø¶Ø§ÙØ© ØªÙÙˆÙŠØ¶
                            </a>
                        </div>
                        <div class="card-body">
                            {% if external_authorizations %}
                            <!-- Ù…Ø­ØªÙˆÙ‰ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙÙˆÙŠØ¶Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠ ÙŠÙˆØ¶Ø¹ Ù‡Ù†Ø§ -->
                            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
                            <div class="row mb-3 text-center">...</div>
                            <hr>
                            <div class="table-responsive">
                                 <!-- Ù†ÙØ³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ -->
                                <table class="table table-hover">...</table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-file-signature fa-3x text-muted mb-3"></i>
                                <h6>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙÙˆÙŠØ¶Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©</h6>
                                <p class="text-muted small">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ØªÙÙˆÙŠØ¶ Ø®Ø§Ø±Ø¬ÙŠ Ø¬Ø¯ÙŠØ¯.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>


                    <!-- External authorizations section already implemented above -->
                </div>

                <!-- Ø§Ù„Ù‚Ø³Ù… 12: Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ù…Ø±ÙˆØ±ÙŠØ© -->
                <div id="section-accidents" class="content-section">
                     <!-- ... Ø¶Ø¹ Ù‡Ù†Ø§ ÙƒÙˆØ¯ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ù…Ø±ÙˆØ±ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ... -->


                    <!-- Ø¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ <div id="section-accidents" class="content-section"> -->
                    <div class="card shadow-sm">
                        <div class="card-header  d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-car-crash ms-2"></i>
                                Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ù…Ø±ÙˆØ±ÙŠØ©
                                {% if accidents %}<span class="badge bg-secondary">{{ accidents|length }}</span>{% endif %}
                            </h5>
                            <div>
                                <a href="{{ url_for('vehicles.create_accident', id=vehicle.id) }}" class="btn btn-sm btn-success">
                                    <i class="fas fa-plus ms-1"></i>
                                    Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ø¯Ø«
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if accidents %}
                            <div class="table-responsive">
                                <!-- Ù†ÙØ³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ -->
                                <table class="table table-hover">...</table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <div class="mb-3">
                                    <i class="fas fa-car-crash fa-4x text-muted"></i>
                                </div>
                                <h5>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­ÙˆØ§Ø¯Ø« Ù…Ø³Ø¬Ù„Ø©</h5>
                                <p class="text-muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø­Ø§Ø¯Ø« Ø¬Ø¯ÙŠØ¯.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                     <!-- Accidents section already implemented above -->
                </div>

            </main>
        </div>
    </div>
</div>

                                                

<!-- ============================ JavaScript ============================ -->
<script>
// Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
document.addEventListener('DOMContentLoaded', function() {
    const sidebarLinks = document.querySelectorAll('.sidebar-nav .nav-link');
    const contentSections = document.querySelectorAll('.main-content .content-section');

    function showSection(targetId) {
        contentSections.forEach(section => {
            section.classList.remove('active');
        });
        sidebarLinks.forEach(link => {
            link.classList.remove('active');
        });

        const targetSection = document.querySelector(targetId);
        const activeLink = document.querySelector(`.nav-link[href="${targetId}"]`);

        if (targetSection) {
            targetSection.classList.add('active');
        }
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }

    sidebarLinks.forEach(link => {
        link.addEventListener('click', function(event) {
            event.preventDefault(); 
            const targetId = this.getAttribute('href');
            showSection(targetId);
            // Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
            if (window.innerWidth < 992) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
    });

    // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    const firstSection = document.querySelector('.main-content .content-section');
    if (firstSection) {
        showSection('#' + firstSection.id);
    }
});


// =========================================================================
// ÙƒÙ„ Ø¯ÙˆØ§Ù„ JavaScript Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙƒØŒ ØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Ù‡Ù†Ø§ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„Ù‡Ø§
// =========================================================================

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
function toggleOlderWorkshopRecords() {
    const olderRecords = document.querySelectorAll('.older-workshop-record');
    const toggleIcon = document.getElementById('toggleWorkshopIcon');
    const toggleText = document.getElementById('toggleWorkshopText');

    if (olderRecords[0] && olderRecords[0].classList.contains('d-none')) {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        olderRecords.forEach(record => { record.classList.remove('d-none'); });
        toggleIcon.className = 'fas fa-chevron-up ms-1';
        toggleText.textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©';
    } else {
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        olderRecords.forEach(record => { record.classList.add('d-none'); });
        toggleIcon.className = 'fas fa-chevron-down ms-1';
        toggleText.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (' + olderRecords.length + ')';
    }
}

// Ø¥Ø¯Ø§Ø±Ø© Ø£Ø²Ø±Ø§Ø± Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙˆØ§Ù„Ø§Ø³ØªÙ„Ø§Ù…
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all');
    const handoverCheckboxes = document.querySelectorAll('.handover-checkbox');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    const handoverDeleteForm = document.getElementById('handover-delete-form');

    function updateDeleteButtonState() {
        const checkedBoxes = document.querySelectorAll('.handover-checkbox:checked');
        if (deleteSelectedBtn) { deleteSelectedBtn.disabled = checkedBoxes.length === 0; }
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            handoverCheckboxes.forEach(checkbox => { checkbox.checked = this.checked; });
            updateDeleteButtonState();
        });
    }

    handoverCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateDeleteButtonState();
            if (selectAllCheckbox) {
                const checkedCount = document.querySelectorAll('.handover-checkbox:checked').length;
                selectAllCheckbox.checked = checkedCount === handoverCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < handoverCheckboxes.length;
            }
        });
    });

    if (handoverDeleteForm) {
        handoverDeleteForm.addEventListener('submit', function(e) {
            const checkedBoxes = document.querySelectorAll('.handover-checkbox:checked');
            if (checkedBoxes.length === 0) { e.preventDefault(); alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡Ø§'); return false; }
            const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${checkedBoxes.length} Ø³Ø¬Ù„ Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙˆØ§Ù„Ø§Ø³ØªÙ„Ø§Ù…ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.`;
            if (!confirm(confirmMessage)) { e.preventDefault(); return false; }
        });
    }
    updateDeleteButtonState();
});

// Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø®ØµØ©
function showLicenseModal() {
    const existingModal = document.getElementById('licenseModalInstance');
    if (existingModal) {
        existingModal.remove();
    }

    const modalHtml = `
        <div class="modal fade" id="licenseModalInstance" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ØµÙˆØ±Ø© Ø±Ø®ØµØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø© - {{ vehicle.plate_number }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
                    </div>
                    <div class="modal-body text-center bg-light">
                        <img src="{{ url_for('static', filename='uploads/vehicles/' + vehicle.license_image) if vehicle.license_image else '' }}" class="img-fluid rounded" style="max-height: 75vh;" alt="ØµÙˆØ±Ø© Ø±Ø®ØµØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©">
                    </div>
                    <div class="modal-footer">
                        <a href="{{ url_for('static', filename='uploads/vehicles/' + vehicle.license_image) if vehicle.license_image else '#' }}" target="_blank" class="btn btn-success"><i class="fas fa-download ms-1"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const bootstrapModal = new bootstrap.Modal(document.getElementById('licenseModalInstance'));
    bootstrapModal.show();

    // Clean up modal from DOM after it's hidden to avoid conflicts
    document.getElementById('licenseModalInstance').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}
</script>
{% endblock %}