{% extends 'layout.html' %}

{% block title %}
    {% if force_mode == 'return' %}
        نموذج استلام مركبة - {{ vehicle.plate_number }}
    {% else %}
        نموذج تسليم مركبة - {{ vehicle.plate_number }}
    {% endif %}
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modules/vehicles/handover_form.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 mb-5 theme-handover-page" style="font-family: var(--font-default);">
    <div class="card shadow-sm theme-card">
        <!-- Page Header -->
        <div class="card-header d-flex justify-content-between align-items-center py-3">
            <h3 class="mb-0 theme-page-title" id="form-main-title" style="font-family: var(--font-default);">
                <i class="fas fa-file-alt me-2 text-primary"></i>
                {% if edit_mode %}
                    تعديل نموذج {{ handover_type_name }}: <span class="text-dark">{{ vehicle.plate_number }}</span>
                {% elif force_mode == 'return' %}
                    نموذج استلام: <span class="text-dark">{{ vehicle.plate_number }}</span>
                {% else %}
                    نموذج تسليم: <span class="text-dark">{{ vehicle.plate_number }}</span>
                {% endif %}
            </h3>
            <div>
                <a href="{{ url_for('vehicles.view', id=vehicle.id) }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-car me-1"></i> عرض السيارة
                </a>
                <a href="{{ url_for('vehicles.index') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-arrow-left me-1"></i> العودة للقائمة
                </a>
            </div>
        </div>

        <div class="card-body p-lg-4">
            <form method="post" action="{% if edit_mode %}{{ url_for('vehicles.edit_handover', id=handover.id) }}{% else %}{{ url_for('vehicles.create_handover', id=vehicle.id) }}{% endif %}" enctype="multipart/form-data" id="main-handover-form">

                {% if info_message %}
                <div class="alert alert-info border-0 shadow-sm" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle fa-2x me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-1">ملاحظة هامة!</h5>
                            <p class="mb-0">{{ info_message }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="row">
                    <!-- Vehicle Info Sidebar (Right Column) -->
                    <div class="col-lg-4 mb-4">
                        <div class="card sticky-top theme-card" style="top: 20px;">
                            <div class="card-header"><h5 class="mb-0" style="font-family: var(--font-default);"><i class="fas fa-info-circle me-2"></i>معلومات السيارة</h5></div>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between"><strong>رقم اللوحة:</strong> <span>{{ vehicle.plate_number }}</span></li>
                                <li class="list-group-item d-flex justify-content-between"><strong>النوع:</strong> <span>{{ vehicle.make }} {{ vehicle.model }}</span></li>
                                <li class="list-group-item d-flex justify-content-between"><strong>السنة:</strong> <span>{{ vehicle.year }}</span></li>
                                <li class="list-group-item d-flex justify-content-between"><strong>اللون:</strong> 
                                    <span class="badge rounded-pill" style="background-color: {{ vehicle.color|e }}; color: {{ '#000' if vehicle.color|lower in ['white', 'yellow', 'silver'] else '#fff' }}; border: 1px solid #ccc;">{{ vehicle.color }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between"><strong>الحالة:</strong>
                                    <span>
                                        {% if vehicle.status == 'available' %} <span class="badge bg-success">متاحة</span>
                                        {% elif vehicle.status == 'in_project' %} <span class="badge bg-info">في المشروع</span>
                                        {% elif vehicle.status == 'in_workshop' %} <span class="badge bg-warning text-dark">في الورشة</span>
                                        {% elif vehicle.status == 'accident' %} <span class="badge bg-danger">حادث</span>
                                        {% elif vehicle.status == 'out_of_service' %} <span class="badge bg-danger text-white"><i class="fas fa-exclamation-triangle me-1"></i>خارج الخدمة</span>
                                        {% else %} <span class="badge bg-secondary">{{ vehicle.status }}</span> {% endif %}
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Main Form Column (Left) -->
                    <div class="col-lg-8">
                        
                        <!-- Section 1: Basic Information -->
                        <h4 class="mb-3 border-bottom pb-1">المعلومات الأساسية</h4>
                        <div class="row g-3 pb-3">
                            <div class="col-md-4">
                                <label for="handover_type" class="form-label required">نوع العملية</label>
                                <select class="form-select select-auto-width" id="handover_type" name="handover_type" required {% if force_mode %}disabled{% endif %}>
                                    <option value="delivery" {% if force_mode == 'delivery' %}selected{% endif %}>تسليم سيارة لسائق</option>
                                    <option value="return" {% if force_mode == 'return' %}selected{% endif %}>استلام سيارة من سائق</option>
                                </select>
                                {% if force_mode %}
                                    <input type="hidden" name="handover_type" value="{{ force_mode }}" />
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="handover_date" class="form-label required">التاريخ</label>
                                <input type="date" class="form-control" id="handover_date" name="handover_date" required value="{% if edit_mode and handover_date %}{{ handover_date }}{% endif %}">
                            </div>
                            <div class="col-md-4">
                                <label for="handover_time" class="form-label">الوقت (اختياري)</label>
                                <input type="time" class="form-control" id="handover_time" name="handover_time">
                            </div>

                            <div class="col-md-6">
                                <label for="project_name" class="form-label">المشروع</label>
                                <input type="text" class="form-control" id="project_name" name="project_name" value="{{ vehicle.project or '' }}" placeholder="المشروع المرتبط بالعملية">
                            </div>
                            <div class="col-md-6">
                                <label for="city" class="form-label">المدينة</label>
                                <input type="text" class="form-control" id="city" name="city" value="{{ vehicle.location or '' }}" placeholder="المدينة التي تتم فيها العملية">
                            </div>

                            <div class="col-md-6">
                                <label for="mileage" class="form-label required">قراءة العداد (كم)</label>
                                <input type="number" class="form-control" id="mileage" name="mileage" min="0" required value="{% if edit_mode and handover.mileage %}{{ handover.mileage }}{% endif %}">
                            </div>
                            <div class="col-md-6">
                                <label for="fuel_level" class="form-label required">مستوى الوقود</label>
                                <select class="form-select" id="fuel_level" name="fuel_level" required>
                                    <option value="" disabled {% if not (edit_mode and handover.fuel_level) %}selected{% endif %}>-- اختر --</option>
                                    <option value="ممتلئ" {% if edit_mode and handover.fuel_level == 'ممتلئ' %}selected{% endif %}>ممتلئ</option>
                                    <option value="3/4" {% if edit_mode and handover.fuel_level == '3/4' %}selected{% endif %}>3/4</option>
                                    <option value="1/2" {% if edit_mode and handover.fuel_level == '1/2' %}selected{% endif %}>1/2</option>
                                    <option value="1/4" {% if edit_mode and handover.fuel_level == '1/4' %}selected{% endif %}>1/4</option>
                                    <option value="منخفض" {% if edit_mode and handover.fuel_level == 'منخفض' %}selected{% endif %}>منخفض</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <label for="reason_for_change" class="form-label">سبب تغيير المركبة / الغرض</label>
                                <textarea class="form-control" id="reason_for_change" name="reason_for_change" rows="2" placeholder="مثال: تسليم السيارة للموظف..."></textarea>
                            </div>
                        </div>

                        <!-- Driver Section -->
                        <div class="card border mb-4">
                            <div class="card-header"><h5 class="mb-0">السائق</h5></div>
                            <div class="card-body">
                                {% if force_mode == 'return' and current_driver_info %}
                                    <div class="mb-3">
                                        <label class="form-label">الاسم</label>
                                        <input type="text" class="form-control" value="{{ current_driver_info.person_name }}" readonly disabled>
                                        <div class="form-text text-primary fw-bold">يتم استلام السيارة من السائق الحالي</div>
                                        <input type="hidden" id="person_name" name="person_name" value="{{ current_driver_info.person_name }}">
                                        <input type="hidden" id="employee_id" name="employee_id" value="{{ current_driver_info.employee_id or '' }}">
                                    </div>
                                {% else %}
                                    <div class="mb-3">
                                        <label for="person_name" class="form-label required">الاسم</label>
                                        <input type="text" class="form-control" id="person_name" name="person_name" required autocomplete="off" placeholder="اكتب الاسم أو اختر موظف من القائمة" value="{% if edit_mode and handover.person_name %}{{ handover.person_name }}{% endif %}">
                                        <input type="hidden" id="employee_id" name="employee_id" value="{% if edit_mode and handover.employee_id %}{{ handover.employee_id }}{% endif %}">
                                    </div>

                                    <div class="accordion" id="employeeSearchAccordion">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEmployeeSearch">بحث عن سائق</button>
                                            </h2>
                                            <div id="collapseEmployeeSearch" class="accordion-collapse collapse" data-bs-parent="#employeeSearchAccordion">
                                                <div class="accordion-body">
                                                    <div class="row mb-3">
                                                        <div class="col-md-4">
                                                            <select class="form-select form-select-sm" id="departmentSelect">
                                                                <option value="">كل الأقسام</option>
                                                                {% for department in departments %}<option value="{{ department.id }}">{{ department.name }}</option>{% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="col-md-8">
                                                            <div class="input-group">
                                                                <input type="text" class="form-control form-control-sm" id="employeeSearchInput" placeholder="بحث بالاسم أو الرقم..">
                                                                <button class="btn btn-outline-primary btn-sm" id="searchEmployeeBtn" type="button"><i class="fas fa-search"></i></button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                                        <table class="table table-sm table-striped table-hover">
                                                            <thead>
                                                                <tr><th>الاسم</th><th>الرقم الوظيفي</th><th>القسم</th><th>الإجراء</th></tr>
                                                            </thead>
                                                            <tbody id="employeesTableBody">
                                                                {% for employee in employees %}
                                                                    {% set dept_names = employee.departments|map(attribute='name')|join(', ') %}
                                                                    {% set dept_ids = employee.departments|map(attribute='id')|join(',') %}
                                                                    <tr class="employee-row" data-name="{{ employee.name }}" data-employee-id="{{ employee.employee_id or '' }}" data-national-id="{{ employee.national_id or '' }}" data-department="{{ dept_names }}" data-department-id="{{ dept_ids }}" data-id="{{ employee.id }}">
                                                                        <td>{{ employee.name }}</td>
                                                                        <td>{{ employee.employee_id or '-' }}</td>
                                                                        <td>
                                                                            {% for dept in employee.departments %}
                                                                                <span class="badge bg-secondary me-1">{{ dept.name }}</span>
                                                                            {% else %}
                                                                                <span class="text-muted">غير محدد</span>
                                                                            {% endfor %}
                                                                        </td>
                                                                        <td>
                                                                            <button type="button" class="btn btn-sm btn-success select-employee-btn" data-name="{{ employee.name }}"><i class="fas fa-check"></i></button>
                                                                        </td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="alert alert-secondary p-2 text-center mt-2 d-none" id="noResultsAlert">لا توجد نتائج</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Supervisor Section -->
                        <div class="card border mb-4">
                            <div class="card-header"><h5 class="mb-0">بيانات المشرف</h5></div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="supervisor_name" class="form-label">اسم المشرف</label>
                                    <input type="text" class="form-control" id="supervisor_name" name="supervisor_name" autocomplete="off" placeholder="اكتب اسم المشرف أو اختر من القائمة" value="{% if edit_mode and handover.supervisor_name %}{{ handover.supervisor_name }}{% endif %}">
                                    <input type="hidden" id="supervisor_employee_id" name="supervisor_employee_id" value="{% if edit_mode and handover.supervisor_employee_id %}{{ handover.supervisor_employee_id }}{% endif %}">
                                </div>

                                <div class="accordion" id="supervisorSearchAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header"><button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSupervisorSearch">بحث عن مشرف</button></h2>
                                        <div id="collapseSupervisorSearch" class="accordion-collapse collapse" data-bs-parent="#supervisorSearchAccordion">
                                            <div class="accordion-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <select class="form-select form-select-sm" id="supervisorDepartmentSelect">
                                                            <option value="">كل الأقسام</option>
                                                            {% for department in departments %}<option value="{{ department.id }}">{{ department.name }}</option>{% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <input type="text" class="form-control form-control-sm" id="supervisorSearchInput" placeholder="بحث بالاسم أو الرقم..">
                                                    </div>
                                                </div>
                                                <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                                    <table class="table table-sm table-striped table-hover">
                                                        <thead><tr><th>الاسم</th><th>الرقم الوظيفي</th><th>الإجراء</th></tr></thead>
                                                        <tbody id="supervisorsTableBody">
                                                        {% for employee in employees %}
                                                            {% set dept_ids = employee.departments|map(attribute='id')|join(',') if employee.departments else '' %}
                                                            <tr class="supervisor-row" 
                                                                data-name="{{ employee.name }}" 
                                                                data-employee-id="{{ employee.employee_id or '' }}" 
                                                                data-department-id="{{ dept_ids }}" 
                                                                data-id="{{ employee.id }}">
                                                                <td>{{ employee.name }}</td>
                                                                <td>{{ employee.employee_id or '-' }}</td>
                                                                <td><button type="button" class="btn btn-sm btn-success select-supervisor-btn"><i class="fas fa-check"></i></button></td>
                                                            </tr>
                                                        {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Equipment & Issues Section -->
                        <div class="pt-4 mt-4 border-top">
                            <h4 class="text-primary mb-3"><i class="fas fa-tasks me-2"></i>فحص وتجهيزات السيارة</h4>
                            
                            <div class="mb-4">
                                <h5>التجهيزات المتوفرة</h5>
                                <div class="row row-cols-1 row-cols-md-2 g-2">
                                    <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" name="has_spare_tire" id="has_spare_tire" checked><label for="has_spare_tire" class="form-check-label">إطار احتياطي</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" name="has_fire_extinguisher" id="has_fire_extinguisher" checked><label for="has_fire_extinguisher" class="form-check-label">طفاية حريق</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" name="has_first_aid_kit" id="has_first_aid_kit" checked><label for="has_first_aid_kit" class="form-check-label">إسعافات أولية</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" name="has_warning_triangle" id="has_warning_triangle" checked><label for="has_warning_triangle" class="form-check-label">مثلث تحذيري</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input" type="checkbox" name="has_tools" id="has_tools" checked><label for="has_tools" class="form-check-label">أدوات</label></div></div>
                                </div>
                            </div>
                            
                            <hr class="my-4">

                            <div>
                                <h5>المشاكل الموجودة</h5>
                                <div class="row row-cols-1 row-cols-md-2 g-3">
                                    <div class="col"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_oil_leaks" id="has_oil_leaks"><label for="has_oil_leaks" class="form-check-label">تهريب زيوت</label></div></div>
                                    <div class="col"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_gear_issue" id="has_gear_issue"><label for="has_gear_issue" class="form-check-label">مشكلة الجير</label></div></div>
                                    <div class="col"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_clutch_issue" id="has_clutch_issue"><label for="has_clutch_issue" class="form-check-label">مشكلة كلتش</label></div></div>
                                    <div class="col"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_engine_issue" id="has_engine_issue"><label for="has_engine_issue" class="form-check-label">مشكلة ماكينة</label></div></div>
                                    <div class="col"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_ac_issue" id="has_ac_issue"><label for="has_ac_issue" class="form-check-label">مشكلة مكيف</label></div></div>
                                    <div class="col"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_windows_issue" id="has_windows_issue"><label for="has_windows_issue" class="form-check-label">مشكلة زجاج</label></div></div>
                                    <div class="col"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_tires_issue" id="has_tires_issue"><label for="has_tires_issue" class="form-check-label">مشكلة كفرات</label></div></div>
                                    <div class="col"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_body_issue" id="has_body_issue"><label for="has_body_issue" class="form-check-label">مشكلة هيكل</label></div></div>
                                    <div class="col"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_electricity_issue" id="has_electricity_issue"><label for="has_electricity_issue" class="form-check-label">مشكلة كهرباء</label></div></div>
                                    <div class="col"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_lights_issue" id="has_lights_issue"><label for="has_lights_issue" class="form-check-label">مشكلة أنوار</label></div></div>
                                </div>
                            </div>
                        </div>

                        <!-- Damage Diagram Section -->
                        <div class="pt-4 mt-4 border-top">
                            <h4 class="mb-3">تحديد أماكن الضرر على الهيكل</h4>
                            <div class="text-center mb-3"><div class="d-inline-block shadow-sm" style="border: 1px solid #ddd; background-color: #fff;"><canvas id="damage-canvas"></canvas></div></div>
                            <div class="card">
                                <div class="card-body d-flex flex-wrap justify-content-center align-items-center gap-3">
                                    <div class="btn-group"><button type="button" class="btn btn-outline-primary btn-sm active" id="draw-mode-btn"><i class="fas fa-pencil-alt me-1"></i>رسم</button><button type="button" class="btn btn-outline-secondary btn-sm" id="select-mode-btn"><i class="fas fa-mouse-pointer me-1"></i>تحديد</button></div>
                                    <div class="d-flex align-items-center"><label for="draw-color-picker" class="form-label mb-0 me-2 small">اللون:</label><input type="color" class="form-control form-control-color" id="draw-color-picker" value="#E53935"></div>
                                    <div class="d-flex align-items-center" style="min-width: 120px;"><label for="draw-line-width" class="form-label mb-0 me-2 small">الحجم:</label><input type="range" class="form-range" min="2" max="20" value="4" id="draw-line-width"></div>
                                    <button type="button" class="btn btn-outline-danger btn-sm" id="clear-canvas-btn"><i class="fas fa-trash-alt me-1"></i>مسح</button>
                                </div>
                            </div>
                            <input type="hidden" name="damage_diagram_data" id="damage-diagram-data">
                        </div>

                        <!-- Documentation Section -->
                        <div class="pt-4 mt-4 border-top">
                            <h4 class="mb-3 text-primary"><i class="fas fa-paperclip me-2"></i>التوثيق والملاحظات</h4>
                            
                            <div class="mb-3">
                                <label for="vehicle_condition" class="form-label required">حالة السيارة</label>
                                <textarea class="form-control" id="vehicle_condition" name="vehicle_condition" rows="3" required placeholder="وصف تفصيلي لحالة السيارة...">{% if edit_mode and handover.vehicle_condition %}{{ handover.vehicle_condition }}{% endif %}</textarea>
                            </div>
                            <div class="mb-3">
                                <label for="vehicle_status_summary" class="form-label">ملخص حالة المركبة</label>
                                <input type="text" class="form-control" id="vehicle_status_summary" name="vehicle_status_summary" placeholder="مثال: يوجد ملاحظات">
                            </div>

                            <div class="mb-3">
                                <label for="form_link" class="form-label">رابط نموذج خارجي</label>
                                <input type="url" class="form-control" id="form_link" name="form_link" placeholder="https://forms.example.com/...">
                            </div>
                            
                            <div class="mb-3">
                                <label for="form_link_2" class="form-label">رابط نموذج خارجي 2</label>
                                <input type="url" class="form-control" id="form_link_2" name="form_link_2" placeholder="https://forms.example.com/...">
                            </div>

                            <div class="mb-3">
                                <label for="files" class="form-label">ملفات توثيقية</label>
                                <input type="file" id="files" name="files" multiple class="d-none">
                                <div class="btn-group">
                                    <button class="btn btn-outline-secondary" type="button" id="trigger-file-select">
                                        <i class="fas fa-file-upload me-2"></i>اختر ملفات
                                    </button>
                                </div>
                            </div>

                            <div id="file-previews" class="row g-3 mt-2"></div>

                            {% if edit_mode and images %}
                            <div class="mt-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0"><i class="fas fa-images me-2"></i>الصور الموجودة</h5>
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllImages">
                                            <label class="form-check-label" for="selectAllImages">تحديد الكل</label>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-danger" id="deleteSelectedImages" style="display: none;">
                                            <i class="fas fa-trash me-1"></i>حذف
                                        </button>
                                    </div>
                                </div>
                                <div class="row g-3" id="existing-images-container">
                                    {% for image in images %}
                                    <div class="col-md-4" id="existing-image-{{ image.id }}">
                                        <div class="card shadow-sm h-100">
                                            <div class="position-absolute top-0 start-0 m-2" style="z-index: 10;">
                                                <input class="form-check-input image-checkbox" type="checkbox" data-image-id="{{ image.id }}" style="width: 20px; height: 20px;">
                                            </div>
                                            {% if image.is_pdf() %}
                                            <div class="card-body text-center d-flex flex-column justify-content-center align-items-center">
                                                <i class="fas fa-file-pdf fa-3x text-danger mb-2"></i>
                                                <h6 class="text-truncate small">{{ image.file_description or 'ملف PDF' }}</h6>
                                                <div class="btn-group mt-2">
                                                    <a href="/{{ image.get_path() }}" target="_blank" class="btn btn-sm btn-outline-primary">عرض</a>
                                                    <button type="button" class="btn btn-sm btn-outline-danger delete-existing-image" data-image-id="{{ image.id }}"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>
                                            {% else %}
                                            <img src="/{{ image.get_path() }}" alt="صورة" class="card-img-top" style="height:120px; object-fit: cover;">
                                            <div class="card-body p-2">
                                                <small class="text-muted d-block mb-2">{{ image.file_description or 'صورة' }}</small>
                                                <div class="btn-group w-100">
                                                    <a href="/{{ image.get_path() }}" target="_blank" class="btn btn-sm btn-outline-primary">عرض</a>
                                                    <button type="button" class="btn btn-sm btn-outline-danger delete-existing-image" data-image-id="{{ image.id }}"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <div class="d-none">
                                <div id="image-preview-template">
                                    <div class="col-md-4 preview-item">
                                        <div class="card shadow-sm h-100"><img src="" alt="" class="card-img-top preview-image" style="height:120px; object-fit: cover;">
                                            <div class="card-body p-2"><input type="text" class="form-control form-control-sm file-description" placeholder="وصف"></div>
                                            <button type="button" class="btn-close position-absolute top-0 end-0 m-1 bg-white p-2 rounded-circle shadow-sm remove-file"></button>
                                        </div>
                                    </div>
                                </div>
                                <div id="pdf-preview-template">
                                    <div class="col-md-4 preview-item">
                                        <div class="card shadow-sm h-100"><div class="card-body text-center d-flex flex-column justify-content-center align-items-center"><i class="fas fa-file-pdf fa-3x text-danger mb-2"></i><h6 class="pdf-filename text-truncate small"></h6></div>
                                            <div class="card-footer p-2"><input type="text" class="form-control form-control-sm file-description" placeholder="وصف"></div>
                                            <button type="button" class="btn-close position-absolute top-0 end-0 m-1 bg-white p-2 rounded-circle shadow-sm remove-file"></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3 mt-3">
                                <label for="notes" class="form-label">ملاحظات إضافية</label>
                                <textarea class="form-control" id="notes" name="notes" rows="2">{% if edit_mode and handover.notes %}{{ handover.notes }}{% endif %}</textarea>
                            </div>
                        </div>

                        <!-- Report Customization -->
                        <div class="pt-4 mt-4 border-top">
                            <div class="accordion" id="reportCustomizationAccordion">
                                <div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCustomization"><i class="fas fa-cog me-2"></i>تخصيص التقرير</button></h2>
                                    <div id="collapseCustomization" class="accordion-collapse collapse" data-bs-parent="#reportCustomizationAccordion">
                                        <div class="accordion-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3"><label for="custom_company_name" class="form-label">اسم شركة مخصص</label><input type="text" class="form-control" id="custom_company_name" name="custom_company_name"></div>
                                                <div class="col-md-6 mb-3"><label for="custom_logo_file" class="form-label">شعار مخصص</label><input class="form-control" type="file" id="custom_logo_file" name="custom_logo_file" accept="image/png, image/jpeg"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Signatures Section -->
                        <div class="pt-4 mt-4 border-top">
                            <h4 class="mb-3">التواقيع</h4>
                            <div class="row">
                                <div class="col-md-6 mb-4"><div class="card h-100">
                                    <div class="card-header"><h5 class="mb-0">توقيع المشرف</h5></div>
                                    <div class="card-body"><ul class="nav nav-tabs nav-fill mb-3" role="tablist"><li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#supervisor-draw-tab" type="button">رسم</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#supervisor-upload-tab" type="button">رفع</button></li></ul><div class="tab-content"><div class="tab-pane fade show active" id="supervisor-draw-tab"><div class="signature-pad-container"><canvas id="supervisor-signature-canvas"></canvas></div><button type="button" class="btn btn-sm btn-outline-secondary mt-2 clear-signature" data-canvas-id="supervisor-signature-canvas">مسح</button></div><div class="tab-pane fade" id="supervisor-upload-tab"><input type="file" class="form-control signature-upload" accept="image/*" data-target-input="supervisor-signature-data"><img src="" class="img-fluid mt-2 d-none signature-preview"></div></div></div></div></div>
                                <div class="col-md-6 mb-4"><div class="card h-100"><div class="card-header"><h5 class="mb-0">توقيع السائق</h5></div><div class="card-body"><ul class="nav nav-tabs nav-fill mb-3" role="tablist"><li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#driver-draw-tab" type="button">رسم</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#driver-upload-tab" type="button">رفع</button></li></ul><div class="tab-content"><div class="tab-pane fade show active" id="driver-draw-tab"><div class="signature-pad-container"><canvas id="driver-signature-canvas"></canvas></div><button type="button" class="btn btn-sm btn-outline-secondary mt-2 clear-signature" data-canvas-id="driver-signature-canvas">مسح</button></div><div class="tab-pane fade" id="driver-upload-tab"><input type="file" class="form-control signature-upload" accept="image/*" data-target-input="driver-signature-data"><img src="" class="img-fluid mt-2 d-none signature-preview"></div></div></div></div></div>
                            </div>

                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header"><h5 class="mb-0">مسؤول الحركة</h5></div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="movement_officer_name" class="form-label">الاسم</label>
                                            <input type="text" class="form-control" id="movement_officer_name" name="movement_officer_name">
                                        </div>
                                        <ul class="nav nav-tabs nav-fill mb-3" role="tablist">
                                            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#movement-officer-draw-tab" type="button">رسم</button></li>
                                            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#movement-officer-upload-tab" type="button">رفع</button></li>
                                        </ul>
                                        <div class="tab-content">
                                            <div class="tab-pane fade show active" id="movement-officer-draw-tab">
                                                <div class="signature-pad-container"><canvas id="movement-officer-signature-canvas"></canvas></div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2 clear-signature" data-canvas-id="movement-officer-signature-canvas">مسح</button>
                                            </div>
                                            <div class="tab-pane fade" id="movement-officer-upload-tab">
                                                <input type="file" class="form-control signature-upload" accept="image/*" data-target-input="movement-officer-signature-data">
                                                <img src="" class="img-fluid mt-2 d-none signature-preview">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="supervisor_signature_data" id="supervisor-signature-data">
                        <input type="hidden" name="driver_signature_data" id="driver-signature-data">
                        <input type="hidden" name="movement_officer_signature" id="movement-officer-signature-data">

                        <!-- Submit Button -->
                        <div class="d-grid gap-2 pt-4 mt-4 border-top">
                            <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save me-2"></i>{% if edit_mode %}حفظ التعديلات{% else %}حفظ والتقرير{% endif %}</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    
    <!-- fabric.js library for canvas drawings -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    
    <!-- Canvas drawing system (damage diagram) -->
    <script src="{{ url_for('static', filename='js/modules/vehicles/handover_canvas.js') }}"></script>
    
    <!-- Form interactions (signatures, search, file upload, image management) -->
    <script src="{{ url_for('static', filename='js/modules/vehicles/handover_interactions.js') }}"></script>
{% endblock %}
