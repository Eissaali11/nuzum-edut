<!-- تم استبدال النافذة المنبثقة بواجهة بحث مدمجة -->
<div class="main-wrapper">
<div class="container py-4">
    <!-- شريط التنقل العلوي -->
    <div class="page-navigator d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-white mb-0">
            {% if handover.handover_type == 'delivery' %}
                <i class="fas fa-share ms-2 text-success"></i>
            {% else %}
                <i class="fas fa-reply ms-2 text-info"></i>
            {% endif %}
            تعديل نموذج {{ handover_type_name }} للمركبة: {{ vehicle.plate_number }}
        </h3>
        <div>
            <a href="{{ url_for('vehicles.view_handover', id=handover.id) }}" class="btn btn-info btn-sm me-2">
                <i class="fas fa-eye ms-1"></i>
                عرض التفاصيل
            </a>
            <a href="{{ url_for('vehicles.view', id=vehicle.id) }}" class="btn btn-primary btn-sm me-2">
                <i class="fas fa-car ms-1"></i>
                تفاصيل السيارة
            </a>
            <a href="{{ url_for('vehicles.index') }}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-right ms-1"></i>
                قائمة السيارات
            </a>
        </div>
    </div>
    
    <!-- نموذج التعديل -->
    <div class="card special-card {{ 'delivery-card' if handover.handover_type == 'delivery' else 'return-card' }}">
        <div class="card-header {{ 'bg-success text-white' if handover.handover_type == 'delivery' else 'bg-info text-white' }}">
            <h5 class="mb-0">
                <i class="fas fa-edit ms-2"></i>
                تعديل نموذج {{ handover_type_name }}
            </h5>
        </div>
        <div class="card-body">
            <form method="POST">
                {{ csrf_token() }}
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="handover_date" class="form-label">تاريخ {{ handover_type_name }}:</label>
                            <input type="date" id="handover_date" name="handover_date" 
                                   class="form-control" value="{{ handover_date }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="person_name" class="form-label">اسم الشخص:</label>
                            <input type="text" id="person_name" name="person_name" 
                                   class="form-control" value="{{ handover.person_name }}" 
                                   autocomplete="off" placeholder="اكتب اسم الشخص المستلم/المسلم" required>
                            <div class="form-text">اختر موظف من القائمة أدناه</div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="card border">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">اختيار موظف</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="departmentSelect" class="form-label">اختر القسم أولاً:</label>
                                            <select class="form-select" id="departmentSelect" onchange="filterEmployees()">
                                                <option value="">جميع الأقسام</option>
                                                {% for department in departments %}
                                                <option value="{{ department.id }}">{{ department.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-8">
                                            <label for="employeeSearchInput" class="form-label">البحث عن الموظف:</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="employeeSearchInput" placeholder="البحث بالاسم أو الرقم الوظيفي أو رقم الهوية" onkeyup="if(event.key === 'Enter') filterEmployees();">
                                                <button class="btn btn-primary" id="searchEmployeeBtn" type="button" onclick="filterEmployees()">
                                                    <i class="fas fa-search"></i> بحث
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>الاسم</th>
                                                    <th>الرقم الوظيفي</th>
                                                    <th>رقم الهوية</th>
                                                    <th>القسم/المشروع</th>
                                                    <th>الإجراء</th>
                                                </tr>
                                            </thead>
                                            <tbody id="employeesTableBody">
                                                {% for employee in employees %}
                                                <tr class="employee-row" 
                                                    data-name="{{ employee.name }}" 
                                                    data-employee-id="{{ employee.employee_id }}" 
                                                    data-national-id="{{ employee.national_id }}" 
                                                    data-department="{{ employee.department.name if employee.department else 'غير محدد' }}"
                                                    data-department-id="{{ employee.department.id if employee.department else '' }}">
                                                    <td>{{ employee.name }}</td>
                                                    <td>{{ employee.employee_id or 'غير محدد' }}</td>
                                                    <td>{{ employee.national_id or 'غير محدد' }}</td>
                                                    <td>{{ employee.department.name if employee.department else 'غير محدد' }}</td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-success select-employee-btn" 
                                                                data-name="{{ employee.name }}" onclick="document.getElementById('person_name').value='{{ employee.name }}';">
                                                            <i class="fas fa-check"></i> اختيار
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="alert alert-info mt-3 d-none" id="noResultsAlert">
                                        <i class="fas fa-info-circle"></i> لا توجد نتائج مطابقة لمعايير البحث.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="mileage" class="form-label">قراءة العداد (كم):</label>
                            <input type="text" id="mileage" name="mileage" 
                                   class="form-control" value="{{ "{:,}".format(handover.mileage) }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="fuel_level" class="form-label">مستوى الوقود:</label>
                            <select id="fuel_level" name="fuel_level" class="form-select" required>
                                <option value="full" {% if handover.fuel_level == 'full' %}selected{% endif %}>ممتلئ</option>
                                <option value="three_quarters" {% if handover.fuel_level == 'three_quarters' %}selected{% endif %}>3/4</option>
                                <option value="half" {% if handover.fuel_level == 'half' %}selected{% endif %}>1/2</option>
                                <option value="quarter" {% if handover.fuel_level == 'quarter' %}selected{% endif %}>1/4</option>
                                <option value="empty" {% if handover.fuel_level == 'empty' %}selected{% endif %}>فارغ</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="form_link" class="form-label">رابط النموذج الإلكتروني:</label>
                            <input type="url" id="form_link" name="form_link" 
                                   class="form-control" value="{{ handover.form_link or '' }}">
                            <small class="text-muted">اختياري - يمكن إضافة رابط لنموذج خارجي</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="form_link_2" class="form-label">رابط نموذج خارجي (اختياري):</label>
                            <input type="url" id="form_link_2" name="form_link_2" 
                                   class="form-control" value="{{ handover.form_link_2 or '' }}">
                            <small class="text-muted">اختياري - يمكن إضافة رابط ثاني لنموذج خارجي</small>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">التجهيزات المتوفرة:</label>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="has_spare_tire" name="has_spare_tire" 
                                       {% if handover.has_spare_tire %}checked{% endif %}>
                                <label class="form-check-label" for="has_spare_tire">
                                    إطار احتياطي
                                </label>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="has_fire_extinguisher" name="has_fire_extinguisher" 
                                       {% if handover.has_fire_extinguisher %}checked{% endif %}>
                                <label class="form-check-label" for="has_fire_extinguisher">
                                    طفاية حريق
                                </label>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="has_first_aid_kit" name="has_first_aid_kit" 
                                       {% if handover.has_first_aid_kit %}checked{% endif %}>
                                <label class="form-check-label" for="has_first_aid_kit">
                                    إسعافات أولية
                                </label>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="has_warning_triangle" name="has_warning_triangle" 
                                       {% if handover.has_warning_triangle %}checked{% endif %}>
                                <label class="form-check-label" for="has_warning_triangle">
                                    مثلث تحذير
                                </label>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="has_tools" name="has_tools" 
                                       {% if handover.has_tools %}checked{% endif %}>
                                <label class="form-check-label" for="has_tools">
                                    أدوات
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="vehicle_condition" class="form-label">حالة السيارة:</label>
                            <textarea id="vehicle_condition" name="vehicle_condition" 
                                     class="form-control">{{ handover.vehicle_condition }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="notes" class="form-label">ملاحظات:</label>
                            <textarea id="notes" name="notes" 
                                     class="form-control">{{ handover.notes or '' }}</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 d-flex justify-content-between">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save ms-1"></i>
                        حفظ التعديلات
                    </button>
                    <a href="{{ url_for('vehicles.view_handover', id=handover.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times ms-1"></i>
                        إلغاء
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
</div>
