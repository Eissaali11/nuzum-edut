<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ألوان للمخططات البيانية
        const colors = [
            'rgba(75, 192, 192, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
            'rgba(255, 99, 132, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
            'rgba(199, 199, 199, 0.7)', 'rgba(83, 102, 255, 0.7)', 'rgba(40, 159, 64, 0.7)',
            'rgba(210, 99, 132, 0.7)', 'rgba(100, 192, 192, 0.7)', 'rgba(120, 162, 235, 0.7)'
        ];
        
        // مخطط توزيع الشركات المصنعة
        {% if make_stats %}
            const makeCtx = document.getElementById('makeChart').getContext('2d');
            new Chart(makeCtx, {
                type: 'pie',
                data: {
                    labels: [{% for make, _ in make_stats %}'{{ make }}',{% endfor %}],
                    datasets: [{
                        data: [{% for _, count in make_stats %}{{ count }},{% endfor %}],
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        {% endif %}
        
        // مخطط توزيع سنوات الصنع
        {% if year_stats %}
            const yearCtx = document.getElementById('yearChart').getContext('2d');
            new Chart(yearCtx, {
                type: 'bar',
                data: {
                    labels: [{% for year, _ in year_stats %}'{{ year }}',{% endfor %}],
                    datasets: [{
                        label: 'عدد السيارات',
                        data: [{% for _, count in year_stats %}{{ count }},{% endfor %}],
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        {% endif %}
        
        // مخطط أسباب الورشة
        {% if workshop_reason_stats %}
            const reasonCtx = document.getElementById('workshopReasonChart').getContext('2d');
            new Chart(reasonCtx, {
                type: 'doughnut',
                data: {
                    labels: [
                        {% for reason, _ in workshop_reason_stats %}
                            {% if reason == 'maintenance' %}'صيانة دورية'
                            {% elif reason == 'breakdown' %}'عطل'
                            {% elif reason == 'accident' %}'حادث'
                            {% else %}'{{ reason }}'{% endif %},
                        {% endfor %}
                    ],
                    datasets: [{
                        data: [{% for _, count in workshop_reason_stats %}{{ count }},{% endfor %}],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        {% endif %}
        
        // مخطط تكاليف الصيانة
        {% if top_maintenance_costs %}
            const costCtx = document.getElementById('maintenanceCostChart').getContext('2d');
            new Chart(costCtx, {
                type: 'bar',
                data: {
                    labels: [
                        {% for item in top_maintenance_costs %}
                            '{{ item.plate_number }}',
                        {% endfor %}
                    ],
                    datasets: [{
                        label: 'تكلفة الصيانة (ريال)',
                        data: [
                            {% for item in top_maintenance_costs %}
                                {{ item.total_cost }},
                            {% endfor %}
                        ],
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',  // أفقي بدلاً من عمودي
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('ar-SA') + ' ريال';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.formattedValue.toLocaleString('ar-SA') + ' ريال';
                                }
                            }
                        }
                    }
                }
            });
        {% endif %}
    });
</script>
