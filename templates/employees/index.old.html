{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h1>
        <div>
            <a href="{{ url_for('employees.create') }}" class="btn btn-success">
                <i class="fas fa-plus me-1"></i> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù
            </a>
            <a href="{{ url_for('employees.import_excel') }}" class="btn btn-primary">
                <i class="fas fa-file-import me-1"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel
            </a>
            <a href="{{ url_for('employees.export_excel') }}" class="btn btn-secondary">
                <i class="fas fa-file-export me-1"></i> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h5>
            <div class="text-muted small">
                <i class="fas fa-info-circle"></i>
                <span>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
            </div>
        </div>
        
        <!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙØ±Ø² Ø§Ù„Ù…Ø­Ø³Ù†Ø© -->
        <div class="p-3 border-bottom bg-light">
            <form method="GET" action="{{ url_for('employees.index') }}" id="filterForm">
                <div class="row">
                    <!-- Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ -->
                    <div class="col-md-6 mb-2">
                        <div class="input-group shadow-sm">
                            <span class="input-group-text bg-white border-0">
                                <i class="fas fa-search text-primary"></i>
                            </span>
                            <input type="text" id="searchInput" class="form-control border-0 shadow-none" 
                                   placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¸Ù (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©ØŒ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„)" 
                                   aria-label="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¸Ù">
                        </div>
                    </div>
                    
                    <!-- ÙÙ„ØªØ± Ø§Ù„Ù‚Ø³Ù… -->
                    <div class="col-md-2 mb-2">
                        <select name="department" class="form-select" onchange="this.form.submit()">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}" {% if current_department == dept.id|string %}selected{% endif %}>
                                {{ dept.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© -->
                    <div class="col-md-2 mb-2">
                        <select name="status" class="form-select" onchange="this.form.submit()">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                            <option value="active" {% if current_status == 'active' %}selected{% endif %}>Ù†Ø´Ø·</option>
                            <option value="inactive" {% if current_status == 'inactive' %}selected{% endif %}>ØºÙŠØ± Ù†Ø´Ø·</option>
                            <option value="on_leave" {% if current_status == 'on_leave' %}selected{% endif %}>ÙÙŠ Ø¥Ø¬Ø§Ø²Ø©</option>
                            <option value="terminated" {% if current_status == 'terminated' %}selected{% endif %}>Ù…ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„</option>
                        </select>
                    </div>
                    
                    <!-- ÙÙ„ØªØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© -->
                    <div class="col-md-2 mb-2">
                        <select name="multi_department" class="form-select" onchange="this.form.submit()">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
                            <option value="yes" {% if current_multi_department == 'yes' %}selected{% endif %}>
                                Ø£ÙƒØ«Ø± Ù…Ù† Ù‚Ø³Ù… ({{ multi_dept_count }})
                            </option>
                            <option value="no" {% if current_multi_department == 'no' %}selected{% endif %}>
                                Ù‚Ø³Ù… ÙˆØ§Ø­Ø¯ ({{ single_dept_count }})
                            </option>
                        </select>
                    </div>
                </div>
                
                <!-- ØµÙ Ø«Ø§Ù†ÙŠ Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© -->
                <div class="row">
                    <!-- ÙÙ„ØªØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ø¯ÙˆÙ† Ø£Ù‚Ø³Ø§Ù… -->
                    <div class="col-md-3 mb-2">
                        <select name="no_department" class="form-select" onchange="this.form.submit()">
                            <option value="">Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                            <option value="yes" {% if current_no_department == 'yes' %}selected{% endif %}>
                                âš ï¸ Ø¨Ø¯ÙˆÙ† Ø£Ù‚Ø³Ø§Ù… ({{ no_dept_count }})
                            </option>
                        </select>
                    </div>
                    
                    <!-- ÙÙ„ØªØ± Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙƒØ±Ø±Ø© -->
                    <div class="col-md-3 mb-2">
                        <select name="duplicate_names" class="form-select" onchange="this.form.submit()">
                            <option value="">Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</option>
                            <option value="yes" {% if current_duplicate_names == 'yes' %}selected{% endif %}>
                                ğŸ”„ Ø£Ø³Ù…Ø§Ø¡ Ù…ÙƒØ±Ø±Ø© ({{ duplicate_names_count }})
                            </option>
                        </select>
                    </div>
                    
                    <div class="col-md-6 mb-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ø¯ÙˆÙ† Ø£Ù‚Ø³Ø§Ù… Ø£Ùˆ Ø¨Ø£Ø³Ù…Ø§Ø¡ Ù…ÙƒØ±Ø±Ø©
                        </small>
                    </div>
                </div>
                
                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
                <div class="row mt-2">
                    <div class="col-md-8">
                        <div id="searchResultsInfo" class="small text-muted" style="display:none;">
                            Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: <strong id="employeeCount">0</strong> Ù…ÙˆØ¸Ù
                        </div>
                        
                        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø© -->
                        {% if current_department or current_status or current_multi_department or current_no_department or current_duplicate_names %}
                        <div class="small text-info">
                            <i class="fas fa-filter me-1"></i>
                            Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù†Ø´Ø·Ø©: 
                            {% if current_department %}
                                {% for dept in departments %}
                                    {% if dept.id|string == current_department %}
                                        <span class="badge bg-primary me-1">{{ dept.name }}</span>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            {% if current_status %}
                                <span class="badge bg-success me-1">
                                    {% if current_status == 'active' %}Ù†Ø´Ø·
                                    {% elif current_status == 'inactive' %}ØºÙŠØ± Ù†Ø´Ø·
                                    {% elif current_status == 'on_leave' %}ÙÙŠ Ø¥Ø¬Ø§Ø²Ø©
                                    {% elif current_status == 'terminated' %}Ù…ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„
                                    {% endif %}
                                </span>
                            {% endif %}
                            {% if current_multi_department %}
                                <span class="badge bg-warning me-1">
                                    {% if current_multi_department == 'yes' %}Ø£ÙƒØ«Ø± Ù…Ù† Ù‚Ø³Ù…
                                    {% else %}Ù‚Ø³Ù… ÙˆØ§Ø­Ø¯{% endif %}
                                </span>
                            {% endif %}
                            {% if current_no_department %}
                                <span class="badge bg-danger me-1">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Ø¨Ø¯ÙˆÙ† Ø£Ù‚Ø³Ø§Ù…
                                </span>
                            {% endif %}
                            {% if current_duplicate_names %}
                                <span class="badge bg-info me-1">
                                    <i class="fas fa-copy me-1"></i>Ø£Ø³Ù…Ø§Ø¡ Ù…ÙƒØ±Ø±Ø©
                                </span>
                            {% endif %}
                            <a href="{{ url_for('employees.index') }}" class="btn btn-sm btn-outline-secondary ms-2">
                                <i class="fas fa-times me-1"></i> Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§ØªØ±
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        <small class="text-muted">
                            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: <strong>{{ employees|length }}</strong>
                        </small>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="card-body">
            <div class="table-horizontal-scroll">
                <table id="employeesTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                            <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                            <th>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                            <th>Ø§Ù„Ù‚Ø³Ù…</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in employees %}
                        <tr class="{% if employee.status == 'inactive' %}table-secondary text-muted{% elif employee.status == 'on_leave' %}table-warning{% elif employee.status == 'terminated' %}text-muted{% endif %}">
                            <td>{{ employee.employee_id }}</td>
                            <td>
                                {% if employee.status == 'terminated' %}
                                    <del>{{ employee.name }}</del>
                                {% else %}
                                    {{ employee.name }}
                                {% endif %}
                                {% if employee.name in duplicate_names_set %}
                                    <span class="badge bg-warning text-dark ms-1" title="Ø§Ø³Ù… Ù…ÙƒØ±Ø±">
                                        <i class="fas fa-copy"></i>
                                    </span>
                                {% endif %}
                            </td>
                            <td>{{ employee.national_id }}</td>
                            <td>{{ employee.mobile }}</td>
                            <td>{{ employee.job_title }}</td>
                            <td>
                                {%- if employee.departments -%}
                                    {%- if employee.departments|length > 1 -%}
                                        <div class="d-flex flex-wrap">
                                            {%- for dept in employee.departments -%}
                                                <span class="badge bg-primary me-1 mb-1">{{ dept.name }}</span>
                                            {%- endfor -%}
                                        </div>
                                        <small class="text-success">
                                            <i class="fas fa-layer-group me-1"></i>Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                                        </small>
                                    {%- else -%}
                                        <span class="badge bg-secondary">{{ employee.departments[0].name }}</span>
                                    {%- endif -%}
                                {%- else -%}
                                    <span class="text-muted">-</span>
                                {%- endif -%}
                            </td>
                            <td>
                                {% if employee.status == 'active' %}
                                <span class="badge bg-success">Ù†Ø´Ø·</span>
                                {% elif employee.status == 'inactive' %}
                                <span class="badge bg-danger">ØºÙŠØ± Ù†Ø´Ø·</span>
                                {% elif employee.status == 'on_leave' %}
                                <span class="badge bg-warning">ÙÙŠ Ø¥Ø¬Ø§Ø²Ø©</span>
                                {% elif employee.status == 'terminated' %}
                                <span class="badge bg-dark">Ù…ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ employee.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if employee.join_date %}
                                <span class="gregorian-date">{{ employee.join_date.strftime('%d/%m/%Y') }}</span>
                                <span class="hijri-date" style="display: none;"></span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{{ url_for('employees.view', id=employee.id) }}" class="btn btn-sm btn-info" title="Ø¹Ø±Ø¶">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('employees.edit', id=employee.id) }}" class="btn btn-sm btn-primary" title="ØªØ¹Ø¯ÙŠÙ„">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ url_for('employees.confirm_delete', id=employee.id) }}" class="btn btn-sm btn-danger" title="Ø­Ø°Ù">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                                

                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Ø¥Ø¶Ø§ÙØ© Ù†Øµ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
<div id="alertContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 5"></div>

<script>
// Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ø­Ø«
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const searchResultsInfo = document.getElementById('searchResultsInfo');
    const employeeCountElement = document.getElementById('employeeCount');
    const employeeRows = document.querySelectorAll('table#employeesTable tbody tr');
    
    // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø«
    if (searchButton && searchInput) {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¨Ø­Ø«
        searchButton.addEventListener('click', function() {
            performSearch();
        });
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
    }
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø«
    function performSearch() {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Øµ Ø§Ù„Ø¨Ø­Ø«
        const searchTerm = searchInput.value.trim().toLowerCase();
        let foundCount = 0;
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« ÙØ§Ø±ØºØ§Ù‹ØŒ Ø£Ø¸Ù‡Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
        if (searchTerm === '') {
            employeeRows.forEach(row => {
                row.style.display = '';
                row.classList.remove('table-primary');
            });
            searchResultsInfo.style.display = 'none';
            return;
        }
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ ØµÙ
        employeeRows.forEach(row => {
            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ØµÙ
            const cells = row.querySelectorAll('td');
            let rowText = '';
            
            cells.forEach(cell => {
                // Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø®Ù„ÙŠØ© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ù† Ø§Ù„Ø¨Ø­Ø«
                if (!cell.querySelector('.btn-group')) {
                    rowText += cell.textContent.trim() + ' ';
                }
            });
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«
            if (rowText.toLowerCase().includes(searchTerm)) {
                row.style.display = '';
                row.classList.add('table-primary'); // ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
                foundCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
        searchResultsInfo.style.display = 'block';
        if (employeeCountElement) {
            employeeCountElement.textContent = foundCount;
        }
        
        // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        if (foundCount > 0) {
            showAlert(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${foundCount} Ù…ÙˆØ¸Ù ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«`, 'success');
        } else {
            showAlert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬', 'warning');
        }
    }
    
    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡
    function showAlert(message, type) {
        const alertContainer = document.getElementById('alertContainer');
        const alertId = `alert-${Date.now()}`;
        
        const alertHtml = `
            <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show shadow-sm" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
            </div>
        `;
        
        alertContainer.insertAdjacentHTML('beforeend', alertHtml);
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
        setTimeout(() => {
            const alertElement = document.getElementById(alertId);
            if (alertElement) {
                const bsAlert = new bootstrap.Alert(alertElement);
                bsAlert.close();
            }
        }, 5000);
    }
});
</script>
{% endblock %}
