function toggleCustodyFields() {
    const employeeType = document.getElementById('employee_type').value;
    const custodySection = document.getElementById('custody-section');
    
    if (employeeType === 'driver') {
        custodySection.style.display = 'block';
    } else {
        custodySection.style.display = 'none';
        // إخفاء وإلغاء تحديد حقول الجوال
        document.getElementById('has_mobile_custody').checked = false;
        toggleMobileFields();
    }
}

function toggleMobileFields() {
    const hasMobileCustody = document.getElementById('has_mobile_custody').checked;
    const mobileFields = document.getElementById('mobile-fields');
    
    if (hasMobileCustody) {
        mobileFields.style.display = 'block';
    } else {
        mobileFields.style.display = 'none';
        // مسح قيم حقول الجوال
        document.getElementById('mobile_type').value = '';
        document.getElementById('mobile_imei').value = '';
        document.getElementById('mobile').value = '';
        // مسح قيم حقول البحث
        const phoneSearch = document.getElementById('phone_search');
        const imeiSearch = document.getElementById('imei_search');
        if (phoneSearch) phoneSearch.value = '';
        if (imeiSearch) imeiSearch.value = '';
    }
}

// إعداد الحالة الافتراضية عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    toggleCustodyFields();
    initializeImeiDropdown();
    initializePhoneDropdown();
    initializeMobileDropdown();
    initializeDepartmentPills();
});

// دالة إعداد الشارات التفاعلية للأقسام
function initializeDepartmentPills() {
    const departmentPills = document.querySelectorAll('.department-pill');
    
    departmentPills.forEach(pill => {
        pill.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target-id');
            const targetCheckbox = document.getElementById(targetId);
            
            if (targetCheckbox) {
                // تبديل حالة الـ checkbox
                targetCheckbox.checked = !targetCheckbox.checked;
                
                // تبديل ظهور الشارة
                if (targetCheckbox.checked) {
                    this.classList.add('active');
                    this.style.backgroundColor = '#28a745';
                    this.style.borderColor = '#28a745';
                } else {
                    this.classList.remove('active');
                    this.style.backgroundColor = '#6c757d';
                    this.style.borderColor = '#6c757d';
                }
            }
        });
    });
}

// دالة إظهار/إخفاء حقل اسم الكفيل
function toggleSponsorNameField() {
    const sponsorshipStatus = document.getElementById('sponsorship_status').value;
    const sponsorNameField = document.getElementById('sponsor-name-field');
    
    if (sponsorshipStatus === 'outside') {
        sponsorNameField.style.display = 'none';
    } else {
        sponsorNameField.style.display = 'block';
    }
}

// دالة إعداد القائمة المنسدلة القابلة للبحث للهاتف الأساسي (العمل)
function initializeMobileDropdown() {
    const searchInput = document.getElementById('mobile_search');
    const dropdownList = document.getElementById('mobile_dropdown_list');
    const hiddenInput = document.getElementById('mobile');
    const dropdownItems = document.querySelectorAll('.mobile-dropdown-item');
    
    if (!searchInput || !dropdownList || !hiddenInput) return;
    
    // إظهار القائمة عند التركيز على حقل البحث
    searchInput.addEventListener('focus', function() {
        dropdownList.style.display = 'block';
        filterMobileDropdownItems('');
    });
    
    // البحث في الأرقام أثناء الكتابة
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        filterMobileDropdownItems(searchTerm);
        dropdownList.style.display = 'block';
        
        // تحديث القيمة المخفية
        hiddenInput.value = searchTerm;
    });
    
    // إخفاء القائمة عند النقر خارجها
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdownList.contains(e.target)) {
            dropdownList.style.display = 'none';
        }
    });
    
    // التعامل مع اختيار عنصر من القائمة
    dropdownItems.forEach(item => {
        item.addEventListener('click', function() {
            const value = this.dataset.value;
            searchInput.value = value;
            hiddenInput.value = value;
            dropdownList.style.display = 'none';
        });
        
        // تأثيرات التمرير
        item.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e3f2fd';
            this.style.color = '#1976d2';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#ffffff';
            this.style.color = '#333';
        });
    });
    
    // دالة فلترة العناصر
    function filterMobileDropdownItems(searchTerm) {
        dropdownItems.forEach(item => {
            const phoneNumber = item.dataset.value;
            const text = item.textContent.toLowerCase();
            
            if (phoneNumber.includes(searchTerm) || text.includes(searchTerm.toLowerCase())) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
}

// دالة إعداد القائمة المنسدلة القابلة للبحث للهاتف
function initializePhoneDropdown() {
    const searchInput = document.getElementById('phone_search');
    const dropdownList = document.getElementById('phone_dropdown_list');
    const hiddenInput = document.getElementById('mobile');
    const dropdownItems = document.querySelectorAll('.phone-dropdown-item');
    
    if (!searchInput || !dropdownList || !hiddenInput) return;
    
    // إظهار القائمة عند التركيز على حقل البحث
    searchInput.addEventListener('focus', function() {
        dropdownList.style.display = 'block';
        filterPhoneDropdownItems('');
    });
    
    // البحث في الأرقام أثناء الكتابة
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        filterPhoneDropdownItems(searchTerm);
        dropdownList.style.display = 'block';
        
        // تحديث القيمة المخفية
        hiddenInput.value = searchTerm;
    });
    
    // إخفاء القائمة عند النقر خارجها
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdownList.contains(e.target)) {
            dropdownList.style.display = 'none';
        }
    });
    
    // التعامل مع اختيار عنصر من القائمة
    dropdownItems.forEach(item => {
        item.addEventListener('click', function() {
            const value = this.dataset.value;
            searchInput.value = value;
            hiddenInput.value = value;
            dropdownList.style.display = 'none';
        });
        
        // تأثيرات التمرير
        item.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e3f2fd';
            this.style.color = '#1976d2';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#ffffff';
            this.style.color = '#333';
        });
    });
    
    // دالة فلترة العناصر
    function filterPhoneDropdownItems(searchTerm) {
        dropdownItems.forEach(item => {
            const phoneNumber = item.dataset.value;
            const text = item.textContent.toLowerCase();
            
            if (phoneNumber.includes(searchTerm) || text.includes(searchTerm.toLowerCase())) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
}

// دالة إعداد القائمة المنسدلة القابلة للبحث لرقم IMEI
function initializeImeiDropdown() {
    const searchInput = document.getElementById('imei_search');
    const dropdownList = document.getElementById('imei_dropdown_list');
    const hiddenInput = document.getElementById('mobile_imei');
    const dropdownItems = document.querySelectorAll('.imei-dropdown-item');
    
    if (!searchInput || !dropdownList || !hiddenInput) return;
    
    // إظهار القائمة عند التركيز على حقل البحث
    searchInput.addEventListener('focus', function() {
        dropdownList.style.display = 'block';
        filterImeiDropdownItems('');
    });
    
    // البحث في الأرقام أثناء الكتابة
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        filterImeiDropdownItems(searchTerm);
        dropdownList.style.display = 'block';
        
        // تحديث القيمة المخفية
        hiddenInput.value = searchTerm;
    });
    
    // إخفاء القائمة عند النقر خارجها
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdownList.contains(e.target)) {
            dropdownList.style.display = 'none';
        }
    });
    
    // التعامل مع اختيار عنصر من القائمة
    dropdownItems.forEach(item => {
        item.addEventListener('click', function() {
            const value = this.dataset.value;
            searchInput.value = value;
            hiddenInput.value = value;
            dropdownList.style.display = 'none';
        });
        
        // تأثيرات التمرير
        item.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e3f2fd';
            this.style.color = '#1976d2';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#ffffff';
            this.style.color = '#333';
        });
    });
    
    // دالة فلترة العناصر
    function filterImeiDropdownItems(searchTerm) {
        dropdownItems.forEach(item => {
            const imeiNumber = item.dataset.value;
            const text = item.textContent.toLowerCase();
            
            if (imeiNumber.includes(searchTerm) || text.includes(searchTerm.toLowerCase())) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
}

// إضافة CSS محسن للقوائم المنسدلة
const dropdownCSS = document.createElement('style');
dropdownCSS.textContent = `
    .mobile-dropdown-list, .phone-dropdown-list, .imei-dropdown-list {
        border: 1px solid #bdc3c7 !important;
        background: #ffffff !important;
        color: #2c3e50 !important;
    }
    
    .mobile-dropdown-item, .phone-dropdown-item, .imei-dropdown-item {
        color: #2c3e50 !important;
        background: #ffffff !important;
        transition: all 0.2s ease;
    }
    
    .mobile-dropdown-item:hover, .phone-dropdown-item:hover, .imei-dropdown-item:hover {
        background: #e3f2fd !important;
        color: #1976d2 !important;
    }
    
    .mobile-dropdown-item div, .phone-dropdown-item div, .imei-dropdown-item div {
        color: inherit !important;
    }
    
    .mobile-dropdown-item:last-child, .phone-dropdown-item:last-child, .imei-dropdown-item:last-child {
        border-bottom: none !important;
    }
    
    /* تصميم الأقسام التفاعلية */
    .department-pills-container {
        background: #f8f9fa;
        min-height: 50px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: flex-start;
        align-content: flex-start;
    }
    
    .department-pill {
        font-size: 13px;
        padding: 8px 15px;
        margin: 3px;
        cursor: pointer;
        border: 2px solid #6c757d;
        background-color: #6c757d;
        color: white;
        border-radius: 20px;
        transition: all 0.3s ease;
        user-select: none;
        display: inline-flex;
        align-items: center;
    }
    
    .department-pill:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .department-pill.active {
        background-color: #28a745 !important;
        border-color: #28a745 !important;
        color: white;
    }
    
    .department-pill i {
        transition: transform 0.2s ease;
    }
    
    .department-pill.active i {
        transform: scale(1.1);
    }
`;
document.head.appendChild(dropdownCSS);
</script>

