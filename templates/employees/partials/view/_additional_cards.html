<div class="row">
    <div class="col-md-6 mb-4">
        <div class="dashboard-card card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-check me-2"></i>سجلات الحضور الأخيرة
                </h5>
            </div>
            <div class="card-body">
                {% if attendances %}
                <div class="table-responsive">
                    <table class="enhanced-table table-sm">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>الحالة</th>
                                <th>الحضور</th>
                                <th>الانصراف</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attendance in attendances %}
                            <tr class="status-{{ attendance.status }} attendance-row {% if loop.index > 5 %}d-none extra-attendance-row{% endif %}">
                                <td class="attendance-date" data-date="{{ attendance.date }}" data-label="التاريخ">
                                    {% if attendance.date %}
                                    <span>{{ attendance.date.strftime('%d/%m/%Y') }}</span>
                                    {% else %}
                                    <span>-</span>
                                    {% endif %}
                                </td>
                                <td data-label="الحالة">
                                    {% if attendance.status == 'present' %}
                                    <span class="badge-enhanced bg-success">حاضر</span>
                                    {% elif attendance.status == 'absent' %}
                                    <span class="badge-enhanced bg-danger">غائب</span>
                                    {% elif attendance.status == 'leave' %}
                                    <span class="badge-enhanced bg-warning">إجازة</span>
                                    {% elif attendance.status == 'sick' %}
                                    <span class="badge-enhanced bg-info">مرضي</span>
                                    {% else %}
                                    <span class="badge-enhanced bg-secondary">{{ attendance.status }}</span>
                                    {% endif %}
                                </td>
                                <td data-label="الحضور">{{ attendance.check_in.strftime('%H:%M') if attendance.check_in else '-' }}</td>
                                <td data-label="الانصراف">{{ attendance.check_out.strftime('%H:%M') if attendance.check_out else '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-2">
                    <a href="{{ url_for('employees.export_attendance_excel', id=employee.id) }}" class="btn-enhanced btn-success-enhanced btn-sm">
                        <i class="fas fa-file-excel"></i> تصدير إلى إكسل
                    </a>
                    <a href="{{ url_for('attendance.employee_attendance', employee_id=employee.id) }}" class="btn-enhanced btn-info-enhanced btn-sm">
                        <i class="fas fa-calendar-check"></i> عرض التفصيلية
                    </a>
                    <button id="showAllDaysBtn" class="btn-enhanced btn-primary-enhanced btn-sm">
                        <i class="fas fa-eye"></i> عرض كل الأيام
                    </button>
                </div>
                {% else %}
                <p class="text-center my-4">لا توجد سجلات حضور</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="dashboard-card card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-money-bill-wave me-2"></i>سجلات الرواتب
                </h5>
            </div>
            <div class="card-body">
                {% if salaries %}
                <div class="table-responsive">
                    <table class="enhanced-table table-sm">
                        <thead>
                            <tr>
                                <th>الشهر/السنة</th>
                                <th>الراتب الأساسي</th>
                                <th>إجمالي المستحقات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for salary in salaries[:5] %}
                            <tr>
                                <td data-label="الشهر/السنة">{{ salary.month }}/{{ salary.year }}</td>
                                <td data-label="الراتب الأساسي">{{ salary.basic_salary }}</td>
                                <td data-label="إجمالي المستحقات">{{ salary.net_salary }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-2">
                    <a href="{{ url_for('salaries.index', employee_id=employee.id) }}" class="btn-enhanced btn-success-enhanced btn-sm">
                        عرض جميع الرواتب
                    </a>
                </div>
                {% else %}
                <p class="text-center my-4">لا توجد سجلات رواتب</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="dashboard-card card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i>الوثائق المسجلة
                    <small class="text-muted">v2.2</small>
                </h5>
                <div>
                    <a href="{{ url_for('documents_refactored.export_employee_documents_pdf', employee_id=employee.id) }}" class="btn-enhanced btn-danger-enhanced btn-sm" title="تصدير PDF">
                        <i class="fas fa-file-pdf"></i> PDF
                    </a>
                    <a href="{{ url_for('documents_refactored.export_employee_documents_excel', employee_id=employee.id) }}" class="btn-enhanced btn-success-enhanced btn-sm" title="تصدير Excel">
                        <i class="fas fa-file-excel"></i> Excel
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% set existing_documents = [] %}
                {% for doc_type, doc_name in document_types_map.items() %}
                    {% if documents_by_type[doc_type] %}
                        {% set _ = existing_documents.append((doc_type, doc_name)) %}
                    {% endif %}
                {% endfor %}

                {% if existing_documents %}
                <div class="row">
                    {% for doc_type, doc_name in existing_documents %}
                    <div class="col-md-6 mb-3">
                        <div class="dashboard-card card h-100 border-{{ documents_by_type[doc_type].status_class }}">
                            <div class="card-header bg-{{ documents_by_type[doc_type].status_class }} text-white">
                                <h6 class="card-title mb-0">{{ doc_name }}</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong>رقم الوثيقة:</strong> {{ documents_by_type[doc_type].document_number }}</p>
                                <p class="mb-2"><strong>تاريخ الإصدار:</strong> {{ documents_by_type[doc_type].issue_date.strftime('%d/%m/%Y') if documents_by_type[doc_type].issue_date else '—' }}</p>
                                <p class="mb-2"><strong>تاريخ الانتهاء:</strong> {{ documents_by_type[doc_type].expiry_date.strftime('%d/%m/%Y') if documents_by_type[doc_type].expiry_date else '—' }}</p>
                                <p class="mb-2">
                                    <strong>الحالة:</strong>
                                    <span class="badge-enhanced bg-{{ documents_by_type[doc_type].status_class }}">{{ documents_by_type[doc_type].status_text }}</span>
                                </p>
                                {% if documents_by_type[doc_type].notes %}
                                <p class="mb-0"><strong>ملاحظات:</strong> {{ documents_by_type[doc_type].notes }}</p>
                                {% endif %}
                            </div>
                            <div class="card-footer d-flex justify-content-between">
                                <form action="{{ url_for('documents.delete', id=documents_by_type[doc_type].id) }}" method="post" onsubmit="return confirm('هل أنت متأكد من حذف هذه الوثيقة؟');">
                                    <button type="submit" class="btn-enhanced btn-danger-enhanced btn-sm">
                                        <i class="fas fa-trash-alt"></i> حذف
                                    </button>
                                </form>
                                <a href="{{ url_for('documents.create', employee_id=employee.id, document_type=doc_type) }}" class="btn-enhanced btn-primary-enhanced btn-sm">
                                    <i class="fas fa-edit"></i> تعديل
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">لا توجد وثائق مسجلة</h5>
                    <p class="text-muted">لم يتم رفع أي وثائق لهذا الموظف بعد</p>
                </div>
                {% endif %}

                <div class="text-center mt-4">
                    <div class="dropdown">
                        <button class="btn-enhanced btn-success-enhanced dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-plus me-2"></i>إضافة وثيقة جديدة
                        </button>
                        <ul class="dropdown-menu dropdown-menu-center ">
                            {% for doc_type, doc_name in document_types_map.items() %}
                            {% if not documents_by_type[doc_type] %}
                            <li>
                                <a class="dropdown-item" href="{{ url_for('documents.create', employee_id=employee.id, document_type=doc_type) }}">
                                    <i class="fas fa-file-alt me-2"></i>{{ doc_name }}
                                </a>
                            </li>
                            {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="dashboard-card card">
            <div class="card-header">
                <h6 class="mb-0">إحصائيات الحضور للشهر الحالي</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    {% set present_count = attendances|selectattr('status', 'eq', 'present')|list|length %}
                    {% set absent_count = attendances|selectattr('status', 'eq', 'absent')|list|length %}
                    {% set leave_count = attendances|selectattr('status', 'eq', 'leave')|list|length %}
                    {% set sick_count = attendances|selectattr('status', 'eq', 'sick')|list|length %}
                    {% set total_count = present_count + absent_count + leave_count + sick_count %}

                    <div class="col-md-3 text-center mb-3">
                        <div class="stat-card p-3 bg-success text-white rounded">
                            <h3 class="stat-value">{{ present_count }}</h3>
                            <small>أيام الحضور</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="stat-card p-3 bg-danger text-white rounded">
                            <h3 class="stat-value">{{ absent_count }}</h3>
                            <small>أيام الغياب</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="stat-card p-3 bg-warning text-white rounded">
                            <h3 class="stat-value">{{ leave_count }}</h3>
                            <small>إجازات</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="stat-card p-3 bg-info text-white rounded">
                            <h3 class="stat-value">{{ sick_count }}</h3>
                            <small>إجازات مرضية</small>
                        </div>
                    </div>

                    <div class="col-12 mt-3">
                        {% set attendance_rate = (present_count / total_count * 100)|round|int if total_count > 0 else 0 %}
                        <p class="mb-1">نسبة الحضور: {{ attendance_rate }}%</p>
                        <div class="progress">
                            <div class="progress-bar
                                {% if attendance_rate >= 90 %}bg-success
                                {% elif attendance_rate >= 75 %}bg-info
                                {% elif attendance_rate >= 50 %}bg-warning
                                {% else %}bg-danger{% endif %}"
                                role="progressbar" style="width: {{ attendance_rate }}%"
                                aria-valuenow="{{ attendance_rate }}" aria-valuemin="0" aria-valuemax="100">
                                {{ attendance_rate }}%
                            </div>
                        </div>
                    </div>

                    <div class="col-12 mt-3">
                        <p class="mb-1">متوسط ساعات العمل اليومية: <span class="fw-bold">8.5</span> ساعة</p>
                        <div class="progress">
                            <div class="progress-bar bg-info" role="progressbar" style="width: 85%"
                                aria-valuenow="85" aria-valuemin="0" aria-valuemax="100">
                                8.5 ساعة
                            </div>
                        </div>
                    </div>

                    <div class="col-12 mt-4">
                        <h6>توزيع حالات الحضور</h6>
                        <div class="chart-container">
                            <canvas id="attendanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
