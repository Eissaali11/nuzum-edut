// تعريف الدوال العامة
function toggleCustodyFields() {
    const employeeType = document.getElementById('employee_type').value;
    const custodySection = document.getElementById('custody-section');
    
    if (employeeType === 'driver') {
        custodySection.style.display = 'block';
    } else {
        custodySection.style.display = 'none';
        // إخفاء وإلغاء تحديد حقول الجوال
        document.getElementById('has_mobile_custody').checked = false;
        toggleMobileFields();
    }
}

function toggleMobileFields() {
    const hasMobileCustody = document.getElementById('has_mobile_custody').checked;
    const mobileFields = document.getElementById('mobile-fields');
    
    if (hasMobileCustody) {
        mobileFields.style.display = 'block';
    } else {
        mobileFields.style.display = 'none';
        // مسح قيم حقول الجوال إذا لم تكن معبأة من قبل
        if (!mobileFields.dataset.hasExistingData) {
            document.getElementById('mobile_type').value = '';
            document.getElementById('mobile_imei').value = '';
        }
    }
}

function toggleSponsorNameField() {
    const sponsorshipStatus = document.getElementById('sponsorship_status').value;
    const sponsorNameField = document.getElementById('sponsor-name-field');
    const sponsorNameInput = document.getElementById('current_sponsor_name');
    
    if (sponsorshipStatus === 'outside') {
        // إذا كان خارج الكفالة، إخفاء حقل اسم الكفيل
        sponsorNameField.style.display = 'none';
        sponsorNameInput.value = ''; // مسح القيمة
    } else {
        // إذا كان على الكفالة، إظهار حقل اسم الكفيل
        sponsorNameField.style.display = 'block';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM is ready. Initializing employee edit scripts...");

    // --- بداية منطق شارات الأقسام التفاعلية ---
    const departmentPills = document.querySelectorAll('.department-pill');
    
    // التحقق مما إذا تم العثور على أي شارات
    console.log(`Found ${departmentPills.length} department pills.`);

    departmentPills.forEach(pill => {
        pill.addEventListener('click', function() {
            // 1. تبديل المظهر البصري للشارة
            this.classList.toggle('active');

            // 2. العثور على معرف مربع الاختيار المرتبط
            const targetCheckboxId = this.dataset.targetId;
            const targetCheckbox = document.getElementById(targetCheckboxId);

            if (targetCheckbox) {
                // 3. عكس حالة مربع الاختيار المخفي
                targetCheckbox.checked = !targetCheckbox.checked;
                console.log(`Checkbox #${targetCheckboxId} is now ${targetCheckbox.checked ? 'checked' : 'unchecked'}`);
            } else {
                console.error(`Could not find checkbox with ID: ${targetCheckboxId}`);
            }
        });
    });
    // --- نهاية منطق شارات الأقسام التفاعلية ---
    
    // إعداد الحالة الافتراضية للحقول الشرطية عند تحميل الصفحة
    toggleCustodyFields();
    toggleSponsorNameField();
    
    // إعداد searchable dropdown للجوال العمل
    initializeMobileDropdown();
    
    // إعداد searchable dropdown لرقم IMEI
    initializeImeiDropdown();
});

// دالة إعداد القائمة المنسدلة القابلة للبحث لجوال العمل
function initializeMobileDropdown() {
    const searchInput = document.getElementById('mobile_search');
    const dropdownList = document.getElementById('mobile_dropdown_list');
    const hiddenInput = document.getElementById('mobile');
    const dropdownItems = document.querySelectorAll('.mobile-dropdown-item');
    
    if (!searchInput || !dropdownList || !hiddenInput) {
        console.error('Mobile dropdown elements not found');
        return;
    }
    
    console.log('Initializing mobile dropdown with current value:', hiddenInput.value);
    
    // إظهار القائمة عند التركيز على حقل البحث
    searchInput.addEventListener('focus', function() {
        dropdownList.style.display = 'block';
        filterDropdownItems('');
    });
    
    // البحث في الأرقام أثناء الكتابة
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        filterDropdownItems(searchTerm);
        dropdownList.style.display = 'block';
        
        // تحديث القيمة المخفية
        hiddenInput.value = searchTerm;
        console.log('Updated hidden input value to:', searchTerm);
    });
    
    // إخفاء القائمة عند النقر خارجها
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdownList.contains(e.target)) {
            dropdownList.style.display = 'none';
        }
    });
    
    // التعامل مع اختيار عنصر من القائمة
    dropdownItems.forEach(item => {
        item.addEventListener('click', function() {
            const value = this.dataset.value;
            searchInput.value = value;
            hiddenInput.value = value;
            dropdownList.style.display = 'none';
            console.log('Selected mobile number:', value);
        });
        
        // تأثيرات التمرير
        item.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e3f2fd';
            this.style.color = '#1976d2';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#ffffff';
            this.style.color = '#333';
        });
    });
    
    // إضافة معالج إرسال النموذج للتأكد من حفظ القيمة
    const form = searchInput.closest('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // التأكد من أن القيمة المخفية تحتوي على القيمة الصحيحة
            const finalValue = searchInput.value.trim();
            hiddenInput.value = finalValue;
            console.log('Form submitting with mobile value:', finalValue);
        });
    }
    
    // دالة فلترة العناصر
    function filterDropdownItems(searchTerm) {
        dropdownItems.forEach(item => {
            const phoneNumber = item.dataset.value;
            const text = item.textContent.toLowerCase();
            
            if (phoneNumber.includes(searchTerm) || text.includes(searchTerm.toLowerCase())) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
}

// إضافة CSS محسن للقائمة المنسدلة
const mobileDropdownCSS = document.createElement('style');
mobileDropdownCSS.textContent = `
    .mobile-dropdown-list {
        border: 1px solid #bdc3c7 !important;
        background: #ffffff !important;
        color: #2c3e50 !important;
    }
    
    .mobile-dropdown-item {
        color: #2c3e50 !important;
        background: #ffffff !important;
        transition: all 0.2s ease;
    }
    
    .mobile-dropdown-item:hover {
        background: #e3f2fd !important;
        color: #1976d2 !important;
    }
    
    .mobile-dropdown-item div {
        color: inherit !important;
    }
    
    .mobile-dropdown-item:last-child {
        border-bottom: none !important;
    }
`;
document.head.appendChild(mobileDropdownCSS);

// دالة إعداد القائمة المنسدلة القابلة للبحث لرقم IMEI
function initializeImeiDropdown() {
    const searchInput = document.getElementById('imei_search');
    const dropdownList = document.getElementById('imei_dropdown_list');
    const hiddenInput = document.getElementById('mobile_imei');
    const dropdownItems = document.querySelectorAll('.imei-dropdown-item');
    
    if (!searchInput || !dropdownList || !hiddenInput) return;
    
    // إظهار القائمة عند التركيز على حقل البحث
    searchInput.addEventListener('focus', function() {
        dropdownList.style.display = 'block';
        filterImeiDropdownItems('');
    });
    
    // البحث في الأرقام أثناء الكتابة
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        filterImeiDropdownItems(searchTerm);
        dropdownList.style.display = 'block';
        
        // تحديث القيمة المخفية
        hiddenInput.value = searchTerm;
    });
    
    // إخفاء القائمة عند النقر خارجها
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdownList.contains(e.target)) {
            dropdownList.style.display = 'none';
        }
    });
    
    // التعامل مع اختيار عنصر من القائمة
    dropdownItems.forEach(item => {
        item.addEventListener('click', function() {
            const value = this.dataset.value;
            searchInput.value = value;
            hiddenInput.value = value;
            dropdownList.style.display = 'none';
        });
        
        // تأثيرات التمرير
        item.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e3f2fd';
            this.style.color = '#1976d2';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#ffffff';
            this.style.color = '#333';
        });
    });
    
    // دالة فلترة العناصر
    function filterImeiDropdownItems(searchTerm) {
        dropdownItems.forEach(item => {
            const imeiNumber = item.dataset.value;
            const text = item.textContent.toLowerCase();
            
            if (imeiNumber.includes(searchTerm) || text.includes(searchTerm.toLowerCase())) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
}

// إضافة CSS محسن للقائمة المنسدلة لـ IMEI
const imeiDropdownCSS = document.createElement('style');
imeiDropdownCSS.textContent = `
    .imei-dropdown-list {
        border: 1px solid #bdc3c7 !important;
        background: #ffffff !important;
        color: #2c3e50 !important;
    }
    
    .imei-dropdown-item {
        color: #2c3e50 !important;
        background: #ffffff !important;
        transition: all 0.2s ease;
    }
    
    .imei-dropdown-item:hover {
        background: #e3f2fd !important;
        color: #1976d2 !important;
    }
    
    .imei-dropdown-item div {
        color: inherit !important;
    }
    
    .imei-dropdown-item:last-child {
        border-bottom: none !important;
    }
`;
document.head.appendChild(imeiDropdownCSS);
