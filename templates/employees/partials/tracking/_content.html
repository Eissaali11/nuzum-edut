<div class="page-tracking-container">
    <div class="tracking-header">
        <h1>
            <i class="fas fa-map-marker-alt"></i>
            ØªØªØ¨Ø¹ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        </h1>
        <div class="tracking-header-actions">
            <a href="/employees/tracking-dashboard" class="tracking-btn">
                <i class="fas fa-chart-bar"></i>
                Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            </a>
            <a href="/employees/geofences" class="tracking-btn tracking-btn-success">
                <i class="fas fa-circle-notch"></i>
                Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©
            </a>
            <a href="/employees" class="tracking-btn tracking-btn-secondary">
                <i class="fas fa-arrow-right"></i>
                Ø§Ù„Ø¹ÙˆØ¯Ø©
            </a>
        </div>
    </div>
    
    <div class="refresh-info">
        <i class="fas fa-sync-alt"></i>
        <span>Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©</span>
    </div>
    
    <div class="tracking-main-content">
        <div class="map-container">
            <div class="map-header">
                <h2><i class="fas fa-map"></i> Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h2>
                <div>
                    <button class="tracking-btn tracking-btn-secondary" onclick="toggleMapView()" style="padding: 10px 18px; font-size: 13px;">
                        <i class="fas fa-satellite"></i>
                        <span id="mapViewText">ØµÙˆØ±Ø© Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ</span>
                    </button>
                </div>
            </div>
            <div id="map"></div>
            
            <div class="map-legend">
                <div class="legend-title">Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
                <div class="legend-item">
                    <span class="legend-dot" style="background: #10b981;"></span>
                    <span>Ù…Ø­Ø¯Ø« (Ø£Ù‚Ù„ Ù…Ù† Ø¯Ù‚ÙŠÙ‚Ø©)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot" style="background: #f59e0b;"></span>
                    <span>Ø­Ø¯ÙŠØ« (1-5 Ø¯Ù‚Ø§Ø¦Ù‚)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot" style="background: #ef4444;"></span>
                    <span>Ù‚Ø¯ÙŠÙ… (Ø£ÙƒØ«Ø± Ù…Ù† 5 Ø¯Ù‚Ø§Ø¦Ù‚)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot" style="background: #6b7280;"></span>
                    <span>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ‚Ø¹</span>
                </div>
            </div>
        </div>
        
        <div class="tracking-sidebar">
            <div class="filters-card">
                <h3><i class="fas fa-filter"></i> Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©</h3>
                
                <form method="GET" action="{{ url_for('employees.tracking') }}">
                    <div class="filter-group">
                        <label class="filter-label">Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                        <div class="search-bar">
                            <input type="text" 
                                   name="search" 
                                   class="filter-input" 
                                   placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¸Ù..." 
                                   value="{{ request.args.get('search', '') }}">
                            <button type="submit" class="btn-search">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Ø§Ù„Ù‚Ø³Ù…</label>
                        <select name="department" class="filter-select">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}" {% if request.args.get('department') == dept.id|string %}selected{% endif %}>
                                {{ dept.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                        <select name="status" class="filter-select">
                            <option value="">Ø§Ù„ÙƒÙ„</option>
                            <option value="active" {% if request.args.get('status') == 'active' %}selected{% endif %}>Ù„Ø¯ÙŠÙ‡Ù… Ù…ÙˆØ§Ù‚Ø¹</option>
                            <option value="inactive" {% if request.args.get('status') == 'inactive' %}selected{% endif %}>Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ§Ù‚Ø¹</option>
                        </select>
                    </div>
                    
                    {% if request.args.get('search') or request.args.get('department') or request.args.get('status') %}
                    <a href="{{ url_for('employees.tracking') }}" class="btn-clear" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-times"></i>
                        <span>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</span>
                    </a>
                    {% endif %}
                </form>
            </div>
            
            <div class="employees-list-card">
                <div class="list-header">
                    <h3><i class="fas fa-users"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
                    <span class="tracking-badge">{{ employees|length }}</span>
                </div>
                <div class="employees-list" id="employeesList">
                    {% if employees %}
                        {% for emp in employees %}
                        {% set location = employee_locations.get(emp.id) %}
                        {% set age_class = location.color if location else 'gray' %}
                        
                        <div class="employee-card status-{{ age_class }}" 
                             onclick="focusEmployee({{ emp.id }}, {% if location %}{{ location.latitude }}, {{ location.longitude }}{% else %}null, null{% endif %})"
                             data-emp-id="{{ emp.id }}">
                            <div class="employee-header">
                                {% if emp.photo_url %}
                                <img src="{{ emp.photo_url }}" alt="{{ emp.name }}" class="employee-photo" onerror="this.src='{{ url_for('static', filename='uploads/employees/default_avatar.svg') }}'">
                                {% else %}
                                <img src="{{ url_for('static', filename='uploads/employees/default_avatar.svg') }}" alt="{{ emp.name }}" class="employee-photo">
                                {% endif %}
                                
                                <div class="employee-info">
                                    <div class="employee-name">{{ emp.name }}</div>
                                    <div class="employee-id">{{ emp.employee_number }}</div>
                                </div>
                            </div>
                            
                            <div class="employee-details">
                                <div class="detail-item">
                                    <i class="fas fa-building"></i>
                                    <span>{{ emp.department.name if emp.department else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
                                </div>
                                
                                {% if location and location.geofence_name %}
                                <div class="detail-item">
                                    <i class="fas fa-circle-notch"></i>
                                    <span>{{ location.geofence_name }}</span>
                                </div>
                                {% endif %}
                                
                                {% if location and location.vehicle_name %}
                                <div class="detail-item">
                                    <i class="fas fa-car"></i>
                                    <span>{{ location.vehicle_name }}</span>
                                </div>
                                {% endif %}
                                
                                {% if location %}
                                <div class="detail-item">
                                    <i class="fas fa-clock"></i>
                                    {% if location.age_minutes < 1 %}
                                        <span>Ù…Ù†Ø° {{ (location.age_minutes * 60)|int }} Ø«Ø§Ù†ÙŠØ©</span>
                                    {% elif location.age_minutes < 60 %}
                                        <span>Ù…Ù†Ø° {{ location.age_minutes|int }} Ø¯Ù‚ÙŠÙ‚Ø©</span>
                                    {% else %}
                                        <span>Ù…Ù†Ø° {{ location.age_hours|round(1) }} Ø³Ø§Ø¹Ø©</span>
                                    {% endif %}
                                </div>
                                <div class="detail-item">
                                    {% if location.connection_status == 'connected' %}
                                    <span class="status-badge" style="background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid rgba(16, 185, 129, 0.3);">
                                        <span class="status-dot" style="background: #10b981; animation: blink 2s infinite;"></span>
                                        ğŸŸ¢ Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†
                                    </span>
                                    {% elif location.connection_status == 'recently_active' %}
                                    <span class="status-badge" style="background: rgba(251, 146, 60, 0.2); color: #fdba74; border: 1px solid rgba(251, 146, 60, 0.3);">
                                        <span class="status-dot" style="background: #fb923c;"></span>
                                        ğŸŸ  Ù†Ø´Ø· Ù…Ø¤Ø®Ø±Ø§Ù‹
                                    </span>
                                    {% elif location.connection_status == 'disconnected' %}
                                    <span class="status-badge" style="background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3);">
                                        <span class="status-dot" style="background: #ef4444;"></span>
                                        ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„
                                    </span>
                                    {% else %}
                                    <span class="status-badge inactive">
                                        <span class="status-dot"></span>
                                        âš« ØºÙŠØ± Ù†Ø´Ø·
                                    </span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <div class="detail-item">
                                    <span class="status-badge inactive">
                                        <span class="status-dot"></span>
                                        âš« Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ‚Ø¹
                                    </span>
                                </div>
                                {% endif %}
                                
                                <div class="detail-item" style="margin-top: 8px;">
                                    <a href="{{ url_for('employees.track_history', id=emp.id) }}" 
                                       onclick="event.stopPropagation();"
                                       style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; text-decoration: none; font-size: 13px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                                        <i class="fas fa-route"></i>
                                        <span>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØªØ¨Ø¹</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-user-slash"></i>
                            <h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ†</h3>
                            <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…ÙˆØ¸ÙÙŠÙ†</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
<div id="shareModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); z-index: 10000; justify-content: center; align-items: center; animation: fadeIn 0.3s ease;">
    <div id="shareModalContent" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); padding: 35px; border-radius: 24px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4); position: relative; animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);">
        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
    </div>
    <div onclick="closeShareModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.9); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);">
        <i class="fas fa-times" style="font-size: 20px; color: #1e1b4b;"></i>
    </div>
</div>
