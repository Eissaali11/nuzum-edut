{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid py-3" dir="rtl">
    <div class="card shadow-sm mb-3" style="border-top: 4px solid #001f3f;">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                <div>
                <h5 class="mb-1" style="color:#001f3f;">صفحة استعراض القسائم</h5>
                <div class="text-muted">مراجعة قبل الإرسال - {{ year }}-{{ '%02d'|format(month) }}</div>
                </div>
                <a class="btn btn-outline-dark btn-sm" href="{{ url_for('payroll.hr_command_center', month=month, year=year) }}">العودة لمركز الأتمتة</a>
            </div>

            <form class="row g-2 align-items-end" method="get" action="{{ url_for('payroll.payslips_review') }}">
                <div class="col-12 col-md-2">
                    <label class="form-label mb-1">الشهر</label>
                    <input class="form-control" type="number" name="month" min="1" max="12" value="{{ month }}">
                </div>
                <div class="col-12 col-md-2">
                    <label class="form-label mb-1">السنة</label>
                    <input class="form-control" type="number" name="year" min="2020" max="2100" value="{{ year }}">
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label mb-1">المشروع (اختياري)</label>
                    <input class="form-control" type="text" name="project" placeholder="مثال: Al Qassim" value="{{ project }}">
                </div>
                <div class="col-12 col-md-2">
                    <button class="btn btn-primary w-100 text-nowrap" type="submit">تحديث النتائج</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-sm mb-0">
                <thead class="table-light">
                    <tr>
                        <th>الموظف</th>
                        <th>المشروع</th>
                        <th>الصافي</th>
                        <th>رابط القسيمة الآمن</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody>
                {% for row in rows %}
                    <tr>
                        <td>{{ row.employee.name }}<br><small class="text-muted">{{ row.employee.employee_id }}</small></td>
                        <td>{{ row.employee.project or '-' }}</td>
                        <td><strong>{{ '{:,.2f}'.format(row.payroll.net_payable or 0) }} SAR</strong></td>
                        <td><a href="{{ row.secure_url }}" target="_blank">فتح الرابط الآمن</a></td>
                        <td class="d-flex gap-1 flex-wrap">
                            <a class="btn btn-sm btn-dark" style="background:#001f3f;border-color:#001f3f;" target="_blank" href="{{ url_for('payroll.generate_payslip', employee_id=row.employee.id, month_year=year ~ '-' ~ '%02d'|format(month)) }}">عرض القسيمة</a>
                            {% if row.wa_link %}
                            <a class="btn btn-sm btn-outline-success" target="_blank" href="{{ row.wa_link }}">إرسال عبر واتساب</a>
                            {% else %}
                            <span class="badge bg-secondary">لا يوجد رقم جوال</span>
                            {% endif %}
                        </td>
                    </tr>
                {% else %}
                    <tr><td colspan="5" class="text-center text-muted py-3">لا توجد سجلات ضمن الفلاتر المحددة</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
