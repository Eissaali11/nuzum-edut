<div class="process-container">
    <div class="process-shell">
    <div class="card">
        <div class="page-header">
            <div>
                <h1><i class="fas fa-cog"></i> معالجة الرواتب</h1>
                <p class="subtitle">معالجة رواتب جميع الموظفين للشهر المحدد</p>
            </div>
            <div class="period-badge">خطوة المعالجة</div>
        </div>
        
        <div class="alert alert-info">
            <strong><i class="fas fa-info-circle"></i> معلومة:</strong> ستتم معالجة رواتب جميع الموظفين النشطين
            بناءً على بيانات الحضور والخصومات المسجلة في النظام.
        </div>
        
        <form id="processForm" onsubmit="submitForm(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label for="month">اختر الشهر والسنة:</label>
                    <input type="month" id="month" name="month" required>
                    <p class="form-hint">سيتم المعالجة بناءً على بيانات الحضور لهذا الشهر</p>
                </div>
                
                <div class="form-group">
                    <label for="fiscalYear">السنة المالية:</label>
                    <select id="fiscalYear" name="fiscal_year">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                    <p class="form-hint">السنة المالية المستخدمة في المعالجة</p>
                </div>
            </div>
            
            <div class="form-group">
                <label class="checkbox-group">
                    <input type="checkbox" id="recalculate" name="recalculate" value="true">
                    <span>إعادة حساب الرواتب السابقة</span>
                </label>
                <p class="form-hint">إذا تم تحديد هذا الخيار، سيتم استبدال الرواتب المعالجة سابقاً</p>
            </div>
            
            <div class="buttons">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check"></i> بدء المعالجة
                </button>
                <a href="{{ url_for('payroll.dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> العودة
                </a>
            </div>
        </form>
        
        <!-- رسالة المعالجة -->
        <div class="processing" id="processingDiv">
            <div class="spinner"></div>
            <p class="processing-text">جارٍ معالجة الرواتب...</p>
            <p id="processingProgressText" style="color: #718096; font-size: 0.9rem; margin-top: 1rem;">
                يرجى الانتظار قد يستغرق بضع دقائق
            </p>
        </div>
        
        <!-- نتائج المعالجة -->
        <div class="results" id="resultsDiv">
            <h2 style="margin-top: 0; color: var(--success);">
                <i class="fas fa-check-circle"></i> تم المعالجة بنجاح
            </h2>
            <div class="result-item">
                <span class="result-label">عدد الموظفين المعالجين:</span>
                <span class="result-value" id="processedCount">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">إجمالي الرواتب:</span>
                <span class="result-value" id="totalPayroll">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">إجمالي الخصومات:</span>
                <span class="result-value" id="totalDeductions">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">الراتب الصافي:</span>
                <span class="result-value" id="totalNetPayable">-</span>
            </div>
            
            <div style="margin-top: 2rem;">
                <button type="button" onclick="goToReview()" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-list-check"></i> الذهاب إلى المراجعة والموافقة
                </button>
            </div>
        </div>
    </div>
    </div>
</div>

<script>
// تعيين الشهر الحالي
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    document.getElementById('month').value = `${year}-${month}`;
});

function submitForm(event) {
    event.preventDefault();
    
    const month = document.getElementById('month').value;
    const fiscalYear = document.getElementById('fiscalYear').value;
    const recalculate = document.getElementById('recalculate').checked;
    
    // إخفاء النموذج وإظهار رسالة المعالجة
    document.getElementById('processForm').style.display = 'none';
    document.getElementById('processingDiv').style.display = 'block';
    document.getElementById('resultsDiv').style.display = 'none';
    
    // إرسال الطلب
    fetch('{{ url_for("payroll.process") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `month=${encodeURIComponent(month)}&fiscal_year=${encodeURIComponent(fiscalYear)}&recalculate=${recalculate}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // إظهار النتائج
            document.getElementById('processingDiv').style.display = 'none';
            document.getElementById('resultsDiv').style.display = 'block';
            
            document.getElementById('processedCount').textContent = data.processed_count || 0;
            document.getElementById('totalPayroll').textContent = formatNumber(data.total_gross_salary || 0);
            document.getElementById('totalDeductions').textContent = formatNumber(data.total_deductions || 0);
            document.getElementById('totalNetPayable').textContent = formatNumber(data.total_net_payable || 0);
        } else {
            alert('حدث خطأ: ' + data.message);
            document.getElementById('processForm').style.display = 'block';
            document.getElementById('processingDiv').style.display = 'none';
        }
    })
    .catch(error => {
        alert('خطأ في الاتصال: ' + error);
        document.getElementById('processForm').style.display = 'block';
        document.getElementById('processingDiv').style.display = 'none';
    });
}

function formatNumber(num) {
    return new Intl.NumberFormat('ar-SA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
}

function goToReview() {
    window.location.href = '{{ url_for("payroll.review", status="pending") }}';
}
</script>
