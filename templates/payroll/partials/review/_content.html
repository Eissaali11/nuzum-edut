<div class="rv-wrap">

    <div class="rv-header">
        <div>
            <h1><i class="fas fa-list-check"></i> مراجعة الرواتب</h1>
            <p>مراجعة واعتماد مسيرات الرواتب قبل إجراءات الدفع</p>
        </div>
        <div class="rv-period"><i class="far fa-calendar-alt"></i> {{ month }}/{{ year }} &mdash; {{ status }}</div>
    </div>

    <div class="rv-stats-row">
        <div class="rv-stat s-count">
            <div class="rv-stat-icon"><i class="fas fa-users"></i></div>
            <div class="rv-stat-label">عدد الموظفين</div>
            <div class="rv-stat-value">{{ payroll_count }}</div>
        </div>
        <div class="rv-stat s-gross">
            <div class="rv-stat-icon"><i class="fas fa-arrow-up"></i></div>
            <div class="rv-stat-label">الراتب الإجمالي</div>
            <div class="rv-stat-value">{{ "{:,.0f}".format(total_gross or 0) }}</div>
            <div class="rv-stat-unit">ريال سعودي</div>
        </div>
        <div class="rv-stat s-ded">
            <div class="rv-stat-icon"><i class="fas fa-arrow-down"></i></div>
            <div class="rv-stat-label">إجمالي الخصومات</div>
            <div class="rv-stat-value">{{ "{:,.0f}".format(total_deductions or 0) }}</div>
            <div class="rv-stat-unit">ريال سعودي</div>
        </div>
        <div class="rv-stat s-net">
            <div class="rv-stat-icon"><i class="fas fa-hand-holding-usd"></i></div>
            <div class="rv-stat-label">صافي المستحقات</div>
            <div class="rv-stat-value">{{ "{:,.0f}".format(total_net or 0) }}</div>
            <div class="rv-stat-unit">ريال سعودي</div>
        </div>
    </div>

    <div class="rv-top-section">
        <div class="rv-card">
            <div class="rv-card-title"><i class="fas fa-filter"></i> تصفية النتائج</div>
            <div class="rv-filter-grid">
                <div class="rv-filter-group">
                    <label>الشهر</label>
                    <select id="monthFilter" onchange="applyFilter()">
                        {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if month == m %}selected{% endif %}>{{ m }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="rv-filter-group">
                    <label>السنة</label>
                    <select id="yearFilter" onchange="applyFilter()">
                        {% for y in range(2024, 2028) %}
                        <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="rv-filter-group">
                    <label>الحالة</label>
                    <select id="statusFilter" onchange="applyFilter()">
                        <option value="pending" {% if status == 'pending' %}selected{% endif %}>قيد الانتظار</option>
                        <option value="approved" {% if status == 'approved' %}selected{% endif %}>معتمدة</option>
                        <option value="rejected" {% if status == 'rejected' %}selected{% endif %}>مرفوضة</option>
                        <option value="paid" {% if status == 'paid' %}selected{% endif %}>مدفوعة</option>
                    </select>
                </div>
                <div class="rv-filter-group">
                    <label>القسم</label>
                    <select id="departmentFilter" onchange="applyFilter()">
                        <option value="">كل الأقسام</option>
                        {% for department in departments %}
                        <option value="{{ department.id }}" {% if selected_department_id == department.id %}selected{% endif %}>{{ department.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="rv-card" style="display:flex;flex-direction:column;align-items:center;justify-content:center;">
            <div class="rv-chart-mini">
                <canvas id="reviewDonut"></canvas>
                <div class="rv-chart-center">
                    <span class="rv-cc-val">{{ payroll_count }}</span>
                    <span class="rv-cc-sub">موظف</span>
                </div>
            </div>
            <div class="rv-legend-mini">
                <span><span class="rv-ldot" style="background:#48bb78"></span> إجمالي</span>
                <span><span class="rv-ldot" style="background:#f56565"></span> خصومات</span>
                <span><span class="rv-ldot" style="background:#667eea"></span> صافي</span>
            </div>
        </div>
    </div>

    {% if status == 'pending' %}
    <div class="rv-batch">
        <label>
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
            اختر الكل
        </label>
        <button class="rv-batch-btn" onclick="batchApprove()">
            <i class="fas fa-check-double"></i> الموافقة على المختارة
        </button>
    </div>
    {% endif %}

    <div class="rv-table-card">
        <div class="rv-table-scroll">
            <table class="rv-table">
                <thead>
                    <tr>
                        {% if status == 'pending' %}<th class="rv-check"><input type="checkbox" id="selectAllCheck" onchange="toggleSelectAll(this)"></th>{% endif %}
                        <th>رقم الموظف</th>
                        <th>اسم الموظف</th>
                        <th>القسم</th>
                        <th>الراتب الأساسي</th>
                        <th>المزايا</th>
                        <th>الراتب الإجمالي</th>
                        <th>الخصومات</th>
                        <th>الراتب الصافي</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payroll in payrolls %}
                    {% set employee_name = payroll.employee.name if payroll.employee and payroll.employee.name else 'غير متاح' %}
                    {% set employee_initial = employee_name[:1] if employee_name != 'غير متاح' else '؟' %}
                    <tr>
                        {% if status == 'pending' %}<td class="rv-check"><input type="checkbox" class="payroll-checkbox" value="{{ payroll.id }}"></td>{% endif %}
                        <td><span class="rv-emp-badge">{{ payroll.employee.employee_id }}</span></td>
                        <td>
                            <div class="rv-emp-cell">
                                <span class="rv-emp-avatar">{{ employee_initial }}</span>
                                <div class="rv-emp-info">
                                    <span class="rv-emp-name">{{ employee_name }}</span>
                                    <span class="rv-emp-id">{{ payroll.employee.employee_id }}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if payroll.employee.department %}
                                <span class="rv-dept-tag">{{ payroll.employee.department.name }}</span>
                            {% else %}
                                <span style="color:#a0aec0">-</span>
                            {% endif %}
                        </td>
                        <td class="rv-sal">{{ "{:,.2f}".format(payroll.basic_salary or 0) }}</td>
                        <td class="rv-sal">{{ "{:,.2f}".format((payroll.housing_allowance or 0) + (payroll.transportation or 0) + (payroll.meal_allowance or 0)) }}</td>
                        <td class="rv-sal sal-green">{{ "{:,.2f}".format(payroll.gross_salary or 0) }}</td>
                        <td class="rv-sal sal-red">{{ "{:,.2f}".format(payroll.total_deductions or 0) }}</td>
                        <td class="rv-sal sal-blue">{{ "{:,.2f}".format(payroll.net_payable or 0) }}</td>
                        <td>
                            {% if payroll.payment_status == 'pending' %}
                                <span class="rv-status st-pending">قيد الانتظار</span>
                            {% elif payroll.payment_status == 'approved' %}
                                <span class="rv-status st-approved">معتمدة</span>
                            {% elif payroll.payment_status == 'rejected' %}
                                <span class="rv-status st-rejected">مرفوضة</span>
                            {% else %}
                                <span class="rv-status st-paid">مدفوعة</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="rv-action-btns">
                                <a href="{{ url_for('payroll.payroll_details', payroll_id=payroll.id) }}" class="rv-btn b-view">
                                    <i class="fas fa-eye"></i> تفاصيل
                                </a>
                                {% if status == 'pending' %}
                                <button class="rv-btn b-approve" onclick="approvePayroll({{ payroll.id }})">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="rv-btn b-reject" onclick="rejectPayroll({{ payroll.id }})">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td class="rv-empty" colspan="{% if status == 'pending' %}11{% else %}10{% endif %}">
                            <i class="fas fa-inbox"></i>
                            لا توجد بيانات رواتب في هذه التصفية
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if payrolls %}
                <tfoot>
                    <tr class="rv-total-row">
                        <td {% if status == 'pending' %}colspan="6"{% else %}colspan="5"{% endif %} style="text-align:center;color:var(--rv-primary)"><i class="fas fa-calculator"></i> الإجمالي</td>
                        <td class="rv-sal sal-green">{{ "{:,.2f}".format(total_gross or 0) }}</td>
                        <td class="rv-sal sal-red">{{ "{:,.2f}".format(total_deductions or 0) }}</td>
                        <td class="rv-sal sal-blue">{{ "{:,.2f}".format(total_net or 0) }}</td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
</div>

<div class="rv-modal-overlay" id="approveModal">
    <div class="rv-modal">
        <h2><i class="fas fa-check-circle" style="color:var(--rv-success)"></i> تأكيد الموافقة</h2>
        <p>هل تريد الموافقة على هذا الراتب؟</p>
        <textarea id="approveNotes" placeholder="ملاحظات إضافية (اختياري)"></textarea>
        <div class="rv-modal-actions">
            <button onclick="confirmApprove()" class="rv-modal-btn mb-confirm">موافق</button>
            <button onclick="cancelApprove()" class="rv-modal-btn mb-cancel">إلغاء</button>
        </div>
    </div>
</div>

<div class="rv-modal-overlay" id="rejectModal">
    <div class="rv-modal">
        <h2><i class="fas fa-times-circle" style="color:var(--rv-danger)"></i> تأكيد الرفض</h2>
        <p>حدد السبب:</p>
        <textarea id="rejectReason" placeholder="السبب..." required></textarea>
        <div class="rv-modal-actions">
            <button onclick="confirmReject()" class="rv-modal-btn mb-reject">رفض</button>
            <button onclick="cancelReject()" class="rv-modal-btn mb-cancel">إلغاء</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function() {
    var grossV = {{ total_gross or 0 }};
    var dedV = {{ total_deductions or 0 }};
    var netV = {{ total_net or 0 }};

    new Chart(document.getElementById('reviewDonut'), {
        type: 'doughnut',
        data: {
            labels: ['الراتب الإجمالي', 'الخصومات', 'الصافي'],
            datasets: [{
                data: [grossV, dedV, netV],
                backgroundColor: ['#48bb78', '#f56565', '#667eea'],
                cutout: '68%',
                borderWidth: 2,
                borderColor: '#fff',
                hoverOffset: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    rtl: true,
                    textDirection: 'rtl',
                    backgroundColor: '#1a202c',
                    titleFont: { size: 12, weight: 'bold' },
                    bodyFont: { size: 11 },
                    padding: 8,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(ctx) {
                            return ctx.label + ': ' + ctx.parsed.toLocaleString('en-US', {minimumFractionDigits:2}) + ' SR';
                        }
                    }
                }
            }
        }
    });
})();

var currentPayrollId = null;
var approvePayrollUrlTemplate = '{{ url_for("payroll.approve_payroll", payroll_id=0) }}';
var rejectPayrollUrlTemplate = '{{ url_for("payroll.reject_payroll", payroll_id=0) }}';

function buildPayrollActionUrl(urlTemplate, payrollId, action) {
    return urlTemplate.replace(new RegExp('/0/' + action + '$'), '/' + payrollId + '/' + action);
}

function applyFilter() {
    var month = document.getElementById('monthFilter').value;
    var year = document.getElementById('yearFilter').value;
    var status = document.getElementById('statusFilter').value;
    var departmentId = document.getElementById('departmentFilter').value;
    var params = new URLSearchParams({ month: month, year: year, status: status });
    if (departmentId) params.set('department_id', departmentId);
    window.location.href = '{{ url_for("payroll.review") }}?' + params.toString();
}

function approvePayroll(id) {
    currentPayrollId = id;
    document.getElementById('approveModal').style.display = 'flex';
}

function cancelApprove() {
    document.getElementById('approveModal').style.display = 'none';
    currentPayrollId = null;
}

function confirmApprove() {
    var notes = document.getElementById('approveNotes').value;
    fetch(buildPayrollActionUrl(approvePayrollUrlTemplate, currentPayrollId, 'approve'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
        body: 'notes=' + encodeURIComponent(notes)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) { alert('تمت الموافقة بنجاح'); location.reload(); }
        else { alert('خطأ: ' + data.message); }
    });
    document.getElementById('approveModal').style.display = 'none';
}

function rejectPayroll(id) {
    currentPayrollId = id;
    document.getElementById('rejectModal').style.display = 'flex';
}

function cancelReject() {
    document.getElementById('rejectModal').style.display = 'none';
    currentPayrollId = null;
}

function confirmReject() {
    var reason = document.getElementById('rejectReason').value;
    if (!reason.trim()) { alert('يجب إدخال سبب الرفض'); return; }
    fetch(buildPayrollActionUrl(rejectPayrollUrlTemplate, currentPayrollId, 'reject'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
        body: 'reason=' + encodeURIComponent(reason)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) { alert('تم الرفض بنجاح'); location.reload(); }
        else { alert('خطأ: ' + data.message); }
    });
    document.getElementById('rejectModal').style.display = 'none';
}

function toggleSelectAll(checkbox) {
    var boxes = document.querySelectorAll('.payroll-checkbox');
    boxes.forEach(function(cb) { cb.checked = checkbox.checked; });
}

function batchApprove() {
    var selected = Array.from(document.querySelectorAll('.payroll-checkbox:checked')).map(function(cb) { return cb.value; });
    if (selected.length === 0) { alert('يجب اختيار رواتب للموافقة عليها'); return; }
    if (confirm('هل تريد الموافقة على ' + selected.length + ' راتب؟')) {
        fetch('{{ url_for("payroll.batch_approve") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
            body: JSON.stringify({ payroll_ids: selected })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) { alert(data.message); location.reload(); }
            else { alert('خطأ: ' + data.message); }
        });
    }
}
</script>
