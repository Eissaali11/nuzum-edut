{% extends "layout.html" %}

{% block extra_css %}
{% include 'partials/admin_external_safety_checks/_extra_css.html' %}
{% endblock %}

{% block content %}
{% include 'partials/admin_external_safety_checks/_content.html' %}
{% endblock %}


<style>
/* Enhanced Dark theme for Select2 Search Dropdowns */
.search-dropdown + .select2-container--default .select2-selection--single,
.vehicle-search-dropdown + .select2-container--default .select2-selection--single {
    background: linear-gradient(135deg, rgba(20, 25, 35, 0.95) 0%, rgba(15, 20, 30, 0.95) 100%) !important;
    border: 2px solid rgba(80, 100, 120, 0.5) !important;
    border-radius: 12px !important;
    height: 45px !important;
    line-height: 41px !important;
    color: #e0e0e0 !important;
    transition: all 0.3s ease !important;
    position: relative;
}

.search-dropdown + .select2-container--default .select2-selection--single:hover,
.vehicle-search-dropdown + .select2-container--default .select2-selection--single:hover {
    border-color: rgba(255, 255, 255, 0.4) !important;
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.1) !important;
}

.vehicle-search-dropdown + .select2-container--default.select2-container--focus .select2-selection--single {
    border-color: #3498db !important;
    box-shadow: 0 0 20px rgba(52, 152, 219, 0.3) !important;
}

.vehicle-search-dropdown + .select2-container--default .select2-selection--single .select2-selection__rendered,
.search-dropdown + .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #e0e0e0 !important;
    padding-left: 15px !important;
    padding-right: 40px !important;
    font-size: 14px !important;
    font-weight: 500 !important;
}

.vehicle-search-dropdown + .select2-container--default .select2-selection--single .select2-selection__placeholder,
.search-dropdown + .select2-container--default .select2-selection--single .select2-selection__placeholder {
    color: rgba(224, 224, 224, 0.7) !important;
    font-style: italic !important;
    padding-left: 15px !important;
}

/* Search icon inside select2 */
.vehicle-search-dropdown + .select2-container--default .select2-selection--single::before {
    content: '\f002';
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(255, 255, 255, 0.6);
    font-size: 16px;
    z-index: 10;
    pointer-events: none;
}

.vehicle-search-dropdown + .select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 43px !important;
    right: 8px !important;
}

.vehicle-search-dropdown + .select2-container--default .select2-selection--single .select2-selection__arrow b {
    border-color: rgba(255, 255, 255, 0.6) transparent transparent transparent !important;
    border-width: 6px 6px 0 6px !important;
}

/* Enhanced Dropdown styling */
.select2-dropdown-dark {
    background: linear-gradient(135deg, rgba(25, 35, 45, 0.98) 0%, rgba(15, 25, 35, 0.98) 100%) !important;
    backdrop-filter: blur(15px) !important;
    border: 2px solid rgba(80, 100, 120, 0.4) !important;
    border-radius: 12px !important;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5) !important;
    color: #e0e0e0 !important;
    margin-top: 4px !important;
}

.select2-dropdown-dark .select2-search--dropdown {
    padding: 12px !important;
}

.select2-dropdown-dark .select2-search--dropdown .select2-search__field {
    background: rgba(35, 45, 55, 0.9) !important;
    border: 1px solid rgba(100, 120, 140, 0.4) !important;
    border-radius: 8px !important;
    color: #e0e0e0 !important;
    padding: 8px 12px !important;
}

.select2-dropdown-dark .select2-search--dropdown .select2-search__field::placeholder {
    color: rgba(255, 255, 255, 0.6) !important;
}

.select2-dropdown-dark .select2-results__option {
    background: transparent !important;
    color: #d0d0d0 !important;
    padding: 10px 15px !important;
    border-radius: 6px !important;
    margin: 2px 8px !important;
    transition: all 0.2s ease !important;
}

.select2-dropdown-dark .select2-results__option--highlighted {
    background: linear-gradient(135deg, rgba(70, 130, 180, 0.4) 0%, rgba(60, 110, 160, 0.4) 100%) !important;
    color: #f0f0f0 !important;
    box-shadow: 0 3px 10px rgba(70, 130, 180, 0.3) !important;
}

.select2-dropdown-dark .select2-results__option--selected {
    background: linear-gradient(135deg, rgba(60, 180, 120, 0.4) 0%, rgba(50, 160, 100, 0.4) 100%) !important;
    color: #f0f0f0 !important;
    font-weight: 600 !important;
}

/* Custom scrollbar for dropdown */
.select2-dropdown-dark .select2-results__options::-webkit-scrollbar {
    width: 6px;
}

.select2-dropdown-dark .select2-results__options::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
}

.select2-dropdown-dark .select2-results__options::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
}

.select2-dropdown-dark .select2-results__options::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}

/* Clear button styling */
.vehicle-search-dropdown + .select2-container--default .select2-selection__clear {
    color: rgba(255, 255, 255, 0.6) !important;
    font-size: 16px !important;
    line-height: 1 !important;
    position: absolute !important;
    right: 30px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    z-index: 10 !important;
}

.vehicle-search-dropdown + .select2-container--default .select2-selection__clear:hover {
    color: #e74c3c !important;
}
</style>


<script>
$(document).ready(function() {
    // Initialize all filter dropdowns with Select2
    setTimeout(function() {
        $('.search-dropdown').each(function() {
            var placeholder = '';
            
            if ($(this).attr('name') === 'status_filter') {
                placeholder = 'اختر الحالة...';
            } else if ($(this).attr('name') === 'vehicle_filter') {
                placeholder = 'اختر السيارة...'; 
            } else if ($(this).attr('name') === 'department_filter') {
                placeholder = 'اختر القسم...';
            }
            
            $(this).select2({
                placeholder: placeholder,
                allowClear: true,
                dir: 'rtl',
                theme: 'default',
                width: '100%',
                dropdownCssClass: 'select2-dropdown-dark',
                minimumInputLength: 0,
                language: {
                    noResults: function() {
                        return "لا توجد نتائج مطابقة";
                    },
                    searching: function() {
                        return "جاري البحث...";
                    },
                    inputTooShort: function() {
                        return "ابحث أو اختر من القائمة";
                    }
                }
            });
        });

        // Enhanced clearFilters function
        window.clearFilters = function() {
            $('.search-dropdown').each(function() {
                $(this).val('').trigger('change');
            });
            $('#vehicleSearchSelect').val('').trigger('change');
            setTimeout(function() {
                document.getElementById('filterForm').submit();
            }, 200);
        };
    }, 500);
});
</script>

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize all filter dropdowns with Select2 and search capability
    $('.search-dropdown').each(function() {
        var placeholder = '';
        
        if ($(this).attr('name') === 'status_filter') {
            placeholder = 'اختر الحالة...';
        } else if ($(this).attr('name') === 'vehicle_filter') {
            placeholder = 'ابحث برقم السيارة...'; 
        } else if ($(this).attr('name') === 'department_filter') {
            placeholder = 'اختر القسم...';
        }
        
        $(this).select2({
            placeholder: placeholder,
            allowClear: true,
            dir: 'rtl',
            theme: 'default',
            width: '100%',
            dropdownCssClass: 'select2-dropdown-dark',
            minimumInputLength: 0,
            language: {
                noResults: function() {
                    return "لا توجد نتائج مطابقة";
                },
                searching: function() {
                    return "جاري البحث...";
                },
                inputTooShort: function() {
                    return "ابحث أو اختر من القائمة";
                }
            }
        });
    });

    // Enhanced clearFilters function
    window.clearFilters = function() {
        $('.search-dropdown').each(function() {
            $(this).val('').trigger('change');
        });
        document.getElementById('filterForm').submit();
    };
});
</script>

<!-- Upload Images Modal -->
<div class="modal fade" id="uploadImagesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--glass-bg); border: 1px solid var(--glass-border);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <h5 class="modal-title"><i class="fas fa-camera me-2"></i>إنشاء فحص سلامة من الصور</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="uploadImagesForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">اختر السيارة</label>
                        <select class="form-control vehicle-search-dropdown" name="vehicle_id" id="vehicleSelect" required>
                            <option value="">-- اختر السيارة --</option>
                            {% for vehicle in all_vehicles %}
                                {% if vehicle %}
                                <option value="{{ vehicle.id }}">{{ vehicle.plate_number }} - {{ vehicle.make }} {{ vehicle.model }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">رفع صور السيارة (يدعم HEIC من iPhone)</label>
                        <input type="file" class="form-control" name="images" id="imageInput" 
                               multiple accept="image/*,.heic,.heif" required>
                        <small class="text-muted">يمكنك رفع عدة صور معاً</small>
                    </div>
                    
                    <div id="imagePreview" class="row mt-3"></div>
                    
                    <div class="mb-3">
                        <label class="form-label">ملاحظات</label>
                        <textarea class="form-control" name="notes" rows="3" 
                                  placeholder="أضف أي ملاحظات حول الفحص..."></textarea>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>إلغاء
                    </button>
                    <button type="submit" class="btn btn-success" id="uploadBtn">
                        <i class="fas fa-upload me-1"></i>رفع وإنشاء الفحص
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
// Wrap in DOMContentLoaded to ensure elements exist
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2 for vehicle dropdown in modal
    $('#vehicleSelect').select2({
        placeholder: 'ابحث عن السيارة...',
        allowClear: true,
        dir: 'rtl',
        theme: 'default',
        width: '100%',
        dropdownParent: $('#uploadImagesModal'),
        language: {
            noResults: function() {
                return "لا توجد نتائج مطابقة";
            },
            searching: function() {
                return "جاري البحث...";
            }
        }
    });
    
    const imageInput = document.getElementById('imageInput');
    const uploadForm = document.getElementById('uploadImagesForm');
    
    if (!imageInput || !uploadForm) {
        return; // Elements not found, exit gracefully
    }
    
    // Image Preview
    imageInput.addEventListener('change', function(e) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '';
        
        const files = Array.from(e.target.files);
        files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-3';
                col.innerHTML = `
                    <div style="position: relative;">
                        <img src="${event.target.result}" class="img-fluid rounded" 
                             style="width: 100%; height: 150px; object-fit: cover;">
                        <span class="badge bg-primary" style="position: absolute; top: 5px; right: 5px;">
                            ${index + 1}
                        </span>
                    </div>
                `;
                preview.appendChild(col);
            };
            reader.readAsDataURL(file);
        });
    });
    
    // Form Submission
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const uploadBtn = document.getElementById('uploadBtn');
        const originalText = uploadBtn.innerHTML;
        
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>جاري الرفع...';
        
        try {
            const response = await fetch('{{ url_for("external_safety.admin_create_check_from_images") }}', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(result.message || 'تم إنشاء الفحص بنجاح!');
                location.reload();
            } else {
                alert(result.error || 'حدث خطأ في الرفع');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('حدث خطأ في الاتصال بالخادم');
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = originalText;
        }
    });
});
</script>



{% endblock %}

<style>
/* Override Select2 input field colors for dark theme */
.search-dropdown + .select2-container--default .select2-selection--single {
    background: linear-gradient(135deg, rgba(25, 35, 45, 0.9) 0%, rgba(15, 25, 35, 0.9) 100%) !important;
    border: 2px solid rgba(100, 120, 140, 0.4) !important;
    border-radius: 12px !important;
    height: 45px !important;
    color: #e0e0e0 !important;
    transition: all 0.3s ease !important;
}

.search-dropdown + .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #e0e0e0 !important;
    line-height: 45px !important;
    padding-left: 15px !important;
    padding-right: 40px !important;
}

.search-dropdown + .select2-container--default .select2-selection--single .select2-selection__placeholder {
    color: rgba(224, 224, 224, 0.7) !important;
}

.search-dropdown + .select2-container--default .select2-selection--single:hover {
    border-color: rgba(120, 140, 160, 0.6) !important;
    box-shadow: 0 0 15px rgba(70, 130, 180, 0.2) !important;
}
</style>

<style>
/* Force dark theme for all Select2 elements */
.select2-container--default .select2-selection--single {
    background: rgba(20, 25, 35, 0.95) !important;
    border: 2px solid rgba(80, 100, 120, 0.5) !important;
    color: #e0e0e0 !important;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #e0e0e0 !important;
}

.select2-container--default .select2-selection--single .select2-selection__placeholder {
    color: rgba(224, 224, 224, 0.7) !important;
}

/* Override any white backgrounds */
.select2-dropdown {
    background: rgba(20, 25, 35, 0.98) !important;
    border: 1px solid rgba(80, 100, 120, 0.4) !important;
}

.select2-results__option {
    background: transparent !important;
    color: #d0d0d0 !important;
}

.select2-results__option--highlighted {
    background: rgba(70, 130, 180, 0.4) !important;
    color: #f0f0f0 !important;
}

.select2-search__field {
    background: rgba(35, 45, 55, 0.9) !important;
    border: 1px solid rgba(100, 120, 140, 0.4) !important;
    color: #e0e0e0 !important;
}
</style>
