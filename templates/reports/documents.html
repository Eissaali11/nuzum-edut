{% extends 'layout.html' %}

{% block title %}تقرير الوثائق - نظام إدارة الموظفين{% endblock %}

{% block content %}
{% include 'reports/partials/documents/_content.html' %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // تنسيق الجدول بواسطة DataTables للحصول على تجربة أفضل
    $(document).ready(function() {
        // تعريف دالة للحصول على التاريخ الحالي
        function getCurrentDate() {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), now.getDate());
        }
        
        const today = getCurrentDate();
        
        $('table').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Arabic.json"
            },
            "order": [[7, "asc"]], // ترتيب حسب تاريخ الانتهاء (تصاعدي)
            "pageLength": 25,
            "paging": true,
            "info": true,
            "searching": true
        });
        
        // إعداد بيانات الرسم البياني لتوزيع الوثائق حسب النوع
        const docTypes = {
            national_id: 0,
            passport: 0,
            driver_license: 0,
            annual_leave: 0,
            health_certificate: 0,
            other: 0
        };
        
        // إعداد بيانات الرسم البياني لحالة الوثائق
        const expiryStatus = {
            expired: 0,
            expiringSoon: 0,
            valid: 0
        };
        
        // حساب إحصائيات الوثائق من البيانات المعروضة
        {% for document, employee in results %}
            // حساب توزيع الوثائق حسب النوع
            {% if document.document_type in ['national_id', 'passport', 'driver_license', 'annual_leave', 'health_certificate'] %}
                docTypes.{{ document.document_type }}++;
            {% else %}
                docTypes.other++;
            {% endif %}
            
            // حساب حالة انتهاء الوثائق
            {% set days_remaining = (document.expiry_date - now.date()).days %}
            {% if days_remaining < 0 %}
                expiryStatus.expired++;
            {% elif days_remaining <= 30 %}
                expiryStatus.expiringSoon++;
            {% else %}
                expiryStatus.valid++;
            {% endif %}
        {% endfor %}
        
        // إنشاء الرسم البياني الدائري لتوزيع الوثائق حسب النوع
        const documentTypeData = {
            labels: ['الهوية الوطنية', 'جواز السفر', 'رخصة القيادة', 'الإجازة السنوية', 'الشهادة الصحية', 'أخرى'],
            datasets: [{
                data: [
                    docTypes.national_id, 
                    docTypes.passport, 
                    docTypes.driver_license, 
                    docTypes.annual_leave, 
                    docTypes.health_certificate,
                    docTypes.other
                ],
                backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#6f42c1', '#dc3545', '#adb5bd'],
                hoverOffset: 4
            }]
        };
        
        const pieChart = new Chart(
            document.getElementById('documentTypeChart'),
            {
                type: 'pie',
                data: documentTypeData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'توزيع أنواع الوثائق'
                        }
                    }
                }
            }
        );
        
        // إنشاء الرسم البياني لحالة انتهاء الوثائق
        const expiryStatusData = {
            labels: ['منتهية', 'تنتهي قريباً', 'سارية'],
            datasets: [{
                label: 'عدد الوثائق',
                data: [expiryStatus.expired, expiryStatus.expiringSoon, expiryStatus.valid],
                backgroundColor: ['#dc3545', '#ffc107', '#198754']
            }]
        };
        
        const barChart = new Chart(
            document.getElementById('expiryStatusChart'),
            {
                type: 'bar',
                data: expiryStatusData,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'حالة انتهاء الوثائق'
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            }
        );
    });
</script>
{% endblock %}