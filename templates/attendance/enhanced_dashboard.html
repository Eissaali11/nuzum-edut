{% extends 'layout.html' %}

{% block content %}
{% include 'attendance/partials/enhanced_dashboard/_content.html' %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // تغيير التاريخ تلقائيًا
        const dateInput = document.getElementById('date');
        dateInput.addEventListener('change', function() {
            document.getElementById('filter-form').submit();
        });
        
        // إعداد الرسم البياني
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        
        // استدعاء API للحصول على البيانات
        fetch('{{ url_for("attendance_dashboard.dashboard_data") }}?date={{ selected_date.strftime("%Y-%m-%d") }}{% if selected_department_id %}&department_id={{ selected_department_id }}{% endif %}')
            .then(response => response.json())
            .then(data => {
                // إنشاء الرسم البياني
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'توزيع الحضور حسب الأقسام',
                                font: {
                                    size: 16
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
    });
    
    // دالة لإظهار/إخفاء جميع الأقسام
    function toggleAllDepartments(show) {
        const checkboxes = document.querySelectorAll('.dept-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = show;
        });
        filterDepartments();
    }
    
    // دالة لتصفية الأقسام المعروضة
    function filterDepartments() {
        const checkboxes = document.querySelectorAll('.dept-checkbox');
        const checkedIds = [];
        
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                checkedIds.push(checkbox.value);
            }
        });
        
        // إظهار أو إخفاء الصفوف حسب الاختيار
        const rows = document.querySelectorAll('.dept-row');
        rows.forEach(row => {
            const deptId = row.getAttribute('data-dept-id');
            if (checkedIds.includes(deptId)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // تحديث عدد الأقسام المعروضة
        const visibleCount = checkedIds.length;
        const totalCount = checkboxes.length;
        console.log(`عرض ${visibleCount} من ${totalCount} قسم`);
    }
</script>
{% endblock %}