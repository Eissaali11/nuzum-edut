<div class="container-fluid">
    <!-- رأس الصفحة -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-chart-line me-3"></i>عرض حضور الأقسام حسب الفترة</h1>
                <p class="mb-0 mt-2" style="opacity: 0.95;">تقارير مفصلة عن حضور الموظفين خلال فترة زمنية محددة</p>
            </div>
            <a href="{{ url_for('attendance.department_attendance') }}" class="btn btn-light btn-lg">
                <i class="fas fa-arrow-right me-2"></i> العودة
            </a>
        </div>
    </div>

    <!-- بطاقة البحث والفلترة -->
    <div class="filter-card">
        <h5><i class="fas fa-filter"></i>خيارات البحث والفلترة</h5>
        <form method="GET" action="{{ url_for('attendance.department_attendance_view') }}">
            <div class="row align-items-end">
                <div class="col-md-2 mb-3">
                    <label for="department_id" class="form-label">
                        <i class="fas fa-building me-1"></i>القسم
                    </label>
                    <select class="form-select" id="department_id" name="department_id">
                        <option value="">جميع الأقسام</option>
                        {% for department in departments %}
                        <option value="{{ department.id }}" {% if department_id == department.id|string %}selected{% endif %}>
                            {{ department.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="search_query" class="form-label">
                        <i class="fas fa-search me-1"></i>بحث عن موظف
                    </label>
                    <input type="text" class="form-control" id="search_query" name="search_query" 
                           placeholder="الاسم، رقم الهوية، أو الرقم الوظيفي"
                           value="{{ search_query or '' }}">
                </div>
                
                <div class="col-md-2 mb-3">
                    <label for="status_filter" class="form-label">
                        <i class="fas fa-filter me-1"></i>الحالة
                    </label>
                    <select class="form-select" id="status_filter" name="status_filter">
                        <option value="">جميع الحالات</option>
                        <option value="present" {% if status_filter == 'present' %}selected{% endif %}>حاضر</option>
                        <option value="absent" {% if status_filter == 'absent' %}selected{% endif %}>غائب</option>
                        <option value="leave" {% if status_filter == 'leave' %}selected{% endif %}>إجازة</option>
                        <option value="sick" {% if status_filter == 'sick' %}selected{% endif %}>مرضي</option>
                    </select>
                </div>
                
                <div class="col-md-2 mb-3">
                    <label for="start_date" class="form-label">
                        <i class="fas fa-calendar-day me-1"></i>من تاريخ
                    </label>
                    <input type="date" class="form-control" id="start_date" name="start_date" 
                           value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}">
                </div>
                
                <div class="col-md-2 mb-3">
                    <label for="end_date" class="form-label">
                        <i class="fas fa-calendar-day me-1"></i>إلى تاريخ
                    </label>
                    <input type="date" class="form-control" id="end_date" name="end_date" 
                           value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}">
                </div>
                
                <div class="col-md-2 mb-3">
                    <label for="working_days_required" class="form-label">
                        <i class="fas fa-briefcase me-1 text-warning"></i>أيام العمل المطلوبة
                    </label>
                    <input type="number" class="form-control" id="working_days_required" name="working_days_required" 
                           value="{{ working_days_required or 26 }}" min="1" max="31" placeholder="26">
                    <small class="text-muted">الحد الأدنى للحضور الكامل</small>
                </div>
                
                <div class="col-md-1 mb-3">
                    <button type="submit" class="search-btn w-100">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>

    {% if attendances %}
    <!-- بطاقات الإحصائيات -->
    <div class="stats-grid">
        <div class="stat-card total">
            <div class="stat-icon">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="stat-number">{{ total_count }}</div>
            <div class="stat-label">إجمالي السجلات</div>
        </div>
        
        <div class="stat-card present">
            <div class="stat-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-number">{{ present_count }}</div>
            <div class="stat-label">موظف حاضر</div>
        </div>
        
        <div class="stat-card absent">
            <div class="stat-icon">
                <i class="fas fa-user-times"></i>
            </div>
            <div class="stat-number">{{ absent_count }}</div>
            <div class="stat-label">موظف غائب</div>
        </div>
        
        <div class="stat-card leave">
            <div class="stat-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-number">{{ leave_count + sick_count }}</div>
            <div class="stat-label">إجازات ومرضي</div>
        </div>
    </div>

    <!-- زر التصدير حسب الفلاتر -->
    {% if attendances %}
    <div class="export-section">
        <div>
            <h6 class="mb-1" style="color: #4a5568; font-weight: 700;">
                <i class="fas fa-download me-2"></i>تصدير البيانات حسب الفلاتر
            </h6>
            <p class="mb-0" style="color: #718096; font-size: 0.9rem;">
                تصدير {{ attendances|length }} سجل إلى ملف Excel
            </p>
        </div>
        <a href="{{ url_for('attendance.export_department_data', 
                            department_id=department_id, 
                            search_query=search_query,
                            status_filter=status_filter,
                            start_date=start_date.strftime('%Y-%m-%d') if start_date else '',
                            end_date=end_date.strftime('%Y-%m-%d') if end_date else '') }}" 
           class="export-btn">
            <i class="fas fa-file-excel me-2"></i>تصدير إلى Excel
        </a>
    </div>
    {% endif %}

    <!-- جدول البيانات -->
    <div class="table-card">
        <div class="table-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-table me-2"></i>سجلات الحضور التفصيلية</h5>
            <button id="deleteSelectedBtn" class="btn btn-danger" style="display: none; border-radius: 12px;">
                <i class="fas fa-trash me-1"></i>حذف المحدد (<span id="selectedCount">0</span>)
            </button>
        </div>
        <div class="table-responsive">
            <table class="attendance-table table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" id="selectAll" class="form-check-input" style="cursor: pointer; width: 20px; height: 20px;">
                        </th>
                        <th><i class="fas fa-user me-1"></i>الموظف</th>
                        <th><i class="fas fa-id-card me-1"></i>الرقم الوظيفي</th>
                        <th><i class="fas fa-building me-1"></i>القسم</th>
                        <th><i class="fas fa-calendar me-1"></i>التاريخ</th>
                        <th><i class="fas fa-info-circle me-1"></i>الحالة</th>
                        <th><i class="fas fa-file-medical me-1"></i>ملف الإجازة</th>
                        <th><i class="fas fa-sign-in-alt me-1"></i>دخول</th>
                        <th><i class="fas fa-sign-out-alt me-1"></i>خروج</th>
                        <th><i class="fas fa-clock me-1"></i>ساعات العمل</th>
                        <th><i class="fas fa-edit me-1"></i>تعديل</th>
                    </tr>
                </thead>
                <tbody>
                    {% for attendance in attendances %}
                    <tr>
                        <td>
                            <input type="checkbox" class="attendance-checkbox form-check-input" 
                                   data-id="{{ attendance.id }}" 
                                   style="cursor: pointer; width: 20px; height: 20px;">
                        </td>
                        <td><span class="employee-name">{{ attendance.employee.name }}</span></td>
                        <td><span class="employee-id">{{ attendance.employee.employee_id }}</span></td>
                        <td>
                            {% if attendance.employee.departments %}
                                <span class="department-badge">{{ attendance.employee.departments[0].name }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td><span class="date-text">{{ attendance.date.strftime('%Y-%m-%d') }}</span></td>
                        <td>
                            {% if attendance.status == 'present' %}
                                <span class="status-badge badge-present">✓ حاضر</span>
                            {% elif attendance.status == 'absent' %}
                                <span class="status-badge badge-absent">✗ غائب</span>
                            {% elif attendance.status == 'leave' %}
                                <span class="status-badge badge-leave">إجازة</span>
                            {% elif attendance.status == 'sick' %}
                                <span class="status-badge badge-sick">مرضي</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if attendance.status == 'sick' and attendance.sick_leave_file %}
                                <div class="d-flex gap-2 justify-content-center">
                                    <a href="{{ url_for('static', filename=attendance.sick_leave_file) }}" 
                                       target="_blank" 
                                       class="btn btn-sm btn-info" 
                                       style="border-radius: 20px; padding: 6px 12px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none;"
                                       title="عرض الملف">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('static', filename=attendance.sick_leave_file) }}" 
                                       download 
                                       class="btn btn-sm btn-success" 
                                       style="border-radius: 20px; padding: 6px 12px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border: none;"
                                       title="تحميل الملف">
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if attendance.check_in %}
                                <span class="time-text">{{ attendance.check_in.strftime('%H:%M') }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if attendance.check_out %}
                                <span class="time-text">{{ attendance.check_out.strftime('%H:%M') }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if attendance.check_in and attendance.check_out %}
                                {% set hours = (attendance.check_out.hour - attendance.check_in.hour) + (attendance.check_out.minute - attendance.check_in.minute) / 60.0 %}
                                <span class="hours-badge">{{ "%.1f"|format(hours) }} ساعة</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('attendance.edit_attendance_page', id=attendance.id, department_id=department_id, start_date=start_date.strftime('%Y-%m-%d') if start_date else '', end_date=end_date.strftime('%Y-%m-%d') if end_date else '') }}" 
                               class="btn btn-sm btn-primary" style="border-radius: 20px; padding: 6px 16px;">
                                <i class="fas fa-edit me-1"></i>تعديل
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <!-- رسالة عدم وجود بيانات -->
    <div class="no-data-container">
        <div class="no-data-icon">
            <i class="fas fa-inbox"></i>
        </div>
        <div class="no-data-title">لا توجد سجلات</div>
        <div class="no-data-text">
            الرجاء تحديد القسم والفترة الزمنية للبحث عن سجلات الحضور
        </div>
    </div>
    {% endif %}
</div>
