{% extends 'layout.html' %}

{% block extra_css %}
{% include 'partials/dashboard/_extra_css.html' %}
{% endblock %}

{% block content %}
{% include 'partials/dashboard/_content.html' %}
{% endblock %}

{% block extra_js %}
<script>
// متغيرات عامة لتخزين مرجعيات المخططات
let departmentChartInstance = null;
let salaryChartInstance = null;
let documentChartInstance = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('بدء تحميل لوحة المعلومات...');
    
    // Initialize tooltips
    initializeTooltips();
    console.log('تم تهيئة التلميحات');
    
    // Initialize charts
    console.log('Chart متوفر:', typeof Chart !== 'undefined');
    if (typeof Chart !== 'undefined') {
        console.log('بدء تهيئة المخططات...');
        try {
            initializeDepartmentChart();
            console.log('تم تهيئة مخطط الأقسام');
        } catch(e) {
            console.error('خطأ في مخطط الأقسام:', e.message || e.toString());
        }
        
        try {
            initializeSalaryChart();
            console.log('تم تهيئة مخطط الرواتب');
        } catch(e) {
            console.error('خطأ في مخطط الرواتب:', e.message || e.toString());
        }
        
        try {
            initializeDocumentChart();
            console.log('تم تهيئة مخطط الوثائق');
        } catch(e) {
            console.error('خطأ في مخطط الوثائق:', e);
        }
    } else {
        console.error('Chart.js غير محمّل!');
    }
    
    // Display current date
    displayCurrentDate();
    console.log('تم عرض التاريخ');
    
    // Animate counters with delay
    setTimeout(function() {
        animateCounters();
        console.log('تم تحريك العدادات');
    }, 800);
    
    // Add loading complete log
    console.log('تم تحميل كافة مكونات لوحة المعلومات بنجاح');
});

function initializeTooltips() {
    if (typeof bootstrap !== 'undefined') {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
}

function displayCurrentDate() {
    const currentDateElement = document.getElementById('current-date');
    if (currentDateElement) {
        const now = new Date();
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        };
        currentDateElement.textContent = now.toLocaleDateString('ar-SA', options);
    }
}

function animateCounters() {
    const counters = document.querySelectorAll('.counter-value');
    
    counters.forEach((counter, index) => {
        const target = parseInt(counter.getAttribute('data-target')) || 0;
        
        // Add animation class
        counter.classList.add('counter-animate');
        
        if (target <= 0) {
            counter.textContent = '0';
            return;
        }
        
        let count = 0;
        const increment = Math.ceil(target / 50);
        const speed = Math.max(20, Math.floor(2000 / target));
        
        const updateCount = setInterval(() => {
            count += increment;
            
            if (count >= target) {
                counter.textContent = target.toLocaleString('ar-SA');
                clearInterval(updateCount);
                
                // Add pulse effect when animation completes
                counter.style.animation = 'counterPulse 0.6s ease-in-out';
            } else {
                counter.textContent = count.toLocaleString('ar-SA');
            }
        }, speed);
    });
}

function initializeDepartmentChart() {
    const departmentChartElement = document.getElementById('departmentChart');
    if (!departmentChartElement) {
        console.log('عنصر مخطط الأقسام غير موجود');
        return;
    }
    
    // تدمير أي chart موجود على canvas
    const existingChart = Chart.getChart(departmentChartElement);
    if (existingChart) {
        existingChart.destroy();
    }
    
    // تدمير المخطط القديم إذا كان موجوداً
    if (departmentChartInstance) {
        departmentChartInstance.destroy();
        departmentChartInstance = null;
    }
    
    console.log('data-labels:', departmentChartElement.getAttribute('data-labels'));
    console.log('data-values:', departmentChartElement.getAttribute('data-values'));
    
    const labels = JSON.parse(departmentChartElement.getAttribute('data-labels') || '[]');
    const values = JSON.parse(departmentChartElement.getAttribute('data-values') || '[]');
    
    console.log('تسميات الأقسام:', labels);
    console.log('قيم الأقسام:', values);
    
    const colors = [
        '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe',
        '#43e97b', '#38f9d7', '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3'
    ];
    
    if (labels.length === 0 || values.length === 0) {
        departmentChartInstance = new Chart(departmentChartElement, {
            type: 'doughnut',
            data: {
                labels: ['لا توجد بيانات'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#e9ecef'],
                    borderColor: ['#dee2e6'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    }
                }
            }
        });
        return;
    }
    
    departmentChartInstance = new Chart(departmentChartElement, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                borderColor: colors,
                borderWidth: 2,
                hoverBorderWidth: 3,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#667eea',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            let percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} موظف (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 1000
            }
        }
    });
}

function initializeSalaryChart() {
    const salaryChartElement = document.getElementById('salaryChart');
    if (!salaryChartElement) return;
    
    // تدمير أي chart موجود على canvas
    const existingChart = Chart.getChart(salaryChartElement);
    if (existingChart) {
        existingChart.destroy();
    }
    
    // تدمير المخطط القديم إذا كان موجوداً
    if (salaryChartInstance) {
        salaryChartInstance.destroy();
        salaryChartInstance = null;
    }
    
    const labels = JSON.parse(salaryChartElement.getAttribute('data-labels') || '[]');
    const values = JSON.parse(salaryChartElement.getAttribute('data-values') || '[]');
    
    if (labels.length === 0 || values.length === 0) {
        salaryChartInstance = new Chart(salaryChartElement, {
            type: 'bar',
            data: {
                labels: ['لا توجد بيانات'],
                datasets: [{
                    label: 'إجمالي الرواتب',
                    data: [0],
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        return;
    }
    
    salaryChartInstance = new Chart(salaryChartElement, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'إجمالي الرواتب',
                data: values,
                backgroundColor: 'rgba(102, 126, 234, 0.2)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
                hoverBackgroundColor: 'rgba(102, 126, 234, 0.4)',
                hoverBorderColor: 'rgba(102, 126, 234, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('ar-SA') + ' ر.س';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#667eea',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            let value = context.raw;
                            return `إجمالي الرواتب: ${value.toLocaleString('ar-SA')} ر.س`;
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });
}

function initializeDocumentChart() {
    const documentChartElement = document.getElementById('documentChart');
    if (!documentChartElement) {
        console.log('عنصر مخطط الوثائق غير موجود');
        return;
    }
    
    // تدمير أي chart موجود على canvas
    const existingChart = Chart.getChart(documentChartElement);
    if (existingChart) {
        existingChart.destroy();
    }
    
    // تدمير المخطط القديم إذا كان موجوداً
    if (documentChartInstance) {
        documentChartInstance.destroy();
        documentChartInstance = null;
    }
    
    const validCount = parseInt(documentChartElement.getAttribute('data-valid')) || 0;
    const expiringCount = parseInt(documentChartElement.getAttribute('data-expiring')) || 0;
    const expiredCount = parseInt(documentChartElement.getAttribute('data-expired')) || 0;
    
    console.log('إحصائيات الوثائق:', { validCount, expiringCount, expiredCount });
    
    if (validCount === 0 && expiringCount === 0 && expiredCount === 0) {
        console.log('لا توجد بيانات وثائق - عرض رسم افتراضي');
        documentChartInstance = new Chart(documentChartElement, {
            type: 'doughnut',
            data: {
                labels: ['لا توجد بيانات'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#e9ecef'],
                    borderColor: ['#dee2e6'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    }
                }
            }
        });
        return;
    }
    
    documentChartInstance = new Chart(documentChartElement, {
        type: 'doughnut',
        data: {
            labels: ['وثائق سارية', 'وثائق تنتهي قريباً', 'وثائق منتهية'],
            datasets: [{
                data: [validCount, expiringCount, expiredCount],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                borderColor: ['#28a745', '#ffc107', '#dc3545'],
                borderWidth: 2,
                hoverBorderWidth: 3,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#667eea',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            let percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 1000
            }
        }
    });
}
</script>
{% endblock %}