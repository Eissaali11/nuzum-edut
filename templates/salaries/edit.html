{% extends 'layout.html' %}

{% block content %}
{% include 'salaries/partials/edit/_content.html' %}
{% endblock %}

{% block extra_js %}
<script>
    function calculateNetSalary() {
        const basicSalary = parseFloat(document.getElementById('basic_salary').value) || 0;
        const allowances = parseFloat(document.getElementById('allowances').value) || 0;
        const deductions = parseFloat(document.getElementById('deductions').value) || 0;
        const bonus = parseFloat(document.getElementById('bonus').value) || 0;
        
        const netSalary = basicSalary + allowances + bonus - deductions;
        document.getElementById('net_salary_display').textContent = netSalary.toFixed(2);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // حساب صافي الراتب عند تحميل الصفحة
        calculateNetSalary();
        
        // التأكد من إدخال الراتب الأساسي
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const basicSalary = parseFloat(document.getElementById('basic_salary').value) || 0;
                if (basicSalary <= 0) {
                    e.preventDefault();
                    alert('يجب إدخال الراتب الأساسي');
                }
            });
        }
    });
    
    // دالة حساب الراتب من الحضور
    async function calculateFromAttendance() {
        const employeeId = {{ salary.employee_id }};  // استخدم ID الموظف الموجود
        const month = document.getElementById('month').value;
        const year = document.getElementById('year').value;
        
        if (!month || !year) {
            alert('يرجى اختيار الشهر والسنة');
            return;
        }
        
        const btn = document.getElementById('calculate_from_attendance_btn');
        const originalBtnText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الحساب...';
        
        try {
            const response = await fetch('/salaries/calculate_from_attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    employee_id: employeeId,
                    month: parseInt(month),
                    year: parseInt(year)
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // ملء الحقول بالبيانات المحسوبة
                document.getElementById('basic_salary').value = result.data.basic_salary.toFixed(2);
                document.getElementById('allowances').value = result.data.allowances.toFixed(2);
                document.getElementById('bonus').value = result.data.bonus.toFixed(2);
                document.getElementById('deductions').value = result.data.total_deductions.toFixed(2);
                
                // عرض ملخص الحضور
                const summaryDiv = document.getElementById('attendance_summary');
                const detailsDiv = document.getElementById('attendance_details');
                
                if (result.attendance_stats) {
                    const stats = result.attendance_stats;
                    detailsDiv.innerHTML = `
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-calendar-day text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted">إجمالي أيام الشهر</small>
                                        <div class="fw-bold">${stats.total_days} يوم</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <div>
                                        <small class="text-muted">أيام الحضور</small>
                                        <div class="fw-bold text-success">${stats.present_days} يوم</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                    <div>
                                        <small class="text-muted">أيام الغياب</small>
                                        <div class="fw-bold text-danger">${stats.absent_days} يوم</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-umbrella-beach text-info me-2"></i>
                                    <div>
                                        <small class="text-muted">أيام الإجازة</small>
                                        <div class="fw-bold text-info">${stats.leave_days} يوم</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-notes-medical text-warning me-2"></i>
                                    <div>
                                        <small class="text-muted">إجازة مرضية</small>
                                        <div class="fw-bold text-warning">${stats.sick_days} يوم</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-exclamation-circle text-secondary me-2"></i>
                                    <div>
                                        <small class="text-muted">أيام غير مسجلة</small>
                                        <div class="fw-bold text-secondary">${stats.unrecorded_days} يوم</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="alert alert-warning mb-0">
                            <strong><i class="fas fa-info-circle me-1"></i> الخصم المحسوب:</strong>
                            خصم حضور: ${result.data.attendance_deduction.toFixed(2)} ر.س | 
                            GOSI: ${(result.data.gosi_deduction || 0).toFixed(2)} ر.س | 
                            إجمالي الخصومات: ${result.data.total_deductions.toFixed(2)} ر.س
                        </div>
                    `;
                    summaryDiv.classList.remove('d-none');
                } else {
                    detailsDiv.innerHTML = '<p class="mb-0">لا توجد سجلات حضور لهذا الشهر</p>';
                    summaryDiv.classList.remove('d-none');
                }
                
                // إعادة حساب صافي الراتب
                calculateNetSalary();
                
                // عرض رسالة نجاح
                alert('تم حساب الراتب من سجلات الحضور بنجاح!');
            } else {
                alert('خطأ: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('حدث خطأ أثناء حساب الراتب: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnText;
        }
    }
</script>
{% endblock %}