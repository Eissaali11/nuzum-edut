{% extends 'layout.html' %}

{% block extra_css %}
{% include 'salaries/partials/index/_extra_css.html' %}
{% endblock %}

{% block content %}
{% include 'salaries/partials/index/_content.html' %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // إعادة تحميل الصفحة عند تغيير الشهر أو السنة أو الموظف أو القسم
    const filterFields = ['month', 'year', 'employee_id', 'department_id'];
    
    filterFields.forEach(function(field) {
        const element = document.getElementById(field);
        if (element) {
            element.addEventListener('change', function() {
                const form = this.closest('form');
                if (form) {
                    form.submit();
                }
            });
        }
    });
    
    // JavaScript لحساب صافي الراتب تلقائيًا عند إدخال البيانات في الحقول
    const salaryInputs = document.querySelectorAll('.salary-input');
    if (salaryInputs.length > 0) {
        salaryInputs.forEach(input => {
            input.addEventListener('input', function() {
                const employeeId = this.getAttribute('data-employee');
                calculateNetSalary(employeeId);
            });
        });
    }
    
    // دالة لحساب صافي الراتب
    function calculateNetSalary(employeeId) {
        const basicSalary = parseFloat(document.querySelector(`.salary-input[data-field="basic_salary"][data-employee="${employeeId}"]`)?.value || 0);
        const allowances = parseFloat(document.querySelector(`.salary-input[data-field="allowances"][data-employee="${employeeId}"]`)?.value || 0);
        const deductions = parseFloat(document.querySelector(`.salary-input[data-field="deductions"][data-employee="${employeeId}"]`)?.value || 0);
        const bonus = parseFloat(document.querySelector(`.salary-input[data-field="bonus"][data-employee="${employeeId}"]`)?.value || 0);
        
        const netSalary = basicSalary + allowances + bonus - deductions;
        
        // عرض صافي الراتب
        const netSalaryDisplay = document.querySelector(`.net-salary-display[data-employee="${employeeId}"]`);
        if (netSalaryDisplay) {
            netSalaryDisplay.textContent = netSalary.toFixed(2);
        }
    }
    
    // تفعيل زر حفظ الراتب الفردي
    const saveSalaryButtons = document.querySelectorAll('.save-salary-btn');
    if (saveSalaryButtons.length > 0) {
        saveSalaryButtons.forEach(button => {
            button.addEventListener('click', async function() {
                const employeeId = this.getAttribute('data-employee');
                const month = this.getAttribute('data-month');
                const year = this.getAttribute('data-year');
                
                // جمع بيانات الراتب
                const basicSalary = document.querySelector(`.salary-input[data-field="basic_salary"][data-employee="${employeeId}"]`).value;
                const allowances = document.querySelector(`.salary-input[data-field="allowances"][data-employee="${employeeId}"]`).value;
                const deductions = document.querySelector(`.salary-input[data-field="deductions"][data-employee="${employeeId}"]`).value;
                const bonus = document.querySelector(`.salary-input[data-field="bonus"][data-employee="${employeeId}"]`).value;
                
                // التحقق من الراتب الأساسي
                if (!basicSalary || basicSalary.trim() === '') {
                    showErrorAlert('يجب إدخال الراتب الأساسي على الأقل');
                    return;
                }
                
                try {
                    // تعطيل الزر مؤقتاً
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري الحفظ...';
                    
                    // حفظ الراتب
                    const response = await fetch('/salaries/save_smart', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            employee_id: employeeId,
                            month: month,
                            year: year,
                            basic_salary: basicSalary,
                            allowances: allowances,
                            deductions: deductions,
                            bonus: bonus
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // تغيير شكل الصف ليظهر أنه تم الحفظ
                        const row = this.closest('tr');
                        row.style.backgroundColor = '#f8f9fa';
                        row.style.borderLeft = '4px solid #28a745';
                        this.innerHTML = '<i class="fas fa-check me-1"></i> تم الحفظ';
                        this.className = 'btn-action btn-outline-success';
                        this.disabled = true;
                        
                        // تحويل حقول الإدخال إلى نص عادي مع الحفاظ على القيم
                        const inputs = row.querySelectorAll('.salary-input');
                        inputs.forEach(input => {
                            const value = input.value || '0';
                            const cell = input.parentElement;
                            cell.innerHTML = `<span class="salary-value">${parseFloat(value).toFixed(2)}</span>`;
                        });
                        
                        // تحديث صافي الراتب
                        const netSalaryDisplay = row.querySelector('.net-salary-display');
                        if (netSalaryDisplay) {
                            const netValue = netSalaryDisplay.textContent;
                            netSalaryDisplay.innerHTML = `<span class="net-salary-value">${netValue}</span>`;
                        }
                        
                        showSuccessAlert(result.message);
                    } else {
                        showErrorAlert('حدث خطأ: ' + result.message);
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-save me-1"></i> حفظ';
                    }
                    
                } catch (error) {
                    console.error('خطأ في حفظ الراتب:', error);
                    showErrorAlert('حدث خطأ في الاتصال');
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-save me-1"></i> حفظ';
                }
            });
        });
    }
    
    // زر إنهاء وحفظ جميع البيانات
    const finishAndSaveAllBtn = document.getElementById('finishAndSaveAll');
    if (finishAndSaveAllBtn) {
        finishAndSaveAllBtn.addEventListener('click', async function() {
            // جمع جميع البيانات المُدخلة (غير المحفوظة)
            const allSalaryData = [];
            const saveBtns = document.querySelectorAll('.save-salary-btn:not(.btn-outline-success)');
            
            saveBtns.forEach(btn => {
                const employeeId = btn.getAttribute('data-employee');
                const basicSalary = document.querySelector(`.salary-input[data-field="basic_salary"][data-employee="${employeeId}"]`).value;
                
                // فقط إذا كان هناك راتب أساسي مُدخل
                if (basicSalary && basicSalary.trim() !== '') {
                    const allowances = document.querySelector(`.salary-input[data-field="allowances"][data-employee="${employeeId}"]`).value;
                    const deductions = document.querySelector(`.salary-input[data-field="deductions"][data-employee="${employeeId}"]`).value;
                    const bonus = document.querySelector(`.salary-input[data-field="bonus"][data-employee="${employeeId}"]`).value;
                    const month = btn.getAttribute('data-month');
                    const year = btn.getAttribute('data-year');
                    
                    allSalaryData.push({
                        employee_id: employeeId,
                        month: month,
                        year: year,
                        basic_salary: basicSalary,
                        allowances: allowances,
                        deductions: deductions,
                        bonus: bonus
                    });
                }
            });
            
            if (allSalaryData.length === 0) {
                showErrorAlert('لا توجد بيانات رواتب مُدخلة للحفظ');
                return;
            }
            
            const confirmMsg = `سيتم حفظ رواتب ${allSalaryData.length} موظف. هل تريد المتابعة؟`;
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // تعطيل الزر وإظهار التحميل
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> جاري حفظ جميع البيانات...';
            
            try {
                const response = await fetch('/salaries/save_all_smart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        salaries: allSalaryData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccessAlert(`تم حفظ ${result.saved_count} راتب بنجاح`);
                    // إعادة تحميل الصفحة لعرض البيانات المحفوظة
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showErrorAlert('حدث خطأ: ' + result.message);
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-check-double me-2"></i> إنهاء وحفظ جميع البيانات المُدخلة';
                }
            } catch (error) {
                console.error('خطأ في حفظ جميع البيانات:', error);
                showErrorAlert('حدث خطأ في الاتصال');
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-check-double me-2"></i> إنهاء وحفظ جميع البيانات المُدخلة';
            }
        });
    }
    
    // معالجة زر الحساب الجماعي
    const bulkCalculateBtn = document.getElementById('bulkCalculateBtn');
    if (bulkCalculateBtn) {
        bulkCalculateBtn.addEventListener('click', async function() {
            const month = document.getElementById('month').value;
            const year = document.getElementById('year').value;
            const departmentId = document.getElementById('department_id').value;
            
            if (!month || !year) {
                showErrorAlert('يرجى تحديد الشهر والسنة');
                return;
            }
            
            // إعداد رسالة التأكيد بناءً على اختيار القسم
            let confirmMsg;
            if (departmentId) {
                const departmentSelect = document.getElementById('department_id');
                const departmentName = departmentSelect.options[departmentSelect.selectedIndex].text;
                confirmMsg = `سيتم حساب رواتب موظفي قسم "${departmentName}" فقط لشهر ${month}/${year} بناءً على بيانات الحضور.\n\nملاحظة: إذا أردت حساب رواتب جميع الموظفين في كل الأقسام، اختر "الكل" من قائمة الأقسام.\n\nهل تريد المتابعة؟`;
            } else {
                confirmMsg = `سيتم حساب رواتب جميع الموظفين النشطين في كل الأقسام لشهر ${month}/${year} بناءً على بيانات الحضور.\n\nهل تريد المتابعة؟`;
            }
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // تعطيل الزر وإظهار التحميل
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري حساب الرواتب...';
            
            // الحصول على عدد أيام العمل المطلوبة
            const workingDaysInput = document.getElementById('workingDaysInput');
            const workingDays = workingDaysInput ? parseInt(workingDaysInput.value) || 26 : 26;
            
            try {
                const response = await fetch('/salaries/bulk_calculate_attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        month: month,
                        year: year,
                        department_id: departmentId || null,
                        working_days_in_month: workingDays
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = `تم حساب رواتب ${result.success_count} موظف بنجاح`;
                    if (result.error_count > 0) {
                        message += `\nفشل حساب ${result.error_count} موظف`;
                        console.log('الأخطاء:', result.errors);
                    }
                    showSuccessAlert(message);
                    
                    // إعادة تحميل الصفحة لعرض البيانات المحدثة
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showErrorAlert('حدث خطأ: ' + result.message);
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-calculator me-1"></i> حساب رواتب الشهر تلقائياً';
                }
            } catch (error) {
                console.error('خطأ في الحساب الجماعي:', error);
                showErrorAlert('حدث خطأ في الاتصال');
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-calculator me-1"></i> حساب رواتب الشهر تلقائياً';
            }
        });
    }
    
    // دالة لإظهار رسائل النجاح
    function showSuccessAlert(message) {
        const alertHtml = `
            <div class="alert alert-success alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', alertHtml);
        
        // إزالة التنبيه تلقائياً بعد 5 ثوان
        setTimeout(() => {
            const alert = document.querySelector('.alert:last-of-type');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
    
    // دالة لإظهار رسائل الخطأ
    function showErrorAlert(message) {
        const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas fa-exclamation-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', alertHtml);
        
        // إزالة التنبيه تلقائياً بعد 5 ثوان
        setTimeout(() => {
            const alert = document.querySelector('.alert:last-of-type');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}