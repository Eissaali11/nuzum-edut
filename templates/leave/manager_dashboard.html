{% extends 'layout.html' %}

{% block title %}إدارة الإجازات{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #667eea;
        --success: #48bb78;
        --danger: #f56565;
        --warning: #ed8936;
        --light: #f7fafc;
        --dark: #2d3748;
    }
    .leave-container { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,.08); padding: 2rem; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: .8rem; border-bottom: 1px solid #edf2f7; text-align: right; vertical-align: top; }
    .status-badge { padding: .25rem .55rem; border-radius: 6px; font-size: .8rem; font-weight: 600; }
    .status-pending { background: #fed7d7; color: #c53030; }
    .status-approved { background: #c6f6d5; color: #22543d; }
    .status-rejected { background: #fbd38d; color: #7c2d12; }
    .btn { border: 0; border-radius: 6px; padding: .45rem .7rem; cursor: pointer; font-size: .85rem; }
    .btn-approve { background: var(--success); color: white; }
    .btn-reject { background: var(--danger); color: white; }
    .calendar-grid { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .calendar-grid th, .calendar-grid td { border: 1px solid #edf2f7; width: 14.28%; vertical-align: top; min-height: 110px; height: 110px; padding: .4rem; }
    .day-num { font-weight: 700; color: var(--dark); margin-bottom: .3rem; }
    .event-item { font-size: .75rem; border-radius: 4px; padding: .18rem .35rem; margin-bottom: .2rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .event-pending { background: #fed7d7; color: #742a2a; }
    .event-approved { background: #c6f6d5; color: #22543d; }
    .event-rejected { background: #fbd38d; color: #7c2d12; }
    .controls { display: flex; gap: .6rem; align-items: center; margin-bottom: .8rem; }
</style>
{% endblock %}

{% block content %}
<div class="leave-container">
    <h1 style="margin-bottom:1rem;"><i class="fas fa-user-check"></i> إدارة طلبات الإجازة</h1>

    <h3>الطلبات المعلقة</h3>
    <table class="table" id="pendingTable">
        <thead>
            <tr>
                <th>الموظف</th>
                <th>النوع</th>
                <th>الفترة</th>
                <th>الأيام</th>
                <th>السبب</th>
                <th>الإجراء</th>
            </tr>
        </thead>
        <tbody>
            {% for req in pending_requests %}
            <tr id="req-row-{{ req.id }}">
                <td>{{ req.employee.name if req.employee else req.employee_id }}</td>
                <td>{{ req.leave_type }}</td>
                <td>{{ req.start_date }} → {{ req.end_date }}</td>
                <td>{{ req.working_days }}</td>
                <td>{{ req.reason or '-' }}</td>
                <td>
                    <button class="btn btn-approve" onclick="approveRequest({{ req.id }})">موافقة</button>
                    <button class="btn btn-reject" onclick="rejectRequest({{ req.id }})">رفض</button>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="6">لا توجد طلبات معلقة.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <hr style="margin:1.5rem 0; border:0; border-top:1px solid #edf2f7;">

    <h3>عرض تقويم الإجازات</h3>
    <form class="controls" method="GET" action="{{ url_for('leaves.manager_dashboard') }}">
        <label>الشهر</label>
        <input type="number" name="month" min="1" max="12" value="{{ month }}">
        <label>السنة</label>
        <input type="number" name="year" min="2000" max="2100" value="{{ year }}">
        <button class="btn" style="background:var(--primary);color:white;" type="submit">عرض</button>
    </form>

    <table class="calendar-grid">
        <thead>
            <tr>
                <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
            </tr>
        </thead>
        <tbody>
            {% for week in days_matrix %}
            <tr>
                {% for day in week %}
                <td>
                    {% if day != 0 %}
                        <div class="day-num">{{ day }}</div>
                        {% for ev in calendar_events.get(day, []) %}
                            <div class="event-item event-{{ ev.status|lower }}">{{ ev.employee }} - {{ ev.type }}</div>
                        {% endfor %}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function approveRequest(requestId) {
    const managerNotes = prompt('ملاحظات المدير (اختياري):', '') || '';
    const body = new URLSearchParams({ manager_notes: managerNotes });

    fetch(`{{ url_for('leaves.approve_leave_request', request_id=0) }}`.replace('0', requestId), {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body.toString()
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const row = document.getElementById(`req-row-${requestId}`);
            if (row) row.remove();
        } else {
            alert(data.message || 'تعذر الموافقة');
        }
    });
}

function rejectRequest(requestId) {
    const reason = prompt('سبب الرفض:');
    if (!reason) return;

    const body = new URLSearchParams({ rejection_reason: reason });

    fetch(`{{ url_for('leaves.reject_leave_request', request_id=0) }}`.replace('0', requestId), {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body.toString()
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const row = document.getElementById(`req-row-${requestId}`);
            if (row) row.remove();
        } else {
            alert(data.message || 'تعذر الرفض');
        }
    });
}
</script>
{% endblock %}
