{% extends 'layout.html' %}

{% block title %}إدارة طلبات الإجازة{% endblock %}

{% block styles %}
<style>
    .leave-mgr-page { background: linear-gradient(160deg, #f8fafc 0%, #eef2f7 100%); min-height: 100vh; }
    .page-hero-leave {
        background: linear-gradient(135deg, #1B2A4A 0%, #0f3460 40%, #0D7377 100%);
        border-radius: 24px;
        padding: 2.5rem 3rem;
        color: white;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    .page-hero-leave::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -20%;
        width: 60%;
        height: 200%;
        background: radial-gradient(circle, rgba(13,115,119,0.15) 0%, transparent 70%);
        pointer-events: none;
    }
    .page-hero-leave::after {
        content: '';
        position: absolute;
        bottom: -40%;
        right: -10%;
        width: 50%;
        height: 180%;
        background: radial-gradient(circle, rgba(37,99,235,0.1) 0%, transparent 70%);
        pointer-events: none;
    }
    .hero-title { font-size: 1.75rem; font-weight: 800; position: relative; z-index: 1; }
    .hero-subtitle { opacity: 0.8; font-size: 0.95rem; position: relative; z-index: 1; }
    .hero-stats-row {
        display: flex;
        gap: 1rem;
        margin-top: 1.25rem;
        position: relative;
        z-index: 1;
        flex-wrap: wrap;
    }
    .hero-stat-box {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 14px;
        padding: 0.75rem 1.25rem;
        text-align: center;
        min-width: 95px;
    }
    .hero-stat-val { font-size: 1.5rem; font-weight: 800; display: block; line-height: 1.2; }
    .hero-stat-lbl { font-size: 0.72rem; opacity: 0.75; }

    .kpi-card {
        background: rgba(255,255,255,0.9);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.06);
        border: 1px solid rgba(255,255,255,0.6);
        transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
        position: relative;
        overflow: hidden;
    }
    .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 16px 48px rgba(0,0,0,0.1); }
    .kpi-card::after { content:''; position:absolute; bottom:0; left:0; right:0; height:4px; border-radius:0 0 20px 20px; }
    .kpi-card.pending::after { background: linear-gradient(90deg,#f59e0b,#fbbf24); }
    .kpi-card.approved::after { background: linear-gradient(90deg,#059669,#10b981); }
    .kpi-card.rejected::after { background: linear-gradient(90deg,#dc2626,#ef4444); }
    .kpi-card.total::after { background: linear-gradient(90deg,#2563eb,#3b82f6); }
    .kpi-icon-box {
        width: 50px; height: 50px;
        border-radius: 14px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; color: white;
        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    .kpi-val { font-size: 1.8rem; font-weight: 800; line-height: 1.2; }
    .kpi-lbl { font-size: 0.78rem; color: #64748b; font-weight: 600; letter-spacing: 0.3px; }

    .filter-bar {
        background: rgba(255,255,255,0.92);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 1.25rem 1.5rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.05);
        border: 1px solid rgba(255,255,255,0.6);
        margin-bottom: 1.5rem;
    }
    .nav-tabs-leave {
        border-bottom: 2px solid #e2e8f0;
        margin-bottom: 1.5rem;
    }
    .nav-tabs-leave .nav-link {
        color: #64748b;
        font-weight: 600;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 0.75rem 1.25rem;
        transition: all 0.3s;
    }
    .nav-tabs-leave .nav-link.active {
        color: #0D7377;
        border-bottom-color: #0D7377;
        background: transparent;
    }
    .nav-tabs-leave .nav-link:hover { color: #0D7377; }

    .pending-card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0,0,0,0.06);
        border: 1px solid #e8ecf1;
    }
    .pending-header {
        background: linear-gradient(135deg, #1B2A4A, #0D7377);
        padding: 1rem 1.5rem;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .pending-table { width: 100%; border-collapse: collapse; }
    .pending-table thead th {
        background: #1e3a5f;
        color: white;
        padding: 0.85rem 1rem;
        font-weight: 600;
        font-size: 0.82rem;
        text-align: center;
        white-space: nowrap;
        letter-spacing: 0.3px;
        border: none;
    }
    .pending-table tbody td {
        padding: 0.85rem 1rem;
        text-align: center;
        vertical-align: middle;
        border-bottom: 1px solid #f0f4f8;
        font-size: 0.88rem;
    }
    .pending-table tbody tr { transition: all 0.2s; }
    .pending-table tbody tr:hover {
        background: linear-gradient(135deg, #f0f9ff, #f0fdf4);
    }

    .btn-approve-act {
        background: linear-gradient(135deg, #059669, #10b981);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 0.4rem 0.85rem;
        font-weight: 600;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 3px 10px rgba(5,150,105,0.25);
    }
    .btn-approve-act:hover { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(5,150,105,0.35); }
    .btn-reject-act {
        background: linear-gradient(135deg, #dc2626, #ef4444);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 0.4rem 0.85rem;
        font-weight: 600;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 3px 10px rgba(220,38,38,0.25);
    }
    .btn-reject-act:hover { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(220,38,38,0.35); }

    .type-badge {
        padding: 0.3rem 0.7rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        display: inline-block;
    }
    .type-annual { background: #dbeafe; color: #1e40af; }
    .type-sick { background: #fce7f3; color: #9d174d; }
    .type-emergency { background: #fef3c7; color: #92400e; }
    .type-unpaid { background: #f1f5f9; color: #475569; }
    .type-default { background: #f0fdfa; color: #0D7377; }

    .calendar-wrapper {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0,0,0,0.06);
        border: 1px solid #e8ecf1;
    }
    .calendar-header-bar {
        background: linear-gradient(135deg, #1B2A4A, #0D7377);
        padding: 1rem 1.5rem;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .cal-grid { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .cal-grid th {
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        padding: 0.75rem 0.5rem;
        text-align: center;
        font-weight: 700;
        font-size: 0.8rem;
        color: #1B2A4A;
        border: 1px solid #e2e8f0;
    }
    .cal-grid th.weekend { color: #dc2626; background: #fef2f2; }
    .cal-grid td {
        border: 1px solid #e8ecf1;
        vertical-align: top;
        min-height: 110px;
        height: 110px;
        padding: 0.3rem;
        transition: background 0.2s;
    }
    .cal-grid td:hover { background: #f8fafc; }
    .cal-grid td.today { background: #f0f9ff; border-color: #0D7377; }
    .cal-day-num {
        font-weight: 800;
        font-size: 0.85rem;
        color: #1B2A4A;
        margin-bottom: 0.2rem;
        padding: 0.15rem 0.4rem;
        display: inline-block;
        border-radius: 6px;
    }
    .cal-day-num.today {
        background: linear-gradient(135deg, #0D7377, #14919B);
        color: white;
    }
    .cal-event {
        font-size: 0.68rem;
        border-radius: 5px;
        padding: 0.12rem 0.3rem;
        margin-bottom: 0.15rem;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        font-weight: 600;
        line-height: 1.4;
    }
    .cal-event-pending { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; border-right: 3px solid #f59e0b; }
    .cal-event-approved { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; border-right: 3px solid #10b981; }
    .cal-event-rejected { background: linear-gradient(135deg, #fee2e2, #fecaca); color: #991b1b; border-right: 3px solid #ef4444; }

    .empty-state-box {
        text-align: center;
        padding: 3rem 2rem;
    }
    .empty-icon-lg {
        width: 80px;
        height: 80px;
        margin: 0 auto 1rem;
        background: linear-gradient(135deg, #f0fdfa, #dbeafe);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #0D7377;
    }

    .status-pill {
        padding: 0.25rem 0.6rem;
        border-radius: 20px;
        font-size: 0.72rem;
        font-weight: 700;
    }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-approved { background: #d1fae5; color: #065f46; }
    .status-rejected { background: #fee2e2; color: #991b1b; }

    .toast-notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        z-index: 9999;
        padding: 0.8rem 1.5rem;
        border-radius: 14px;
        font-weight: 600;
        box-shadow: 0 12px 40px rgba(0,0,0,0.2);
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        min-width: 300px;
        text-align: center;
    }
    .toast-notification.show { transform: translateX(-50%) translateY(0); }
    .toast-success { background: linear-gradient(135deg, #059669, #10b981); color: white; }
    .toast-error { background: linear-gradient(135deg, #dc2626, #ef4444); color: white; }

    .reject-modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
        z-index: 9998;
        justify-content: center;
        align-items: center;
    }
    .reject-modal-overlay.active { display: flex; }
    .reject-modal-box {
        background: white;
        border-radius: 24px;
        padding: 2rem;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 24px 80px rgba(0,0,0,0.2);
    }

    @media (max-width: 768px) {
        .page-hero-leave { padding: 1.5rem; border-radius: 16px; }
        .hero-title { font-size: 1.3rem; }
        .kpi-val { font-size: 1.4rem; }
        .cal-grid td { height: auto; min-height: 60px; }
        .cal-event { font-size: 0.6rem; }
        .hero-stats-row { gap: 0.5rem; }
        .hero-stat-box { padding: 0.5rem 0.8rem; min-width: 75px; }
        .hero-stat-val { font-size: 1.1rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="leave-mgr-page p-3 p-md-4">
    <div class="page-hero-leave">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h2 class="hero-title mb-1"><i class="fas fa-user-check me-2"></i>إدارة طلبات الإجازة</h2>
                <p class="hero-subtitle mb-0">مراجعة الطلبات المعلقة وتقويم الإجازات الشهري</p>
                <div class="hero-stats-row">
                    <div class="hero-stat-box">
                        <span class="hero-stat-val">{{ stats.total }}</span>
                        <span class="hero-stat-lbl">إجمالي الطلبات</span>
                    </div>
                    <div class="hero-stat-box">
                        <span class="hero-stat-val" style="color:#fbbf24">{{ stats.pending }}</span>
                        <span class="hero-stat-lbl">معلّق</span>
                    </div>
                    <div class="hero-stat-box">
                        <span class="hero-stat-val" style="color:#6ee7b7">{{ stats.approved }}</span>
                        <span class="hero-stat-lbl">مقبول</span>
                    </div>
                    <div class="hero-stat-box">
                        <span class="hero-stat-val" style="color:#fca5a5">{{ stats.rejected }}</span>
                        <span class="hero-stat-lbl">مرفوض</span>
                    </div>
                </div>
            </div>
            <a href="{{ url_for('leaves.leave_balances') }}" class="btn btn-outline-light rounded-pill px-4" style="position:relative;z-index:1">
                <i class="fas fa-layer-group me-2"></i>أرصدة الإجازات
            </a>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-6">
            <div class="kpi-card pending">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="kpi-lbl">طلبات معلّقة</div>
                        <div class="kpi-val" style="color:#f59e0b">{{ stats.pending }}</div>
                        <small class="text-muted">تنتظر المراجعة</small>
                    </div>
                    <div class="kpi-icon-box" style="background:linear-gradient(135deg,#f59e0b,#fbbf24)"><i class="fas fa-clock"></i></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="kpi-card approved">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="kpi-lbl">طلبات مقبولة</div>
                        <div class="kpi-val text-success">{{ stats.approved }}</div>
                        <small class="text-muted">تمت الموافقة</small>
                    </div>
                    <div class="kpi-icon-box" style="background:linear-gradient(135deg,#059669,#10b981)"><i class="fas fa-check-circle"></i></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="kpi-card rejected">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="kpi-lbl">طلبات مرفوضة</div>
                        <div class="kpi-val text-danger">{{ stats.rejected }}</div>
                        <small class="text-muted">تم الرفض</small>
                    </div>
                    <div class="kpi-icon-box" style="background:linear-gradient(135deg,#dc2626,#ef4444)"><i class="fas fa-times-circle"></i></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="kpi-card total">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="kpi-lbl">إجازات الشهر</div>
                        <div class="kpi-val" style="color:#2563eb">{{ stats.month_requests }}</div>
                        <small class="text-muted">{{ month_name }} {{ year }}</small>
                    </div>
                    <div class="kpi-icon-box" style="background:linear-gradient(135deg,#2563eb,#3b82f6)"><i class="fas fa-calendar-alt"></i></div>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs-leave" id="leaveTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pendingPane" type="button">
                <i class="fas fa-hourglass-half me-2"></i>الطلبات المعلقة
                {% if stats.pending > 0 %}
                <span class="badge bg-warning text-dark rounded-pill ms-1">{{ stats.pending }}</span>
                {% endif %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendarPane" type="button">
                <i class="fas fa-calendar me-2"></i>تقويم الإجازات
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="pendingPane" role="tabpanel">
            <div class="pending-card">
                <div class="pending-header">
                    <h6 class="mb-0"><i class="fas fa-list-ul me-2"></i>الطلبات المعلقة</h6>
                    <span class="badge bg-warning text-dark rounded-pill px-3">{{ pending_requests|length }} طلب</span>
                </div>
                {% if pending_requests %}
                <div class="table-responsive">
                    <table class="pending-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th><i class="fas fa-user me-1"></i>الموظف</th>
                                <th><i class="fas fa-tag me-1"></i>النوع</th>
                                <th><i class="fas fa-calendar-alt me-1"></i>من</th>
                                <th><i class="fas fa-calendar-check me-1"></i>إلى</th>
                                <th><i class="fas fa-business-time me-1"></i>أيام العمل</th>
                                <th><i class="fas fa-comment-alt me-1"></i>السبب</th>
                                <th><i class="fas fa-clock me-1"></i>تاريخ الطلب</th>
                                <th><i class="fas fa-cogs me-1"></i>الإجراء</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for req in pending_requests %}
                            <tr id="req-row-{{ req.id }}">
                                <td class="fw-bold text-muted">{{ loop.index }}</td>
                                <td class="fw-bold">
                                    <i class="fas fa-user-circle me-1 text-primary"></i>
                                    {{ req.employee.name if req.employee else req.employee_id }}
                                </td>
                                <td>
                                    {% set lt = (req.leave_type or '')|lower %}
                                    <span class="type-badge {% if lt == 'annual' %}type-annual{% elif lt == 'sick' %}type-sick{% elif lt == 'emergency' %}type-emergency{% elif lt == 'unpaid' %}type-unpaid{% else %}type-default{% endif %}">
                                        {{ leave_type_label(req.leave_type) }}
                                    </span>
                                </td>
                                <td>{{ req.start_date.strftime('%Y-%m-%d') if req.start_date else '-' }}</td>
                                <td>{{ req.end_date.strftime('%Y-%m-%d') if req.end_date else '-' }}</td>
                                <td><span class="badge bg-primary rounded-pill px-3">{{ req.working_days }}</span></td>
                                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="{{ req.reason or '' }}">{{ req.reason or '-' }}</td>
                                <td><small class="text-muted">{{ req.created_at.strftime('%Y-%m-%d') if req.created_at else '-' }}</small></td>
                                <td>
                                    <div class="d-flex gap-1 justify-content-center">
                                        <button class="btn-approve-act" onclick="approveRequest({{ req.id }})" title="موافقة">
                                            <i class="fas fa-check me-1"></i>موافقة
                                        </button>
                                        <button class="btn-reject-act" onclick="openRejectModal({{ req.id }})" title="رفض">
                                            <i class="fas fa-times me-1"></i>رفض
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state-box">
                    <div class="empty-icon-lg"><i class="fas fa-check-double"></i></div>
                    <h5 class="fw-bold text-dark mb-1">لا توجد طلبات معلقة</h5>
                    <p class="text-muted mb-0">جميع الطلبات تمت مراجعتها</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="tab-pane fade" id="calendarPane" role="tabpanel">
            <div class="filter-bar">
                <form method="GET" action="{{ url_for('leaves.manager_dashboard') }}" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label fw-bold"><i class="fas fa-calendar-alt me-1 text-primary"></i>الشهر</label>
                        <select name="month" class="form-select">
                            {% for m_val, m_name in months_list %}
                            <option value="{{ m_val }}" {% if m_val == month %}selected{% endif %}>{{ m_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold"><i class="fas fa-calendar me-1 text-primary"></i>السنة</label>
                        <select name="year" class="form-select">
                            {% for y in range(current_year - 2, current_year + 2) %}
                            <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100 rounded-pill" onclick="localStorage.setItem('leaveTab','calendar-tab')">
                            <i class="fas fa-search me-2"></i>عرض التقويم
                        </button>
                    </div>
                </form>
            </div>

            <div class="calendar-wrapper">
                <div class="calendar-header-bar">
                    <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>تقويم الإجازات</h6>
                    <span class="badge bg-light text-dark rounded-pill px-3 fs-6">{{ month_name }} {{ year }}</span>
                </div>
                <div class="table-responsive">
                    <table class="cal-grid">
                        <thead>
                            <tr>
                                {% for d in day_names %}
                                <th {% if loop.index >= 5 %}class="weekend"{% endif %}>{{ d }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% set today = None %}
                            {% set now = import('datetime').datetime.utcnow() if false else none %}
                            {% for week in days_matrix %}
                            <tr>
                                {% for day in week %}
                                <td {% if day == 0 %}style="background:#fafbfc"{% endif %}>
                                    {% if day != 0 %}
                                        <div class="cal-day-num">{{ day }}</div>
                                        {% for ev in calendar_events.get(day, []) %}
                                        <div class="cal-event cal-event-{{ ev.status|lower }}" title="{{ ev.employee }} - {{ ev.type }}">
                                            {{ ev.employee[:12] }}{% if ev.employee|length > 12 %}..{% endif %} <small>({{ ev.type }})</small>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="p-3 d-flex gap-3 flex-wrap border-top" style="background:#fafbfc">
                    <div class="d-flex align-items-center gap-2">
                        <div style="width:14px;height:14px;border-radius:4px;background:linear-gradient(135deg,#fef3c7,#fde68a);border-right:3px solid #f59e0b"></div>
                        <small class="fw-600 text-muted">معلّق</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <div style="width:14px;height:14px;border-radius:4px;background:linear-gradient(135deg,#d1fae5,#a7f3d0);border-right:3px solid #10b981"></div>
                        <small class="fw-600 text-muted">مقبول</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <div style="width:14px;height:14px;border-radius:4px;background:linear-gradient(135deg,#fee2e2,#fecaca);border-right:3px solid #ef4444"></div>
                        <small class="fw-600 text-muted">مرفوض</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="reject-modal-overlay" id="rejectModal">
    <div class="reject-modal-box">
        <h5 class="fw-bold mb-3"><i class="fas fa-times-circle text-danger me-2"></i>رفض الطلب</h5>
        <div class="mb-3">
            <label class="form-label fw-bold">سبب الرفض <span class="text-danger">*</span></label>
            <textarea id="rejectReason" class="form-control" rows="3" placeholder="يرجى كتابة سبب الرفض..."></textarea>
        </div>
        <div class="d-flex gap-2 justify-content-end">
            <button type="button" class="btn btn-light rounded-pill px-4" onclick="closeRejectModal()">إلغاء</button>
            <button type="button" class="btn btn-danger rounded-pill px-4" onclick="submitReject()">
                <i class="fas fa-times me-2"></i>تأكيد الرفض
            </button>
        </div>
    </div>
</div>

<div class="toast-notification" id="toastNotif"></div>
{% endblock %}

{% block extra_js %}
<script>
let rejectingId = null;

function showToast(msg, type) {
    const t = document.getElementById('toastNotif');
    t.textContent = msg;
    t.className = 'toast-notification toast-' + type + ' show';
    setTimeout(() => t.classList.remove('show'), 3000);
}

function approveRequest(requestId) {
    const managerNotes = '';
    const body = new URLSearchParams({ manager_notes: managerNotes });

    fetch(`{{ url_for('leaves.approve_leave_request', request_id=0) }}`.replace('0', requestId), {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body.toString()
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const row = document.getElementById(`req-row-${requestId}`);
            if (row) {
                row.style.transition = 'all 0.4s';
                row.style.opacity = '0';
                row.style.transform = 'translateX(-20px)';
                setTimeout(() => row.remove(), 400);
            }
            showToast(data.message || 'تمت الموافقة على الطلب', 'success');
        } else {
            showToast(data.message || 'تعذر الموافقة', 'error');
        }
    })
    .catch(() => showToast('حدث خطأ أثناء المعالجة', 'error'));
}

function openRejectModal(requestId) {
    rejectingId = requestId;
    document.getElementById('rejectReason').value = '';
    document.getElementById('rejectModal').classList.add('active');
}

function closeRejectModal() {
    rejectingId = null;
    document.getElementById('rejectModal').classList.remove('active');
}

function submitReject() {
    const reason = document.getElementById('rejectReason').value.trim();
    if (!reason) {
        showToast('يرجى كتابة سبب الرفض', 'error');
        return;
    }
    const body = new URLSearchParams({ rejection_reason: reason });

    fetch(`{{ url_for('leaves.reject_leave_request', request_id=0) }}`.replace('0', rejectingId), {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body.toString()
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const row = document.getElementById(`req-row-${rejectingId}`);
            if (row) {
                row.style.transition = 'all 0.4s';
                row.style.opacity = '0';
                row.style.transform = 'translateX(-20px)';
                setTimeout(() => row.remove(), 400);
            }
            closeRejectModal();
            showToast(data.message || 'تم رفض الطلب', 'success');
        } else {
            showToast(data.message || 'تعذر الرفض', 'error');
        }
    })
    .catch(() => showToast('حدث خطأ أثناء المعالجة', 'error'));
}

document.addEventListener('DOMContentLoaded', function() {
    const savedTab = localStorage.getItem('leaveTab');
    if (savedTab) {
        const tabEl = document.getElementById(savedTab);
        if (tabEl) {
            const tab = new bootstrap.Tab(tabEl);
            tab.show();
        }
        localStorage.removeItem('leaveTab');
    }
});
</script>
{% endblock %}
