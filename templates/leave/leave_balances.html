{% extends 'layout.html' %}

{% block title %}أرصدة الإجازات{% endblock %}

{% block styles %}
<style>
    .balances-page { background: linear-gradient(160deg, #f8fafc 0%, #eef2f7 100%); min-height: 100vh; }
    .page-hero-bal {
        background: linear-gradient(135deg, #1B2A4A 0%, #0f3460 40%, #0D7377 100%);
        border-radius: 24px;
        padding: 2.5rem 3rem;
        color: white;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    .page-hero-bal::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -20%;
        width: 60%;
        height: 200%;
        background: radial-gradient(circle, rgba(13,115,119,0.15) 0%, transparent 70%);
        pointer-events: none;
    }
    .page-hero-bal::after {
        content: '';
        position: absolute;
        bottom: -40%;
        right: -10%;
        width: 50%;
        height: 180%;
        background: radial-gradient(circle, rgba(37,99,235,0.1) 0%, transparent 70%);
        pointer-events: none;
    }
    .hero-title { font-size: 1.75rem; font-weight: 800; position: relative; z-index: 1; }
    .hero-subtitle { opacity: 0.8; font-size: 0.95rem; position: relative; z-index: 1; }
    .hero-stats-row {
        display: flex;
        gap: 1rem;
        margin-top: 1.25rem;
        position: relative;
        z-index: 1;
        flex-wrap: wrap;
    }
    .hero-stat-box {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 14px;
        padding: 0.75rem 1.25rem;
        text-align: center;
        min-width: 95px;
    }
    .hero-stat-val { font-size: 1.5rem; font-weight: 800; display: block; line-height: 1.2; }
    .hero-stat-lbl { font-size: 0.72rem; opacity: 0.75; }

    .kpi-card {
        background: rgba(255,255,255,0.9);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.06);
        border: 1px solid rgba(255,255,255,0.6);
        transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
        position: relative;
        overflow: hidden;
    }
    .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 16px 48px rgba(0,0,0,0.1); }
    .kpi-card::after { content:''; position:absolute; bottom:0; left:0; right:0; height:4px; border-radius:0 0 20px 20px; }
    .kpi-card.accrued::after { background: linear-gradient(90deg,#2563eb,#3b82f6); }
    .kpi-card.used::after { background: linear-gradient(90deg,#dc2626,#ef4444); }
    .kpi-card.remaining::after { background: linear-gradient(90deg,#059669,#10b981); }
    .kpi-card.rate::after { background: linear-gradient(90deg,#7c3aed,#8b5cf6); }
    .kpi-icon-box {
        width: 50px; height: 50px;
        border-radius: 14px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; color: white;
        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    .kpi-val { font-size: 1.8rem; font-weight: 800; line-height: 1.2; }
    .kpi-lbl { font-size: 0.78rem; color: #64748b; font-weight: 600; letter-spacing: 0.3px; }

    .filter-bar {
        background: rgba(255,255,255,0.92);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 1.25rem 1.5rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.05);
        border: 1px solid rgba(255,255,255,0.6);
        margin-bottom: 1.5rem;
    }

    .summary-card {
        background: white;
        border-radius: 16px;
        padding: 1.25rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.04);
        border: 1px solid #e8ecf1;
        text-align: center;
        transition: all 0.3s;
    }
    .summary-card:hover { transform: translateY(-3px); box-shadow: 0 8px 28px rgba(0,0,0,0.08); }
    .summary-icon {
        width: 44px; height: 44px;
        border-radius: 12px;
        display: inline-flex; align-items: center; justify-content: center;
        font-size: 1rem; color: white;
        margin-bottom: 0.5rem;
    }
    .summary-val { font-size: 1.3rem; font-weight: 800; display: block; }
    .summary-lbl { font-size: 0.72rem; color: #94a3b8; font-weight: 600; }

    .bal-table-card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0,0,0,0.06);
        border: 1px solid #e8ecf1;
    }
    .bal-table-header {
        background: linear-gradient(135deg, #1B2A4A, #0D7377);
        padding: 1rem 1.5rem;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .bal-table { width: 100%; border-collapse: collapse; }
    .bal-table thead th {
        background: #1e3a5f;
        color: white;
        padding: 0.85rem 1rem;
        font-weight: 600;
        font-size: 0.82rem;
        text-align: center;
        white-space: nowrap;
        letter-spacing: 0.3px;
        border: none;
    }
    .bal-table tbody td {
        padding: 0.85rem 1rem;
        text-align: center;
        vertical-align: middle;
        border-bottom: 1px solid #f0f4f8;
        font-size: 0.88rem;
    }
    .bal-table tbody tr { transition: all 0.2s; }
    .bal-table tbody tr:hover { background: linear-gradient(135deg, #f0f9ff, #f0fdf4); }

    .progress-bar-custom {
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        min-width: 80px;
    }
    .progress-bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
    }
    .progress-low { background: linear-gradient(90deg, #059669, #10b981); }
    .progress-medium { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .progress-high { background: linear-gradient(90deg, #dc2626, #ef4444); }

    .type-badge {
        padding: 0.3rem 0.7rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        display: inline-block;
    }
    .type-annual { background: #dbeafe; color: #1e40af; }
    .type-sick { background: #fce7f3; color: #9d174d; }
    .type-emergency { background: #fef3c7; color: #92400e; }
    .type-unpaid { background: #f1f5f9; color: #475569; }
    .type-default { background: #f0fdfa; color: #0D7377; }

    .alert-card {
        background: linear-gradient(135deg, #fef2f2, #fee2e2);
        border: 1px solid #fecaca;
        border-radius: 16px;
        padding: 1.25rem;
    }

    .empty-state-box {
        text-align: center;
        padding: 3rem 2rem;
    }
    .empty-icon-lg {
        width: 80px;
        height: 80px;
        margin: 0 auto 1rem;
        background: linear-gradient(135deg, #f0fdfa, #dbeafe);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #0D7377;
    }

    @media (max-width: 768px) {
        .page-hero-bal { padding: 1.5rem; border-radius: 16px; }
        .hero-title { font-size: 1.3rem; }
        .kpi-val { font-size: 1.4rem; }
        .hero-stats-row { gap: 0.5rem; }
        .hero-stat-box { padding: 0.5rem 0.8rem; min-width: 75px; }
        .hero-stat-val { font-size: 1.1rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="balances-page p-3 p-md-4">
    <div class="page-hero-bal">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h2 class="hero-title mb-1"><i class="fas fa-layer-group me-2"></i>أرصدة الإجازات</h2>
                <p class="hero-subtitle mb-0">عرض شامل لأرصدة الإجازات والاستحقاقات لجميع الموظفين</p>
                <div class="hero-stats-row">
                    <div class="hero-stat-box">
                        <span class="hero-stat-val">{{ stats.unique_employees }}</span>
                        <span class="hero-stat-lbl">موظف</span>
                    </div>
                    <div class="hero-stat-box">
                        <span class="hero-stat-val">{{ stats.total_records }}</span>
                        <span class="hero-stat-lbl">سجل إجازة</span>
                    </div>
                    <div class="hero-stat-box">
                        <span class="hero-stat-val" style="color:#6ee7b7">{{ "%.0f"|format(stats.total_remaining) }}</span>
                        <span class="hero-stat-lbl">يوم متبقي</span>
                    </div>
                    <div class="hero-stat-box">
                        <span class="hero-stat-val" style="color:#fbbf24">{{ "%.0f"|format(stats.utilization_rate) }}%</span>
                        <span class="hero-stat-lbl">نسبة الاستخدام</span>
                    </div>
                </div>
            </div>
            <a href="{{ url_for('leaves.manager_dashboard') }}" class="btn btn-outline-light rounded-pill px-4" style="position:relative;z-index:1">
                <i class="fas fa-user-check me-2"></i>إدارة الطلبات
            </a>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-6">
            <div class="kpi-card accrued">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="kpi-lbl">إجمالي المستحق</div>
                        <div class="kpi-val" style="color:#2563eb">{{ "%.0f"|format(stats.total_accrued) }}</div>
                        <small class="text-muted">يوم</small>
                    </div>
                    <div class="kpi-icon-box" style="background:linear-gradient(135deg,#2563eb,#3b82f6)"><i class="fas fa-calendar-plus"></i></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="kpi-card used">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="kpi-lbl">إجمالي المستخدم</div>
                        <div class="kpi-val text-danger">{{ "%.0f"|format(stats.total_used) }}</div>
                        <small class="text-muted">يوم</small>
                    </div>
                    <div class="kpi-icon-box" style="background:linear-gradient(135deg,#dc2626,#ef4444)"><i class="fas fa-calendar-minus"></i></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="kpi-card remaining">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="kpi-lbl">إجمالي المتبقي</div>
                        <div class="kpi-val text-success">{{ "%.0f"|format(stats.total_remaining) }}</div>
                        <small class="text-muted">يوم</small>
                    </div>
                    <div class="kpi-icon-box" style="background:linear-gradient(135deg,#059669,#10b981)"><i class="fas fa-calendar-check"></i></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="kpi-card rate">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="kpi-lbl">نسبة الاستخدام</div>
                        <div class="kpi-val" style="color:#7c3aed">{{ "%.1f"|format(stats.utilization_rate) }}%</div>
                        <small class="text-muted">{{ year }}</small>
                    </div>
                    <div class="kpi-icon-box" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6)"><i class="fas fa-chart-pie"></i></div>
                </div>
            </div>
        </div>
    </div>

    {% if type_summary %}
    <div class="row g-3 mb-4">
        {% for ts in type_summary %}
        <div class="col-lg-2 col-md-3 col-4">
            <div class="summary-card">
                {% set lt = (ts.type or '')|lower %}
                <div class="summary-icon" style="background:linear-gradient(135deg,{% if lt == 'annual' %}#2563eb,#3b82f6{% elif lt == 'sick' %}#ec4899,#f472b6{% elif lt == 'emergency' %}#f59e0b,#fbbf24{% elif lt == 'unpaid' %}#64748b,#94a3b8{% else %}#0D7377,#14919B{% endif %})">
                    <i class="fas {% if lt == 'annual' %}fa-umbrella-beach{% elif lt == 'sick' %}fa-medkit{% elif lt == 'emergency' %}fa-exclamation-triangle{% elif lt == 'unpaid' %}fa-ban{% else %}fa-calendar{% endif %}"></i>
                </div>
                <span class="summary-val">{{ ts.count }}</span>
                <span class="summary-lbl">{{ ts.label }}</span>
                <div class="mt-1">
                    <small class="text-muted">{{ "%.0f"|format(ts.used) }}/{{ "%.0f"|format(ts.accrued) }} يوم</small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="filter-bar">
        <form method="GET" action="{{ url_for('leaves.leave_balances') }}" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-bold"><i class="fas fa-calendar me-1 text-primary"></i>السنة</label>
                <select name="year" class="form-select">
                    {% for y in range(current_year - 3, current_year + 1) %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold"><i class="fas fa-search me-1 text-primary"></i>بحث بالاسم</label>
                <input type="text" name="search" class="form-control" placeholder="اسم الموظف..." value="{{ search }}">
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold"><i class="fas fa-tag me-1 text-primary"></i>نوع الإجازة</label>
                <select name="leave_type" class="form-select">
                    <option value="">الكل</option>
                    {% for lt in available_leave_types %}
                    <option value="{{ lt }}" {% if lt == leave_type_filter %}selected{% endif %}>{{ leave_type_label(lt) }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100 rounded-pill">
                    <i class="fas fa-filter me-2"></i>تصفية
                </button>
            </div>
        </form>
    </div>

    {% if low_balance_employees %}
    <div class="alert-card mb-4">
        <div class="d-flex align-items-center gap-2 mb-2">
            <i class="fas fa-exclamation-triangle text-danger fa-lg"></i>
            <h6 class="mb-0 fw-bold text-danger">تنبيه: موظفون برصيد منخفض (3 أيام أو أقل)</h6>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            {% for lb in low_balance_employees[:10] %}
            <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill px-3 py-2">
                <i class="fas fa-user me-1"></i>
                {{ lb.employee.name if lb.employee else lb.employee_id }}
                <small>({{ leave_type_label(lb.leave_type) }}: {{ "%.1f"|format(lb.remaining) }} يوم)</small>
            </span>
            {% endfor %}
            {% if low_balance_employees|length > 10 %}
            <span class="badge bg-secondary rounded-pill px-3 py-2">+{{ low_balance_employees|length - 10 }} آخرين</span>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="bal-table-card">
        <div class="bal-table-header">
            <h6 class="mb-0"><i class="fas fa-table me-2"></i>تفاصيل أرصدة الإجازات</h6>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-light text-dark rounded-pill px-3">{{ balances|length }} سجل</span>
                <span class="badge bg-light text-dark rounded-pill px-3">{{ year }}</span>
            </div>
        </div>
        {% if balances %}
        <div class="table-responsive">
            <table class="bal-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th><i class="fas fa-user me-1"></i>الموظف</th>
                        <th><i class="fas fa-tag me-1"></i>النوع</th>
                        <th><i class="fas fa-calendar-plus me-1"></i>المستحق</th>
                        <th><i class="fas fa-calendar-minus me-1"></i>المستخدم</th>
                        <th><i class="fas fa-calendar-check me-1"></i>المتبقي</th>
                        <th><i class="fas fa-chart-bar me-1"></i>الاستخدام</th>
                        <th><i class="fas fa-info-circle me-1"></i>الحالة</th>
                    </tr>
                </thead>
                <tbody>
                    {% for b in balances %}
                    {% set accrued = b.total_accrued|float %}
                    {% set used = b.used|float %}
                    {% set remaining = b.remaining|float %}
                    {% set usage_pct = (used / accrued * 100) if accrued > 0 else 0 %}
                    <tr>
                        <td class="fw-bold text-muted">{{ loop.index }}</td>
                        <td class="fw-bold text-start">
                            <i class="fas fa-user-circle me-1 text-primary"></i>
                            {{ b.employee.name if b.employee else b.employee_id }}
                        </td>
                        <td>
                            {% set lt = (b.leave_type or '')|lower %}
                            <span class="type-badge {% if lt == 'annual' %}type-annual{% elif lt == 'sick' %}type-sick{% elif lt == 'emergency' %}type-emergency{% elif lt == 'unpaid' %}type-unpaid{% else %}type-default{% endif %}">
                                {{ leave_type_label(b.leave_type) }}
                            </span>
                        </td>
                        <td class="fw-bold" style="color:#2563eb">{{ "%.1f"|format(accrued) }}</td>
                        <td class="fw-bold text-danger">{{ "%.1f"|format(used) }}</td>
                        <td class="fw-bold {% if remaining <= 3 and accrued > 0 %}text-danger{% else %}text-success{% endif %}">{{ "%.1f"|format(remaining) }}</td>
                        <td>
                            <div class="d-flex align-items-center gap-2 justify-content-center">
                                <div class="progress-bar-custom">
                                    <div class="progress-bar-fill {% if usage_pct < 50 %}progress-low{% elif usage_pct < 80 %}progress-medium{% else %}progress-high{% endif %}"
                                         style="width:{{ [usage_pct, 100]|min }}%"></div>
                                </div>
                                <small class="fw-bold text-muted" style="min-width:35px">{{ "%.0f"|format(usage_pct) }}%</small>
                            </div>
                        </td>
                        <td>
                            {% if remaining <= 0 and accrued > 0 %}
                            <span class="badge bg-danger rounded-pill px-3">مستنفد</span>
                            {% elif remaining <= 3 and accrued > 0 %}
                            <span class="badge bg-warning text-dark rounded-pill px-3">منخفض</span>
                            {% elif accrued > 0 %}
                            <span class="badge bg-success rounded-pill px-3">متاح</span>
                            {% else %}
                            <span class="badge bg-secondary rounded-pill px-3">غير مُهيّأ</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if balances|length > 1 %}
                <tfoot>
                    <tr style="background:linear-gradient(135deg,#1B2A4A,#0D7377)">
                        <td colspan="3" class="fw-bold text-white text-start"><i class="fas fa-calculator me-2"></i>الإجمالي</td>
                        <td class="fw-bold text-white">{{ "%.1f"|format(stats.total_accrued) }}</td>
                        <td class="fw-bold text-white">{{ "%.1f"|format(stats.total_used) }}</td>
                        <td class="fw-bold text-white">{{ "%.1f"|format(stats.total_remaining) }}</td>
                        <td class="fw-bold text-white">{{ "%.0f"|format(stats.utilization_rate) }}%</td>
                        <td></td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
        {% else %}
        <div class="empty-state-box">
            <div class="empty-icon-lg"><i class="fas fa-layer-group"></i></div>
            <h5 class="fw-bold text-dark mb-1">لا توجد أرصدة إجازات</h5>
            <p class="text-muted mb-0">لم يتم تسجيل أي أرصدة إجازات لسنة {{ year }}</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
