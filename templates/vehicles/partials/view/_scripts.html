{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Ø­ÙØ¸ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    const activeTab = localStorage.getItem("activeVehicleTab");
    if (activeTab) {
        const tabTrigger = new bootstrap.Tab(document.querySelector(activeTab));
        tabTrigger.show();
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
    const tabLinks = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabLinks.forEach((tabLink) => {
        tabLink.addEventListener("shown.bs.tab", (event) => {
            localStorage.setItem(
                "activeVehicleTab",
                event.target.getAttribute("data-bs-target")
            );
        });
    });

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const selectAllCheckbox = document.getElementById("select-all");
    const handoverCheckboxes = document.querySelectorAll(".handover-checkbox");
    const deleteSelectedBtn = document.getElementById("delete-selected-btn");
    const handoverDeleteForm = document.getElementById("handover-delete-form");

    if (selectAllCheckbox && handoverCheckboxes.length > 0 && deleteSelectedBtn) {
        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        function updateDeleteButtonState() {
            const checkedCount = document.querySelectorAll(".handover-checkbox:checked").length;
            deleteSelectedBtn.disabled = checkedCount === 0;

            // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø²Ø± Ù„ÙŠØ¹ÙƒØ³ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            if (checkedCount > 0) {
                deleteSelectedBtn.innerHTML = `<i class="fas fa-trash-alt ms-1"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ (${checkedCount})`;
            } else {
                deleteSelectedBtn.innerHTML = `<i class="fas fa-trash-alt ms-1"></i> Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯`;
            }
        }

        // ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
        selectAllCheckbox.addEventListener("change", function () {
            handoverCheckboxes.forEach((checkbox) => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateDeleteButtonState();
        });

        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­Ø°Ù Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø£ÙŠ Ø®Ø§Ù†Ø©
        handoverCheckboxes.forEach((checkbox) => {
            checkbox.addEventListener("change", function () {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø®Ø§Ù†Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                const allChecked = document.querySelectorAll(".handover-checkbox:checked").length === handoverCheckboxes.length;
                selectAllCheckbox.checked = allChecked;

                // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø­Ø°Ù
                updateDeleteButtonState();
            });
        });

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        updateDeleteButtonState();
    }

    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    if (handoverDeleteForm) {
        handoverDeleteForm.addEventListener("submit", function (e) {
            const checkedBoxes = document.querySelectorAll(".handover-checkbox:checked");
            if (checkedBoxes.length === 0) {
                e.preventDefault();
                alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡Ø§");
                return false;
            }

            const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${checkedBoxes.length} Ø³Ø¬Ù„ Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙˆØ§Ù„Ø§Ø³ØªÙ„Ø§Ù…ØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.`;
            if (!confirm(confirmMessage)) {
                e.preventDefault();
                return false;
            }
        });
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø· Ù†Ù…ÙˆØ°Ø¬ ÙØ­Øµ Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
    function shareSafetyCheckForm(vehicleId, plateNumber) {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const formUrl = window.location.origin + "/external-safety/external-safety-check/" + vehicleId;

        const shareData = {
            title: "Ù†Ù…ÙˆØ°Ø¬ ÙØ­Øµ Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ - Ù†ÙØ¸Ù…",
            text: `Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹

ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ù†Ù…ÙˆØ°Ø¬ ÙØ­Øµ Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ù„Ù„Ù…Ø±ÙƒØ¨Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:

ğŸš— Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©: ${plateNumber}
ğŸ“‹ Ù†ÙˆØ¹ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: ÙØ­Øµ Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
ğŸ¢ Ù†Ø¸Ø§Ù… Ù†ÙØ¸Ù… Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª

ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡ Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:
${formUrl}

âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ù†Ø§ÙŠØ© ÙˆØ¥Ø±ÙØ§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ÙØ­Øµ.

Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§ÙˆÙ†ÙƒÙ…`,
            url: formUrl,
        };

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Share API Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
        if (navigator.share) {
            navigator.share(shareData)
                .then(() => {
                    showToast("ØªÙ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!", "success");
                })
                .catch((error) => {
                    console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:", error);
                    fallbackShare(shareData);
                });
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ù„Ù„Ø­Ø§ÙØ¸Ø© ÙƒØ¨Ø¯ÙŠÙ„
            fallbackShare(shareData);
        }
    }

    // Ø¯Ø§Ù„Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
    function fallbackShare(shareData) {
        const textToCopy = shareData.text;

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ù„Ù„Ø­Ø§ÙØ¸Ø©
        if (navigator.clipboard) {
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    showToast("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ÙØ­Øµ Ù„Ù„Ø­Ø§ÙØ¸Ø©!", "success");
                })
                .catch(() => {
                    showShareModal(shareData);
                });
        } else {
            showShareModal(shareData);
        }
    }

    // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
    function showShareModal(shareData) {
        const modal = document.createElement("div");
        modal.className = "modal fade";
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø· ÙØ­Øµ Ø§Ù„Ø³Ù„Ø§Ù…Ø©</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§:</p>
                        <textarea class="form-control" rows="8" readonly>${shareData.text}</textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="copyToClipboard(this, '${shareData.text}')">
                            <i class="fas fa-copy ms-1"></i>
                            Ù†Ø³Ø® Ø§Ù„Ù†Øµ
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        modal.addEventListener("hidden.bs.modal", () => {
            document.body.removeChild(modal);
        });
    }

    // Ø¯Ø§Ù„Ø© Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ù„Ù„Ø­Ø§ÙØ¸Ø©
    function copyToClipboard(button, text) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);

        // ØªØºÙŠÙŠØ± Ù†Øµ Ø§Ù„Ø²Ø± Ù…Ø¤Ù‚ØªØ§Ù‹
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check ms-1"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
        button.className = "btn btn-success";

        setTimeout(() => {
            button.innerHTML = originalText;
            button.className = "btn btn-primary";
        }, 2000);
    }

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Toast
    function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = "top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px;";
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(toast);

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 5000);
    }
});
</script>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Google Drive -->
<div class="modal fade" id="driveModal" tabindex="-1" aria-labelledby="driveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="driveModalLabel">
                    <i class="fab fa-google-drive me-2"></i>
                    Ø¥Ø¯Ø§Ø±Ø© Ù…Ù„ÙØ§Øª Google Drive
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{{ url_for('vehicles.update_drive_link', vehicle_id=vehicle.id) }}" id="driveForm">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="driveLink" class="form-label">
                                    <i class="fas fa-link me-1"></i>
                                    Ø±Ø§Ø¨Ø· Ù…Ø¬Ù„Ø¯ Google Drive
                                </label>
                                <input type="url" 
                                       class="form-control" 
                                       id="driveLink" 
                                       name="drive_link" 
                                       value="{{ vehicle.drive_folder_link or '' }}" 
                                       placeholder="https://drive.google.com/drive/folders/..." 
                                       dir="ltr">
                                <div class="form-text">
                                    Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ ÙÙŠ Google Drive ÙˆØ§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù‡Ù†Ø§
                                </div>
                            </div>

                            <div id="previewContainer" style="display: none" class="alert">
                                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <h6>
                            <i class="fas fa-info-circle me-1"></i> ÙƒÙŠÙÙŠØ© Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Google Drive:
                        </h6>
                        <ol class="mb-0">
                            <li>
                                Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰
                                <a href="https://drive.google.com" target="_blank">Google Drive</a>
                            </li>
                            <li>Ø§Ù†Ù‚Ø± Ø¨Ø²Ø± Ø§Ù„Ù…Ø§ÙˆØ³ Ø§Ù„Ø£ÙŠÙ…Ù† ÙˆØ§Ø®ØªØ± "Ù…Ø¬Ù„Ø¯ Ø¬Ø¯ÙŠØ¯"</li>
                            <li>
                                Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¨Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©: "{{ vehicle.plate_number }} - {{ vehicle.make }} {{ vehicle.model }}"
                            </li>
                            <li>
                                Ø§Ù†Ù‚Ø± Ø¨Ø²Ø± Ø§Ù„Ù…Ø§ÙˆØ³ Ø§Ù„Ø£ÙŠÙ…Ù† Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù„Ø¯ ÙˆØ§Ø®ØªØ± "Ù…Ø´Ø§Ø±ÙƒØ©"
                            </li>
                            <li>
                                ØºÙŠØ± Ø§Ù„Ø¥Ø°Ù† Ø¥Ù„Ù‰ "Ø£ÙŠ Ø´Ø®Øµ Ù„Ø¯ÙŠÙ‡ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ø¹Ø±Ø¶"
                            </li>
                            <li>Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„ØµÙ‚Ù‡ Ù‡Ù†Ø§</li>
                        </ol>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-save me-1"></i>
                        Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø·
                    </button>
                    {% if vehicle.drive_folder_link %}
                    <button type="submit" name="action" value="remove" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>
                        Ø­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø·
                    </button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

<!-- Vehicle Document Sharing JavaScript -->
<script src="{{ url_for('static', filename='js/vehicle_document_share.js') }}"></script>

<!-- Vehicle data for sharing -->
<div style="display: none;">
    <span data-plate-number="{{ vehicle.plate_number }}"></span>
    <span data-make="{{ vehicle.make }}"></span>
    <span data-model="{{ vehicle.model }}"></span>
    <span data-year="{{ vehicle.year }}"></span>
    <span data-current-driver="{{ current_driver.name if current_driver else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}"></span>
    <span data-driver-phone="{{ current_driver.mobile if current_driver else '' }}"></span>
    <span data-registration-form="{{ request.url_root }}{{ vehicle.registration_form_image if vehicle.registration_form_image else '' }}"></span>
    <span data-insurance-file="{{ request.url_root }}{{ vehicle.insurance_file if vehicle.insurance_file else '' }}"></span>
</div>
</div>
