<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("الصفحة جاهزة للعمل");
        
        // وظيفة البحث عن الموظفين - تحديث محدد العناصر
        const searchInput = document.querySelector('#employeeSearchInput');
        const searchBtn = document.querySelector('#searchEmployeeBtn');
        const employeeRows = document.querySelectorAll('#employeesTableBody .employee-row');
        const noResultsAlert = document.querySelector('#noResultsAlert');
        const personNameInput = document.querySelector('#person_name');
        const selectButtons = document.querySelectorAll('.select-employee-btn');
        const departmentSelect = document.querySelector('#departmentSelect');
        
        console.log("عناصر البحث:", {
            "search input": searchInput !== null,
            "search button": searchBtn !== null,
            "rows count": employeeRows.length,
            "no results alert": noResultsAlert !== null,
            "person name input": personNameInput !== null,
            "select buttons count": selectButtons.length,
            "department select": departmentSelect !== null
        });
        
        // وظيفة البحث وتصفية الموظفين
        function filterEmployees() {
            console.log("تشغيل وظيفة البحث");
            const searchTerm = searchInput.value.trim().toLowerCase();
            const departmentId = departmentSelect ? departmentSelect.value : '';
            
            console.log("مصطلح البحث:", searchTerm);
            console.log("القسم المختار:", departmentId);
            
            let resultsFound = false;
            
            employeeRows.forEach(row => {
                const name = row.getAttribute('data-name').toLowerCase();
                const employeeId = row.getAttribute('data-employee-id')?.toLowerCase() || '';
                const nationalId = row.getAttribute('data-national-id')?.toLowerCase() || '';
                const department = row.getAttribute('data-department')?.toLowerCase() || '';
                const rowDepartmentId = row.getAttribute('data-department-id') || '';
                
                // التحقق من تطابق القسم
                const departmentMatch = !departmentId || departmentId === rowDepartmentId;
                
                // البحث في كافة الحقول
                const searchMatch = !searchTerm || 
                    name.includes(searchTerm) || 
                    employeeId.includes(searchTerm) || 
                    nationalId.includes(searchTerm) || 
                    department.includes(searchTerm);
                
                // إظهار الصف فقط إذا تطابق مع معايير البحث والقسم
                if (departmentMatch && searchMatch) {
                    row.style.display = '';
                    resultsFound = true;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // إظهار/إخفاء تنبيه عدم وجود نتائج
            if (resultsFound) {
                noResultsAlert.classList.add('d-none');
            } else {
                noResultsAlert.classList.remove('d-none');
            }
        }
        
        // تنفيذ البحث عند النقر على زر البحث
        if (searchBtn) {
            searchBtn.addEventListener('click', function() {
                console.log("تم النقر على زر البحث");
                filterEmployees();
            });
        }
        
        // تنفيذ البحث عند الضغط على Enter في حقل البحث
        if (searchInput) {
            searchInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    console.log("تم الضغط على Enter في حقل البحث");
                    filterEmployees();
                }
            });
        }
        
        // تنفيذ التصفية عند تغيير القسم
        if (departmentSelect) {
            departmentSelect.addEventListener('change', function() {
                console.log("تم تغيير القسم المختار");
                filterEmployees();
            });
        }
        
        // حدث عند اختيار موظف
        selectButtons.forEach(button => {
            button.addEventListener('click', function() {
                const employeeName = this.getAttribute('data-name');
                console.log("تم اختيار الموظف:", employeeName);
                personNameInput.value = employeeName;
            });
        });
        
        // إعادة تعيين خاصية بحث الموظفين
        function resetEmployeeSearch() {
            if (searchInput) {
                searchInput.value = '';
                
                // إعادة عرض جميع الصفوف
                employeeRows.forEach(row => {
                    row.style.display = '';
                });
                
                // إخفاء رسالة عدم وجود نتائج
                noResultsAlert.classList.add('d-none');
                
                // تركيز على حقل البحث
                searchInput.focus();
            }
        }
        
        // إعادة ضبط حقل البحث عند تحميل الصفحة
        resetEmployeeSearch();
        
        // تنسيق حقل العداد لإظهار الأرقام بفواصل
        const mileageInput = document.getElementById('mileage');
        mileageInput.addEventListener('blur', function() {
            // إزالة الفواصل والأحرف غير الرقمية
            let value = this.value.replace(/[^\d]/g, '');
            
            // إعادة تنسيق الرقم بالفواصل
            if (value) {
                this.value = Number(value).toLocaleString('en-US');
            }
        });
        
        // تنظيف الأرقام قبل الإرسال
        const form = mileageInput.form;
        form.addEventListener('submit', function() {
            mileageInput.value = mileageInput.value.replace(/[^\d]/g, '');
        });
    });
</script>
