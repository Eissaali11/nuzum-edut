<script>
    document.addEventListener('DOMContentLoaded', function() {
        // التحقق من صحة التواريخ
        const entryDateInput = document.getElementById('entry_date');
        const exitDateInput = document.getElementById('exit_date');
        
        // التحقق عند تغيير تاريخ الخروج
        exitDateInput.addEventListener('change', function() {
            if (exitDateInput.value && exitDateInput.value < entryDateInput.value) {
                alert('لا يمكن أن يكون تاريخ الخروج قبل تاريخ الدخول');
                exitDateInput.value = '';
            }
        });
        
        // التحقق عند تغيير تاريخ الدخول
        entryDateInput.addEventListener('change', function() {
            if (exitDateInput.value && exitDateInput.value < entryDateInput.value) {
                exitDateInput.value = '';
            }
        });
        
        // إعداد نموذج التعديل
        const form = document.getElementById('workshop-edit-form');
        const saveButton = document.getElementById('save-button');
        
        console.log('تم تحميل JavaScript للنموذج');
        console.log('النموذج:', form);
        console.log('زر الحفظ:', saveButton);
        
        if (!form) {
            console.error('لم يتم العثور على النموذج!');
            return;
        }
        
        if (!saveButton) {
            console.error('لم يتم العثور على زر الحفظ!');
            return;
        }
        
        // إضافة معالج submit للنموذج بإرسال AJAX يدوي
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // منع الإرسال الافتراضي
            console.log('تم إرسال النموذج');
            
            // التحقق من الملفات المرفقة قبل الإرسال
            const beforeImages = document.getElementById('before_images').files;
            const afterImages = document.getElementById('after_images').files;
            
            console.log('صور قبل الإصلاح:', beforeImages.length);
            console.log('صور بعد الإصلاح:', afterImages.length);
            
            // عرض تفاصيل الملفات
            for (let i = 0; i < beforeImages.length; i++) {
                console.log(`صورة قبل ${i+1}: ${beforeImages[i].name} (${beforeImages[i].size} bytes)`);
            }
            for (let i = 0; i < afterImages.length; i++) {
                console.log(`صورة بعد ${i+1}: ${afterImages[i].name} (${afterImages[i].size} bytes)`);
            }
            
            // تعطيل زر الحفظ وتغيير النص
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin ms-1"></i> جاري الحفظ...';
            
            // إنشاء FormData يدوياً
            const formData = new FormData();
            
            // إضافة جميع البيانات من النموذج
            const formElements = form.elements;
            for (let i = 0; i < formElements.length; i++) {
                const element = formElements[i];
                if (element.name && element.type !== 'file') {
                    formData.append(element.name, element.value);
                }
            }
            
            // إضافة الملفات يدوياً
            for (let i = 0; i < beforeImages.length; i++) {
                formData.append('before_images', beforeImages[i]);
                console.log('تم إضافة صورة قبل:', beforeImages[i].name);
            }
            for (let i = 0; i < afterImages.length; i++) {
                formData.append('after_images', afterImages[i]);
                console.log('تم إضافة صورة بعد:', afterImages[i].name);
            }
            
            // إرسال البيانات عبر fetch
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // الانتقال للصفحة التالية
                    window.location.href = response.url;
                } else {
                    throw new Error('خطأ في الخادم');
                }
            })
            .catch(error => {
                console.error('خطأ:', error);
                alert('حدث خطأ أثناء حفظ البيانات');
                // إعادة تفعيل الزر
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save ms-1"></i> حفظ التعديلات';
            });
        });
        
        // التأكد من أن زر الحفظ مفعل عند تحميل الصفحة
        if (saveButton.disabled) {
            saveButton.disabled = false;
            saveButton.innerHTML = '<i class="fas fa-save ms-1"></i> حفظ التعديلات';
            console.log('تم إعادة تفعيل زر الحفظ عند تحميل الصفحة');
        }
        
        // إزالة المعالج المباشر المتداخل لزر الحفظ
        // السماح للنموذج بالإرسال بالطريقة الطبيعية
        
        // إضافة معالج تشخيصي للنقر على زر الحفظ (لا يتداخل مع السلوك الافتراضي)
        console.log('تم تحديد معالج submit للنموذج');
    });
</script>
