{% extends 'layout.html' %}

{% block title %}إضافة سجل ورشة للسيارة: {{ vehicle.plate_number }}{% endblock %}

{% block styles %}
{{ super() }}
<link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="mt-4 theme-workshop-page" style="font-family: var(--font-default);">
    <div class="card shadow-sm theme-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="mb-0 theme-page-title" style="font-family: var(--font-default);">
                <i class="fas fa-tools ms-2"></i>
                إضافة سجل ورشة للسيارة: {{ vehicle.plate_number }}
            </h3>
            <div>
                <a href="{{ url_for('vehicles.view', id=vehicle.id) }}" class="btn btn-outline-primary">
                    <i class="fas fa-eye ms-1"></i>
                    عرض تفاصيل السيارة
                </a>
                <a href="{{ url_for('vehicles.index') }}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-right ms-1"></i>
                    قائمة السيارات
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="row-cols-1 row-cols-sm-2 row-cols-md-3 mb-4">
                <div class="col-md-12">
                    <div class="card theme-card">
                        <div class="card-header">
                            <h5 class="mb-0" style="font-family: var(--font-default);">معلومات السيارة</h5>
                        </div>
                        <div class="card-body">
                            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-5 g-3">

                            <div class="col">
                                <strong>رقم اللوحة:</strong> {{ vehicle.plate_number }}
                            </div>
                            <div class="col">
                                <strong>النوع:</strong> {{ vehicle.make }} {{ vehicle.model }}
                            </div>
                            <div class="col">
                                <strong>السنة:</strong> {{ vehicle.year }}
                            </div>
                            <div class="col">
                                <strong>اللون:</strong> 
                                <span class="badge rounded-pill" style="background-color: {{ vehicle.color }}; color: {{ '#000' if vehicle.color in ['white', 'yellow', 'silver'] else '#fff' }};">
                                    {{ vehicle.color }}
                                </span>
                            </div>
                            <div class="mb-2">
                                <strong>الحالة:</strong>
                                {% if vehicle.status == 'available' %}
                                    <span class="badge bg-success">متاحة</span>
                                {% elif vehicle.status == 'rented' %}
                                    <span class="badge bg-primary">مؤجرة</span>
                                {% elif vehicle.status == 'in_project' %}
                                    <span class="badge bg-info">في المشروع</span>
                                {% elif vehicle.status == 'in_workshop' %}
                                    <span class="badge bg-warning text-dark">في الورشة</span>
                                {% elif vehicle.status == 'accident' %}
                                    <span class="badge bg-danger">حادث</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ vehicle.status }}</span>
                                {% endif %}
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
                </div>
                <div class="col-md-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle ms-2"></i>
                        <span>إذا لم تحدد تاريخ الخروج من الورشة، سيتم تغيير حالة السيارة تلقائيًا إلى "في الورشة".</span>
                    </div>
                    
                    <form method="post" action="{{ url_for('vehicles.create_workshop', id=vehicle.id) }}" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="entry_date" class="form-label required">تاريخ دخول الورشة</label>
                                <input type="date" class="form-control" id="entry_date" name="entry_date" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="exit_date" class="form-label">تاريخ الخروج من الورشة</label>
                                <input type="date" class="form-control" id="exit_date" name="exit_date">
                                <div class="form-text">اتركه فارغًا إذا كانت السيارة ما زالت في الورشة</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="reason" class="form-label required">سبب الدخول</label>
                                <select class="form-select" id="reason" name="reason" required>
                                    {% for reason in reasons %}
                                    <option value="{{ reason }}">
                                        {% if reason == 'maintenance' %}صيانة دورية
                                        {% elif reason == 'breakdown' %}عطل
                                        {% elif reason == 'accident' %}حادث
                                        {% else %}{{ reason }}{% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="repair_status" class="form-label required">حالة الإصلاح</label>
                                <select class="form-select" id="repair_status" name="repair_status" required>
                                    {% for status in statuses %}
                                    <option value="{{ status }}">
                                        {% if status == 'in_progress' %}قيد التنفيذ
                                        {% elif status == 'completed' %}تم الإصلاح
                                        {% elif status == 'pending_approval' %}بانتظار الموافقة
                                        {% else %}{{ status }}{% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label required">وصف العطل أو الصيانة</label>
                            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cost" class="form-label">تكلفة الإصلاح</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="cost" name="cost" step="0.01" min="0" value="0">
                                    <span class="input-group-text">ريال</span>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="workshop_name" class="form-label">اسم الورشة</label>
                                <input type="text" class="form-control" id="workshop_name" name="workshop_name">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="technician_name" class="form-label">اسم الفني المسؤول</label>
                            <input type="text" class="form-control" id="technician_name" name="technician_name">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="delivery_link" class="form-label">رابط تسليم ورشة</label>
                                <input type="url" class="form-control" id="delivery_link" name="delivery_link" placeholder="https://example.com/delivery-form">
                                <div class="form-text">أدخل رابط نموذج تسليم المركبة للورشة إن وجد</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="reception_link" class="form-label">رابط استلام من ورشة</label>
                                <input type="url" class="form-control" id="reception_link" name="reception_link" placeholder="https://example.com/reception-form">
                                <div class="form-text">أدخل رابط نموذج استلام المركبة من الورشة إن وجد</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="before_images" class="form-label">صور قبل الإصلاح</label>
                                <input type="file" class="form-control" id="before_images" name="before_images" multiple accept="image/*">
                                <div class="form-text">يمكنك اختيار أكثر من صورة</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="after_images" class="form-label">صور بعد الإصلاح</label>
                                <input type="file" class="form-control" id="after_images" name="after_images" multiple accept="image/*">
                                <div class="form-text">يمكنك اختيار أكثر من صورة</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="notes" class="form-label">ملاحظات إضافية</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary px-5">
                                <i class="fas fa-save ms-1"></i>
                                حفظ سجل الورشة
                            </button>
                            <a href="{{ url_for('vehicles.view', id=vehicle.id) }}" class="btn btn-secondary ms-2">
                                <i class="fas fa-times ms-1"></i>
                                إلغاء
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ضبط تاريخ اليوم كقيمة افتراضية لتاريخ الدخول
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('entry_date').value = today;
        
        // إضافة التحقق من التواريخ
        const entryDateInput = document.getElementById('entry_date');
        const exitDateInput = document.getElementById('exit_date');
        
        exitDateInput.addEventListener('change', function() {
            if (exitDateInput.value && exitDateInput.value < entryDateInput.value) {
                alert('لا يمكن أن يكون تاريخ الخروج قبل تاريخ الدخول');
                exitDateInput.value = '';
            }
        });
        
        entryDateInput.addEventListener('change', function() {
            if (exitDateInput.value && exitDateInput.value < entryDateInput.value) {
                exitDateInput.value = '';
            }
        });
    });
</script>
{% endblock %}