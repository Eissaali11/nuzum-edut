{% extends 'mobile/layout.html' %} {% block title %}ูููุฐุฌ ุชุณููู/ุงุณุชูุงู{%
endblock %} {% block header_title %}ูููุฐุฌ ุชุณููู/ุงุณุชูุงู{% endblock %} {% block
styles %} {{ super() }}
<!-- ุณุชุงููุงุช ุฎุงุตุฉ ุจููุญุงุช ุงูุฑุณู ูุงูุชูุงููุน -->
<style>
    .signature-pad-container {
        border: 1px dashed #ced4da;
        cursor: crosshair;
        background-color: #f8f9fa;
        height: 150px;
        width: 100%;
        border-radius: 0.25rem;
    }
    .form-switch {
        /* ุฅุตูุงุญ ูุญุงุฐุงุฉ ุฃุฒุฑุงุฑ ุงููุญุต */
        padding-right: 2.5em;
        padding-left: 0;
    }
    .form-switch .form-check-input {
        float: right;
        margin-right: -2.5em;
        margin-left: 0;
    }

    /* Expand button styling */
    #expand-canvas-btn {
        opacity: 0.8;
        transition: opacity 0.2s ease;
    }
    #expand-canvas-btn:hover {
        opacity: 1;
        transform: scale(1.1);
    }

    /* Modal canvas styling */
    #modal-damage-canvas {
        border: 1px solid #ddd;
        border-radius: 0.25rem;
    }
</style>
{% endblock %} {% block content %}
<div class="container-fluid py-3" style="background-color: #f0f2f5">
    <form
        method="post"
        action="{{ url_for('mobile.create_handover_mobile', handover_id=existing_handover.id if existing_handover else None) }}"
        enctype="multipart/form-data"
        id="main-handover-form"
    >
        <!-- ุงูุจุทุงูุฉ ุงูุฃููู: ุงุฎุชูุงุฑ ุงูุณูุงุฑุฉ -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-car me-2"></i>ุงูุฎุทูุฉ 1: ุงุฎุชุฑ ุงููุฑูุจุฉ
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <label for="vehicle_id" class="form-label required"
                        >ุงุจุญุซ ุนู ูุฑูุจุฉ:</label
                    >
                    <select
                        class="form-select"
                        id="vehicle_id"
                        name="vehicle_id"
                        required
                    >
                        <option value="" disabled selected>
                            --- ูุฑุฌู ุงุฎุชูุงุฑ ูุฑูุจุฉ ---
                        </option>
                        {% for vehicle in vehicles %}

                            <option value="{{ vehicle.id }}" 
                                    data-plate="{{ vehicle.plate_number }}"
                                    data-project="{{ vehicle.project or '' }}"
                                    data-location="{{ vehicle.location or '' }}"
                                    data-status="{{ vehicle.status }}"
                                    {% if vehicle.status == 'out_of_service' %}style="color: #dc3545; font-weight: bold;"{% endif %}
                                    {% if vehicle.status != 'available' %}style="color: #dc3545; font-weight: bold;"{% endif %}>
                                {{ vehicle.plate_number }} - ({{ vehicle.make }} {{ vehicle.model }})
                                {% if vehicle.status == 'out_of_service' %} โ๏ธ [ุฎุงุฑุฌ ุงูุฎุฏูุฉ]{% endif %}

                                                         </option>

                        {% endfor %}
                    </select>
                    <div id="vehicle-status-alert" class="alert alert-danger mt-2 d-none">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>ุชุญุฐูุฑ:</strong> ุงูุณูุงุฑุฉ ุงููุฎุชุงุฑุฉ ุฎุงุฑุฌ ุงูุฎุฏูุฉ ููุง ูููู ุชูููุฐ ุนูููุงุช ุชุณููู ุฃู ุงุณุชูุงู ุนูููุง.
                    </div>
                    <div id="vehicle-status-alert-avaliable" class="alert alert-primary mt-2 d-none">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>ุชุญุฐูุฑ:</strong> ุงูุณูุงุฑุฉ ุงููุฎุชุงุฑุฉ ููุณุช ูุชุงุญุฉ ุญุงููุงู. ูุฌุจ ุงุณุชูุงููุง ุฃููุงู ูู ุงูุณุงุฆู ุงูุญุงูู.
                        <div class="mt-3">
                            <button type="button" class="btn btn-success btn-sm me-2" id="quick-return-btn" onclick="handleQuickReturn()">
                                <i class="fas fa-undo me-2"></i> ุงุณุชูุงู ุณุฑูุน - ุชุญููู ุจูุงูุงุช ุงูุณุงุฆู
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="show-return-checklist-btn" onclick="handleManualReturn()">
                                <i class="fas fa-edit me-2"></i> ุงุณุชูุงู ูุฏูู - ุฅุฏุฎุงู ุงูุจูุงูุงุช ูุฏููุงู
                            </button>
                        </div>
                        
                        <script>
                        async function handleQuickReturn() {
                            console.log('ุชู ุงูุถุบุท ุนูู ุงูุงุณุชูุงู ุงูุณุฑูุน');
                            
                            const vehicleSelect = document.getElementById('vehicle_id');
                            const selectedVehicleId = vehicleSelect.value;
                            
                            if (!selectedVehicleId) {
                                alert('ูุฑุฌู ุงุฎุชูุงุฑ ุณูุงุฑุฉ ุฃููุงู');
                                return;
                            }
                            
                            // ุชุนุทูู ุงูุฒุฑ ุฃุซูุงุก ุงูุชุญููู
                            const button = document.getElementById('quick-return-btn');
                            button.disabled = true;
                            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุงูุณุงุฆู...';
                            
                            try {
                                // ุฌูุจ ุจูุงูุงุช ุงูุณุงุฆู ุงูุญุงูู
                                const response = await fetch(`/mobile/get_vehicle_driver_info/${selectedVehicleId}`);
                                
                                if (response.ok) {
                                    const data = await response.json();
                                    console.log('ุจูุงูุงุช ุงูุณุงุฆู:', data);
                                    
                                    if (data.success && data.driver_info) {
                                        // ุชุนุจุฆุฉ ุจูุงูุงุช ุงูุณุงุฆู ุชููุงุฆูุงู
                                        fillDriverData(data.driver_info);
                                        
                                        // ุชุบููุฑ ููุน ุงูุนูููุฉ ุฅูู ุงุณุชูุงู
                                        setOperationType('return');
                                        
                                        // ุฅุธูุงุฑ ุงููููุฐุฌ
                                        showForm();
                                        
                                        alert('โ ุชู ุชุญููู ุจูุงูุงุช ุงูุณุงุฆู ุงูุญุงูู ุจูุฌุงุญ: ' + data.driver_info.name);
                                        
                                    } else {
                                        // ูุง ุชูุฌุฏ ุจูุงูุงุช ุณุงุฆูุ ุนุฑุถ ุงููููุฐุฌ ูุงุฑุบ
                                        setOperationType('return');
                                        showForm();
                                        alert('โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ุงูุณุงุฆู ุงูุญุงูู. ูุฑุฌู ุชุนุจุฆุฉ ุงูุจูุงูุงุช ูุฏููุงู.');
                                    }
                                } else {
                                    throw new Error('ูุดู ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู');
                                }
                                
                            } catch (error) {
                                console.error('ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงูุณุงุฆู:', error);
                                
                                // ุนุฑุถ ุงููููุฐุฌ ุญุชู ูู ุญุงูุฉ ุงูุฎุทุฃ
                                setOperationType('return');
                                showForm();
                                alert('ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช. ูุฑุฌู ุชุนุจุฆุฉ ุงูุจูุงูุงุช ูุฏููุงู.');
                                
                            } finally {
                                // ุฅุนุงุฏุฉ ุชูุนูู ุงูุฒุฑ
                                button.disabled = false;
                                button.innerHTML = '<i class="fas fa-undo me-2"></i> ุงุณุชูุงู ุณุฑูุน - ุชุญููู ุจูุงูุงุช ุงูุณุงุฆู';
                            }
                        }
                        
                        function fillDriverData(driverInfo) {
                            console.log('ุชุนุจุฆุฉ ุจูุงูุงุช ุงูุณุงุฆู:', driverInfo);
                            
                            // ุชุนุจุฆุฉ ุงูุญููู ุงูุฃุณุงุณูุฉ
                            const fields = [
                                { id: 'person_name', value: driverInfo.name || '' },
                                { id: 'employee_id', value: driverInfo.employee_id || '' },
                                { name: 'person_phone', value: driverInfo.phone || driverInfo.mobile || '' },
                                { name: 'person_national_id', value: driverInfo.national_id || '' }
                            ];
                            
                            fields.forEach(field => {
                                let element = null;
                                
                                if (field.id) {
                                    element = document.getElementById(field.id);
                                } else if (field.name) {
                                    element = document.querySelector(`[name="${field.name}"]`);
                                }
                                
                                if (element && field.value) {
                                    element.value = field.value;
                                    // ุชูููุฒ ุงูุญููู ุงููุนุจุฃุฉ ุชููุงุฆูุงู
                                    element.style.backgroundColor = '#d4edda';
                                    element.style.border = '2px solid #28a745';
                                    
                                    console.log(`ุชู ุชุนุจุฆุฉ ${field.id || field.name}: ${field.value}`);
                                }
                            });
                        }
                        
                        function setOperationType(type) {
                            const handoverType = document.getElementById('handover_type');
                            if (handoverType) {
                                handoverType.value = type;
                                handoverType.style.backgroundColor = '#cce5ff';
                                handoverType.style.border = '2px solid #007bff';
                                console.log('ุชู ุชุญุฏูุฏ ููุน ุงูุนูููุฉ:', type);
                            }
                        }
                        
                        function showForm() {
                            const formContainer = document.getElementById('handover-form-container');
                            if (formContainer) {
                                formContainer.classList.remove('d-none');
                                
                                // ุชูุนูู ุฒุฑ ุงูุญูุธ ุนูุฏ ุฅุธูุงุฑ ุงููููุฐุฌ
                                const submitBtn = document.querySelector('button[type="submit"]');
                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    console.log('๐ง ุชู ุชูุนูู ุฒุฑ ุงูุญูุธ ุนูุฏ ุฅุธูุงุฑ ุงููููุฐุฌ');
                                }
                                
                                setTimeout(() => {
                                    formContainer.scrollIntoView({ behavior: 'smooth' });
                                }, 300);
                            }
                        }
                        
                        function handleManualReturn() {
                            console.log('ุชู ุงูุถุบุท ุนูู ุงูุงุณุชูุงู ุงููุฏูู');
                            
                            // ุชุบููุฑ ููุน ุงูุนูููุฉ ุฅูู ุงุณุชูุงู
                            const handoverType = document.getElementById('handover_type');
                            if (handoverType) {
                                handoverType.value = 'return';
                                handoverType.style.backgroundColor = '#cce5ff';
                                handoverType.style.border = '2px solid #007bff';
                            }
                            
                            // ุฅุธูุงุฑ ุงููููุฐุฌ
                            const formContainer = document.getElementById('handover-form-container');
                            if (formContainer) {
                                formContainer.classList.remove('d-none');
                                
                                // ุชูุนูู ุฒุฑ ุงูุญูุธ ููุงุณุชูุงู ุงููุฏูู
                                const submitBtn = document.querySelector('button[type="submit"]');
                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    console.log('๐ง ุชู ุชูุนูู ุฒุฑ ุงูุญูุธ ููุงุณุชูุงู ุงููุฏูู');
                                }
                                
                                setTimeout(() => {
                                    formContainer.scrollIntoView({ behavior: 'smooth' });
                                }, 200);
                            }
                            
                            alert('โ ูุฑุฌู ุชุนุจุฆุฉ ุจูุงูุงุช ุงูุงุณุชูุงู ูุฏููุงู ูู ุงููููุฐุฌ ุฃุฏูุงู');
                        }
                        </script>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุญุงููุฉ ุงููููุฐุฌ ุงููุฎููุฉ -->
        <div id="handover-form-container" class="d-none">
            <!-- ุงูุจุทุงูุฉ 2: ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ -->
            <div class="card shadow-sm mb-3">
                <div class="card-header">
                    <h6 class="mb-0 fw-bold">2. ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ</h6>
                </div>
                <div class="card-body row g-3">
                    <div class="col-12">
                        <label for="handover_type" class="form-label required"
                            >ููุน ุงูุนูููุฉ</label
                        >
                        <select
                            class="form-select"
                            id="handover_type"
                            name="handover_type"
                            required
                        >
                            {% for type in handover_types %}
                            <option value="{{ type }}">
                                {% if type == 'delivery' %}ุชุณููู ุงูุณูุงุฑุฉ {% elif
                                type == 'return' or type == 'receive' %}ุงุณุชูุงู
                                ุงูุณูุงุฑุฉ {% elif type == 'inspection' %}ุชูุชูุด {%
                                elif type == 'weekly_inspection' %}ุชูุชูุด ุฃุณุจูุนู
                                {% elif type == 'monthly_inspection' %}ุชูุชูุด
                                ุดูุฑู {% else %}{{ type|title }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- ... ุจุงูู ุญููู ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ (ูุง ุชุบููุฑ) ... -->
                    <!-- Date and time fields are hidden and set automatically -->
                    <input
                        type="hidden"
                        id="handover_date"
                        name="handover_date"
                        required
                    />
                    <input
                        type="hidden"
                        id="handover_time"
                        name="handover_time"
                    />
                    <div class="col-md-6">
                        <label for="project_name" class="form-label"
                            >ุงููุดุฑูุน</label
                        >
                        <input
                            type="text"
                            class="form-control"
                            id="project_name"
                            name="project_name"
                            placeholder="ุงููุดุฑูุน ุงููุฑุชุจุท"
                        />
                    </div>
                    <div class="col-md-6">
                        <label for="city" class="form-label">ุงููุฏููุฉ</label>
                        <input
                            type="text"
                            class="form-control"
                            id="city"
                            name="city"
                            placeholder="ุงููุฏููุฉ ุงูุญุงููุฉ"
                        />
                    </div>
                    <div class="col-md-6">
                        <label for="mileage" class="form-label required"
                            >ูุฑุงุกุฉ ุงูุนุฏุงุฏ (ูู)</label
                        >
                        <input
                            type="number"
                            class="form-control"
                            id="mileage"
                            name="mileage"
                            min="0"
                            required
                        />
                    </div>
                    <div class="col-md-6">
                        <label for="fuel_level" class="form-label required"
                            >ูุณุชูู ุงููููุฏ</label
                        >
                        <select
                            class="form-select"
                            id="fuel_level"
                            name="fuel_level"
                            required
                        >
                            <option value="ููุชูุฆ">ููุชูุฆ</option>
                            <option value="3/4">3/4</option>
                            <option value="1/2">ูุตู</option>
                            <option value="1/4">ุฑุจุน</option>
                            <option value="ููุฎูุถ">ูุงุฑุบ</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label for="reason_for_change" class="form-label"
                            >ุณุจุจ ุชุบููุฑ ุงููุฑูุจุฉ / ุงูุบุฑุถ</label
                        >
                        <textarea
                            class="form-control"
                            id="reason_for_change"
                            name="reason_for_change"
                            rows="2"
                            placeholder="ูุซุงู: ุชุณููู ููููุธู ูุจุฏุก ุงูุนูู..."
                        ></textarea>
                    </div>
                </div>
            </div>

            <!-- ุงูุจุทุงูุฉ 3: ุงูุณุงุฆู -->
            <div class="card shadow-sm mb-3">
                <div class="card-header">
                    <h6 class="mb-0 fw-bold">3. ุงูุณุงุฆู</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="person_name" class="form-label required"
                            >ุงุณู ุงูุณุงุฆู</label
                        >
                        <input
                            type="text"
                            class="form-control"
                            id="person_name"
                            name="person_name"
                            required
                            autocomplete="off"
                            placeholder="ุงูุชุจ ุงูุงุณู ุฃู ุงุจุญุซ"
                        />
                        <input
                            type="hidden"
                            id="employee_id"
                            name="employee_id"
                        />
                    </div>
                    <div class="accordion" id="employeeSearchAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button
                                    class="accordion-button collapsed py-2"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#collapseEmployeeSearch"
                                >
                                    ุจุญุซ ุนู ุณุงุฆู
                                </button>
                            </h2>
                            <div
                                id="collapseEmployeeSearch"
                                class="accordion-collapse collapse"
                                data-bs-parent="#employeeSearchAccordion"
                            >
                                <div
                                    class="accordion-body"
                                    id="driver_search_body"
                                ></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุงูุจุทุงูุฉ 4: ุงููุดุฑู (ูุฎููุฉ - ุชุฃุชู ูู ุจูุงูุงุช ุงููุณุชุฎุฏู) -->
            <input
                type="hidden"
                id="supervisor_name"
                name="supervisor_name"
                value="{{ current_user.name if current_user else '' }}"
            />
            <input
                type="hidden"
                id="supervisor_employee_id"
                name="supervisor_employee_id"
                value="{{ current_user.id if current_user else '' }}"
            />

            <!-- ููุงูุจ ุงูุจุญุซ ุงููุฎููุฉ -->
            <div id="search-template" class="d-none">
                <div class="row g-2 mb-2">
                    <div class="col-sm-5">
                        <select
                            class="form-select form-select-sm department-select"
                        >
                            <option value="">ูู ุงูุฃูุณุงู</option>
                            {% for d in departments %}
                            <option value="{{ d.id }}">{{ d.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-sm-7">
                        <input
                            type="text"
                            class="form-control form-control-sm search-input"
                            placeholder="ุจุญุซ ุจุงูุงุณู ุฃู ุงูุฑูู.."
                        />
                    </div>
                </div>
                <div
                    class="list-group list-container"
                    style="max-height: 200px; overflow-y: auto"
                ></div>
                <div
                    class="alert alert-secondary p-2 text-center mt-2 d-none no-results-alert"
                >
                    ูุง ุชูุฌุฏ ูุชุงุฆุฌ.
                </div>
            </div>

            <!-- ุงูุจุทุงูุฉ 5: ูุญุต ุงูุณูุงุฑุฉ -->
            <div class="card shadow-sm mb-3">
                <!-- ... ูุญุชูู ุจุทุงูุฉ ุงููุญุต (ูุง ุชุบููุฑ) ... -->
                <div class="card-header">
                    <h6 class="mb-0 fw-bold">5. ูุญุต ุงูุณูุงุฑุฉ</h6>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h5>ุงูุชุฌููุฒุงุช ุงููุชููุฑุฉ</h5>
                        <div class="row row-cols-1 row-cols-sm-2 g-2">
                            <div class="col">
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        name="has_spare_tire"
                                        id="has_spare_tire"
                                        checked
                                    /><label
                                        for="has_spare_tire"
                                        class="form-check-label"
                                        >ุฅุทุงุฑ ุงุญุชูุงุทู</label
                                    >
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        name="has_fire_extinguisher"
                                        id="has_fire_extinguisher"
                                        checked
                                    /><label
                                        for="has_fire_extinguisher"
                                        class="form-check-label"
                                        >ุทูุงูุฉ ุญุฑูู</label
                                    >
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        name="has_first_aid_kit"
                                        id="has_first_aid_kit"
                                        checked
                                    /><label
                                        for="has_first_aid_kit"
                                        class="form-check-label"
                                        >ุฅุณุนุงูุงุช ุฃูููุฉ</label
                                    >
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        name="has_warning_triangle"
                                        id="has_warning_triangle"
                                        checked
                                    /><label
                                        for="has_warning_triangle"
                                        class="form-check-label"
                                        >ูุซูุซ ุชุญุฐูุฑู</label
                                    >
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        name="has_tools"
                                        id="has_tools"
                                        checked
                                    /><label
                                        for="has_tools"
                                        class="form-check-label"
                                        >ุฃุฏูุงุช</label
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr class="my-3" />
                    <div>
                        <h5>
                            ุงููุดุงูู ุงูููุฌูุฏุฉ
                            <small class="text-muted">(ุญุฏุฏ ุฅู ูุฌุฏุช)</small>
                        </h5>
                        <div class="row row-cols-1 row-cols-sm-2 g-3">
                            <div class="col">
                                <div class="form-check form-switch">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        role="switch"
                                        name="has_oil_leaks"
                                        id="has_oil_leaks"
                                    /><label
                                        for="has_oil_leaks"
                                        class="form-check-label"
                                        >ุชูุฑูุจ ุฒููุช</label
                                    >
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check form-switch">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        role="switch"
                                        name="has_gear_issue"
                                        id="has_gear_issue"
                                    /><label
                                        for="has_gear_issue"
                                        class="form-check-label"
                                        >ูุดููุฉ ูู ุงูุฌูุฑ</label
                                    >
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check form-switch">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        role="switch"
                                        name="has_clutch_issue"
                                        id="has_clutch_issue"
                                    /><label
                                        for="has_clutch_issue"
                                        class="form-check-label"
                                        >ูุดููุฉ ููุชุด</label
                                    >
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check form-switch">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        role="switch"
                                        name="has_engine_issue"
                                        id="has_engine_issue"
                                    /><label
                                        for="has_engine_issue"
                                        class="form-check-label"
                                        >ูุดููุฉ ูุงูููุฉ</label
                                    >
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check form-switch">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        role="switch"
                                        name="has_ac_issue"
                                        id="has_ac_issue"
                                    /><label
                                        for="has_ac_issue"
                                        class="form-check-label"
                                        >ูุดููุฉ ูููู</label
                                    >
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check form-switch">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        role="switch"
                                        name="has_windows_issue"
                                        id="has_windows_issue"
                                    /><label
                                        for="has_windows_issue"
                                        class="form-check-label"
                                        >ูุดููุฉ ุฒุฌุงุฌ</label
                                    >
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check form-switch">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        role="switch"
                                        name="has_tires_issue"
                                        id="has_tires_issue"
                                    /><label
                                        for="has_tires_issue"
                                        class="form-check-label"
                                        >ูุดููุฉ ููุฑุงุช</label
                                    >
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check form-switch">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        role="switch"
                                        name="has_body_issue"
                                        id="has_body_issue"
                                    /><label
                                        for="has_body_issue"
                                        class="form-check-label"
                                        >ูุดููุฉ ูููู</label
                                    >
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check form-switch">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        role="switch"
                                        name="has_electricity_issue"
                                        id="has_electricity_issue"
                                    /><label
                                        for="has_electricity_issue"
                                        class="form-check-label"
                                        >ูุดููุฉ ููุฑุจุงุก</label
                                    >
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-check form-switch">
                                    <input
                                        class="form-check-input"
                                        type="checkbox"
                                        role="switch"
                                        name="has_lights_issue"
                                        id="has_lights_issue"
                                    /><label
                                        for="has_lights_issue"
                                        class="form-check-label"
                                        >ูุดููุฉ ุฃููุงุฑ</label
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุงูุจุทุงูุฉ 6: ูุฎุทุท ุงูุถุฑุฑ -->
            <div class="card shadow-sm mb-3">
                <div class="card-header">
                    <h6 class="mb-0 fw-bold">6. ุชุญุฏูุฏ ุงูุถุฑุฑ ุนูู ุงููููู</h6>
                </div>
                <div class="card-body text-center">
                    <div
                        class="mb-3 mx-auto position-relative"
                        style="
                            border: 1px solid #ddd;
                            background-color: #fff;
                            max-width: 400px;
                        "
                    >
                        <canvas id="damage-canvas"></canvas>
                        <button
                            type="button"
                            class="btn btn-sm btn-outline-primary position-absolute"
                            style="top: 5px; right: 5px; z-index: 10"
                            id="expand-canvas-btn"
                            title="ุนุฑุถ ุจุญุฌู ุฃูุจุฑ"
                        >
                            <i class="fas fa-expand-alt"></i>
                        </button>
                    </div>
                    <div
                        class="btn-toolbar justify-content-center"
                        role="toolbar"
                    >
                        <div class="btn-group me-2 mb-2" role="group">
                            <button
                                type="button"
                                class="btn btn-outline-primary btn-sm active"
                                id="draw-mode-btn"
                            >
                                <i class="fas fa-pencil-alt"></i></button
                            ><button
                                type="button"
                                class="btn btn-outline-secondary btn-sm"
                                id="select-mode-btn"
                            >
                                <i class="fas fa-mouse-pointer"></i>
                            </button>
                        </div>
                        <div
                            class="input-group input-group-sm me-2 mb-2"
                            style="width: auto"
                        >
                            <span class="input-group-text">ุงูููู</span
                            ><input
                                type="color"
                                class="form-control-color"
                                id="draw-color-picker"
                                value="#E53935"
                                title="ุงุฎุชุฑ ููู ุงูุฎุท"
                            />
                        </div>
                        <div
                            class="input-group input-group-sm mb-2"
                            style="width: auto"
                        >
                            <input
                                type="range"
                                class="form-range"
                                min="2"
                                max="20"
                                value="4"
                                id="draw-line-width"
                            />
                        </div>
                        <button
                            type="button"
                            class="btn btn-outline-danger btn-sm ms-auto mb-2"
                            id="clear-canvas-btn"
                        >
                            <i class="fas fa-trash-alt"></i> ูุณุญ
                        </button>
                    </div>
                    <input
                        type="hidden"
                        name="damage_diagram_data"
                        id="damage-diagram-data"
                    />
                </div>
            </div>

            <!-- **ุงูุจุทุงูุฉ 7: ุงูุชูุซูู (ููุตุญูุญุฉ ูููุญุฏูุซุฉ)** -->
            <div class="card shadow-sm mb-3">
                <div class="card-header">
                    <h6 class="mb-0 fw-bold">7. ุงูุชูุซูู ูุงูููุงุญุธุงุช</h6>
                </div>
                <div class="card-body">
                    <!-- **** ุงูุญูู ุงูุฌุฏูุฏ ูุงูููู **** -->
                    <div class="mb-3">
                        <label
                            for="vehicle_condition"
                            class="form-label required"
                            >ุญุงูุฉ ุงูุณูุงุฑุฉ ุนูุฏ ุงูุชุณููู/ุงูุงุณุชูุงู</label
                        >
                        <textarea
                            class="form-control"
                            id="vehicle_condition"
                            name="vehicle_condition"
                            rows="3"
                            required
                            placeholder="ูุตู ุชูุตููู ูุญุงูุฉ ุงูุณูุงุฑุฉ ุงูุฎุงุฑุฌูุฉ ูุงูุฏุงุฎููุฉ..."
                        ></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="vehicle_status_summary" class="form-label"
                            >ููุฎุต ุญุงูุฉ ุงููุฑูุจุฉ</label
                        >
                        <input
                            type="text"
                            class="form-control"
                            id="vehicle_status_summary"
                            name="vehicle_status_summary"
                            placeholder="ูุซุงู: ููุฌุฏ ููุงุญุธุงุชุ ุฃู: ูุง ููุฌุฏ ููุงุญุธุงุช"
                        />
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label"
                            >ููุงุญุธุงุช ุฅุถุงููุฉ</label
                        >
                        <textarea
                            class="form-control"
                            id="notes"
                            name="notes"
                            rows="2"
                            placeholder="ุฃู ุชูุงุตูู ุฃุฎุฑู..."
                        ></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="form_link" class="form-label"
                            >ุฑุงุจุท ุฎุงุฑุฌู (ุงุฎุชูุงุฑู)</label
                        >
                        <input
                            type="url"
                            class="form-control"
                            id="form_link"
                            name="form_link"
                            placeholder="https://..."
                        />
                    </div>
                    <hr />
                    <!-- ูุธุงู ุฑูุน ุงููููุงุช ุงูุฌุฏูุฏ -->
                    <label for="files" class="form-label"
                        >ูููุงุช ุชูุซูููุฉ (ุตูุฑ/PDF)</label
                    >
                    <div class="alert alert-info py-2 mb-2">
                        <small
                            ><i class="fas fa-info-circle me-1"></i>ุงูุญุฏ ุงูุฃูุตู:
                            20 ููุฌุงุจุงูุช. ุงูุตูุฑ ุงููุจูุฑุฉ (ุฃูุจุฑ ูู 500KB) ุณูุชู
                            ุถุบุทูุง ุชููุงุฆูุงู.</small
                        >
                    </div>
                    <input
                        type="file"
                        id="files"
                        name="files"
                        multiple
                        class="d-none"
                    />
                    <button
                        class="btn btn-outline-secondary w-100"
                        type="button"
                        id="trigger-file-select"
                    >
                        <i class="fas fa-file-upload me-2"></i>ุงุฎุชุฑ ูููุงุช...
                    </button>
                    <div id="file-previews" class="row g-2 mt-2"></div>
                </div>
            </div>
            <!-- ููุงูุจ ุงููุนุงููุฉ -->
            <div class="d-none">
                <div id="image-preview-template">
                    <div class="col-6 col-sm-4 preview-item">
                        <div class="card h-100 position-relative">
                            <img
                                src=""
                                class="card-img-top"
                                style="height: 80px; object-fit: cover"
                            />
                            <div class="card-body p-1">
                                <input
                                    type="text"
                                    class="form-control form-control-sm file-description"
                                    placeholder="ูุตู.."
                                />
                            </div>
                            <button
                                type="button"
                                class="btn-close remove-file"
                                style="
                                    position: absolute;
                                    top: 2px;
                                    right: 2px;
                                    background-color: rgba(255, 255, 255, 0.7);
                                    border-radius: 50%;
                                    padding: 0.25rem 0.5rem;
                                "
                            ></button>
                        </div>
                    </div>
                </div>
                <div id="pdf-preview-template">
                    <div class="col-6 col-sm-4 preview-item">
                        <div class="card h-100 position-relative">
                            <div
                                class="card-body d-flex flex-column justify-content-center p-2"
                            >
                                <i class="fas fa-file-pdf fa-2x text-danger"></i
                                ><small
                                    class="pdf-filename text-truncate mt-1"
                                ></small>
                            </div>
                            <div class="card-footer p-1">
                                <input
                                    type="text"
                                    class="form-control form-control-sm file-description"
                                    placeholder="ูุตู.."
                                />
                            </div>
                            <button
                                type="button"
                                class="btn-close remove-file"
                                style="
                                    position: absolute;
                                    top: 2px;
                                    right: 2px;
                                    background-color: rgba(255, 255, 255, 0.7);
                                    border-radius: 50%;
                                    padding: 0.25rem 0.5rem;
                                "
                            ></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุงูุจุทุงูุฉ 8: ุงูุชูุงููุน -->
            <div class="card shadow-sm mb-3">
                <div class="card-header">
                    <h6 class="mb-0 fw-bold">8. ุงูุชูุงููุน</h6>
                </div>
                <div class="card-body">
                    <!-- ุชูููุน ุงููุดุฑู -->
                    <div class="mb-4">
                        <h5 class="mb-0">ุชูููุน ุงููุดุฑู</h5>
                        <small class="text-muted" id="supervisor-name-display"
                            >{{ current_user.name if current_user else 'ุบูุฑ
                            ูุญุฏุฏ' }}</small
                        >
                        <ul class="nav nav-pills nav-fill my-2">
                            <li class="nav-item">
                                <button
                                    class="nav-link active py-1"
                                    data-bs-toggle="tab"
                                    data-bs-target="#supervisor-draw-tab"
                                >
                                    ุฑุณู
                                </button>
                            </li>
                            <li class="nav-item">
                                <button
                                    class="nav-link py-1"
                                    data-bs-toggle="tab"
                                    data-bs-target="#supervisor-upload-tab"
                                >
                                    ุฑูุน
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div
                                class="tab-pane fade show active"
                                id="supervisor-draw-tab"
                            >
                                <div class="signature-pad-container">
                                    <canvas
                                        id="supervisor-signature-canvas"
                                    ></canvas>
                                </div>
                                <button
                                    type="button"
                                    class="btn btn-sm btn-outline-secondary mt-2 w-100 clear-signature"
                                    data-canvas-id="supervisor-signature-canvas"
                                >
                                    ูุณุญ
                                </button>
                            </div>
                            <div
                                class="tab-pane fade"
                                id="supervisor-upload-tab"
                            >
                                <input
                                    type="file"
                                    class="form-control form-control-sm signature-upload"
                                    accept="image/*"
                                    data-target-input-id="supervisor-signature-data"
                                /><img
                                    src=""
                                    class="img-fluid mt-2 d-none signature-preview"
                                />
                            </div>
                        </div>
                    </div>
                    <hr />
                    <!-- ุชูููุน ุงูุณุงุฆู -->
                    <div class="my-4">
                        <h5 class="mb-0">ุชูููุน ุงูุณุงุฆู/ุงููุณุชูู</h5>
                        <small
                            class="text-muted"
                            id="driver-name-display"
                        ></small>
                        <ul class="nav nav-pills nav-fill my-2">
                            <li class="nav-item">
                                <button
                                    class="nav-link active py-1"
                                    data-bs-toggle="tab"
                                    data-bs-target="#driver-draw-tab"
                                >
                                    ุฑุณู
                                </button>
                            </li>
                            <li class="nav-item">
                                <button
                                    class="nav-link py-1"
                                    data-bs-toggle="tab"
                                    data-bs-target="#driver-upload-tab"
                                >
                                    ุฑูุน
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div
                                class="tab-pane fade show active"
                                id="driver-draw-tab"
                            >
                                <div class="signature-pad-container">
                                    <canvas
                                        id="driver-signature-canvas"
                                    ></canvas>
                                </div>
                                <button
                                    type="button"
                                    class="btn btn-sm btn-outline-secondary mt-2 w-100 clear-signature"
                                    data-canvas-id="driver-signature-canvas"
                                >
                                    ูุณุญ
                                </button>
                            </div>
                            <div class="tab-pane fade" id="driver-upload-tab">
                                <input
                                    type="file"
                                    class="form-control form-control-sm signature-upload"
                                    accept="image/*"
                                    data-target-input-id="driver-signature-data"
                                /><img
                                    src=""
                                    class="img-fluid mt-2 d-none signature-preview"
                                />
                            </div>
                        </div>
                    </div>
                    <hr />
                    <!-- ุชูููุน ูุณุคูู ุงูุญุฑูุฉ -->
                    <div class="mt-4">
                        <h5 class="mb-0">
                            ุจูุงูุงุช ูุชูููุน ูุณุคูู ุงูุญุฑูุฉ (ุงุฎุชูุงุฑู)
                        </h5>
                        <div class="my-2">
                            <input
                                type="text"
                                class="form-control form-control-sm"
                                name="movement_officer_name"
                                placeholder="ุงุณู ูุณุคูู ุงูุญุฑูุฉ"
                            />
                        </div>
                        <ul class="nav nav-pills nav-fill my-2">
                            <li class="nav-item">
                                <button
                                    class="nav-link active py-1"
                                    data-bs-toggle="tab"
                                    data-bs-target="#movement-officer-draw-tab"
                                >
                                    ุฑุณู
                                </button>
                            </li>
                            <li class="nav-item">
                                <button
                                    class="nav-link py-1"
                                    data-bs-toggle="tab"
                                    data-bs-target="#movement-officer-upload-tab"
                                >
                                    ุฑูุน
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div
                                class="tab-pane fade show active"
                                id="movement-officer-draw-tab"
                            >
                                <div class="signature-pad-container">
                                    <canvas
                                        id="movement-officer-signature-canvas"
                                    ></canvas>
                                </div>
                                <button
                                    type="button"
                                    class="btn btn-sm btn-outline-secondary mt-2 w-100 clear-signature"
                                    data-canvas-id="movement-officer-signature-canvas"
                                >
                                    ูุณุญ
                                </button>
                            </div>
                            <div
                                class="tab-pane fade"
                                id="movement-officer-upload-tab"
                            >
                                <input
                                    type="file"
                                    class="form-control form-control-sm signature-upload"
                                    accept="image/*"
                                    data-target-input-id="movement-officer-signature-data"
                                /><img
                                    src=""
                                    class="img-fluid mt-2 d-none signature-preview"
                                />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุงูุจุทุงูุฉ 9: ุชุฎุตูุต ุงูุชูุฑูุฑ -->
            <div class="accordion mb-3" id="reportCustomizationAccordion">
                <div class="card shadow-sm">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button
                                class="accordion-button collapsed py-2"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapseCustomization"
                            >
                                <i class="fas fa-cog me-2"></i>ุชุฎุตูุต ุงูุชูุฑูุฑ
                                (ุงุฎุชูุงุฑู)
                            </button>
                        </h2>
                        <div
                            id="collapseCustomization"
                            class="accordion-collapse collapse"
                            data-bs-parent="#reportCustomizationAccordion"
                        >
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <label
                                        for="custom_company_name"
                                        class="form-label"
                                        >ุงุณู ุดุฑูุฉ ูุฎุตุต</label
                                    ><input
                                        type="text"
                                        class="form-control"
                                        name="custom_company_name"
                                    />
                                </div>
                                <div>
                                    <label
                                        for="custom_logo_file"
                                        class="form-label"
                                        >ุดุนุงุฑ ูุฎุตุต</label
                                    ><input
                                        class="form-control"
                                        type="file"
                                        name="custom_logo_file"
                                        accept="image/*"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ุงูุญููู ุงููุฎููุฉ ููุชูุงููุน (ูุตุญุญุฉ) -->
            <input
                type="hidden"
                name="supervisor_signature_data"
                id="supervisor-signature-data"
            />
            <input
                type="hidden"
                name="driver_signature_data"
                id="driver-signature-data"
            />
            <input
                type="hidden"
                name="movement_officer_signature_data"
                id="movement-officer-signature-data"
            />

            <!-- ุฃุฒุฑุงุฑ ุงูุญูุธ ุงูููุงุฆูุฉ -->
            <div class="d-grid p-2 sticky-bottom">
                {% if is_editing %}
                <!-- ุฃุฒุฑุงุฑ ุงูุชุนุฏูู -->
                <div class="row g-2">
                    <div class="col-6">
                        <button
                            type="submit"
                            name="action"
                            value="update"
                            class="btn btn-primary btn-lg shadow w-100"
                        >
                            <i class="fas fa-edit me-2"></i>ุชุญุฏูุซ ุงูุณุฌู ุงูุญุงูู
                        </button>
                    </div>
                    <div class="col-6">
                        <button
                            type="submit"
                            name="action"
                            value="save_as_new"
                            class="btn btn-success btn-lg shadow w-100"
                        >
                            <i class="fas fa-copy me-2"></i>ุญูุธ ููุณุฎุฉ ุฌุฏูุฏุฉ
                        </button>
                    </div>
                </div>
                {% else %}
                <!-- ุฒุฑ ุงูุฅูุดุงุก -->
                <button type="submit" class="btn btn-primary btn-lg shadow">
                    <i class="fas fa-save me-2"></i>ุญูุธ ูุฅูุดุงุก ุงูุชูุฑูุฑ
                </button>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<!-- Modal for expanded damage canvas -->
<div
    class="modal fade"
    id="damageCanvasModal"
    tabindex="-1"
    aria-labelledby="damageCanvasModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="damageCanvasModalLabel">
                    <i class="fas fa-car me-2"></i>ูุฎุทุท ุงูุถุฑุฑ - ุนุฑุถ ููุณุน
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <canvas id="modal-damage-canvas"></canvas>
                </div>
                <div class="btn-toolbar justify-content-center" role="toolbar">
                    <div class="btn-group me-2 mb-2" role="group">
                        <button
                            type="button"
                            class="btn btn-outline-primary btn-sm active"
                            id="modal-draw-mode-btn"
                        >
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button
                            type="button"
                            class="btn btn-outline-secondary btn-sm"
                            id="modal-select-mode-btn"
                        >
                            <i class="fas fa-mouse-pointer"></i>
                        </button>
                    </div>
                    <div
                        class="input-group input-group-sm me-2 mb-2"
                        style="width: auto"
                    >
                        <span class="input-group-text">ุงูููู</span>
                        <input
                            type="color"
                            class="form-control-color"
                            id="modal-draw-color-picker"
                            value="#E53935"
                            title="ุงุฎุชุฑ ููู ุงูุฎุท"
                        />
                    </div>
                    <div
                        class="input-group input-group-sm mb-2"
                        style="width: auto"
                    >
                        <input
                            type="range"
                            class="form-range"
                            min="2"
                            max="20"
                            value="4"
                            id="modal-draw-line-width"
                        />
                    </div>
                    <button
                        type="button"
                        class="btn btn-outline-danger btn-sm ms-auto mb-2"
                        id="modal-clear-canvas-btn"
                    >
                        <i class="fas fa-trash-alt"></i> ูุณุญ
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    ุฅุบูุงู
                </button>
                <button
                    type="button"
                    class="btn btn-primary"
                    id="sync-canvas-btn"
                >
                    <i class="fas fa-sync-alt me-2"></i>ูุฒุงููุฉ ูุน ุงููููุฐุฌ
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<!-- ูุง ุญุงุฌุฉ ูุชุญููู ุงูููุชุจุงุช ููุงุ layout.html ูููุฑูุง -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 ูุชุทูุจ jQuery -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ุชุญููู Fabric.js ุจุทุฑููุฉ ููุซููุฉ
(function loadFabricJS() {
    console.log('๐ ุจุฏุก ุชุญููู Fabric.js...');
    
    // ุฅุฒุงูุฉ ุฃู script ุณุงุจู
    const existingScript = document.querySelector('script[src*="fabric"]');
    if (existingScript) {
        existingScript.remove();
    }
    
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js';
    script.async = false; // ุชุญููู ูุชุฒุงูู
    
    script.onload = function() {
        console.log('โ ุชู ุชุญููู Fabric.js ุจูุฌุงุญ!');
        // ุชุดุบูู ุชููุฆุฉ Canvas ุนูุฏ ุงูุชุญููู
        if (typeof initializeDamageDiagram === 'function') {
            setTimeout(initializeDamageDiagram, 100);
        }
    };
    
    script.onerror = function() {
        console.error('โ ูุดู ุชุญููู Fabric.js');
        // ูุญุงููุฉ ุฑุงุจุท ุจุฏูู
        const backupScript = document.createElement('script');
        backupScript.src = 'https://unpkg.com/fabric@5.3.0/dist/fabric.min.js';
        backupScript.onload = function() {
            console.log('โ ุชู ุชุญููู Fabric.js ูู ุงููุตุฏุฑ ุงูุจุฏูู!');
        };
        document.head.appendChild(backupScript);
    };
    
    document.head.appendChild(script);
})();
</script>
<script src="{{ url_for('static', filename='js/vehicle_damage_map.js') }}"></script>

<!-- ุงูุณูุฑุจุช ุงูููุญุฏ ููุตูุญุฉ (ุงููุณุฎุฉ ุงูููุงุฆูุฉ ูุงููุตุญุญุฉ) -->
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // === 1. ุงูุชููุฆุฉ ุงูุนุงูุฉ ===
        const vehicleSelect = $('#vehicle_id');
        const formContainer = $('#handover-form-container');
        const mainForm = document.getElementById('main-handover-form');

        // ุถุจุท ุงูุชุงุฑูุฎ ูุงูููุช ุงูุญุงูู ุชููุงุฆูุงู
        const dateInput = document.getElementById('handover_date');
        const timeInput = document.getElementById('handover_time');
        const now = new Date();

        if (dateInput) {
            dateInput.value = now.toISOString().split('T')[0];
        }
        if (timeInput) {
            timeInput.value = now.toTimeString().slice(0, 5);
        }

        vehicleSelect.select2({ theme: 'bootstrap-5', placeholder: "ุงุจุญุซ ุจุฑูู ุงูููุญุฉ ุฃู ุงูููุน...", dir: "rtl" });

        // === 2. ุงูููุทู ุงูุฑุฆูุณู ุนูุฏ ุงุฎุชูุงุฑ ุณูุงุฑุฉ ===
        vehicleSelect.on('select2:select', function (e) {
            const selectedOption = $(e.params.data.element);

            const vehicleStatus = selectedOption.data('status');
            const statusAlert = document.getElementById('vehicle-status-alert');
            const statusAlertSuccess = document.getElementById('vehicle-status-alert-avaliable');

            
            // ูุญุต ุงููุฑูุจุงุช ุฎุงุฑุฌ ุงูุฎุฏูุฉ
            if (vehicleStatus === 'out_of_service') {
                statusAlert.classList.remove('d-none');
                formContainer.addClass('d-none');
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.disabled = true;
                return;
            }
            else if (vehicleStatus !== "available"){
                statusAlertSuccess.classList.remove('d-none');
                formContainer.addClass('d-none');
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.disabled = true;
                return;
            }
             else {
                statusAlert.classList.add('d-none');
                statusAlertSuccess.classList.add('d-none');
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.disabled = false;
            }
            
            document.getElementById('project_name').value = selectedOption.data('project');
            document.getElementById('city').value = selectedOption.data('location');
            

            const handoverTypeSelect = document.getElementById('handover_type');
            if (vehicleStatus === 'available') { handoverTypeSelect.value = 'delivery'; }
            else { handoverTypeSelect.value = 'return'; }

            formContainer.removeClass('d-none').hide().fadeIn(400);

            // **ููู ุฌุฏุงู: ุชูุนูู ูู ุดูุก ุจุนุฏ ุฅุธูุงุฑ ุงููููุฐุฌ**
            initializeAllInteractiveElements();
        });

        // --- ูุฐู ุงูุฏุงูุฉ ุณุชููู ุงููุฑูุฒ ุงูุฑุฆูุณู ูุชุดุบูู ูู ุดูุก ---
        let areElementsInitialized = false;
        function initializeAllInteractiveElements() {
            if (areElementsInitialized) return; // ุชุดุบูู ูุฑุฉ ูุงุญุฏุฉ ููุท

            // ุฃ. ุชูุนูู ุจุญุซ ุงูุณุงุฆู ููุท (ุงููุดุฑู ูุฃุชู ูู ุจูุงูุงุช ุงููุณุชุฎุฏู)
            setupEmployeeSearch('driver');

            // ุจ. ุชูุนูู ูุฎุทุท ุงูุถุฑุฑ
            initializeDamageDiagram();

            // ุฌ. ุชูุนูู ููุญุงุช ุงูุชูููุน
            setupSignatures();

            // ุฏ. ุชูุนูู ูุธุงู ุฑูุน ุงููููุงุช ุงูุชูุซูููุฉ
            setupFileUploader();

            areElementsInitialized = true;
        }

        // === 3. ุฅุฏุงุฑุฉ ุงูุจุญุซ ุนู ุงูููุธููู (ุณุงุฆู ููุท) ===
        const employeeData = JSON.parse('{{ employeeData | tojson | safe }}');
        function setupEmployeeSearch(type) {
            const searchBody = document.getElementById(`${type}_search_body`);
            if (!searchBody.innerHTML) { // ูุฅูุดุงุก ุงููุงุฌูุฉ ูุฑุฉ ูุงุญุฏุฉ ููุท
                const template = document.getElementById('search-template').innerHTML;
                searchBody.innerHTML = template;
            }

            const nameInput = document.getElementById('person_name');
            const idInput = document.getElementById('employee_id');
            const departmentSelect = searchBody.querySelector('.department-select');
            const searchInput = searchBody.querySelector('.search-input');
            const listContainer = searchBody.querySelector('.list-container');
            const noResultsAlert = searchBody.querySelector('.no-results-alert');
            const accordionCollapse = searchBody.closest('.accordion-collapse');

            function renderList(employees) {
                listContainer.innerHTML = '';
                noResultsAlert.classList.toggle('d-none', employees.length > 0);
                employees.forEach(emp => {
                    const a = document.createElement('a');
                    a.href = '#'; a.className = 'list-group-item list-group-item-action';

                    // ุนุฑุถ ุฃุณูุงุก ุงูุฃูุณุงู
                    let departmentNames = '-';
                    if (emp.departments && emp.departments.length > 0) {
                        departmentNames = emp.departments.map(dept => dept.name).join(', ');
                    } else if (emp.department && emp.department.name) {
                        departmentNames = emp.department.name;
                    }

                    a.innerHTML = `<div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${emp.name}</h6><small class="text-muted">${emp.employee_id||''}</small></div><small>${departmentNames}</small>`;
                    a.onclick = (e) => {
                        e.preventDefault();
                        nameInput.value = emp.name;
                        idInput.value = emp.id;
                        document.getElementById('driver-name-display').textContent = emp.name; // ุชุญุฏูุซ ุงุณู ุงูุชูููุน
                        new bootstrap.Collapse(accordionCollapse).hide();
                    };
                    listContainer.appendChild(a);
                });
            }

            function filter() {
                const deptId = departmentSelect.value;
                const term = searchInput.value.toLowerCase().trim();
                const filtered = employeeData.filter(emp => {
                    // ููุชุฑุฉ ุญุณุจ ุงููุณู - ุงูุชุญูู ูู ุงููุณู ุงูุฃุณุงุณู ุฃู ุฌููุน ุงูุฃูุณุงู
                    let deptMatch = !deptId;
                    if (deptId) {
                        // ุงูุชุญูู ูู ุงููุณู ุงูุฃุณุงุณู
                        if (emp.department_id && String(emp.department_id) === deptId) {
                            deptMatch = true;
                        }
                        // ุงูุชุญูู ูู ุฌููุน ุงูุฃูุณุงู
                        if (emp.departments && emp.departments.length > 0) {
                            deptMatch = emp.departments.some(dept => String(dept.id) === deptId);
                        }
                    }

                    // ููุชุฑุฉ ุญุณุจ ุงููุต ุงููุฏุฎู
                    const textMatch = !term ||
                        (emp.name || '').toLowerCase().includes(term) ||
                        (emp.employee_id || '').toLowerCase().includes(term);

                    return deptMatch && textMatch;
                });
                renderList(filtered);
            }
            searchInput.oninput = filter;
            departmentSelect.onchange = filter;
            renderList(employeeData);
        }

        // === 4. ุฅุฏุงุฑุฉ ูุฎุทุท ุงูุถุฑุฑ ===
        let damageCanvas = null;
        let modalDamageCanvas = null;

        function initializeDamageDiagram() {
            if (damageCanvas) return;
            const diagramEl = document.getElementById('damage-canvas');
            if (!diagramEl) return;

            const diagramContainer = diagramEl.parentElement;
            damageCanvas = new fabric.Canvas('damage-canvas', { isDrawingMode: true, backgroundColor: '#fff' });
            damageCanvas.freeDrawingBrush.color = "#E53935";
            damageCanvas.freeDrawingBrush.width = 4;

            const imageUrl = "{{ url_for('static', filename='images/vehicle_diagram.png') }}";
            fabric.Image.fromURL(imageUrl, (img) => {
                const w = diagramContainer.offsetWidth > 0 ? diagramContainer.offsetWidth : 350;
                const scale = w / img.width;
                damageCanvas.setWidth(w).setHeight(img.height * scale);
                damageCanvas.setBackgroundImage(img, damageCanvas.renderAll.bind(damageCanvas), { scaleX: scale, scaleY: scale });
            }, { crossOrigin: 'anonymous' });

            // Main canvas controls
            document.getElementById('draw-mode-btn').onclick = () => { damageCanvas.isDrawingMode = true; };
            document.getElementById('select-mode-btn').onclick = () => { damageCanvas.isDrawingMode = false; };
            document.getElementById('draw-color-picker').oninput = e => { damageCanvas.freeDrawingBrush.color = e.target.value; };
            document.getElementById('draw-line-width').oninput = e => { damageCanvas.freeDrawingBrush.width = parseInt(e.target.value); };
            document.getElementById('clear-canvas-btn').onclick = () => { if (confirm("ูู ุชุฑูุฏ ูุณุญ ูู ุงูุฑุณููุ")) damageCanvas.remove(...damageCanvas.getObjects()); };

            // Expand button functionality
            document.getElementById('expand-canvas-btn').onclick = openDamageModal;
        }

        function openDamageModal() {
            const modal = new bootstrap.Modal(document.getElementById('damageCanvasModal'));
            modal.show();

            // Initialize modal canvas after modal is shown
            document.getElementById('damageCanvasModal').addEventListener('shown.bs.modal', function() {
                initializeModalCanvas();
            }, { once: true });
        }

        function initializeModalCanvas() {
            if (modalDamageCanvas) {
                // Update existing modal canvas with current data
                syncCanvasToModal();
                return;
            }

            const modalCanvasEl = document.getElementById('modal-damage-canvas');
            if (!modalCanvasEl) return;

            // Set modal canvas size
            const modalBody = modalCanvasEl.closest('.modal-body');
            const maxWidth = Math.min(modalBody.offsetWidth - 40, 600);
            const maxHeight = Math.min(window.innerHeight * 0.6, 400);

            modalDamageCanvas = new fabric.Canvas('modal-damage-canvas', {
                isDrawingMode: true,
                backgroundColor: '#fff',
                width: maxWidth,
                height: maxHeight
            });

            modalDamageCanvas.freeDrawingBrush.color = "#E53935";
            modalDamageCanvas.freeDrawingBrush.width = 4;

            // Load background image
            const imageUrl = "{{ url_for('static', filename='images/vehicle_diagram.png') }}";
            fabric.Image.fromURL(imageUrl, (img) => {
                const scale = Math.min(maxWidth / img.width, maxHeight / img.height);
                const scaledWidth = img.width * scale;
                const scaledHeight = img.height * scale;

                modalDamageCanvas.setWidth(scaledWidth).setHeight(scaledHeight);
                modalDamageCanvas.setBackgroundImage(img, modalDamageCanvas.renderAll.bind(modalDamageCanvas), {
                    scaleX: scale,
                    scaleY: scale
                });

                // Copy existing drawings from main canvas
                syncCanvasToModal();
            }, { crossOrigin: 'anonymous' });

            // Modal canvas controls
            document.getElementById('modal-draw-mode-btn').onclick = () => { modalDamageCanvas.isDrawingMode = true; };
            document.getElementById('modal-select-mode-btn').onclick = () => { modalDamageCanvas.isDrawingMode = false; };
            document.getElementById('modal-draw-color-picker').oninput = e => { modalDamageCanvas.freeDrawingBrush.color = e.target.value; };
            document.getElementById('modal-draw-line-width').oninput = e => { modalDamageCanvas.freeDrawingBrush.width = parseInt(e.target.value); };
            document.getElementById('modal-clear-canvas-btn').onclick = () => {
                if (confirm("ูู ุชุฑูุฏ ูุณุญ ูู ุงูุฑุณููุ")) modalDamageCanvas.remove(...modalDamageCanvas.getObjects());
            };

            // Sync button functionality
            document.getElementById('sync-canvas-btn').onclick = syncModalToCanvas;
        }

        function syncCanvasToModal() {
            if (!modalDamageCanvas || !damageCanvas) return;

            // Clear modal canvas objects
            modalDamageCanvas.remove(...modalDamageCanvas.getObjects());

            // Copy objects from main canvas to modal
            damageCanvas.getObjects().forEach(obj => {
                const clonedObj = fabric.util.object.clone(obj);
                modalDamageCanvas.add(clonedObj);
            });

            modalDamageCanvas.renderAll();
        }

        function syncModalToCanvas() {
            if (!modalDamageCanvas || !damageCanvas) return;

            // Clear main canvas objects
            damageCanvas.remove(...damageCanvas.getObjects());

            // Copy objects from modal to main canvas
            modalDamageCanvas.getObjects().forEach(obj => {
                const clonedObj = fabric.util.object.clone(obj);
                damageCanvas.add(clonedObj);
            });

            damageCanvas.renderAll();

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('damageCanvasModal'));
            if (modal) modal.hide();
        }

        // === 5. ุฅุฏุงุฑุฉ ุงูุชูุงููุน (ุดุงููุฉ) ===
        const signaturePads = {};
        function setupSignatures() {
            ['supervisor', 'driver', 'movement-officer'].forEach(type => {
                const canvasId = `${type}-signature-canvas`;
                const el = document.getElementById(canvasId);
                if (el) {
                    signaturePads[canvasId] = new fabric.Canvas(el, { isDrawingMode: true, backgroundColor: 'rgba(0,0,0,0)' });
                    signaturePads[canvasId].freeDrawingBrush.color = "#000";
                    signaturePads[canvasId].freeDrawingBrush.width = 2;
                }
            });

            document.querySelectorAll('.clear-signature').forEach(btn => {
                btn.onclick = () => {
                    const canvas = signaturePads[btn.dataset.canvasId];
                    if (canvas) canvas.clear();
                };
            });

            document.querySelectorAll('.signature-upload').forEach(input => {
                input.onchange = e => {
                    const file = e.target.files[0]; if(!file) return;
                    const previewEl = input.parentElement.querySelector('.signature-preview');
                    const targetInput = document.getElementById(input.dataset.targetInputId);
                    const reader = new FileReader();
                    reader.onload = res => {
                        targetInput.value = res.target.result;
                        previewEl.src = res.target.result;
                        previewEl.classList.remove('d-none');
                        const canvas = signaturePads[input.dataset.targetInputId.replace('-data', '-canvas')];
                        if (canvas) canvas.clear();
                    };
                    reader.readAsDataURL(file);
                };
            });

            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    const canvasId = e.target.dataset.bsTarget.replace('#','').replace('-draw-tab','-signature-canvas');
                    const canvas = signaturePads[canvasId];
                    if(canvas){
                        const container = canvas.getElement().parentElement;
                        canvas.setWidth(container.offsetWidth).setHeight(container.offsetHeight).renderAll();
                    }
                });
            });
        }

        // === 6. ุฅุฏุงุฑุฉ ุฑูุน ุงููููุงุช ุงูุชูุซูููุฉ (ุงูุณุจุจ ุงูุฑุฆูุณู ูููุดููุฉ) ===
        function setupFileUploader() {
            const filesInput = document.getElementById('files');
            const filePreviews = document.getElementById('file-previews');
            const triggerFileSelectBtn = document.getElementById('trigger-file-select');
            let filesTransferList = new DataTransfer();

            triggerFileSelectBtn.onclick = () => {
                const tempInput = document.createElement('input');
                tempInput.type = 'file'; tempInput.multiple = true; tempInput.accept = "image/*,application/pdf";
                tempInput.onchange = () => { Array.from(tempInput.files).forEach(addFilePreview); };
                tempInput.click();
            };

            async function addFilePreview(file) {
                for (let f of filesTransferList.files) { if (f.name === file.name && f.size === file.size) return; }

                // ุฅูุดุงุก ุงูุนุฑุถ ุฃููุงู ุจุงูููู ุงูุฃุตูู
                const tplId = file.name.toLowerCase().endsWith('.pdf') ? 'pdf-preview-template' : 'image-preview-template';
                const clone = document.getElementById(tplId).firstElementChild.cloneNode(true);
                clone.querySelector('.file-description').name = `description_${file.name}`;

                let processedFile = file; // ุฅุนูุงู ุงููุชุบูุฑ ูู ุงูุจุฏุงูุฉ

                if (tplId.includes('image')) {
                    // ุนุฑุถ ุงูุตูุฑุฉ ูุจุงุดุฑุฉ (ุงูุฃุตููุฉ ุฃููุงู)
                    const img = clone.querySelector('img');
                    const reader = new FileReader();
                    reader.onload = e => img.src = e.target.result;
                    reader.readAsDataURL(file);

                    // ุถุบุท ุงูุตูุฑุฉ ูู ุงูุฎูููุฉ ุฅุฐุง ูุงูุช ูุจูุฑุฉ
                    if (file.type.startsWith('image/') && file.size > 500000) {
                        // ุฅุถุงูุฉ ูุคุดุฑ ุงูุถุบุท
                        const sizeIndicator = clone.querySelector('.file-description');
                        const originalText = sizeIndicator.placeholder;
                        sizeIndicator.placeholder = 'ุฌุงุฑู ุถุบุท ุงูุตูุฑุฉ...';

                        try {
                            processedFile = await compressImage(file, 0.7, 1200);
                            console.log(`ุชู ุถุบุท ${file.name} ูู ${(file.size/1024).toFixed(1)}KB ุฅูู ${(processedFile.size/1024).toFixed(1)}KB`);

                            // ุชุญุฏูุซ ุนุฑุถ ุงูุตูุฑุฉ ุจุงููุณุฎุฉ ุงููุถุบูุทุฉ
                            const compressedReader = new FileReader();
                            compressedReader.onload = e => img.src = e.target.result;
                            compressedReader.readAsDataURL(processedFile);

                            sizeIndicator.placeholder = `ูุถุบูุทุฉ: ${(processedFile.size/1024).toFixed(0)}KB`;
                        } catch (error) {
                            console.log('ูุดู ุถุบุท ุงูุตูุฑุฉุ ุณูุชู ุงุณุชุฎุฏุงู ุงูููู ุงูุฃุตูู:', error);
                            processedFile = file;
                            sizeIndicator.placeholder = originalText;
                        }
                    }
                } else {
                    clone.querySelector('.pdf-filename').textContent = file.name;
                }

                filePreviews.appendChild(clone);

                // ุฅุถุงูุฉ ุงูููู ูููุงุฆูุฉ (ูุถุบูุท ุฃู ุฃุตูู)
                filesTransferList.items.add(processedFile);
                filesInput.files = filesTransferList.files;

                // ุฑุจุท ุฒุฑ ุงูุญุฐู
                clone.querySelector('.remove-file').onclick = () => removeFilePreview(clone, processedFile);
            }

            // ุฏุงูุฉ ุถุบุท ุงูุตูุฑ
            function compressImage(file, quality = 0.6, maxWidth = 1200) {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();

                    img.onload = () => {
                        let { width, height } = img;

                        // ุชุตุบูุฑ ุงูุฃุจุนุงุฏ ุฅุฐุง ูุงูุช ูุจูุฑุฉ
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (blob) {
                                // ุฅูุดุงุก ููู ุฌุฏูุฏ ุจููุณ ุงูุงุณู
                                const compressedFile = new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                resolve(compressedFile);
                            } else {
                                reject(new Error('ูุดู ูู ุถุบุท ุงูุตูุฑุฉ'));
                            }
                        }, 'image/jpeg', quality);
                    };

                    img.onerror = () => reject(new Error('ูุดู ูู ุชุญููู ุงูุตูุฑุฉ'));
                    img.src = URL.createObjectURL(file);
                });
            }

            function removeFilePreview(item, fileToRemove) {
                const newTransferList = new DataTransfer();
                for (let f of filesTransferList.files) { if (f.name !== fileToRemove.name || f.size !== fileToRemove.size) newTransferList.items.add(f); }
                filesTransferList = newTransferList;
                filesInput.files = filesTransferList.files;
                item.remove();
            }
        }

        // === 7. ูุนุงูุฌ ุงูุฅุฑุณุงู ุงูููุงุฆู ===
        mainForm.addEventListener('submit', function (e) {
            // ูุญุต ุญุฌู ุงููููุงุช ูุจู ุงูุฅุฑุณุงู
            const filesInput = document.getElementById('files');
            let totalSize = 0;

            if (filesInput.files) {
                for (let file of filesInput.files) {
                    totalSize += file.size;
                }
            }

            // ุญุณุงุจ ุญุฌู ุงูุชูุงููุน ูุงููุฎุทุทุงุช
            const signatures = ['supervisor-signature-data', 'driver-signature-data', 'movement-officer-signature-data', 'damage-diagram-data'];
            for (let id of signatures) {
                const input = document.getElementById(id);
                if (input && input.value && input.value.startsWith('data:image')) {
                    // ุชูุฏูุฑ ุญุฌู base64 (ุญูุงูู 75% ูู ุงูุญุฌู ุงููุนูู)
                    totalSize += input.value.length * 0.75;
                }
            }

            const maxSize = 20 * 1024 * 1024; // 20 MB
            if (totalSize > maxSize) {
                e.preventDefault();
                const sizeMB = (totalSize / (1024 * 1024)).toFixed(1);
                alert(`ุญุฌู ุงูุจูุงูุงุช ูุจูุฑ ุฌุฏุงู (${sizeMB} ููุฌุงุจุงูุช). ุงูุญุฏ ุงูุฃูุตู 20 ููุฌุงุจุงูุช. ูุฑุฌู ุชูููู ุนุฏุฏ ุงูุตูุฑ ุฃู ุถุบุทูุง.`);
                return false;
            }

            // ุฃ. ุญูุธ ูุฎุทุท ุงูุถุฑุฑ (ูู ุงููุงููุงุณ ุงูุฑุฆูุณู ุฃู ุงูููุฏุงู)
            let canvasToSave = damageCanvas;
            if (modalDamageCanvas && modalDamageCanvas.getObjects().length > 0) {
                canvasToSave = modalDamageCanvas;
            } else if (damageCanvas && damageCanvas.getObjects().length > 0) {
                canvasToSave = damageCanvas;
            }

            if (canvasToSave && canvasToSave.getObjects().length > 0) {
                document.getElementById('damage-diagram-data').value = canvasToSave.toDataURL({ format: 'png', quality: 0.8 });
            }
            // ุจ. ุญูุธ ุงูุชูุงููุน ุงููุฑุณููุฉ ููุท (ุงูุชู ุชู ุฑูุนูุง ูุญููุธุฉ ุจุงููุนู)
            for (const id in signaturePads) {
                const hiddenInput = document.getElementById(id.replace('-canvas', '-data'));
                if (hiddenInput && !hiddenInput.value.startsWith('data:image')) {
                    const canvas = signaturePads[id];
                    if (canvas.getObjects().length > 0) {
                        hiddenInput.value = canvas.toDataURL({ format: 'png' });
                    }
                }
            }

            // ุฌ. ุญูุธ ุชูููุน ุงููุดุฑู (ูู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุญุงูู)
            const supervisorSignatureInput = document.getElementById('supervisor-signature-data');
            if (supervisorSignatureInput) {
                const supervisorCanvas = signaturePads['supervisor-signature-canvas'];
                if (supervisorCanvas && supervisorCanvas.getObjects().length > 0) {
                    supervisorSignatureInput.value = supervisorCanvas.toDataURL({ format: 'png' });
                }
            }
        });

    }); // ููุงูุฉ DOMContentLoaded

    // === 8. ููุก ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ุนูุฏ ุงูุชุนุฏูู ===
    {% if existing_handover %}
    document.addEventListener('DOMContentLoaded', function() {
        const handover = JSON.parse('{{ existing_handover|tojson|safe }}');

        // ููุก ุจูุงูุงุช ุงููุฑูุจุฉ
        if (handover.vehicle_id) {
            const vehicleSelect = document.getElementById('vehicle_id');
            vehicleSelect.value = handover.vehicle_id;
            vehicleSelect.dispatchEvent(new Event('change'));
        }

        // ููุก ููุน ุงูุนูููุฉ
        if (handover.handover_type) {
            const typeSelect = document.getElementById('handover_type');
            typeSelect.value = handover.handover_type;
        }

        // ููุก ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
        if (handover.project_name) {
            document.getElementById('project_name').value = handover.project_name;
        }
        if (handover.city) {
            document.getElementById('city').value = handover.city;
        }
        if (handover.mileage) {
            document.getElementById('mileage').value = handover.mileage;
        }
        if (handover.fuel_level) {
            document.getElementById('fuel_level').value = handover.fuel_level;
        }
        if (handover.reason_for_change) {
            document.getElementById('reason_for_change').value = handover.reason_for_change;
        }

        // ููุก ุจูุงูุงุช ุงูุณุงุฆู
        if (handover.person_name) {
            document.getElementById('person_name').value = handover.person_name;
        }
        if (handover.employee_id) {
            document.getElementById('employee_id').value = handover.employee_id;
        }

        // ููุก ุจูุงูุงุช ุงููุดุฑู
        if (handover.supervisor_name) {
            document.getElementById('supervisor_name').value = handover.supervisor_name;
        }
        if (handover.supervisor_employee_id) {
            document.getElementById('supervisor_employee_id').value = handover.supervisor_employee_id;
        }

        // ููุก ูุงุฆูุฉ ุงููุญุต
        const checklistItems = [
            'has_spare_tire', 'has_fire_extinguisher', 'has_first_aid_kit',
            'has_warning_triangle', 'has_tools', 'has_oil_leaks', 'has_gear_issue',
            'has_clutch_issue', 'has_engine_issue', 'has_windows_issue',
            'has_tires_issue', 'has_body_issue', 'has_electricity_issue',
            'has_lights_issue', 'has_ac_issue'
        ];

        checklistItems.forEach(item => {
            if (handover[item]) {
                const checkbox = document.getElementById(item);
                if (checkbox) {
                    checkbox.checked = handover[item];
                }
            }
        });

        // ููุก ุงูููุงุญุธุงุช ูุงูุญููู ุงูุฅุถุงููุฉ
        if (handover.notes) {
            const notesField = document.getElementById('notes');
            if (notesField) {
                notesField.value = handover.notes;
            }
        }
        if (handover.vehicle_status_summary) {
            const statusField = document.getElementById('vehicle_status_summary');
            if (statusField) {
                statusField.value = handover.vehicle_status_summary;
            }
        }
        if (handover.reason_for_authorization) {
            const authField = document.getElementById('reason_for_authorization');
            if (authField) {
                authField.value = handover.reason_for_authorization;
            }
        }
        if (handover.authorization_details) {
            const detailsField = document.getElementById('authorization_details');
            if (detailsField) {
                detailsField.value = handover.authorization_details;
            }
        }
        if (handover.movement_officer_name) {
            const officerField = document.getElementById('movement_officer_name');
            if (officerField) {
                officerField.value = handover.movement_officer_name;
            }
        }
        if (handover.form_link) {
            const linkField = document.getElementById('form_link');
            if (linkField) {
                linkField.value = handover.form_link;
            }
        }
        if (handover.custom_company_name) {
            const companyField = document.getElementById('custom_company_name');
            if (companyField) {
                companyField.value = handover.custom_company_name;
            }
        }

        // ุฅุธูุงุฑ ุงููููุฐุฌ ุจุนุฏ ููุก ุงูุจูุงูุงุช
        setTimeout(() => {
            const container = document.getElementById('handover-form-container');
            if (container) {
                container.classList.remove('d-none');
            }
        }, 500);
    });
    {% endif %}
</script>

<!-- Template ููุจุญุซ ุนู ุงูููุธููู -->
<script type="text/html" id="search-template">
    <div class="mb-3">
        <label class="form-label">ููุชุฑุฉ ุญุณุจ ุงููุณู:</label>
        <select class="form-select department-select">
            <option value="">ูู ุงูุฃูุณุงู</option>
            {% for dept in departments %}
            <option value="{{ dept.id }}">{{ dept.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">ุงูุจุญุซ ุจุงูุงุณู ุฃู ุฑูู ุงูููุธู:</label>
        <input
            type="text"
            class="form-control search-input"
            placeholder="ุงูุชุจ ููุจุญุซ..."
        />
    </div>
    <div
        class="list-group list-container"
        style="max-height: 300px; overflow-y: auto;"
    ></div>
    <div class="alert alert-info text-center d-none no-results-alert">
        <i class="fas fa-search"></i> ูุง ุชูุฌุฏ ูุชุงุฆุฌ ููุจุญุซ
    </div>
</script>
{% endblock %}
