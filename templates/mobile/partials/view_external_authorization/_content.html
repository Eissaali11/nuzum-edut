<style>
/* Ø¥ØµÙ„Ø§Ø­ ØªÙ…ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø¹ÙŠØ¯Ø§Ù‹ Ø¹Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„ÙÙˆØªØ± */
body {
    padding-top: 70px !important; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± */
    padding-bottom: 120px !important; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
}

.mobile-content-wrapper {
    padding-top: 20px;
    padding-bottom: 20px;
}
</style>

<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
<div class="card mb-3 mx-3">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0">
            <i class="fas fa-car ms-1"></i>
            Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-6">
                <strong>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©:</strong><br>
                <span class="text-primary">{{ vehicle.plate_number }}</span>
            </div>
            <div class="col-6">
                <strong>Ø§Ù„Ù…Ø§Ø±ÙƒØ©:</strong><br>
                <span>{{ vehicle.make }} {{ vehicle.model }}</span>
            </div>
        </div>
    </div>
</div>

<!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶ -->
<div class="card mb-3 mx-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
            <i class="fas fa-file-signature ms-1"></i>
            ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶
        </h6>
        <div>
            {% if authorization.status == 'pending' %}
                <span class="badge bg-warning">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
            {% elif authorization.status == 'approved' %}
                <span class="badge bg-success">Ù…ÙÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡</span>
            {% elif authorization.status == 'rejected' %}
                <span class="badge bg-danger">Ù…Ø±ÙÙˆØ¶</span>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù -->
        <div class="mb-3">
            <h6 class="text-primary border-bottom pb-1">
                <i class="fas fa-user ms-1"></i>
                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù
            </h6>
            <div class="row">
                <div class="col-12 mb-2">
                    <strong>Ø§Ù„Ø§Ø³Ù…:</strong> {{ authorization.employee.name }}
                </div>
                <div class="col-6">
                    <strong>Ø§Ù„Ù…Ù†ØµØ¨:</strong><br>
                    <small>{{ authorization.employee.job_title or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</small>
                </div>
                <div class="col-6">
                    <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong><br>
                    <small>{{ authorization.employee.mobile or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</small>
                </div>
                <div class="col-12 mt-2">
                    <strong>Ø§Ù„Ù‚Ø³Ù…:</strong>
                    {% for dept in authorization.employee.departments %}
                        <span class="badge bg-info me-1">{{ dept.name }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶ -->
        <div class="mb-3">
            <h6 class="text-primary border-bottom pb-1">
                <i class="fas fa-info-circle ms-1"></i>
                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙÙˆÙŠØ¶
            </h6>
            <div class="row">
                <div class="col-12 mb-2">
                    <strong>Ù†ÙˆØ¹ Ø§Ù„ØªÙÙˆÙŠØ¶:</strong>
                    <span class="badge bg-secondary">{{ authorization.authorization_type }}</span>
                </div>
                <div class="col-6">
                    <strong>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:</strong><br>
                    <small>{{ authorization.project_name or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</small>
                </div>
                <div class="col-6">
                    <strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong><br>
                    <small>{{ authorization.city or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</small>
                </div>
                <div class="col-6 mt-2">
                    <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong><br>
                    <small>{{ authorization.created_at.strftime('%Y-%m-%d') if authorization.created_at else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</small>
                </div>
                {% if authorization.updated_at and authorization.updated_at != authorization.created_at %}
                <div class="col-6 mt-2">
                    <strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong><br>
                    <small>{{ authorization.updated_at.strftime('%Y-%m-%d') }}</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ù…Ù„ÙØ§Øª -->
        {% if authorization.external_link or authorization.file_path %}
        <div class="mb-3">
            <h6 class="text-primary border-bottom pb-1">
                <i class="fas fa-paperclip ms-1"></i>
                Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø·
            </h6>
            {% if authorization.external_link %}
            <div class="mb-2">
                <strong>Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ:</strong><br>
                <a href="{{ authorization.external_link }}" target="_blank" class="btn btn-sm btn-outline-primary mt-1">
                    <i class="fas fa-external-link-alt ms-1"></i>
                    ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·
                </a>
            </div>
            {% endif %}
            
            {% if authorization.file_path %}
            <div class="mb-2">
                <strong>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚:</strong><br>
                <a href="{{ url_for('static', filename='uploads/authorizations/' + authorization.file_path.split('/')[-1]) }}" 
                   target="_blank" class="btn btn-sm btn-outline-success mt-1">
                    <i class="fas fa-file-pdf ms-1"></i>
                    Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù
                </a>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
        {% if authorization.notes %}
        <div class="mb-3">
            <h6 class="text-primary border-bottom pb-1">
                <i class="fas fa-sticky-note ms-1"></i>
                Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            </h6>
            <div class="alert alert-info">
                {{ authorization.notes }}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
<div class="action-buttons-container mb-5 mx-3">
    <!-- Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ù…Ù„ -->
    <button onclick="shareFullAuthorization()" class="btn btn-success w-100 mb-2">
        <i class="fas fa-share-alt ms-1"></i>
        Ù…Ø´Ø§Ø±ÙƒØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
    </button>
    
    <a href="{{ url_for('mobile.edit_external_authorization', vehicle_id=vehicle.id, auth_id=authorization.id) }}" 
       class="btn btn-warning w-100 mb-2">
        <i class="fas fa-edit ms-1"></i>
        ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶
    </a>
    
    {% if authorization.status == 'pending' %}
    <div class="row gx-2 mb-2">
        <div class="col-6">
            <a href="{{ url_for('mobile.approve_external_authorization', vehicle_id=vehicle.id, auth_id=authorization.id) }}" 
               class="btn btn-success w-100" 
               onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ØªÙÙˆÙŠØ¶ØŸ')">
                <i class="fas fa-check ms-1"></i>
                Ù…ÙˆØ§ÙÙ‚Ø©
            </a>
        </div>
        <div class="col-6">
            <a href="{{ url_for('mobile.reject_external_authorization', vehicle_id=vehicle.id, auth_id=authorization.id) }}" 
               class="btn btn-danger w-100" 
               onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¶ Ù‡Ø°Ø§ Ø§Ù„ØªÙÙˆÙŠØ¶ØŸ')">
                <i class="fas fa-times ms-1"></i>
                Ø±ÙØ¶
            </a>
        </div>
    </div>
    {% endif %}
    
    <div class="row gx-2">
        <div class="col-6">
            <a href="{{ url_for('vehicles.delete_external_authorization', vehicle_id=vehicle.id, auth_id=authorization.id) }}" 
               class="btn btn-outline-danger w-100" 
               onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙÙˆÙŠØ¶ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')">
                <i class="fas fa-trash ms-1"></i>
                Ø­Ø°Ù
            </a>
        </div>
        <div class="col-6">
            <a href="{{ url_for('mobile.vehicle_details', vehicle_id=vehicle.id) }}" class="btn btn-outline-secondary w-100">
                <i class="fas fa-arrow-right ms-1"></i>
                Ø§Ù„Ø¹ÙˆØ¯Ø©
            </a>
        </div>
    </div>
</div>

<script>
// Ø¯Ø§Ù„Ø© Ù…Ø´Ø§Ø±ÙƒØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
async function shareFullAuthorization() {
    const vehicleInfo = "{{ vehicle.plate_number }} - {{ vehicle.make }} {{ vehicle.model }}";
    
    // Ø¥Ù†Ø´Ø§Ø¡ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
    const currentDate = new Date();
    const formattedDateTime = currentDate.toLocaleString('ar-SA', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ù†Ø¸ÙŠÙØ©
    let shareText = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹

Ø¥Ù„ÙŠÙƒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„Ø©:

ğŸš™ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${vehicleInfo}
ğŸ“… ØªØ§Ø±ÙŠØ® ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${formattedDateTime}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ø§Ù„Ø§Ø³Ù…: {{ authorization.employee.name }}
Ø§Ù„Ù…Ù†ØµØ¨: {{ authorization.employee.job_title or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
Ø§Ù„Ù‡Ø§ØªÙ: {{ authorization.employee.mobile or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
Ø§Ù„Ù‚Ø³Ù…: {% for dept in authorization.employee.departments %}{{ dept.name }}{% if not loop.last %}, {% endif %}{% endfor %}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ù†ÙˆØ¹ Ø§Ù„ØªÙÙˆÙŠØ¶: {{ authorization.authorization_type }}
Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: {{ authorization.project_name or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: {{ authorization.city or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: {{ authorization.created_at.strftime('%Y-%m-%d') if authorization.created_at else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
{% if authorization.updated_at and authorization.updated_at != authorization.created_at %}
Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {{ authorization.updated_at.strftime('%Y-%m-%d') }}
{% endif %}
Ø§Ù„Ø­Ø§Ù„Ø©: {% if authorization.status == 'pending' %}Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©{% elif authorization.status == 'approved' %}Ù…ÙÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡{% elif authorization.status == 'rejected' %}Ù…Ø±ÙÙˆØ¶{% endif %}

`;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
    let hasAttachments = false;
    {% if authorization.external_link %}
    shareText += `ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ:
{{ authorization.external_link }}

`;
    hasAttachments = true;
    {% endif %}
    {% if authorization.file_path %}
    shareText += `ğŸ“„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚:
{{ request.url_root }}static/uploads/authorizations/{{ authorization.file_path.split('/')[-1] }}

`;
    hasAttachments = true;
    {% endif %}
    
    {% if authorization.notes %}
    shareText += `ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
{{ authorization.notes }}

`;
    {% endif %}
    
    shareText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“± Ù†Ø¸Ø§Ù… Ù†ÙØ¸Ù… Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª
ğŸ• ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${formattedDateTime}`;

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© (Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ÙÙ‚Ø·)
    const externalLink = '{{ authorization.external_link if authorization.external_link else "" }}';
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ§ØµÙŠÙ„
    const primaryUrl = externalLink;

    if (navigator.share) {
        try {
            const shareData = {
                title: `ØªÙÙˆÙŠØ¶ Ø®Ø§Ø±Ø¬ÙŠ - ${vehicleInfo}`,
                text: shareText
            };
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹
            if (primaryUrl && primaryUrl.trim() !== '') {
                shareData.url = primaryUrl;
            }
            
            await navigator.share(shareData);
        } catch (error) {
            console.log('Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ù„ØºØ§Ø© Ø£Ùˆ Ø®Ø·Ø£:', error);
            showFallbackShare(shareText);
        }
    } else {
        showFallbackShare(shareText);
    }
}

// Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
function showFallbackShare(text) {
    // Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            alert('ØªÙ… Ù†Ø³Ø® ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©');
        }).catch(() => {
            showTextModal(text);
        });
    } else {
        showTextModal(text);
    }
}

function showTextModal(text) {
    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 9999;
        display: flex; align-items: center; justify-content: center;
    `;
    
    const content = document.createElement('div');
    content.style.cssText = `
        background: white; padding: 20px; border-radius: 8px;
        max-width: 90%; max-height: 80%; overflow-y: auto;
        direction: rtl; text-align: right;
    `;
    
    content.innerHTML = `
        <h5>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙÙˆÙŠØ¶ Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h5>
        <textarea readonly style="width: 100%; height: 300px; margin: 10px 0;">${text}</textarea>
        <button onclick="this.closest('.modal').remove()" class="btn btn-primary">Ø¥ØºÙ„Ø§Ù‚</button>
    `;
    
    modal.appendChild(content);
    modal.className = 'modal';
    document.body.appendChild(modal);
}
</script>
