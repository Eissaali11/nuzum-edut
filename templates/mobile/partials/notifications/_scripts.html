<script>
// تعليم الإشعار كمقروء
function markAsRead(id) {
    fetch('/mobile/api/notifications/' + id + '/read', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // تحديث واجهة المستخدم
            const notification = document.querySelector(`.notification-item[data-id="${id}"]`);
            notification.classList.remove('unread');
            notification.classList.add('read');
            
            // تحديث زر الإشعار
            const actionBtn = notification.querySelector('.notification-action i');
            actionBtn.classList.remove('fa-envelope');
            actionBtn.classList.add('fa-envelope-open');
            
            // تحديث الإحصائيات
            updateStats();
        }
    })
    .catch(error => {
        console.error('خطأ:', error);
    });
}

// تعليم جميع الإشعارات كمقروءة
function markAllAsRead() {
    fetch('/mobile/api/notifications/read-all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // تحديث واجهة المستخدم
            const unreadNotifications = document.querySelectorAll('.notification-item.unread');
            unreadNotifications.forEach(notification => {
                notification.classList.remove('unread');
                notification.classList.add('read');
                
                // تحديث زر الإشعار
                const actionBtn = notification.querySelector('.notification-action i');
                actionBtn.classList.remove('fa-envelope');
                actionBtn.classList.add('fa-envelope-open');
            });
            
            // تحديث الإحصائيات
            updateStats();
        }
    })
    .catch(error => {
        console.error('خطأ:', error);
    });
}

// حذف إشعار
function deleteNotification(id) {
    if (confirm('هل تريد حذف هذا الإشعار؟')) {
        fetch('/mobile/api/notifications/' + id, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // حذف الإشعار من واجهة المستخدم
                const notification = document.querySelector(`.notification-item[data-id="${id}"]`);
                notification.style.height = notification.offsetHeight + 'px';
                notification.style.height = '0';
                notification.style.padding = '0';
                notification.style.overflow = 'hidden';
                
                setTimeout(() => {
                    notification.remove();
                    
                    // التحقق مما إذا كانت القائمة فارغة
                    const notificationList = document.querySelector('.notification-list');
                    if (notificationList.children.length === 0) {
                        location.reload(); // إعادة تحميل الصفحة لإظهار رسالة "لا توجد إشعارات"
                    } else {
                        // تحديث الإحصائيات
                        updateStats();
                    }
                }, 300);
            }
        })
        .catch(error => {
            console.error('خطأ:', error);
        });
    }
}

// عرض تفاصيل الإشعار
function viewNotification(id) {
    const notification = document.querySelector(`.notification-item[data-id="${id}"]`);
    const type = notification.dataset.type;
    
    // تعليم الإشعار كمقروء إذا لم يكن مقروءاً بالفعل
    if (notification.classList.contains('unread')) {
        markAsRead(id);
    }
    
    // توجيه المستخدم إلى الصفحة المناسبة حسب نوع الإشعار
    switch (type) {
        case 'document':
            // إعادة توجيه إلى صفحة الوثيقة
            // window.location.href = `/mobile/documents/view/${documentId}`;
            break;
        case 'salary':
            // إعادة توجيه إلى صفحة الراتب
            // window.location.href = `/mobile/salaries/view/${salaryId}`;
            break;
        case 'attendance':
            // إعادة توجيه إلى صفحة الحضور
            // window.location.href = `/mobile/attendance/view/${attendanceId}`;
            break;
        case 'fee':
            // إعادة توجيه إلى صفحة الرسوم
            // window.location.href = `/mobile/fees/view/${feeId}`;
            break;
        default:
            // لا شيء
            break;
    }
}

// تحديث إحصائيات الإشعارات
function updateStats() {
    const unreadCount = document.querySelectorAll('.notification-item.unread').length;
    const readCount = document.querySelectorAll('.notification-item.read').length;
    const totalCount = unreadCount + readCount;
    
    // تحديث العناصر في واجهة المستخدم
    document.querySelector('.notification-stat.new .notification-value').textContent = unreadCount;
    document.querySelector('.notification-stat.read .notification-value').textContent = readCount;
    document.querySelector('.notification-stat.total .notification-value').textContent = totalCount;
}

// فلترة الإشعارات
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.notification-tab');
    const notifications = document.querySelectorAll('.notification-item');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // إزالة الفئة النشطة من جميع علامات التبويب
            tabs.forEach(t => t.classList.remove('active'));
            
            // إضافة الفئة النشطة إلى علامة التبويب المحددة
            this.classList.add('active');
            
            // الحصول على فلتر
            const filter = this.dataset.filter;
            
            // تطبيق الفلتر
            notifications.forEach(notification => {
                if (filter === 'all') {
                    notification.style.display = 'flex';
                } else if (filter === 'unread' && notification.classList.contains('unread')) {
                    notification.style.display = 'flex';
                } else if (filter === 'read' && notification.classList.contains('read')) {
                    notification.style.display = 'flex';
                } else {
                    notification.style.display = 'none';
                }
            });
        });
    });
});
</script>
