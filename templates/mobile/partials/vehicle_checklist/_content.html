<div class="container-fluid p-2 p-md-3">

    <div class="d-flex justify-content-between align-items-center mb-3 px-2">
        <h4 class="mb-0">
            {% if is_editing %}
                <i class="fas fa-edit text-primary"></i> تعديل فحص لـ: <strong class="text-dark">{{ vehicle.plate_number }}</strong>
            {% elif force_mode == 'return' %}
                <i class="fas fa-reply text-info"></i> استلام مركبة: <strong class="text-dark">{{ vehicle.plate_number }}</strong>
            {% else %}
                <i class="fas fa-share text-success"></i> تسليم مركبة: <strong class="text-dark">{{ vehicle.plate_number }}</strong>
            {% endif %}
        </h4>
        <a href="{{ url_for('mobile.vehicle_details', vehicle_id=vehicle.id) }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-car"></i> العودة
        </a>
    </div>

    <!-- المحور الثاني: الهيكل الكامل لـ HTML والمنطق -->
    <form id="main-handover-form" method="post" action="{{ form_action }}" enctype="multipart/form-data" class="needs-validation" novalidate>

        {% if info_message %}
            <div class="alert alert-info border-0 shadow-sm">{{ info_message }}</div>
        {% endif %}

        <!-- بطاقة معلومات السيارة (ثابتة) -->
        <div class="card">
            <div class="card-body p-3">
                 <h5 class="card-title mb-2">معلومات المركبة</h5>
                 <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between px-0"><strong>النوع:</strong> <span>{{ vehicle.make }} {{ vehicle.model }}</span></li>
                    <li class="list-group-item d-flex justify-content-between px-0"><strong>الحالة الحالية:</strong> <span>{{ vehicle.status_ar if vehicle.status_ar else vehicle.status }}</span></li>
                 </ul>
            </div>
        </div>

        <!-- بطاقة المعلومات الأساسية -->
        <div class="card">
            <div class="card-body p-3">
                 <h5 class="card-title mb-3">المعلومات الأساسية</h5>
                 <div class="row g-3">
                     <div class="col-12">
                        <label class="form-label">نوع العملية</label>
                        <input type="text" class="form-control" 
                               value="{% if is_editing %}{{ 'تسليم' if existing_handover.handover_type == 'delivery' else 'استلام' }}{% elif force_mode == 'return' %}استلام مركبة من سائق{% else %}تسليم مركبة لسائق{% endif %}" 
                               readonly>
                        <input type="hidden" name="handover_type" value="{{ existing_handover.handover_type if is_editing else force_mode }}">
                    </div>
                    <div class="col-6">
                        <label for="handover_date" class="form-label">التاريخ</label>
                        <input type="date" class="form-control" id="handover_date" name="handover_date" value="{% if is_editing and existing_handover.handover_date %}{{ existing_handover.handover_date }}{% else %}{{ now_date }}{% endif %}" required>
                    </div>
                    <div class="col-6">
                        <label for="handover_time" class="form-label">الوقت</label>
                        <input type="time" class="form-control" id="handover_time" name="handover_time" value="{% if is_editing and existing_handover.handover_time %}{{ existing_handover.handover_time }}{% else %}{{ now_time }}{% endif %}">
                    </div>
                    <div class="col-6">
                        <label for="mileage" class="form-label">عداد الكيلومترات</label>
                        <input type="number" class="form-control" id="mileage" name="mileage" value="{% if is_editing %}{{ existing_handover.mileage }}{% endif %}" placeholder="كم" required>
                    </div>
                    <div class="col-6">
                        <label for="fuel_level" class="form-label">الوقود</label>
                        <select class="form-select" id="fuel_level" name="fuel_level" required>
                             <option value="ممتلئ" {% if is_editing and existing_handover.fuel_level == 'ممتلئ' %}selected{% endif %}>ممتلئ</option>
                             <option value="3/4" {% if is_editing and existing_handover.fuel_level == '3/4' %}selected{% endif %}>3/4</option>
                             <option value="1/2" {% if is_editing and existing_handover.fuel_level == '1/2' %}selected{% endif %}>نصف</option>
                             <option value="1/4" {% if is_editing and existing_handover.fuel_level == '1/4' %}selected{% endif %}>ربع</option>
                             <option value="منخفض" {% if is_editing and existing_handover.fuel_level == 'منخفض' %}selected{% endif %}>منخفض</option>
                        </select>
                    </div>
                 </div>
            </div>
        </div>

        <!-- بطاقة بيانات الأشخاص -->
        <!-- في ملف: templates/mobile/vehicle_checklist.html -->

        <!-- ... -->
        <!-- في ملف: templates/mobile/vehicle_checklist.html -->

        <!-- في ملف: templates/mobile/vehicle_checklist.html -->

        <!-- ... -->
        <!-- بطاقة بيانات الأشخاص (بنية مبسطة وفعالة لـ Select2) -->
        <div class="card">
            <div class="card-body p-3">
                <h5 class="card-title mb-3">بيانات الأشخاص</h5>

                <div class="mb-3">
                    <label for="department_filter" class="form-label">تصفية حسب القسم</label>
                    <select id="department_filter" class="form-select form-select-sm">
                       <option value="all">جميع الأقسام</option>
                       {% for dept in departments %} <option value="{{ dept.id }}">{{ dept.name }}</option> {% endfor %}
                    </select>
                </div>
                <hr>

                <!-- قسم السائق -->
                <h6 class="text-muted">السائق / المستلم</h6>
                {% if not is_editing and force_mode == 'return' %}
                    <div class="mb-3">
                        <label class="form-label">اسم السائق الحالي</label>
                        <input type="text" class="form-control" value="{{ current_driver_info.person_name }}" readonly>
                        <input type="hidden" name="employee_id" value="{{ current_driver_info.employee_id or '' }}">
                        <input type="hidden" name="person_name" value="{{ current_driver_info.person_name }}">
                    </div>
                {% else %}
                    <div class="mb-3">
                        <label for="employee_id" class="form-label">السائق (من القائمة)</label>
                        <select class="form-select select2-bs5" id="employee_id" name="employee_id">
                            <option value="">-- سائق غير مسجل --</option>
                            {% for employee in employees %}
                                <option value="{{ employee.id }}" {% if is_editing and existing_handover.employee_id == employee.id %}selected{% endif %}
                                    data-departments="{{ employee.departments|map(attribute='id')|join(',') }}">{{ employee.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="person_name" class="form-label">أو أدخل اسم السائق يدوياً</label>
                        <input type="text" class="form-control" id="person_name" name="person_name" value="{% if is_editing %}{{ existing_handover.person_name or '' }}{% endif %}" placeholder="اسم السائق" required>
                    </div>
                {% endif %}
                <hr>

                <!-- قسم المشرف -->
                <h6 class="text-muted">المشرف / المسلّم</h6>
                <div class="mb-3">
                    <label for="supervisor_employee_id" class="form-label">المشرف (من القائمة)</label>
                    <select class="form-select select2-bs5" id="supervisor_employee_id" name="supervisor_employee_id">
                        <option value="">-- مشرف غير مسجل --</option>
                        {% for employee in employees %}
                             <option value="{{ employee.id }}" {% if is_editing and existing_handover.supervisor_employee_id == employee.id %}selected{% endif %}
                                data-departments="{{ employee.departments|map(attribute='id')|join(',') }}">{{ employee.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                 <div class="mb-3">
                    <label for="supervisor_name" class="form-label">أو أدخل اسم المشرف يدوياً</label>
                    <input type="text" class="form-control" id="supervisor_name" name="supervisor_name" value="{% if is_editing %}{{ existing_handover.supervisor_name or '' }}{% endif %}" placeholder="اسم المشرف">
                </div>
            </div>
        </div>
        <!-- ... -->

        <!-- بطاقة قائمة الفحص الكاملة (داخل Accordion) -->
        <div class="card">
             <div class="accordion" id="checklistAccordion">
                <div class="accordion-item border-0">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseChecklist">قائمة الفحص والتجهيزات</button></h2>
                    <div id="collapseChecklist" class="accordion-collapse collapse" data-bs-parent="#checklistAccordion">
                        <div class="accordion-body">
                            <h6>التجهيزات المتوفرة</h6>
                            <ul class="list-group list-group-flush mb-3">
                                <li class="list-group-item ps-0"><div class="form-check"><input class="form-check-input" type="checkbox" name="has_spare_tire" id="has_spare_tire" {% if not is_editing or (is_editing and existing_handover.has_spare_tire) %}checked{% endif %}><label for="has_spare_tire" class="form-check-label">إطار احتياطي</label></div></li>
                                <li class="list-group-item ps-0"><div class="form-check"><input class="form-check-input" type="checkbox" name="has_fire_extinguisher" id="has_fire_extinguisher" {% if not is_editing or (is_editing and existing_handover.has_fire_extinguisher) %}checked{% endif %}><label for="has_fire_extinguisher" class="form-check-label">طفاية حريق</label></div></li>
                                <li class="list-group-item ps-0"><div class="form-check"><input class="form-check-input" type="checkbox" name="has_first_aid_kit" id="has_first_aid_kit" {% if not is_editing or (is_editing and existing_handover.has_first_aid_kit) %}checked{% endif %}><label for="has_first_aid_kit" class="form-check-label">إسعافات أولية</label></div></li>
                                <li class="list-group-item ps-0"><div class="form-check"><input class="form-check-input" type="checkbox" name="has_warning_triangle" id="has_warning_triangle" {% if not is_editing or (is_editing and existing_handover.has_warning_triangle) %}checked{% endif %}><label for="has_warning_triangle" class="form-check-label">مثلث تحذيري</label></div></li>
                                <li class="list-group-item ps-0"><div class="form-check"><input class="form-check-input" type="checkbox" name="has_tools" id="has_tools" {% if not is_editing or (is_editing and existing_handover.has_tools) %}checked{% endif %}><label for="has_tools" class="form-check-label">أدوات</label></div></li>
                            </ul>
                            <h6 class="text-muted mt-4">المشاكل الموجودة <small>(حدد إن وجدت)</small></h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item ps-0"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_oil_leaks" id="has_oil_leaks" {% if is_editing and existing_handover.has_oil_leaks %}checked{% endif %}><label for="has_oil_leaks" class="form-check-label">تهريب زيوت</label></div></li>
                                <li class="list-group-item ps-0"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_gear_issue" id="has_gear_issue" {% if is_editing and existing_handover.has_gear_issue %}checked{% endif %}><label for="has_gear_issue" class="form-check-label">مشكلة في الجير</label></div></li>
                                <li class="list-group-item ps-0"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_clutch_issue" id="has_clutch_issue" {% if is_editing and existing_handover.has_clutch_issue %}checked{% endif %}><label for="has_clutch_issue" class="form-check-label">مشكلة كلتش</label></div></li>
                                <li class="list-group-item ps-0"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_engine_issue" id="has_engine_issue" {% if is_editing and existing_handover.has_engine_issue %}checked{% endif %}><label for="has_engine_issue" class="form-check-label">مشكلة ماكينة</label></div></li>
                                <li class="list-group-item ps-0"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_ac_issue" id="has_ac_issue" {% if is_editing and existing_handover.has_ac_issue %}checked{% endif %}><label for="has_ac_issue" class="form-check-label">مشكلة مكيف</label></div></li>
                                <li class="list-group-item ps-0"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_windows_issue" id="has_windows_issue" {% if is_editing and existing_handover.has_windows_issue %}checked{% endif %}><label for="has_windows_issue" class="form-check-label">مشكلة زجاج</label></div></li>
                                <li class="list-group-item ps-0"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_tires_issue" id="has_tires_issue" {% if is_editing and existing_handover.has_tires_issue %}checked{% endif %}><label for="has_tires_issue" class="form-check-label">مشكلة إطارات</label></div></li>
                                <li class="list-group-item ps-0"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_body_issue" id="has_body_issue" {% if is_editing and existing_handover.has_body_issue %}checked{% endif %}><label for="has_body_issue" class="form-check-label">مشكلة هيكل</label></div></li>
                                <li class="list-group-item ps-0"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_electricity_issue" id="has_electricity_issue" {% if is_editing and existing_handover.has_electricity_issue %}checked{% endif %}><label for="has_electricity_issue" class="form-check-label">مشكلة كهرباء</label></div></li>
                                <li class="list-group-item ps-0"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" name="has_lights_issue" id="has_lights_issue" {% if is_editing and existing_handover.has_lights_issue %}checked{% endif %}><label for="has_lights_issue" class="form-check-label">مشكلة أنوار</label></div></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- بطاقة التوثيق والملاحظات (داخل Accordion) -->
        <div class="card">
            <div class="accordion" id="docsAccordion">
                <div class="accordion-item border-0">
                    <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDocs">التوثيق والملاحظات</button></h2>
                    <div id="collapseDocs" class="accordion-collapse collapse show" data-bs-parent="#docsAccordion">
                        <div class="accordion-body">
                            <h6>تحديد الضرر على الهيكل</h6>
                            <div class="text-center mb-3"><div class="d-inline-block border rounded p-1 bg-light"><canvas id="damage-canvas" width="300" height="150"></canvas></div></div>
                            <div class="btn-group btn-group-sm d-flex mb-3" role="group"><button type="button" class="btn btn-outline-danger" id="clear-canvas-btn"><i class="fas fa-trash"></i> مسح</button><button type="button" class="btn btn-outline-secondary" id="select-mode-btn"><i class="fas fa-mouse-pointer"></i> تحديد</button><button type="button" class="btn btn-primary active" id="draw-mode-btn"><i class="fas fa-pencil-alt"></i> رسم</button></div>
                            <hr>
                            <div class="mb-3">
                                <label for="vehicle_status_summary" class="form-label">وصف حالة المركبة</label>
                                <textarea class="form-control" id="vehicle_status_summary" name="vehicle_status_summary" rows="3" placeholder="مثال: السيارة نظيفة مع خدش بسيط..." required>{% if is_editing %}{{ existing_handover.vehicle_status_summary or '' }}{% endif %}</textarea>
                            </div>
                            <h6>رفع مرفقات (صور, PDF)</h6>
                            <div class="d-grid mb-2">
                                <button class="btn btn-outline-secondary" type="button" id="trigger-file-select"><i class="fas fa-paperclip me-1"></i> اختر ملفات</button>
                                <input type="file" id="files" name="files" multiple class="d-none" accept="image/*,.heic,.heif,application/pdf">
                            </div>
                            <div id="file-previews" class="row g-2"></div>
                            <hr>
                            
                            <!-- حقل رابط نموذج خارجي 1 -->
                            <div class="mb-3">
                                <label for="form_link" class="form-label">
                                    <i class="fas fa-link me-2"></i>
                                    رابط نموذج خارجي 1 (اختياري)
                                </label>
                                <input type="url" class="form-control" id="form_link" name="form_link" 
                                       placeholder="https://example.com/form" 
                                       value="{% if is_editing %}{{ existing_handover.form_link or '' }}{% endif %}">
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-info-circle me-1"></i>
                                    يمكن إضافة رابط لنموذج خارجي مثل Google Forms
                                </small>
                            </div>

                            <!-- حقل رابط نموذج خارجي 2 -->
                            <div class="mb-3">
                                <label for="form_link_2" class="form-label">
                                    <i class="fas fa-link me-2"></i>
                                    رابط نموذج خارجي 2 (اختياري)
                                </label>
                                <input type="url" class="form-control" id="form_link_2" name="form_link_2" 
                                       placeholder="https://example.com/form2" 
                                       value="{% if is_editing %}{{ existing_handover.form_link_2 or '' }}{% endif %}">
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-info-circle me-1"></i>
                                    رابط إضافي ثاني للنماذج الخارجية
                                </small>
                            </div>
                            
                             <div class="mb-3">
                                <label for="notes" class="form-label">ملاحظات إضافية</label>
                                <textarea class="form-control" id="notes" name="notes" rows="2">{% if is_editing %}{{ existing_handover.notes or '' }}{% endif %}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- بطاقة التواقيع (داخل Accordion) -->
        <div class="card">
             <div class="accordion" id="signaturesAccordion">
                <div class="accordion-item border-0">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSignatures">التواقيع</button></h2>
                    <div id="collapseSignatures" class="accordion-collapse collapse" data-bs-parent="#signaturesAccordion">
                        <div class="accordion-body">
                            <div class="mb-3">
                                <label class="form-label">توقيع المشرف (<span id="supervisor-name-display">...</span>)</label>
                                <div class="signature-pad-container"><canvas id="supervisor-signature-canvas"></canvas></div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2 clear-signature" data-canvas-id="supervisor-signature-canvas">مسح</button>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">توقيع السائق (<span id="driver-name-display">...</span>)</label>
                                <div class="signature-pad-container"><canvas id="driver-signature-canvas"></canvas></div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2 clear-signature" data-canvas-id="driver-signature-canvas">مسح</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- حقول مخفية -->
        <input type="hidden" name="supervisor_signature_data" id="supervisor-signature-data">
        <input type="hidden" name="driver_signature_data" id="driver-signature-data">
        <input type="hidden" name="damage_diagram_data" id="damage-diagram-data">

        <!-- أزرار الحفظ الديناميكية النهائية -->
        <div class="d-grid mt-3 gap-2 action-buttons-container">

        <div class="d-grid mt-3 gap-2">
             {% if is_editing %}
                 <button type="submit" name="action" value="update" class="btn btn-primary btn-lg">
                     <i class="fas fa-save me-2"></i> حفظ التعديلات
                 </button>
                 <button type="submit" name="action" value="save_as_next" class="btn btn-success btn-lg" 
                         formaction="{{ url_for('mobile.save_as_next_handover_mobile', handover_id=existing_handover.id) }}">
                     <i class="fas fa-copy me-2"></i> حفظ كعملية تالية ({% if existing_handover.handover_type == 'return' %}'تسليم'{% else %}'استلام'{% endif %})
                 </button>
             {% else %}
                 <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-paper-plane me-2"></i> إرسال الطلب للموافقة
                </button>
             {% endif %}
        </div>
            </div>

    </form>

    <!-- قوالب المعاينة المخفية (ضرورية للـ JavaScript) -->
    <template id="image-preview-template">
        <div class="col-6 preview-item">
            <div class="card">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect fill='%23f0f0f0' width='100' height='100'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23999' font-size='14'%3Eجاري التحميل...%3C/text%3E%3C/svg%3E" alt="صورة" class="preview-image">
                <button type="button" class="btn-close remove-file"></button>
            </div>
        </div>
    </template>
    <template id="pdf-preview-template">
         <div class="col-12 preview-item">
             <div class="card p-2">
                 <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-file-pdf fa-2x text-danger me-2"></i>
                        <small class="pdf-filename text-truncate"></small>
                    </div>
                    <button type="button" class="btn-close remove-file"></button>
                 </div>
             </div>
         </div>
    </template>
</div>
