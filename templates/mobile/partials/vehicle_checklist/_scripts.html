    {{ super() }}
    <!-- مكتبات JS المطلوبة (تأكد من وجود jQuery قبل Select2) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <script>
    // استخدام $(document).ready() من jQuery لضمان أن كل عناصر DOM قد تم تحميلها وجاهزة للتفاعل.
    $(document).ready(function () {

        // استخدام setTimeout للتأكد من أن كل شيء قد تم عرضه (rendered) بشكل كامل
        setTimeout(function() {

            // ===================================================================
            // الوحدة 1: تهيئة المكونات والمكتبات الخارجية
            // ===================================================================
            function initComponents() {
                if ($('.select2-bs5').length > 0) {
                    $('.select2-bs5').select2({
                        theme: 'bootstrap-5',
                        placeholder: 'اختر أو ابحث...',
                        width: '100%',
                        tags: true
                      
                    });
                }
            }

            // ===================================================================
            // الوحدة 2: إدارة لوحات الرسم (Canvas)
            // ===================================================================
            let damageCanvas = null;
            const sigPads = {};
            function initCanvases() {
                const damageCanvasElement = document.getElementById('damage-canvas');
                if (damageCanvasElement) {
                    damageCanvas = new fabric.Canvas('damage-canvas', { isDrawingMode: true });
                    const imageUrl = "{{ url_for('static', filename='images/vehicle_diagram.png') }}";
                    fabric.Image.fromURL(imageUrl, (img) => {
                        damageCanvas.setBackgroundImage(img, damageCanvas.renderAll.bind(damageCanvas), { scaleX: damageCanvas.width / img.width, scaleY: damageCanvas.height / img.height });
                        {% if is_editing and existing_handover.damage_diagram_path %}
                            const savedDiagramUrl = "{{ url_for('static', filename=existing_handover.damage_diagram_path) }}";
                            fabric.Image.fromURL(savedDiagramUrl, (savedImg) => {
                                damageCanvas.add(savedImg.set({ evented: false, selectable: false }));
                                damageCanvas.renderAll();
                            }, { crossOrigin: 'anonymous' });
                        {% endif %}
                    }, { crossOrigin: 'anonymous' });
                    damageCanvas.freeDrawingBrush.color = "#E53935"; damageCanvas.freeDrawingBrush.width = 3;
                }
                ['supervisor-signature-canvas', 'driver-signature-canvas'].forEach(id => {
                    const canvasEl = document.getElementById(id); if (!canvasEl) return;
                    const container = canvasEl.parentElement; canvasEl.width = container.offsetWidth > 0 ? container.offsetWidth - 2 : 280; canvasEl.height = 120;
                    sigPads[id] = new fabric.Canvas(id, { isDrawingMode: true, backgroundColor: '#fff' });
                    sigPads[id].freeDrawingBrush.color = "#000000"; sigPads[id].freeDrawingBrush.width = 2;
                });
            }


            // ===================================================================
            // الوحدة 3: إدارة تفاعل المستخدمين والأحداث
            // ===================================================================
            function bindUIEvents() {
                // ... (كود أزرار الكانفاس كما هو)
                $('#draw-mode-btn').on('click', () => { if(damageCanvas) damageCanvas.isDrawingMode = true; });
                $('#select-mode-btn').on('click', () => { if(damageCanvas) damageCanvas.isDrawingMode = false; });
                $('#clear-canvas-btn').on('click', () => {
                    if(damageCanvas) {
                        damageCanvas.getObjects().forEach(obj => { if (obj !== damageCanvas.backgroundImage) damageCanvas.remove(obj); });
                        damageCanvas.renderAll();
                    }
                });
                $('.clear-signature').on('click', function() {
                    const canvasId = $(this).data('canvasId');
                    if (sigPads[canvasId]) sigPads[canvasId].clear();
                });

                // === بداية التعديل المهم ===
                const $employeeSelect = $('#employee_id');
                const $supervisorSelect = $('#supervisor_employee_id');
                const personNameInput = document.getElementById('person_name');
                const supervisorNameInput = document.getElementById('supervisor_name');
                const departmentFilter = document.getElementById('department_filter');

                // حفظ الخيارات الأصلية مرة واحدة عند التحميل
                const originalEmployeeOptions = [];
                const originalSupervisorOptions = [];
                
                // حفظ خيارات السائق
                $employeeSelect.find('option').each(function() {
                    originalEmployeeOptions.push({
                        value: $(this).val(),
                        text: $(this).text(),
                        departments: $(this).data('departments')
                    });
                });
                
                // حفظ خيارات المشرف
                $supervisorSelect.find('option').each(function() {
                    originalSupervisorOptions.push({
                        value: $(this).val(),
                        text: $(this).text(),
                        departments: $(this).data('departments')
                    });
                });

                // دالة محدثة لفلترة الموظفين باستخدام Select2
                const filterSelectOptions = () => {
                    const selectedDeptId = departmentFilter.value;
                    console.log('Selected department ID:', selectedDeptId);

                    // دالة الفلترة المحسنة
                    const applyFilter = ($selectElement, originalOptions, defaultText) => {
                        if (!$selectElement.length) return;

                        // احفظ القيمة المحددة حالياً
                        let currentSelection = $selectElement.val();
                        
                        // فلترة الخيارات حسب القسم المحدد
                        const filteredOptions = [];
                        
                        originalOptions.forEach(option => {
                            // احتفظ بالخيار الافتراضي دائماً
                            if (!option.value) {
                                filteredOptions.push(option);
                                return;
                            }

                            // تطبيق الفلتر
                            if (selectedDeptId === 'all') {
                                // أظهر كل الموظفين
                                filteredOptions.push(option);
                            } else {
                                // أظهر فقط الموظفين من القسم المحدد
                                const departments = String(option.departments || '').split(',');
                                if (departments.includes(selectedDeptId)) {
                                    filteredOptions.push(option);
                                }
                            }
                        });

                        // تدمير Select2 الحالي
                        $selectElement.select2('destroy');
                        
                        // مسح جميع الخيارات
                        $selectElement.empty();
                        
                        // إعادة بناء الخيارات
                        filteredOptions.forEach(option => {
                            const $newOption = $('<option></option>')
                                .attr('value', option.value)
                                .text(option.text);
                            
                            if (option.departments) {
                                $newOption.attr('data-departments', option.departments);
                            }
                            
                            $selectElement.append($newOption);
                        });

                        // إعادة تهيئة Select2
                        $selectElement.select2({
                            theme: 'bootstrap-5',
                            placeholder: 'اختر أو ابحث...',
                            width: '100%',
                            tags: true
                        });

                        // إعادة تحديد القيمة إذا كانت لا تزال متاحة
                        const availableValues = filteredOptions.map(opt => opt.value);
                        if (currentSelection && availableValues.includes(currentSelection)) {
                            $selectElement.val(currentSelection).trigger('change');
                        } else {
                            $selectElement.val('').trigger('change');
                        }
                        
                        console.log('Select element ID:', $selectElement.attr('id'));
                        console.log('Filtered options count:', filteredOptions.length - 1); // -1 for empty option
                        console.log('Available options:', filteredOptions.map(opt => opt.text));
                    };

                    console.log('Applying filter to employee select...');
                    applyFilter($employeeSelect, originalEmployeeOptions, '-- سائق غير مسجل --');
                    console.log('Applying filter to supervisor select...');
                    applyFilter($supervisorSelect, originalSupervisorOptions, '-- مشرف غير مسجل --');
                };

                $(departmentFilter).on('change', filterSelectOptions);
                // قم بتشغيل الفلتر مرة واحدة عند تحميل الصفحة في حال كان هناك قسم محدد مسبقاً
                filterSelectOptions();

                // --- (بقية دوال ربط الأحداث تبقى كما هي) ---

                const updateInputFromSelect = ($selectElement, inputElement) => {
                    if (!inputElement) return;
                    const selectedData = $selectElement.select2('data')[0];
                    if (selectedData && selectedData.id) inputElement.value = selectedData.text.trim();
                };

                const updateSignatureLabels = () => {
                    const driverNameReadOnly = $('input[name="person_name"][readonly]');
                    let driverName = driverNameReadOnly.length ? driverNameReadOnly.val().trim() : (personNameInput ? personNameInput.value.trim() : "لم يحدد");
                    let supervisorName = supervisorNameInput ? supervisorNameInput.value.trim() : "لم يحدد";
                    $('#driver-name-display').text(driverName || "لم يحدد");
                    $('#supervisor-name-display').text(supervisorName || "لم يحدد");
                };

                if ($employeeSelect.length) $employeeSelect.on('change', () => { updateInputFromSelect($employeeSelect, personNameInput); updateSignatureLabels(); });
                if ($supervisorSelect.length) $supervisorSelect.on('change', () => { updateInputFromSelect($supervisorSelect, supervisorNameInput); updateSignatureLabels(); });
                if (personNameInput && !personNameInput.readOnly) personNameInput.addEventListener('keyup', updateSignatureLabels);
                if (supervisorNameInput) supervisorNameInput.addEventListener('keyup', updateSignatureLabels);

                // استدعاء أولي لتحديث الأسماء عند تحميل الصفحة
                updateSignatureLabels();
                 // === نهاية التعديل المهم ===
            }

            // ===================================================================
            // الوحدة 4: إدارة رفع الملفات
            // ===================================================================
            const filesInput = document.getElementById('files');
            const filePreviewsContainer = document.getElementById('file-previews');
            let stagedFiles = new DataTransfer();
            $('#trigger-file-select').on('click', () => { filesInput.value = null; filesInput.click(); });
            $(filesInput).on('change', event => {
                const files = Array.from(event.target.files);
                const totalFiles = stagedFiles.files.length + files.length;
                
                // تحذير عند رفع عدد كبير من الصور
                if (totalFiles > 100) {
                    alert('تحذير: عدد الصور كبير جداً (' + totalFiles + ' صورة). قد يستغرق الرفع وقتاً طويلاً.');
                } else if (totalFiles > 50) {
                    console.log('تنبيه: جاري رفع ' + totalFiles + ' صورة. سيتم ضغط الصور تلقائياً لتسريع العملية.');
                }
                
                files.forEach(addFilePreview);
            });

            // دالة ضغط الصور
            async function compressImage(file, maxWidth = 1920, quality = 0.8) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            // تقليل الحجم إذا كان أكبر من maxWidth
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    const compressedFile = new File([blob], file.name, {
                                        type: 'image/jpeg',
                                        lastModified: Date.now()
                                    });
                                    resolve(compressedFile);
                                } else {
                                    resolve(file);
                                }
                            }, 'image/jpeg', quality);
                        };
                        img.src = e.target.result;
                    };
                    reader.onerror = () => resolve(file);
                    reader.readAsDataURL(file);
                });
            }
            
            async function addFilePreview(file) {
                for(let i=0; i<stagedFiles.files.length; i++) if(stagedFiles.files[i].name === file.name && stagedFiles.files[i].size === file.size) return;
                
                // ضغط الصور تلقائياً
                const fileName = file.name.toLowerCase();
                const isImage = file.type.startsWith('image/') || 
                                fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') || 
                                fileName.endsWith('.png') || fileName.endsWith('.gif') || 
                                fileName.endsWith('.heic') || fileName.endsWith('.heif') || 
                                fileName.endsWith('.webp');
                
                if (isImage && file.size > 500 * 1024) { // ضغط الصور أكبر من 500 KB
                    try {
                        file = await compressImage(file);
                        console.log('تم ضغط الصورة:', file.name, 'الحجم الجديد:', Math.round(file.size / 1024), 'KB');
                    } catch (error) {
                        console.log('لم يتم ضغط الصورة:', error);
                    }
                }
                
                stagedFiles.items.add(file);
                
                // التحقق من نوع الملف بناءً على الامتداد والـ MIME type
                const isPdf = file.type === 'application/pdf' || fileName.endsWith('.pdf');
                
                const template = document.getElementById(isPdf ? 'pdf-preview-template' : 'image-preview-template');
                const clone = template.content.cloneNode(true);
                
                if (isPdf) {
                    $(clone).find('.pdf-filename').text(file.name);
                    appendPreviewToDOM(clone, file);
                } else if (isImage) {
                    // تعيين الصورة باستخدام FileReader
                    const imgElement = $(clone).find('.preview-image');
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        imgElement.attr('src', e.target.result);
                        console.log('تم تحميل الصورة:', file.name);
                    };
                    
                    reader.onerror = function(error) {
                        console.error('خطأ في قراءة الملف:', file.name, error);
                        // محاولة استخدام URL.createObjectURL كخطة بديلة
                        try {
                            const url = URL.createObjectURL(file);
                            imgElement.attr('src', url);
                        } catch(err) {
                            console.error('فشل تحميل الصورة:', err);
                        }
                    };
                    
                    // قراءة الملف كـ Data URL
                    reader.readAsDataURL(file);
                    // إضافة العنصر فوراً مع صورة placeholder
                    appendPreviewToDOM(clone, file);
                } else {
                    // نوع ملف غير مدعوم
                    appendPreviewToDOM(clone, file);
                }
            }
            
            function appendPreviewToDOM(clone, file) {
                $(clone).find('.remove-file').on('click', function() {
                    const newDt = new DataTransfer();
                    Array.from(stagedFiles.files).forEach(f => { if (f !== file) newDt.items.add(f); });
                    stagedFiles = newDt;
                    try {
                        filesInput.files = stagedFiles.files;
                    } catch (e) {
                        console.log('تم حذف الملف من المعاينة');
                    }
                    $(this).closest('.preview-item').remove();
                });
                $(filePreviewsContainer).append(clone);
            }

            // ===================================================================
            // الوحدة 5: إرسال النموذج (Form Submission)
            // ===================================================================
            $('#main-handover-form').on('submit', function (event) {
                // تحديث ملفات الإدخال من الملفات المُدرجة
                try {
                    filesInput.files = stagedFiles.files;
                } catch (e) {
                    // في حالة فشل التحديث المباشر، نستخدم طريقة بديلة
                    console.log('تم استخدام الطريقة البديلة لتحديث الملفات');
                }
                if (!this.checkValidity()) {
                    event.preventDefault(); event.stopPropagation();
                    $(this).addClass('was-validated');
                    alert('الرجاء تعبئة جميع الحقول المطلوبة.'); return;
                }
                if (damageCanvas && damageCanvas.getObjects().length > 1) $('#damage-diagram-data').val(damageCanvas.toDataURL({format: 'png'}));
                Object.keys(sigPads).forEach(id => {
                    const pad = sigPads[id];
                    if (pad && pad.getObjects().length > 0) $('#' + id.replace('-canvas', '-data')).val(pad.toDataURL({format: 'png'}));
                });
                const activeSubmitButton = $(document.activeElement);
                if(activeSubmitButton.is('button[type="submit"]')){
                    activeSubmitButton.prop('disabled', true).html(`<span class="spinner-border spinner-border-sm"></span> جارٍ الحفظ...`);
                }
            });

            // ===================================================================
            // نقطة البداية: تشغيل كل شيء
            // ===================================================================
            initComponents();
            initCanvases();
            bindUIEvents();

        }, 50); // <-- التأخير البسيط لضمان تحميل كل شيء

    });
    </script>
