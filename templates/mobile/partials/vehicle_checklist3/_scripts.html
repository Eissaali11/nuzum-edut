 {{ super() }}
<!-- Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ù‡Ù†Ø§ØŒ layout.html ÙŠÙˆÙØ±Ù‡Ø§ -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 ÙŠØªØ·Ù„Ø¨ jQuery -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ØªØ­Ù…ÙŠÙ„ Fabric.js Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…ÙˆØ«ÙˆÙ‚Ø©
(function loadFabricJS() {
    console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Fabric.js...');
    
    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ script Ø³Ø§Ø¨Ù‚
    const existingScript = document.querySelector('script[src*="fabric"]');
    if (existingScript) {
        existingScript.remove();
    }
    
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js';
    script.async = false; // ØªØ­Ù…ÙŠÙ„ Ù…ØªØ²Ø§Ù…Ù†
    
    script.onload = function() {
        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Fabric.js Ø¨Ù†Ø¬Ø§Ø­!');
        // ØªØ´ØºÙŠÙ„ ØªÙ‡ÙŠØ¦Ø© Canvas Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        if (typeof initializeDamageDiagram === 'function') {
            setTimeout(initializeDamageDiagram, 100);
        }
    };
    
    script.onerror = function() {
        console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Fabric.js');
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø±Ø§Ø¨Ø· Ø¨Ø¯ÙŠÙ„
        const backupScript = document.createElement('script');
        backupScript.src = 'https://unpkg.com/fabric@5.3.0/dist/fabric.min.js';
        backupScript.onload = function() {
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Fabric.js Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø¨Ø¯ÙŠÙ„!');
        };
        document.head.appendChild(backupScript);
    };
    
    document.head.appendChild(script);
})();
</script>
<script src="{{ url_for('static', filename='js/vehicle_damage_map.js') }}"></script>

<!-- Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù„ØµÙØ­Ø© (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ù…ØµØ­Ø­Ø©) -->
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // === 1. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ===
        const vehicleSelect = $('#vehicle_id');
        const formContainer = $('#handover-form-container');
        const mainForm = document.getElementById('main-handover-form');

        // Ø¶Ø¨Ø· Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        const dateInput = document.getElementById('handover_date');
        const timeInput = document.getElementById('handover_time');
        const now = new Date();

        if (dateInput) {
            dateInput.value = now.toISOString().split('T')[0];
        }
        if (timeInput) {
            timeInput.value = now.toTimeString().slice(0, 5);
        }

        vehicleSelect.select2({ theme: 'bootstrap-5', placeholder: "Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© Ø£Ùˆ Ø§Ù„Ù†ÙˆØ¹...", dir: "rtl" });

        // === 2. Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø³ÙŠØ§Ø±Ø© ===
        vehicleSelect.on('select2:select', function (e) {
            const selectedOption = $(e.params.data.element);

            const vehicleStatus = selectedOption.data('status');
            const statusAlert = document.getElementById('vehicle-status-alert');
            const statusAlertSuccess = document.getElementById('vehicle-status-alert-avaliable');

            
            // ÙØ­Øµ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©
            if (vehicleStatus === 'out_of_service') {
                statusAlert.classList.remove('d-none');
                formContainer.addClass('d-none');
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.disabled = true;
                return;
            }
            else if (vehicleStatus !== "available"){
                statusAlertSuccess.classList.remove('d-none');
                formContainer.addClass('d-none');
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.disabled = true;
                return;
            }
             else {
                statusAlert.classList.add('d-none');
                statusAlertSuccess.classList.add('d-none');
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.disabled = false;
            }
            
            document.getElementById('project_name').value = selectedOption.data('project');
            document.getElementById('city').value = selectedOption.data('location');
            

            const handoverTypeSelect = document.getElementById('handover_type');
            if (vehicleStatus === 'available') { handoverTypeSelect.value = 'delivery'; }
            else { handoverTypeSelect.value = 'return'; }

            formContainer.removeClass('d-none').hide().fadeIn(400);

            // **Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹: ØªÙØ¹ÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡ Ø¨Ø¹Ø¯ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬**
            initializeAllInteractiveElements();
        });

        // --- Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø³ØªÙƒÙˆÙ† Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„ØªØ´ØºÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡ ---
        let areElementsInitialized = false;
        function initializeAllInteractiveElements() {
            if (areElementsInitialized) return; // ØªØ´ØºÙŠÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·

            // Ø£. ØªÙØ¹ÙŠÙ„ Ø¨Ø­Ø« Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙ‚Ø· (Ø§Ù„Ù…Ø´Ø±Ù ÙŠØ£ØªÙŠ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
            setupEmployeeSearch('driver');

            // Ø¨. ØªÙØ¹ÙŠÙ„ Ù…Ø®Ø·Ø· Ø§Ù„Ø¶Ø±Ø±
            initializeDamageDiagram();

            // Ø¬. ØªÙØ¹ÙŠÙ„ Ù„ÙˆØ­Ø§Øª Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
            setupSignatures();

            // Ø¯. ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙˆØ«ÙŠÙ‚ÙŠØ©
            setupFileUploader();

            areElementsInitialized = true;
        }

        // === 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ø³Ø§Ø¦Ù‚ ÙÙ‚Ø·) ===
        const employeeData = JSON.parse('{{ employeeData | tojson | safe }}');
        function setupEmployeeSearch(type) {
            const searchBody = document.getElementById(`${type}_search_body`);
            if (!searchBody.innerHTML) { // Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
                const template = document.getElementById('search-template').innerHTML;
                searchBody.innerHTML = template;
            }

            const nameInput = document.getElementById('person_name');
            const idInput = document.getElementById('employee_id');
            const departmentSelect = searchBody.querySelector('.department-select');
            const searchInput = searchBody.querySelector('.search-input');
            const listContainer = searchBody.querySelector('.list-container');
            const noResultsAlert = searchBody.querySelector('.no-results-alert');
            const accordionCollapse = searchBody.closest('.accordion-collapse');

            function renderList(employees) {
                listContainer.innerHTML = '';
                noResultsAlert.classList.toggle('d-none', employees.length > 0);
                employees.forEach(emp => {
                    const a = document.createElement('a');
                    a.href = '#'; a.className = 'list-group-item list-group-item-action';

                    // Ø¹Ø±Ø¶ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                    let departmentNames = '-';
                    if (emp.departments && emp.departments.length > 0) {
                        departmentNames = emp.departments.map(dept => dept.name).join(', ');
                    } else if (emp.department && emp.department.name) {
                        departmentNames = emp.department.name;
                    }

                    a.innerHTML = `<div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${emp.name}</h6><small class="text-muted">${emp.employee_id||''}</small></div><small>${departmentNames}</small>`;
                    a.onclick = (e) => {
                        e.preventDefault();
                        nameInput.value = emp.name;
                        idInput.value = emp.id;
                        document.getElementById('driver-name-display').textContent = emp.name; // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
                        new bootstrap.Collapse(accordionCollapse).hide();
                    };
                    listContainer.appendChild(a);
                });
            }

            function filter() {
                const deptId = departmentSelect.value;
                const term = searchInput.value.toLowerCase().trim();
                const filtered = employeeData.filter(emp => {
                    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù… - Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø£Ùˆ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                    let deptMatch = !deptId;
                    if (deptId) {
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                        if (emp.department_id && String(emp.department_id) === deptId) {
                            deptMatch = true;
                        }
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                        if (emp.departments && emp.departments.length > 0) {
                            deptMatch = emp.departments.some(dept => String(dept.id) === deptId);
                        }
                    }

                    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¯Ø®Ù„
                    const textMatch = !term ||
                        (emp.name || '').toLowerCase().includes(term) ||
                        (emp.employee_id || '').toLowerCase().includes(term);

                    return deptMatch && textMatch;
                });
                renderList(filtered);
            }
            searchInput.oninput = filter;
            departmentSelect.onchange = filter;
            renderList(employeeData);
        }

        // === 4. Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø·Ø· Ø§Ù„Ø¶Ø±Ø± ===
        let damageCanvas = null;
        let modalDamageCanvas = null;

        function initializeDamageDiagram() {
            if (damageCanvas) return;
            const diagramEl = document.getElementById('damage-canvas');
            if (!diagramEl) return;

            const diagramContainer = diagramEl.parentElement;
            damageCanvas = new fabric.Canvas('damage-canvas', { isDrawingMode: true, backgroundColor: '#fff' });
            damageCanvas.freeDrawingBrush.color = "#E53935";
            damageCanvas.freeDrawingBrush.width = 4;

            const imageUrl = "{{ url_for('static', filename='images/vehicle_diagram.png') }}";
            fabric.Image.fromURL(imageUrl, (img) => {
                const w = diagramContainer.offsetWidth > 0 ? diagramContainer.offsetWidth : 350;
                const scale = w / img.width;
                damageCanvas.setWidth(w).setHeight(img.height * scale);
                damageCanvas.setBackgroundImage(img, damageCanvas.renderAll.bind(damageCanvas), { scaleX: scale, scaleY: scale });
            }, { crossOrigin: 'anonymous' });

            // Main canvas controls
            document.getElementById('draw-mode-btn').onclick = () => { damageCanvas.isDrawingMode = true; };
            document.getElementById('select-mode-btn').onclick = () => { damageCanvas.isDrawingMode = false; };
            document.getElementById('draw-color-picker').oninput = e => { damageCanvas.freeDrawingBrush.color = e.target.value; };
            document.getElementById('draw-line-width').oninput = e => { damageCanvas.freeDrawingBrush.width = parseInt(e.target.value); };
            document.getElementById('clear-canvas-btn').onclick = () => { if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø±Ø³ÙˆÙ…ØŸ")) damageCanvas.remove(...damageCanvas.getObjects()); };

            // Expand button functionality
            document.getElementById('expand-canvas-btn').onclick = openDamageModal;
        }

        function openDamageModal() {
            const modal = new bootstrap.Modal(document.getElementById('damageCanvasModal'));
            modal.show();

            // Initialize modal canvas after modal is shown
            document.getElementById('damageCanvasModal').addEventListener('shown.bs.modal', function() {
                initializeModalCanvas();
            }, { once: true });
        }

        function initializeModalCanvas() {
            if (modalDamageCanvas) {
                // Update existing modal canvas with current data
                syncCanvasToModal();
                return;
            }

            const modalCanvasEl = document.getElementById('modal-damage-canvas');
            if (!modalCanvasEl) return;

            // Set modal canvas size
            const modalBody = modalCanvasEl.closest('.modal-body');
            const maxWidth = Math.min(modalBody.offsetWidth - 40, 600);
            const maxHeight = Math.min(window.innerHeight * 0.6, 400);

            modalDamageCanvas = new fabric.Canvas('modal-damage-canvas', {
                isDrawingMode: true,
                backgroundColor: '#fff',
                width: maxWidth,
                height: maxHeight
            });

            modalDamageCanvas.freeDrawingBrush.color = "#E53935";
            modalDamageCanvas.freeDrawingBrush.width = 4;

            // Load background image
            const imageUrl = "{{ url_for('static', filename='images/vehicle_diagram.png') }}";
            fabric.Image.fromURL(imageUrl, (img) => {
                const scale = Math.min(maxWidth / img.width, maxHeight / img.height);
                const scaledWidth = img.width * scale;
                const scaledHeight = img.height * scale;

                modalDamageCanvas.setWidth(scaledWidth).setHeight(scaledHeight);
                modalDamageCanvas.setBackgroundImage(img, modalDamageCanvas.renderAll.bind(modalDamageCanvas), {
                    scaleX: scale,
                    scaleY: scale
                });

                // Copy existing drawings from main canvas
                syncCanvasToModal();
            }, { crossOrigin: 'anonymous' });

            // Modal canvas controls
            document.getElementById('modal-draw-mode-btn').onclick = () => { modalDamageCanvas.isDrawingMode = true; };
            document.getElementById('modal-select-mode-btn').onclick = () => { modalDamageCanvas.isDrawingMode = false; };
            document.getElementById('modal-draw-color-picker').oninput = e => { modalDamageCanvas.freeDrawingBrush.color = e.target.value; };
            document.getElementById('modal-draw-line-width').oninput = e => { modalDamageCanvas.freeDrawingBrush.width = parseInt(e.target.value); };
            document.getElementById('modal-clear-canvas-btn').onclick = () => {
                if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø±Ø³ÙˆÙ…ØŸ")) modalDamageCanvas.remove(...modalDamageCanvas.getObjects());
            };

            // Sync button functionality
            document.getElementById('sync-canvas-btn').onclick = syncModalToCanvas;
        }

        function syncCanvasToModal() {
            if (!modalDamageCanvas || !damageCanvas) return;

            // Clear modal canvas objects
            modalDamageCanvas.remove(...modalDamageCanvas.getObjects());

            // Copy objects from main canvas to modal
            damageCanvas.getObjects().forEach(obj => {
                const clonedObj = fabric.util.object.clone(obj);
                modalDamageCanvas.add(clonedObj);
            });

            modalDamageCanvas.renderAll();
        }

        function syncModalToCanvas() {
            if (!modalDamageCanvas || !damageCanvas) return;

            // Clear main canvas objects
            damageCanvas.remove(...damageCanvas.getObjects());

            // Copy objects from modal to main canvas
            modalDamageCanvas.getObjects().forEach(obj => {
                const clonedObj = fabric.util.object.clone(obj);
                damageCanvas.add(clonedObj);
            });

            damageCanvas.renderAll();

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('damageCanvasModal'));
            if (modal) modal.hide();
        }

        // === 5. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ (Ø´Ø§Ù…Ù„Ø©) ===
        const signaturePads = {};
        function setupSignatures() {
            ['supervisor', 'driver', 'movement-officer'].forEach(type => {
                const canvasId = `${type}-signature-canvas`;
                const el = document.getElementById(canvasId);
                if (el) {
                    signaturePads[canvasId] = new fabric.Canvas(el, { isDrawingMode: true, backgroundColor: 'rgba(0,0,0,0)' });
                    signaturePads[canvasId].freeDrawingBrush.color = "#000";
                    signaturePads[canvasId].freeDrawingBrush.width = 2;
                }
            });

            document.querySelectorAll('.clear-signature').forEach(btn => {
                btn.onclick = () => {
                    const canvas = signaturePads[btn.dataset.canvasId];
                    if (canvas) canvas.clear();
                };
            });

            document.querySelectorAll('.signature-upload').forEach(input => {
                input.onchange = e => {
                    const file = e.target.files[0]; if(!file) return;
                    const previewEl = input.parentElement.querySelector('.signature-preview');
                    const targetInput = document.getElementById(input.dataset.targetInputId);
                    const reader = new FileReader();
                    reader.onload = res => {
                        targetInput.value = res.target.result;
                        previewEl.src = res.target.result;
                        previewEl.classList.remove('d-none');
                        const canvas = signaturePads[input.dataset.targetInputId.replace('-data', '-canvas')];
                        if (canvas) canvas.clear();
                    };
                    reader.readAsDataURL(file);
                };
            });

            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    const canvasId = e.target.dataset.bsTarget.replace('#','').replace('-draw-tab','-signature-canvas');
                    const canvas = signaturePads[canvasId];
                    if(canvas){
                        const container = canvas.getElement().parentElement;
                        canvas.setWidth(container.offsetWidth).setHeight(container.offsetHeight).renderAll();
                    }
                });
            });
        }

        // === 6. Ø¥Ø¯Ø§Ø±Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙˆØ«ÙŠÙ‚ÙŠØ© (Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©) ===
        function setupFileUploader() {
            const filesInput = document.getElementById('files');
            const filePreviews = document.getElementById('file-previews');
            const triggerFileSelectBtn = document.getElementById('trigger-file-select');
            let filesTransferList = new DataTransfer();

            triggerFileSelectBtn.onclick = () => {
                const tempInput = document.createElement('input');
                tempInput.type = 'file'; tempInput.multiple = true; tempInput.accept = "image/*,application/pdf";
                tempInput.onchange = () => { Array.from(tempInput.files).forEach(addFilePreview); };
                tempInput.click();
            };

            async function addFilePreview(file) {
                for (let f of filesTransferList.files) { if (f.name === file.name && f.size === file.size) return; }

                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ
                const tplId = file.name.toLowerCase().endsWith('.pdf') ? 'pdf-preview-template' : 'image-preview-template';
                const clone = document.getElementById(tplId).firstElementChild.cloneNode(true);
                clone.querySelector('.file-description').name = `description_${file.name}`;

                let processedFile = file; // Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù…ØªØºÙŠØ± ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©

                if (tplId.includes('image')) {
                    // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹)
                    const img = clone.querySelector('img');
                    const reader = new FileReader();
                    reader.onload = e => img.src = e.target.result;
                    reader.readAsDataURL(file);

                    // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙƒØ¨ÙŠØ±Ø©
                    if (file.type.startsWith('image/') && file.size > 500000) {
                        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø§Ù„Ø¶ØºØ·
                        const sizeIndicator = clone.querySelector('.file-description');
                        const originalText = sizeIndicator.placeholder;
                        sizeIndicator.placeholder = 'Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©...';

                        try {
                            processedFile = await compressImage(file, 0.7, 1200);
                            console.log(`ØªÙ… Ø¶ØºØ· ${file.name} Ù…Ù† ${(file.size/1024).toFixed(1)}KB Ø¥Ù„Ù‰ ${(processedFile.size/1024).toFixed(1)}KB`);

                            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø©
                            const compressedReader = new FileReader();
                            compressedReader.onload = e => img.src = e.target.result;
                            compressedReader.readAsDataURL(processedFile);

                            sizeIndicator.placeholder = `Ù…Ø¶ØºÙˆØ·Ø©: ${(processedFile.size/1024).toFixed(0)}KB`;
                        } catch (error) {
                            console.log('ÙØ´Ù„ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ:', error);
                            processedFile = file;
                            sizeIndicator.placeholder = originalText;
                        }
                    }
                } else {
                    clone.querySelector('.pdf-filename').textContent = file.name;
                }

                filePreviews.appendChild(clone);

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© (Ù…Ø¶ØºÙˆØ· Ø£Ùˆ Ø£ØµÙ„ÙŠ)
                filesTransferList.items.add(processedFile);
                filesInput.files = filesTransferList.files;

                // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø­Ø°Ù
                clone.querySelector('.remove-file').onclick = () => removeFilePreview(clone, processedFile);
            }

            // Ø¯Ø§Ù„Ø© Ø¶ØºØ· Ø§Ù„ØµÙˆØ±
            function compressImage(file, quality = 0.6, maxWidth = 1200) {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();

                    img.onload = () => {
                        let { width, height } = img;

                        // ØªØµØºÙŠØ± Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙƒØ¨ÙŠØ±Ø©
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (blob) {
                                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
                                const compressedFile = new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                resolve(compressedFile);
                            } else {
                                reject(new Error('ÙØ´Ù„ ÙÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©'));
                            }
                        }, 'image/jpeg', quality);
                    };

                    img.onerror = () => reject(new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©'));
                    img.src = URL.createObjectURL(file);
                });
            }

            function removeFilePreview(item, fileToRemove) {
                const newTransferList = new DataTransfer();
                for (let f of filesTransferList.files) { if (f.name !== fileToRemove.name || f.size !== fileToRemove.size) newTransferList.items.add(f); }
                filesTransferList = newTransferList;
                filesInput.files = filesTransferList.files;
                item.remove();
            }
        }

        // === 7. Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ===
        mainForm.addEventListener('submit', function (e) {
            // ÙØ­Øµ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„ÙØ§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            const filesInput = document.getElementById('files');
            let totalSize = 0;

            if (filesInput.files) {
                for (let file of filesInput.files) {
                    totalSize += file.size;
                }
            }

            // Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ ÙˆØ§Ù„Ù…Ø®Ø·Ø·Ø§Øª
            const signatures = ['supervisor-signature-data', 'driver-signature-data', 'movement-officer-signature-data', 'damage-diagram-data'];
            for (let id of signatures) {
                const input = document.getElementById(id);
                if (input && input.value && input.value.startsWith('data:image')) {
                    // ØªÙ‚Ø¯ÙŠØ± Ø­Ø¬Ù… base64 (Ø­ÙˆØ§Ù„ÙŠ 75% Ù…Ù† Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙØ¹Ù„ÙŠ)
                    totalSize += input.value.length * 0.75;
                }
            }

            const maxSize = 20 * 1024 * 1024; // 20 MB
            if (totalSize > maxSize) {
                e.preventDefault();
                const sizeMB = (totalSize / (1024 * 1024)).toFixed(1);
                alert(`Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (${sizeMB} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª). Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 20 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª. ÙŠØ±Ø¬Ù‰ ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± Ø£Ùˆ Ø¶ØºØ·Ù‡Ø§.`);
                return false;
            }

            // Ø£. Ø­ÙØ¸ Ù…Ø®Ø·Ø· Ø§Ù„Ø¶Ø±Ø± (Ù…Ù† Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„)
            let canvasToSave = damageCanvas;
            if (modalDamageCanvas && modalDamageCanvas.getObjects().length > 0) {
                canvasToSave = modalDamageCanvas;
            } else if (damageCanvas && damageCanvas.getObjects().length > 0) {
                canvasToSave = damageCanvas;
            }

            if (canvasToSave && canvasToSave.getObjects().length > 0) {
                document.getElementById('damage-diagram-data').value = canvasToSave.toDataURL({ format: 'png', quality: 0.8 });
            }
            // Ø¨. Ø­ÙØ¸ Ø§Ù„ØªÙˆØ§Ù‚ÙŠØ¹ Ø§Ù„Ù…Ø±Ø³ÙˆÙ…Ø© ÙÙ‚Ø· (Ø§Ù„ØªÙŠ ØªÙ… Ø±ÙØ¹Ù‡Ø§ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø§Ù„ÙØ¹Ù„)
            for (const id in signaturePads) {
                const hiddenInput = document.getElementById(id.replace('-canvas', '-data'));
                if (hiddenInput && !hiddenInput.value.startsWith('data:image')) {
                    const canvas = signaturePads[id];
                    if (canvas.getObjects().length > 0) {
                        hiddenInput.value = canvas.toDataURL({ format: 'png' });
                    }
                }
            }

            // Ø¬. Ø­ÙØ¸ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø´Ø±Ù (Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ)
            const supervisorSignatureInput = document.getElementById('supervisor-signature-data');
            if (supervisorSignatureInput) {
                const supervisorCanvas = signaturePads['supervisor-signature-canvas'];
                if (supervisorCanvas && supervisorCanvas.getObjects().length > 0) {
                    supervisorSignatureInput.value = supervisorCanvas.toDataURL({ format: 'png' });
                }
            }
        });

    }); // Ù†Ù‡Ø§ÙŠØ© DOMContentLoaded

    // === 8. Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ===
    {% if existing_handover %}
    document.addEventListener('DOMContentLoaded', function() {
        const handover = JSON.parse('{{ existing_handover|tojson|safe }}');

        // Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©
        if (handover.vehicle_id) {
            const vehicleSelect = document.getElementById('vehicle_id');
            vehicleSelect.value = handover.vehicle_id;
            vehicleSelect.dispatchEvent(new Event('change'));
        }

        // Ù…Ù„Ø¡ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        if (handover.handover_type) {
            const typeSelect = document.getElementById('handover_type');
            typeSelect.value = handover.handover_type;
        }

        // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        if (handover.project_name) {
            document.getElementById('project_name').value = handover.project_name;
        }
        if (handover.city) {
            document.getElementById('city').value = handover.city;
        }
        if (handover.mileage) {
            document.getElementById('mileage').value = handover.mileage;
        }
        if (handover.fuel_level) {
            document.getElementById('fuel_level').value = handover.fuel_level;
        }
        if (handover.reason_for_change) {
            document.getElementById('reason_for_change').value = handover.reason_for_change;
        }

        // Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚
        if (handover.person_name) {
            document.getElementById('person_name').value = handover.person_name;
        }
        if (handover.employee_id) {
            document.getElementById('employee_id').value = handover.employee_id;
        }

        // Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù
        if (handover.supervisor_name) {
            document.getElementById('supervisor_name').value = handover.supervisor_name;
        }
        if (handover.supervisor_employee_id) {
            document.getElementById('supervisor_employee_id').value = handover.supervisor_employee_id;
        }

        // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ­Øµ
        const checklistItems = [
            'has_spare_tire', 'has_fire_extinguisher', 'has_first_aid_kit',
            'has_warning_triangle', 'has_tools', 'has_oil_leaks', 'has_gear_issue',
            'has_clutch_issue', 'has_engine_issue', 'has_windows_issue',
            'has_tires_issue', 'has_body_issue', 'has_electricity_issue',
            'has_lights_issue', 'has_ac_issue'
        ];

        checklistItems.forEach(item => {
            if (handover[item]) {
                const checkbox = document.getElementById(item);
                if (checkbox) {
                    checkbox.checked = handover[item];
                }
            }
        });

        // Ù…Ù„Ø¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
        if (handover.notes) {
            const notesField = document.getElementById('notes');
            if (notesField) {
                notesField.value = handover.notes;
            }
        }
        if (handover.vehicle_status_summary) {
            const statusField = document.getElementById('vehicle_status_summary');
            if (statusField) {
                statusField.value = handover.vehicle_status_summary;
            }
        }
        if (handover.reason_for_authorization) {
            const authField = document.getElementById('reason_for_authorization');
            if (authField) {
                authField.value = handover.reason_for_authorization;
            }
        }
        if (handover.authorization_details) {
            const detailsField = document.getElementById('authorization_details');
            if (detailsField) {
                detailsField.value = handover.authorization_details;
            }
        }
        if (handover.movement_officer_name) {
            const officerField = document.getElementById('movement_officer_name');
            if (officerField) {
                officerField.value = handover.movement_officer_name;
            }
        }
        if (handover.form_link) {
            const linkField = document.getElementById('form_link');
            if (linkField) {
                linkField.value = handover.form_link;
            }
        }
        if (handover.custom_company_name) {
            const companyField = document.getElementById('custom_company_name');
            if (companyField) {
                companyField.value = handover.custom_company_name;
            }
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ø¯ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        setTimeout(() => {
            const container = document.getElementById('handover-form-container');
            if (container) {
                container.classList.remove('d-none');
            }
        }, 500);
    });
    {% endif %}
</script>

<!-- Template Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
<script type="text/html" id="search-template">
    <div class="mb-3">
        <label class="form-label">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…:</label>
        <select class="form-select department-select">
            <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
            {% for dept in departments %}
            <option value="{{ dept.id }}">{{ dept.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</label>
        <input
            type="text"
            class="form-control search-input"
            placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«..."
        />
    </div>
    <div
        class="list-group list-container"
        style="max-height: 300px; overflow-y: auto;"
    ></div>
    <div class="alert alert-info text-center d-none no-results-alert">
        <i class="fas fa-search"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«
    </div>
</script>
