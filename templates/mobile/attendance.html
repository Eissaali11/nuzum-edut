{% extends 'mobile/layout.html' %}

{% block title %}الحضور والغياب - نُظم{% endblock %}

{% block header_title %}الحضور والغياب{% endblock %}

{% block content %}
<!-- أزرار الإجراءات -->
<style>
/* تجاوز padding الافتراضي للصفحة */
body {
    padding-top: 60px !important;
}

.action-buttons-bar {
    background: white;
    padding: 12px 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    display: flex !important;
    gap: 8px;
    justify-content: flex-start;
    margin: 0 0 12px 0;
    position: relative;
    width: 100%;
    z-index: 100;
}

.action-btn-modern {
    padding: 10px 14px;
    border: none;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    display: flex !important;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    white-space: nowrap;
    flex-shrink: 0;
}

.btn-dashboard {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
}

.btn-add {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
    color: white !important;
}

.btn-export {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
    color: white !important;
}

.action-btn-modern:active {
    transform: scale(0.95);
}

.content-with-actions {
    padding-top: 0;
    margin-top: 0;
}

/* ضمان عدم قطع المحتوى */
.mobile-content-wrapper {
    padding-top: 0 !important;
}

/* تحسين للشاشات الصغيرة */
@media (max-width: 380px) {
    .action-buttons-bar {
        padding: 10px 15px;
        gap: 6px;
    }
    
    .action-btn-modern {
        padding: 10px 12px;
        font-size: 12px;
        gap: 4px;
    }
    
    .action-btn-modern span {
        display: none;
    }
    
    .action-btn-modern i {
        font-size: 18px;
    }
}

/* التأكد من الظهور على جميع الأجهزة */
@media (max-width: 767px) {
    .action-buttons-bar {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .action-btn-modern {
        display: flex !important;
        visibility: visible !important;
    }
}
</style>

<div class="action-buttons-bar">
    <button class="action-btn-modern btn-dashboard" onclick="location.href='{{ url_for('mobile.attendance_dashboard') }}'">
        <i class="fas fa-chart-pie"></i>
        <span>Dashboard</span>
    </button>
    <button class="action-btn-modern btn-add" onclick="location.href='{{ url_for('mobile.add_attendance') }}'">
        <i class="fas fa-plus"></i>
        <span>إضافة</span>
    </button>
    <button class="action-btn-modern btn-export" onclick="location.href='{{ url_for('mobile.export_attendance') }}'">
        <i class="fas fa-file-excel"></i>
        <span>تصدير</span>
    </button>
</div>

<div class="content-with-actions">

<!-- فلتر التاريخ -->
<div class="smart-search-container" style="margin-top: 20px;">
    <div class="search-title">
        <i class="fas fa-calendar-alt"></i>
        <span>اختر التاريخ</span>
    </div>
    <form action="{{ url_for('mobile.attendance') }}" method="GET" id="dateFilterForm">
        <input type="date" 
               name="date" 
               class="search-input" 
               value="{{ selected_date.strftime('%Y-%m-%d') }}"
               onchange="this.form.submit()"
               style="text-align: right;">
        <input type="hidden" name="search" value="{{ request.args.get('search', '') }}">
        <input type="hidden" name="status" value="{{ request.args.get('status', '') }}">
        <input type="hidden" name="department_id" value="{{ request.args.get('department_id', '') }}">
    </form>
</div>
<style>
/* تصميم مستقبلي بألوان واضحة */
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    --danger-gradient: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
    --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

/* البحث الذكي */
.smart-search-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 24px;
    margin: 0 20px 20px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.search-title {
    color: white;
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.search-title i {
    font-size: 22px;
}

.search-input-wrapper {
    position: relative;
    margin-bottom: 16px;
}

.search-input {
    width: 100%;
    padding: 14px 50px 14px 16px;
    border: none;
    border-radius: 12px;
    font-size: 15px;
    background: rgba(255, 255, 255, 0.95);
    color: #1a1a1a;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.search-input::placeholder {
    color: #8e8e93;
}

.search-input:focus {
    outline: none;
    background: white;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #667eea;
    font-size: 18px;
}

.filter-chips {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.filter-chip {
    background: rgba(255, 255, 255, 0.25);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-chip:hover, .filter-chip.active {
    background: white;
    color: #667eea;
    border-color: white;
}

/* الإحصائيات */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    padding: 0 20px 20px;
}

.stat-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.stat-card.present::before {
    background: var(--success-gradient);
}

.stat-card.absent::before {
    background: var(--danger-gradient);
}

.stat-card.leave::before {
    background: var(--info-gradient);
}

.stat-card.total::before {
    background: var(--primary-gradient);
}

.stat-icon {
    font-size: 32px;
    margin-bottom: 12px;
}

.stat-card.present .stat-icon {
    background: var(--success-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-card.absent .stat-icon {
    background: var(--danger-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-card.leave .stat-icon {
    background: var(--info-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-card.total .stat-icon {
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-number {
    font-size: 28px;
    font-weight: 800;
    color: #1a1a1a;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 13px;
    color: #8e8e93;
    font-weight: 600;
}

/* قائمة السجلات */
.records-container {
    padding: 0 20px 80px;
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.section-title {
    font-size: 18px;
    font-weight: 700;
    color: #1a1a1a;
    display: flex;
    align-items: center;
    gap: 8px;
}

.records-count {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
}

.record-card {
    background: white;
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    border: 1px solid #f0f0f5;
    display: flex;
    align-items: center;
    gap: 14px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.record-card::before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    right: 0;
    width: 4px;
}

.record-card.status-present::before {
    background: var(--success-gradient);
}

.record-card.status-absent::before {
    background: var(--danger-gradient);
}

.record-card.status-leave::before {
    background: var(--info-gradient);
}

.record-card.status-sick::before {
    background: var(--warning-gradient);
}

.record-card:active {
    transform: scale(0.98);
}

.record-status-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    flex-shrink: 0;
}

.record-card.status-present .record-status-icon {
    background: linear-gradient(135deg, rgba(17, 153, 142, 0.1) 0%, rgba(56, 239, 125, 0.1) 100%);
    color: #11998e;
}

.record-card.status-absent .record-status-icon {
    background: linear-gradient(135deg, rgba(235, 51, 73, 0.1) 0%, rgba(244, 92, 67, 0.1) 100%);
    color: #eb3349;
}

.record-card.status-leave .record-status-icon {
    background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%);
    color: #4facfe;
}

.record-card.status-sick .record-status-icon {
    background: linear-gradient(135deg, rgba(240, 147, 251, 0.1) 0%, rgba(245, 87, 108, 0.1) 100%);
    color: #f093fb;
}

.record-info {
    flex: 1;
    min-width: 0;
}

.record-name {
    font-size: 16px;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 6px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.record-details {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.detail-badge {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 8px;
    font-weight: 600;
}

.detail-badge.date {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
}

.detail-badge.time-in {
    background: rgba(17, 153, 142, 0.1);
    color: #11998e;
}

.detail-badge.time-out {
    background: rgba(235, 51, 73, 0.1);
    color: #eb3349;
}

.detail-badge.employee-id {
    background: rgba(79, 172, 254, 0.1);
    color: #4facfe;
}

.record-action {
    flex-shrink: 0;
}

.edit-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    border: none;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    cursor: pointer;
    text-decoration: none;
}

.edit-btn:active {
    transform: scale(0.95);
}

/* حالة فارغة */
.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-icon {
    font-size: 80px;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 20px;
}

.empty-title {
    font-size: 20px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 8px;
}

.empty-text {
    font-size: 14px;
    color: #8e8e93;
    margin-bottom: 24px;
}

.add-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 14px 28px;
    background: var(--primary-gradient);
    color: white;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

/* Pagination */
.pagination-container {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 20px;
}

.page-btn {
    min-width: 40px;
    height: 40px;
    border-radius: 10px;
    background: white;
    color: #667eea;
    border: 2px solid #f0f0f5;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
}

.page-btn.active {
    background: var(--primary-gradient);
    color: white;
    border-color: transparent;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.page-btn:active {
    transform: scale(0.95);
}
</style>

<!-- البحث الذكي -->
<div class="smart-search-container">
    <div class="search-title">
        <i class="fas fa-search"></i>
        <span>البحث الذكي</span>
    </div>
    
    <form action="{{ url_for('mobile.attendance') }}" method="GET" id="searchForm">
        <div class="search-input-wrapper">
            <input type="text" name="search" class="search-input" 
                   placeholder="ابحث بالاسم، الرقم الوظيفي، أو رقم الهوية..." 
                   value="{{ request.args.get('search', '') }}"
                   autocomplete="off">
            <i class="fas fa-search search-icon"></i>
        </div>
        
        <!-- فلتر القسم -->
        <div style="margin-bottom: 12px;">
            <select name="department_id" id="departmentSelect" class="search-input" 
                    onchange="document.getElementById('searchForm').submit()">
                <option value="">جميع الأقسام</option>
                {% for dept in departments %}
                <option value="{{ dept.id }}" {% if request.args.get('department_id')|string == dept.id|string %}selected{% endif %}>
                    {{ dept.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-chips">
            <button type="button" class="filter-chip {% if not request.args.get('status') %}active{% endif %}" 
                    onclick="setFilter('status', '')">
                الكل
            </button>
            <button type="button" class="filter-chip {% if request.args.get('status') == 'حاضر' %}active{% endif %}" 
                    onclick="setFilter('status', 'حاضر')">
                <i class="fas fa-check-circle"></i> حاضر
            </button>
            <button type="button" class="filter-chip {% if request.args.get('status') == 'غائب' %}active{% endif %}" 
                    onclick="setFilter('status', 'غائب')">
                <i class="fas fa-times-circle"></i> غائب
            </button>
            <button type="button" class="filter-chip {% if request.args.get('status') == 'إجازة' %}active{% endif %}" 
                    onclick="setFilter('status', 'إجازة')">
                <i class="fas fa-umbrella-beach"></i> إجازة
            </button>
        </div>
        <input type="hidden" name="status" id="statusInput" value="{{ request.args.get('status', '') }}">
        <input type="hidden" name="date" id="dateInput" value="{{ request.args.get('date', '') }}">
    </form>
</div>

<!-- عرض التاريخ المحدد -->
<div style="text-align: center; padding: 12px 20px; margin-bottom: 10px;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 16px; border-radius: 12px; display: inline-block; font-size: 14px; font-weight: 600; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);">
        <i class="fas fa-calendar"></i> 
        {{ selected_date.strftime('%Y-%m-%d') }}
    </div>
</div>

<!-- الإحصائيات -->
<div class="stats-grid">
    <div class="stat-card present">
        <div class="stat-icon">
            <i class="fas fa-user-check"></i>
        </div>
        <div class="stat-number">{{ today_stats.present or 0 }}</div>
        <div class="stat-label">حاضر</div>
    </div>
    
    <div class="stat-card absent">
        <div class="stat-icon">
            <i class="fas fa-user-times"></i>
        </div>
        <div class="stat-number">{{ today_stats.absent or 0 }}</div>
        <div class="stat-label">غائب</div>
    </div>
    
    <div class="stat-card leave">
        <div class="stat-icon">
            <i class="fas fa-calendar-minus"></i>
        </div>
        <div class="stat-number">{{ today_stats.leave or 0 }}</div>
        <div class="stat-label">إجازة</div>
    </div>
    
    <div class="stat-card total">
        <div class="stat-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-number">{{ today_stats.total or 0 }}</div>
        <div class="stat-label">الإجمالي</div>
    </div>
</div>

<!-- قائمة السجلات -->
{% if attendance_records %}
<div class="records-container">
    <div class="section-header">
        <div class="section-title">
            <i class="fas fa-clipboard-list"></i>
            <span>السجلات</span>
        </div>
        <div class="records-count">{{ attendance_records|length }}</div>
    </div>
    
    {% for record in attendance_records %}
    <div class="record-card status-{{ 'present' if record.status == 'حاضر' else 'absent' if record.status == 'غائب' else 'leave' if record.status == 'إجازة' else 'sick' }}">
        <div class="record-status-icon">
            {% if record.status == 'حاضر' %}
            <i class="fas fa-check-circle"></i>
            {% elif record.status == 'غائب' %}
            <i class="fas fa-times-circle"></i>
            {% elif record.status == 'إجازة' %}
            <i class="fas fa-umbrella-beach"></i>
            {% else %}
            <i class="fas fa-notes-medical"></i>
            {% endif %}
        </div>
        
        <div class="record-info">
            <div class="record-name">{{ record.employee.name }}</div>
            <div class="record-details">
                <span class="detail-badge date">
                    <i class="fas fa-calendar-alt"></i> {{ record.date.strftime('%Y/%m/%d') }}
                </span>
                {% if record.employee.employee_id %}
                <span class="detail-badge employee-id">
                    <i class="fas fa-id-badge"></i> {{ record.employee.employee_id }}
                </span>
                {% endif %}
                {% if record.check_in %}
                <span class="detail-badge time-in">
                    <i class="fas fa-sign-in-alt"></i> {{ record.check_in.strftime('%H:%M') }}
                </span>
                {% endif %}
                {% if record.check_out %}
                <span class="detail-badge time-out">
                    <i class="fas fa-sign-out-alt"></i> {{ record.check_out.strftime('%H:%M') }}
                </span>
                {% endif %}
            </div>
        </div>
        
        <div class="record-action">
            <a href="{{ url_for('mobile.edit_attendance', record_id=record.id) }}" class="edit-btn">
                <i class="fas fa-edit"></i>
            </a>
        </div>
    </div>
    {% endfor %}
    
    <!-- Pagination -->
    {% if pagination and pagination.pages > 1 %}
    <div class="pagination-container">
        {% if pagination.has_prev %}
        <a href="{{ url_for('mobile.attendance', page=pagination.prev_num, search=request.args.get('search', ''), status=request.args.get('status', ''), department_id=request.args.get('department_id', ''), date=request.args.get('date', '')) }}" class="page-btn">
            <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
        
        {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
                <a href="{{ url_for('mobile.attendance', page=page_num, search=request.args.get('search', ''), status=request.args.get('status', ''), department_id=request.args.get('department_id', ''), date=request.args.get('date', '')) }}" 
                   class="page-btn {% if page_num == pagination.page %}active{% endif %}">
                    {{ page_num }}
                </a>
            {% else %}
                <span class="page-btn">…</span>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <a href="{{ url_for('mobile.attendance', page=pagination.next_num, search=request.args.get('search', ''), status=request.args.get('status', ''), department_id=request.args.get('department_id', ''), date=request.args.get('date', '')) }}" class="page-btn">
            <i class="fas fa-chevron-left"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% else %}
<div class="empty-state">
    <div class="empty-icon">
        <i class="fas fa-clipboard-check"></i>
    </div>
    <div class="empty-title">لا توجد سجلات حضور</div>
    <div class="empty-text">ابدأ بتسجيل حضور الموظفين اليوم</div>
    <a href="{{ url_for('mobile.add_attendance') }}" class="add-btn">
        <i class="fas fa-plus"></i>
        <span>تسجيل حضور جديد</span>
    </a>
</div>
{% endif %}
</div>
<!-- إغلاق content-with-actions -->

{% endblock %}

{% block scripts %}
<script>
// البحث التلقائي عند الكتابة - فقط لحقل البحث
let searchTimeout;
const searchForm = document.getElementById('searchForm');
const searchInput = searchForm.querySelector('input[name="search"]');

if (searchInput) {
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchForm.submit();
        }, 800);
    });
}

// تغيير الفلتر
function setFilter(name, value) {
    document.getElementById('statusInput').value = value;
    searchForm.submit();
}
</script>
{% endblock %}
