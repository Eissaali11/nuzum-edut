{% extends "layout.html" %}

{% block title %}إحصائيات الموظفين{% endblock %}

{% block extra_css %}
{% include 'partials/employee_stats/_extra_css.html' %}
{% endblock %}

{% block content %}
{% include 'partials/employee_stats/_content.html' %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced notification function
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification-toast position-fixed top-0 end-0 m-3 alert alert-${type}`;
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';
        notification.style.borderRadius = '12px';
        notification.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 3000);
    }

    // Update chart info with animation
    function updateChartInfo(data) {
        const totalEl = document.getElementById('totalEmployees');
        const deptEl = document.getElementById('departmentsCount');
        
        // Animate numbers
        if (totalEl) animateValue(totalEl, 0, data.total || 0, 1000);
        if (deptEl) animateValue(deptEl, 0, data.labels.length || 0, 1000);
    }

    // Number animation function
    function animateValue(element, start, end, duration) {
        if (!element) {
            console.warn('animateValue: element is null');
            return;
        }
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            element.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // Get chart data from backend (passed via template)
    const chartData = {
        labels: {{ chart_labels|tojson if chart_labels else '[]' }},
        data: {{ chart_data|tojson if chart_data else '[]' }},
        departmentIds: {{ chart_dept_ids|tojson if chart_dept_ids else '[]' }},
        percentages: {{ chart_percentages|tojson if chart_percentages else '[]' }},
        total: {{ total_active_employees if total_active_employees else 0 }},
        backgroundColor: {{ chart_colors|tojson if chart_colors else '[]' }}
    };
    
    console.log('Chart Data:', chartData);
    
    // Department Chart - render immediately with backend data
    (function renderDepartmentChart() {
        try {
            const data = chartData;
            console.log('Rendering chart with data:', data);
            
            // Update chart info with animation
            updateChartInfo(data);
            
            const canvas = document.getElementById('departmentChart');
            
            // Destroy any existing chart on this canvas
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                console.log('Destroying existing chart');
                existingChart.destroy();
            }
            
            const ctx = canvas.getContext('2d');
            
            // Enhanced chart configuration
            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: data.backgroundColor || [
                            '#667eea', '#764ba2', '#6B8DD6', '#8FD3F4', '#84fab0', 
                            '#a6c1ee', '#fbc2eb', '#ff9a9e', '#f6d365', '#fda085'
                        ],
                        borderWidth: 0,
                        borderRadius: 6,
                        hoverOffset: 15,
                        hoverBorderWidth: 2,
                        hoverBorderColor: 'rgba(255,255,255,0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'right',
                            rtl: true,
                            labels: {
                                boxWidth: 15,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 15,
                                font: {
                                    family: 'Tajawal, sans-serif',
                                    size: 13,
                                    weight: '600'
                                },
                                generateLabels: function(chart) {
                                    const datasets = chart.data.datasets;
                                    const labels = chart.data.labels;
                                    const total = datasets[0].data.reduce((a, b) => a + b, 0);
                                    
                                    return labels.map(function(label, i) {
                                        const value = datasets[0].data[i];
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return {
                                            text: `${label} (${percentage}%)`,
                                            fillStyle: datasets[0].backgroundColor[i],
                                            strokeStyle: datasets[0].backgroundColor[i],
                                            lineWidth: 0,
                                            fontColor: '#555',
                                            hidden: !chart.getDataVisibility(i),
                                            index: i
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.85)',
                            titleFont: {
                                family: 'Tajawal, sans-serif',
                                size: 15,
                                weight: 'bold'
                            },
                            bodyFont: {
                                family: 'Tajawal, sans-serif',
                                size: 14
                            },
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: true,
                            usePointStyle: true,
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = data.percentages[context.dataIndex];
                                    return [`عدد الموظفين: ${value}`, `النسبة: ${percentage}%`];
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 1200,
                        easing: 'easeOutQuart'
                    },
                    onClick: function(e, elements) {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const departmentId = data.departmentIds[index];
                            if (departmentId > 0) {
                                showNotification(`جاري تحميل قسم ${data.labels[index]}...`, 'info');
                                setTimeout(() => {
                                    window.location.href = '/departments/view/' + departmentId;
                                }, 500);
                            }
                        }
                    }
                }
            });

            // Show success notification
            console.log('تم إنشاء مخطط الأقسام بنجاح');
        } catch(error) {
            console.error('خطأ في إنشاء المخطط:', error.message || error.toString() || error);
            console.error('Stack:', error.stack);
            if (typeof showNotification === 'function') {
                showNotification('حدث خطأ في عرض المخطط', 'danger');
            }
        }
    })();
});
</script>
{% endblock %}