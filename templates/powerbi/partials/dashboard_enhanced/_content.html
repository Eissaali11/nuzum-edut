<div class="power-bi-container">
    <!-- الرأس الرئيسي -->
    <div class="main-header">
        <div class="header-top">
            <div class="header-title">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="title-content">
                    <h1>لوحة التحليلات الشاملة</h1>
                    <p>عرض شامل تفصيلي للبيانات والإحصائيات</p>
                </div>
            </div>
        </div>

        <!-- إحصائيات الرأس -->
        <div class="header-stats">
            <div class="stat-box">
                <div class="stat-number">{{ total_employees }}</div>
                <div class="stat-label">الموظفون النشطون</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">{{ departments|length }}</div>
                <div class="stat-label">عدد الأقسام</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">{{ total_vehicles }}</div>
                <div class="stat-label">السيارات والمركبات</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">{{ total_documents }}</div>
                <div class="stat-label">الوثائق والملفات</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">{{ attendance_stats.rate }}%</div>
                <div class="stat-label">نسبة الحضور العامة</div>
            </div>
        </div>
    </div>

    <!-- مؤشرات الأداء الرئيسية -->
    <h2 class="section-title">
        <i class="fas fa-gauge-high"></i>
        مؤشرات الأداء الرئيسية
    </h2>

    <div class="kpi-section">
        <div class="kpi-card" style="--kpi-color: var(--green); --kpi-bg: rgba(0, 255, 136, 0.1);">
            <div style="display: flex; align-items: flex-start; gap: 1rem;">
                <div class="kpi-icon" style="background: rgba(0, 255, 136, 0.1); color: var(--green);">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="kpi-text">
                    <div class="kpi-value">{{ attendance_stats.present }}</div>
                    <div class="kpi-label">حاضرين اليوم</div>
                </div>
            </div>
        </div>

        <div class="kpi-card" style="--kpi-color: var(--red); --kpi-bg: rgba(255, 71, 87, 0.1);">
            <div style="display: flex; align-items: flex-start; gap: 1rem;">
                <div class="kpi-icon" style="background: rgba(255, 71, 87, 0.1); color: var(--red);">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="kpi-text">
                    <div class="kpi-value">{{ attendance_stats.absent }}</div>
                    <div class="kpi-label">غائبين</div>
                </div>
            </div>
        </div>

        <div class="kpi-card" style="--kpi-color: var(--orange); --kpi-bg: rgba(255, 140, 0, 0.1);">
            <div style="display: flex; align-items: flex-start; gap: 1rem;">
                <div class="kpi-icon" style="background: rgba(255, 140, 0, 0.1); color: var(--orange);">
                    <i class="fas fa-plane"></i>
                </div>
                <div class="kpi-text">
                    <div class="kpi-value">{{ attendance_stats.leave }}</div>
                    <div class="kpi-label">في الإجازة</div>
                </div>
            </div>
        </div>

        <div class="kpi-card" style="--kpi-color: var(--purple); --kpi-bg: rgba(123, 104, 238, 0.1);">
            <div style="display: flex; align-items: flex-start; gap: 1rem;">
                <div class="kpi-icon" style="background: rgba(123, 104, 238, 0.1); color: var(--purple);">
                    <i class="fas fa-hospital"></i>
                </div>
                <div class="kpi-text">
                    <div class="kpi-value">{{ attendance_stats.sick }}</div>
                    <div class="kpi-label">إجازة مرضية</div>
                </div>
            </div>
        </div>
    </div>

    <!-- الرسوم البيانية والإحصائيات -->
    <h2 class="section-title">
        <i class="fas fa-chart-bar"></i>
        الرسوم البيانية
    </h2>

    <div class="charts-grid">
        <!-- نسبة الحضور -->
        <div class="chart-card">
            <div class="chart-header">
                <i class="fas fa-pie-chart"></i>
                <span>نسبة الحضور الإجمالية</span>
            </div>
            <div class="chart-container">
                <canvas id="attendanceChart"></canvas>
            </div>
        </div>

        <!-- يوميات الحضور -->
        <div class="chart-card">
            <div class="chart-header">
                <i class="fas fa-bars"></i>
                <span>توزيع حالات الحضور</span>
            </div>
            <div class="stats-grid">
                <div class="stat-item" style="--color: var(--green);">
                    <span class="label"><i class="fas fa-check"></i> حاضرين</span>
                    <span class="value">{{ attendance_stats.present }}</span>
                </div>
                <div class="stat-item" style="--color: var(--red);">
                    <span class="label"><i class="fas fa-times"></i> غائبين</span>
                    <span class="value">{{ attendance_stats.absent }}</span>
                </div>
                <div class="stat-item" style="--color: var(--orange);">
                    <span class="label"><i class="fas fa-plane"></i> إجازة</span>
                    <span class="value">{{ attendance_stats.leave }}</span>
                </div>
                <div class="stat-item" style="--color: var(--purple);">
                    <span class="label"><i class="fas fa-hospital"></i> مرضى</span>
                    <span class="value">{{ attendance_stats.sick }}</span>
                </div>
            </div>
        </div>

        <!-- حالة السيارات -->
        <div class="chart-card">
            <div class="chart-header">
                <i class="fas fa-car"></i>
                <span>حالة السيارات</span>
            </div>
            <div class="stats-grid">
                {% for status, count in vehicle_stats.items() %}
                <div class="stat-item" style="--color: {% if status == 'available' %}var(--green){% elif status == 'in_workshop' %}var(--orange){% else %}var(--cyan){% endif %};">
                    <span class="label">
                        {% if status == 'available' %}<i class="fas fa-check"></i> متاحة
                        {% elif status == 'in_project' %}<i class="fas fa-briefcase"></i> في المشروع
                        {% elif status == 'in_workshop' %}<i class="fas fa-wrench"></i> في الورشة
                        {% elif status == 'out_of_service' %}<i class="fas fa-ban"></i> خارج الخدمة
                        {% elif status == 'accident' %}<i class="fas fa-car-crash"></i> حادث
                        {% else %}<i class="fas fa-question"></i> {{ status }}
                        {% endif %}
                    </span>
                    <span class="value">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- حالة الوثائق -->
        <div class="chart-card">
            <div class="chart-header">
                <i class="fas fa-file"></i>
                <span>حالة الوثائق والملفات</span>
            </div>
            <div class="stats-grid">
                <div class="stat-item" style="--color: var(--green);">
                    <span class="label"><i class="fas fa-check-double"></i> سارية</span>
                    <span class="value">{{ doc_stats.valid }}</span>
                </div>
                <div class="stat-item" style="--color: var(--orange);">
                    <span class="label"><i class="fas fa-clock"></i> تنتهي قريباً</span>
                    <span class="value">{{ doc_stats.expiring }}</span>
                </div>
                <div class="stat-item" style="--color: var(--red);">
                    <span class="label"><i class="fas fa-exclamation"></i> منتهية</span>
                    <span class="value">{{ doc_stats.expired }}</span>
                </div>
                <div class="stat-item" style="--color: var(--cyan);">
                    <span class="label"><i class="fas fa-folder"></i> الإجمالي</span>
                    <span class="value">{{ doc_stats.total }}</span>
                </div>
            </div>
        </div>

        <!-- توزيع الموظفين -->
        <div class="chart-card">
            <div class="chart-header">
                <i class="fas fa-chart-bar"></i>
                <span>عدد الموظفين حسب القسم</span>
            </div>
            <div class="chart-container">
                <canvas id="departmentChart"></canvas>
            </div>
        </div>
    </div>

    <!-- جدول الحضور حسب القسم -->
    <h2 class="section-title">
        <i class="fas fa-table"></i>
        تفاصيل الحضور حسب القسم
    </h2>

    <div class="table-card">
        {% if dept_attendance %}
        <table class="data-table">
            <thead>
                <tr>
                    <th><i class="fas fa-building"></i> اسم القسم</th>
                    <th><i class="fas fa-users"></i> عدد الموظفين</th>
                    <th><i class="fas fa-calendar-check"></i> أيام الحضور</th>
                    <th><i class="fas fa-check-circle"></i> الحاضرين</th>
                    <th><i class="fas fa-times-circle"></i> الغائبين</th>
                    <th><i class="fas fa-list"></i> الإجمالي</th>
                    <th><i class="fas fa-percent"></i> النسبة</th>
                    <th><i class="fas fa-star"></i> التقييم</th>
                </tr>
            </thead>
            <tbody>
                {% for dept in dept_attendance %}
                <tr>
                    <td><strong>{{ dept.name }}</strong></td>
                    <td>{{ dept.employee_count }}</td>
                    <td style="color: var(--purple);">{{ dept.present_days }}</td>
                    <td style="color: var(--green);">{{ dept.present }}</td>
                    <td style="color: var(--red);">{{ dept.absent }}</td>
                    <td>{{ dept.total }}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div class="progress-bar">
                                <div class="fill" style="width: {{ dept.rate }}%; background: {% if dept.rate >= 90 %}var(--green){% elif dept.rate >= 75 %}var(--cyan){% elif dept.rate >= 60 %}var(--orange){% else %}var(--red){% endif %};"></div>
                            </div>
                            <span style="color: var(--cyan); font-weight: 700;">{{ dept.rate }}%</span>
                        </div>
                    </td>
                    <td>
                        {% if dept.rate >= 90 %}
                        <span class="badge badge-excellent"><i class="fas fa-star"></i> ممتاز</span>
                        {% elif dept.rate >= 75 %}
                        <span class="badge badge-good"><i class="fas fa-thumbs-up"></i> جيد</span>
                        {% elif dept.rate >= 60 %}
                        <span class="badge badge-average"><i class="fas fa-minus"></i> متوسط</span>
                        {% else %}
                        <span class="badge badge-poor"><i class="fas fa-arrow-down"></i> ضعيف</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                <tr class="total-row">
                    <td><i class="fas fa-calculator"></i> <strong>الإجمالي</strong></td>
                    <td><strong>{{ dept_attendance|sum(attribute='employee_count') }}</strong></td>
                    <td><strong>{{ dept_attendance|sum(attribute='present_days') }}</strong></td>
                    <td><strong>{{ dept_attendance|sum(attribute='present') }}</strong></td>
                    <td><strong>{{ dept_attendance|sum(attribute='absent') }}</strong></td>
                    <td><strong>{{ dept_attendance|sum(attribute='total') }}</strong></td>
                    <td>
                        {% set total_present = dept_attendance|sum(attribute='present') %}
                        {% set total_records = dept_attendance|sum(attribute='total') %}
                        {% set overall_rate = ((total_present / total_records) * 100)|round(1) if total_records > 0 else 0 %}
                        <strong style="color: var(--cyan);">{{ overall_rate }}%</strong>
                    </td>
                    <td>
                        {% if overall_rate >= 90 %}
                        <span class="badge badge-excellent"><i class="fas fa-trophy"></i> ممتاز</span>
                        {% elif overall_rate >= 75 %}
                        <span class="badge badge-good"><i class="fas fa-star"></i> جيد</span>
                        {% elif overall_rate >= 60 %}
                        <span class="badge badge-average"><i class="fas fa-minus"></i> متوسط</span>
                        {% else %}
                        <span class="badge badge-poor"><i class="fas fa-arrow-down"></i> ضعيف</span>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
        {% else %}
        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p>لا توجد بيانات حضور للأقسام في الفترة المحددة</p>
        </div>
        {% endif %}
    </div>

    <!-- معلومات التصفية والتاريخ -->
    <div style="background: rgba(0, 212, 255, 0.05); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-top: 2rem; text-align: center;">
        <p style="color: var(--text-muted); margin: 0;">
            <i class="fas fa-info-circle"></i>
            البيانات معروضة من {{ date_from }} إلى {{ date_to }}
        </p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // رسم بياني الحضور
    const attendanceCtx = document.getElementById('attendanceChart');
    if (attendanceCtx) {
        new Chart(attendanceCtx, {
            type: 'doughnut',
            data: {
                labels: ['حاضرين', 'غائبين', 'إجازة', 'مرضى'],
                datasets: [{
                    data: [{{ attendance_stats.present }}, {{ attendance_stats.absent }}, {{ attendance_stats.leave }}, {{ attendance_stats.sick }}],
                    backgroundColor: [
                        'rgba(0, 255, 136, 0.7)',
                        'rgba(255, 71, 87, 0.7)',
                        'rgba(255, 140, 0, 0.7)',
                        'rgba(123, 104, 238, 0.7)'
                    ],
                    borderColor: [
                        'rgba(0, 255, 136, 1)',
                        'rgba(255, 71, 87, 1)',
                        'rgba(255, 140, 0, 1)',
                        'rgba(123, 104, 238, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#e8eaed', font: { size: 12 } }
                    }
                }
            }
        });
    }

    // رسم بياني الأقسام
    const deptCtx = document.getElementById('departmentChart');
    if (deptCtx) {
        const deptNames = [{% for dept in dept_attendance %}'{{ dept.name }}'{% if not loop.last %},{% endif %}{% endfor %}];
        const deptCounts = [{% for dept in dept_attendance %}{{ dept.employee_count }}{% if not loop.last %},{% endif %}{% endfor %}];
        
        if (deptNames.length > 0) {
            new Chart(deptCtx, {
                type: 'bar',
                data: {
                    labels: deptNames,
                    datasets: [{
                        label: 'عدد الموظفين',
                        data: deptCounts,
                        backgroundColor: [
                            'rgba(0, 212, 255, 0.7)',
                            'rgba(0, 245, 212, 0.7)',
                            'rgba(123, 104, 238, 0.7)',
                            'rgba(255, 215, 0, 0.7)',
                            'rgba(0, 255, 136, 0.7)',
                            'rgba(255, 140, 0, 0.7)',
                            'rgba(255, 71, 87, 0.7)',
                            'rgba(138, 43, 226, 0.7)'
                        ],
                        borderColor: [
                            'rgba(0, 212, 255, 1)',
                            'rgba(0, 245, 212, 1)',
                            'rgba(123, 104, 238, 1)',
                            'rgba(255, 215, 0, 1)',
                            'rgba(0, 255, 136, 1)',
                            'rgba(255, 140, 0, 1)',
                            'rgba(255, 71, 87, 1)',
                            'rgba(138, 43, 226, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'x',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#8892a0' },
                            grid: { color: 'rgba(0, 212, 255, 0.05)' }
                        },
                        x: {
                            ticks: { color: '#8892a0', font: { size: 11 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
    }
});
</script>
