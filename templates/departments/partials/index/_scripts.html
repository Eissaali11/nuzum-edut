<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('departmentSearchInput');
    const clearButton = document.getElementById('clearSearchBtn');
    const departmentItems = document.querySelectorAll('.department-item');
    
    // Enhanced search function with debouncing
    let searchTimeout;
    function performSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const searchTerm = searchInput.value.trim().toLowerCase();
            let resultsFound = false;
            
            // Show loading state
            searchInput.style.background = 'url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iOCIgc3Ryb2tlPSIjNjY3ZWVhIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPHBhdGggZD0iTTE2IDE2bDQgNCIgc3Ryb2tlPSIjNjY3ZWVhIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4K") no-repeat right 10px center';
            
            setTimeout(() => {
                departmentItems.forEach((item, index) => {
                    const departmentName = item.getAttribute('data-department-name').toLowerCase();
                    
                    if (departmentName.includes(searchTerm) || searchTerm === '') {
                        item.style.display = 'block';
                        item.style.animation = `fadeIn 0.5s ease-in-out ${index * 0.1}s both`;
                        resultsFound = true;
                        
                        // Enhanced text highlighting
                        const header = item.querySelector('.department-header h4');
                        const originalText = item.getAttribute('data-department-name');
                        
                        // Reset original text first
                        header.innerHTML = '<i class="fas fa-building me-2"></i>' + originalText;
                        
                        // Highlight matching text with enhanced styling
                        if (searchTerm !== '') {
                            const regex = new RegExp(`(${searchTerm})`, 'gi');
                            header.innerHTML = '<i class="fas fa-building me-2"></i>' + 
                                              originalText.replace(regex, '<span class="search-highlight">$1</span>');
                        }
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // Enhanced no results message
                const noResultsMessage = document.getElementById('noResultsMessage');
                if (!resultsFound && searchTerm !== '') {
                    if (!noResultsMessage) {
                        const message = document.createElement('div');
                        message.id = 'noResultsMessage';
                        message.className = 'col-12';
                        message.innerHTML = `
                            <div class="alert alert-warning alert-enhanced text-center">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                لا توجد نتائج مطابقة للبحث: "<strong>${searchTerm}</strong>"
                                <br>
                                <small class="text-muted mt-2 d-block">جرب استخدام كلمات مختلفة أو تحقق من الإملاء</small>
                            </div>
                        `;
                        document.querySelector('.row').appendChild(message);
                    }
                } else {
                    if (noResultsMessage) {
                        noResultsMessage.remove();
                    }
                }
                
                // Show result notification
                if (resultsFound && searchTerm !== '') {
                    const foundCount = Array.from(departmentItems).filter(item => 
                        item.style.display !== 'none').length;
                    showNotification(`تم العثور على ${foundCount} قسم يطابق البحث`, 'success');
                }
                
                // Clear loading state
                searchInput.style.background = '';
            }, 300);
        }, 300);
    }
    
    // Enhanced event listeners
    searchInput.addEventListener('input', performSearch);
    
    // Enhanced clear functionality
    clearButton.addEventListener('click', function() {
        searchInput.value = '';
        performSearch();
        searchInput.focus();
        showNotification('تم مسح البحث', 'info');
    });
    
    // Enhanced keyboard shortcuts
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            searchInput.value = '';
            performSearch();
        }
    });
    
    // Initialize display
    departmentItems.forEach(item => {
        item.style.display = 'block';
    });
    
    // Enhanced notification system
    function showNotification(message, type) {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.notification-toast');
        existingNotifications.forEach(notification => notification.remove());
        
        const notification = document.createElement('div');
        notification.className = `notification-toast position-fixed top-0 end-0 m-3 alert alert-${type} alert-enhanced`;
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 3000);
    }
    
    // Initialize tooltips
    if (typeof bootstrap !== 'undefined') {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
        tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
    
    console.log('تم تحميل صفحة إدارة الأقسام بنجاح');
});
</script>
