{% extends 'layout.html' %}

{% block extra_css %}
{% include 'documents/partials/index/_extra_css.html' %}
{% endblock %}

{% block content %}
{% include 'documents/partials/index/_content.html' %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Enhanced filter field behavior
        const filterFields = [
            "document_type",
            "employee_id",
            "department_id",
            "sponsorship_status",
            "expiring",
        ];

        filterFields.forEach(function (field) {
            const element = document.getElementById(field);
            if (element) {
                element.addEventListener("change", function () {
                    // Show loading state
                    const form = this.closest("form");
                    if (form) {
                        const submitButton = form.querySelector('button[type="submit"]');
                        if (submitButton) {
                            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحميل...';
                            submitButton.disabled = true;
                        }
                        form.submit();
                    }
                });
            }
        });

        // Add data-labels for responsive table
        document.querySelectorAll(".enhanced-table thead th").forEach((th, index) => {
            const label = th.textContent;
            document.querySelectorAll(`.enhanced-table tbody tr td:nth-child(${index + 1})`).forEach((td) => {
                td.setAttribute("data-label", label);
            });
        });

        // Initialize tooltips
        if (typeof bootstrap !== "undefined") {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll("[title]"));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
    });
</script>

<script>
const documentsExportEndpoint = "{{ url_for('documents.export_excel') if endpoint_exists('documents.export_excel') else url_for('documents_refactored.export_excel') }}";

function exportToExcel() {
    // الحصول على معلمات الفلتر الحالية من URL
    const urlParams = new URLSearchParams(window.location.search);
    
    // بناء رابط التصدير مع نفس الفلاتر
    let exportUrl = documentsExportEndpoint + '?';
    
    // إضافة معلمات الفلتر
    if (urlParams.get('document_type')) {
        exportUrl += `document_type=${urlParams.get('document_type')}&`;
    }
    if (urlParams.get('employee_id')) {
        exportUrl += `employee_id=${urlParams.get('employee_id')}&`;
    }
    if (urlParams.get('department_id')) {
        exportUrl += `department_id=${urlParams.get('department_id')}&`;
    }
    if (urlParams.get('sponsorship_status')) {
        exportUrl += `sponsorship_status=${urlParams.get('sponsorship_status')}&`;
    }
    if (urlParams.get('expiring')) {
        exportUrl += `expiring=${urlParams.get('expiring')}&`;
    }
    if (urlParams.get('show_all')) {
        exportUrl += `show_all=${urlParams.get('show_all')}&`;
    }
    
    // إزالة & الأخير إذا كان موجوداً
    if (exportUrl.endsWith('&')) {
        exportUrl = exportUrl.slice(0, -1);
    }
    
    // فتح الرابط في نافذة جديدة
    window.open(exportUrl, '_blank');
    
    // عرض رسالة نجاح
    showToast('جاري تصدير البيانات إلى Excel...', 'success');
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(toast);

    // إزالة الرسالة تلقائياً بعد 5 ثوانٍ
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}
</script>
{% endblock %}