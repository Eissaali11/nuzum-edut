{% extends 'layout.html' %}

{% block content %}
{% include 'documents/partials/expiring/_content.html' %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // إظهار/إخفاء حقل اختيار الأيام بناءً على نوع الوثائق المطلوبة
        const statusRadios = document.querySelectorAll('input[name="status"]');
        const daysContainer = document.getElementById('daysFilterContainer');
        
        // دالة للتحقق من حالة الوثائق وإظهار/إخفاء حقل الأيام
        function toggleDaysFilter() {
            const selectedStatus = document.querySelector('input[name="status"]:checked').value;
            if (selectedStatus === 'expired') {
                daysContainer.style.display = 'none';
            } else {
                daysContainer.style.display = 'block';
            }
        }
        
        // تطبيق الحالة الأولية عند تحميل الصفحة
        toggleDaysFilter();
        
        // إضافة مستمع للتغييرات في اختيار نوع الوثائق
        statusRadios.forEach(function(radio) {
            radio.addEventListener('change', toggleDaysFilter);
        });
        
        // إعادة تحميل الصفحة عند تغيير أي من حقول البحث
        const filterFields = ['days', 'document_type', 'status', 'employee_id', 'department_id', 'sponsorship_status'];
        
        filterFields.forEach(function(field) {
            const elements = document.querySelectorAll(`[name="${field}"]`);
            elements.forEach(function(element) {
                if (element) {
                    element.addEventListener('change', function() {
                        const form = this.closest('form');
                        if (form) {
                            form.submit();
                        }
                    });
                }
            });
        });
        
        // جلب إحصائيات انتهاء الوثائق
        fetch('{{ url_for("documents.expiry_stats") }}')
            .then(response => response.json())
            .then(data => {
                document.getElementById('expiring30Count').textContent = data.expiring_30;
                document.getElementById('expiring60Count').textContent = data.expiring_60;
                document.getElementById('expiring90Count').textContent = data.expiring_90;
                document.getElementById('expiredCount').textContent = data.expired;
            })
            .catch(error => {
                console.error('Error fetching document statistics:', error);
            });
    });

    // دالة تحديث تاريخ انتهاء الوثيقة
    function updateExpiryDate(documentId, currentDate) {
        // إظهار نافذة التأكيد مع حقل إدخال التاريخ
        Swal.fire({
            title: 'تحديث تاريخ الانتهاء',
            html: '<input type="date" id="newExpiryDate" class="swal2-input" value="' + currentDate + '" required>',
            showCancelButton: true,
            confirmButtonText: 'تحديث',
            cancelButtonText: 'إلغاء',
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            preConfirm: () => {
                const newDate = document.getElementById('newExpiryDate').value;
                if (!newDate) {
                    Swal.showValidationMessage('يجب إدخال تاريخ الانتهاء الجديد');
                    return false;
                }
                return newDate;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // إنشاء نموذج لإرسال البيانات
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("documents.update_expiry_date", document_id=0) }}'.replace('0', documentId);
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'new_expiry_date';
                input.value = result.value;
                
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
</script>
{% endblock %}
